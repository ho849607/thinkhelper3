<!DOCTYPE html>
<html lang="ko" data-theme="light">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>ThinkHelper â€” Workspace & Discover (GitHub Demo)</title>
  <link rel="icon" href="data:,"/>
  <!-- Libs (CDN) -->
  <script src="https://cdn.ckeditor.com/ckeditor5/41.3.1/classic/ckeditor.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js" defer></script>

  <style>
    :root{
      --bg:#f6f8fb;--fg:#0b1020;--muted:#6a7691;
      --panel:#fff;--card:#f2f5ff;--border:#d6deee;
      --hover:#e9effe;--accent:#2563eb;--touch:48px
    }
    :root[data-theme="dark"]{
      --bg:#0b1020;--fg:#f1f5ff;--muted:#a8b4cf;
      --panel:#0f172a;--card:#101a30;--border:#273453;
      --hover:#16213b;--accent:#60a5fa
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:var(--bg);color:var(--fg);
      font-family:-apple-system,Segoe UI,Roboto,
        Apple SD Gothic Neo,Noto Sans KR,sans-serif;
      display:flex;flex-direction:column;
      min-height:100vh;overflow:hidden
    }

    /* Topbar */
    .topbar{
      position:sticky;top:0;z-index:50;
      display:flex;align-items:center;justify-content:space-between;
      gap:8px;padding:calc(8px + env(safe-area-inset-top,0)) 12px 10px;
      background:var(--panel);border-bottom:1px solid var(--border)
    }
    .brand{display:flex;align-items:center;gap:10px;font-weight:900}
    .logo{width:18px;height:18px;border-radius:4px;
      background:linear-gradient(135deg,#60a5fa,#34d399)}
    .modes{display:flex;gap:8px}
    .tab{
      border:1px solid var(--border);background:var(--card);
      padding:.55rem .9rem;border-radius:10px;
      font-weight:800;cursor:pointer;min-height:var(--touch)
    }
    .tab[aria-selected="true"]{
      background:var(--panel);outline:2px solid var(--accent)
    }
    .actions{display:flex;gap:8px;align-items:center}
    .iconbtn,.btn{
      border:1px solid var(--border);background:var(--card);
      color:var(--fg);border-radius:10px;
      padding:.55rem .9rem;font-weight:800;
      cursor:pointer;min-height:var(--touch)
    }
    .iconbtn:hover,.btn:hover{background:var(--hover)}

    main{flex:1;min-height:0}

    /* Workspace grid */
    #workspace{
      height:100%;
      display:grid;
      grid-template-columns:280px 1fr 320px;
      gap:12px;padding:12px;overflow:hidden
    }
    aside#left,aside#right,#center{
      background:var(--panel);border:1px solid var(--border);
      border-radius:12px;min-height:0;
      display:flex;flex-direction:column;overflow:hidden
    }

    /* Left column */
    #left{padding:10px}
    .left-search{display:flex;gap:8px;margin:6px 0 10px}
    .left-search input{
      flex:1;border:1px solid var(--border);background:var(--card);
      border-radius:10px;padding:.6rem .8rem;font-size:.95rem
    }
    .tabs{
      display:grid;grid-template-columns:repeat(4,1fr);
      gap:6px;margin-bottom:8px
    }
    .tabs button{
      border:1px solid var(--border);background:var(--card);
      border-radius:8px;padding:.5rem .7rem;font-weight:800;
      cursor:pointer;min-height:40px
    }
    .tabs button[data-active="1"]{
      background:var(--panel);color:var(--accent)
    }
    .panel{flex:1;overflow:auto;display:none}
    .panel[data-active="1"]{display:block}
    .panel-head{
      display:flex;justify-content:space-between;align-items:center;
      margin:6px 0 8px
    }

    .doc{
      display:flex;justify-content:space-between;align-items:center;
      padding:.55rem .7rem;border:1px solid var(--border);
      border-radius:8px;background:var(--card);
      margin-bottom:6px;cursor:pointer
    }
    .doc:hover{background:var(--hover)}
    .doc .ttl{
      font-weight:800;min-width:0;overflow:hidden;
      text-overflow:ellipsis;white-space:nowrap
    }
    .doc .date{
      color:var(--muted);font-size:.82rem;margin-left:8px;white-space:nowrap
    }
    .doc-main{
      display:flex;
      flex-direction:column;
      min-width:0;
    }
    .doc-actions{
      display:flex;
      gap:4px;
      margin-left:8px;
      flex-shrink:0;
      opacity:0;
      transition:opacity .15s;
    }
    .doc:hover .doc-actions{
      opacity:1;
    }
    .doc-actions .icon-mini{
      border:none;
      background:transparent;
      color:var(--muted);
      cursor:pointer;
      font-size:.8rem;
      padding:2px 4px;
      border-radius:6px;
    }
    .doc-actions .icon-mini:hover{
      background:var(--hover);
      color:var(--fg);
    }

    /* search history rows */
    #searchList .srow{
      display:flex;justify-content:space-between;align-items:center;
      padding:.5rem .6rem;border:1px solid var(--border);
      border-radius:8px;background:var(--card);
      margin-bottom:6px;cursor:pointer
    }
    #searchList .srow:hover{background:var(--hover)}
    #searchList .srow .meta{
      color:var(--muted);font-size:.8rem;margin-left:6px
    }
    #searchList .srow .del{
      border:none;background:transparent;color:var(--muted);
      cursor:pointer;font-size:.8rem
    }

    /* Center / editor */
    #center{padding:0}
    #center-inner{display:flex;flex-direction:column;height:100%}
    .editor-wrap{
      flex:1;min-height:0;overflow:auto;padding:10px;
      position:relative; /* ìë™ì™„ì„± ìœ„ì¹˜ ê¸°ì¤€ */
    }
    .ck-editor__editable_inline{
      min-height:60vh!important;background:#fff;
      color:#222;border-radius:8px
    }
    [data-theme="dark"] .ck-editor__editable_inline{
      color:#ffe7b3;background:#0b1327
    }
    .doc-title{
      font-weight:900;font-size:1.05rem;padding:10px;
      color:var(--muted);border-bottom:1px dashed var(--border);
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis
    }

    /* Right / AI */
    #right{padding:10px}
    .ai-head{display:flex;justify-content:space-between;align-items:center}
    .ai-box{
      flex:1;overflow:auto;margin-top:8px;
      display:flex;flex-direction:column;gap:8px
    }
    .bubble{
      max-width:85%;padding:.9rem 1rem;
      border:1px solid var(--border);border-radius:14px;
      background:var(--card);line-height:1.6;white-space:pre-wrap
    }
    .me{
      margin-left:auto;background:#143763;
      color:#fff;border-color:#143763
    }
    .ai{
      margin-right:auto;border-color:#314264;
      background:#122142;color:#fff
    }
    .ai-form{display:flex;gap:8px;margin-top:auto}
    .ai-form textarea{
      flex:1;border:1px solid var(--border);border-radius:10px;
      background:var(--card);color:var(--fg);
      padding:.7rem .9rem;min-height:64px;resize:vertical
    }
    .ai-form button{min-width:92px}

    /* Autocomplete popup */
    #suggestionBox{
      position:absolute;display:none;z-index:9999;
      background:var(--panel);border:1px solid var(--border);
      border-radius:6px;box-shadow:0 4px 12px rgba(0,0,0,.15);
      min-width:160px;max-width:260px;overflow:hidden;
      font-family:monospace,sans-serif;font-size:.85rem
    }
    #suggestionBox ul{list-style:none;margin:0;padding:4px 0}
    #suggestionBox li{
      padding:6px 12px;cursor:pointer;
      display:flex;justify-content:space-between;color:var(--fg)
    }
    #suggestionBox li.active{
      background:#007AFF;color:#fff
    }
    #suggestionBox li:hover:not(.active){background:var(--hover)}

    .pill{
      display:inline-flex;align-items:center;
      padding:0 .4em;border-radius:999px;
      border:1px dashed var(--border);background:var(--card);
      font-size:.85em;cursor:pointer;user-select:none;margin:0 1px
    }

    footer{
      padding:8px 12px calc(8px + env(safe-area-inset-bottom,0));
      border-top:1px solid var(--border);background:var(--panel);
      font-size:.95rem;display:flex;flex-wrap:wrap;
      gap:12px;justify-content:space-between
    }
    .status-left,.status-right{
      display:flex;gap:12px;align-items:center
    }
    .tip{color:var(--muted)}

    /* --- Discover: í…ìŠ¤íŠ¸ ì „ìš© Google News ìŠ¤íƒ€ì¼ ë ˆì´ì•„ì›ƒ --- */
    #discover{
      padding:12px;
      height:100%;
      overflow:auto;
      background:var(--bg);
    }
    .discover-header{
      display:flex;justify-content:space-between;align-items:flex-end;
      margin:4px 0 12px
    }
    .discover-title{
      font-size:1.2rem;font-weight:900
    }
    .discover-meta{
      font-size:.85rem;color:var(--muted)
    }

    /* ë©”ì¸/ì‚¬ì´ë“œ 2ë‹¨ ë ˆì´ì•„ì›ƒ */
    #discoverGrid{
      display:grid;
      grid-template-columns:minmax(0,2.2fr) minmax(0,1.1fr);
      gap:18px;
      align-items:flex-start;
    }
    .discover-col{
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    /* í…ìŠ¤íŠ¸ ì „ìš© ë‰´ìŠ¤ ì¹´ë“œ */
    .news-card{
      border:1px solid var(--border);background:var(--panel);
      border-radius:16px;
      box-shadow:0 8px 24px rgba(15,23,42,.04);
      padding:10px 14px 8px;
      display:flex;
      flex-direction:column;
      cursor:pointer;
    }
    .news-card.hero{
      padding:14px 16px 10px;
    }
    .news-body{
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .news-meta{
      font-size:.78rem;color:var(--muted);
    }
    .news-title{
      font-weight:900;margin-bottom:2px;font-size:1rem;
      line-height:1.5;
    }
    .news-card.hero .news-title{
      font-size:1.1rem;
    }
    .news-desc{
      color:var(--muted);font-size:.9rem;line-height:1.6;
      max-height:3.8em;overflow:hidden;
    }
    .news-card.hero .news-desc{
      max-height:none;
    }
    .news-card.compact{
      padding:8px 10px 6px;
    }
    .news-card.compact .news-title{
      font-size:.95rem;
    }
    .news-actions{
      margin-top:6px;
      display:flex;
      gap:6px;
      padding-top:6px;
      border-top:1px dashed var(--border);
    }
    .news-actions .btn{
      flex:1;text-align:center;font-size:.88rem;
    }

    /* Google News ì•ˆë‚´ ì¹´ë“œ */
    .google-login-card{
      margin:24px auto 12px;
      max-width:520px;
      border-radius:14px;
      border:1px dashed var(--border);
      padding:12px 14px;
      background:var(--card);
    }
    .google-login-card h4{
      margin:0 0 4px;
      font-size:.95rem;
      font-weight:800;
    }
    .google-login-card p{
      margin:0 0 8px;
      font-size:.85rem;
      color:var(--muted);
    }
    .google-login-card .btn{
      font-size:.85rem;
    }

    /* ë°˜ì‘í˜•(ë””ìŠ¤ì»¤ë²„ë¦¬) */
    @media (max-width:900px){
      #discoverGrid{
        grid-template-columns:1fr;
      }
    }

    /* Settings modal */
    .modal{
      position:fixed;inset:0;display:none;
      align-items:center;justify-content:center;
      background:rgba(0,0,0,.25);z-index:120
    }
    .modal[open]{display:flex}
    .modal-card{
      width:min(560px,92vw);max-height:90vh;overflow:auto;
      background:var(--panel);border:1px solid var(--border);
      border-radius:16px;padding:16px 16px 14px
    }
    .row{
      display:flex;gap:8px;align-items:center;
      justify-content:space-between;
      border:1px dashed var(--border);
      border-radius:10px;padding:8px 10px;margin-top:6px
    }
    .row-label{
      flex:1;font-size:.9rem;font-weight:600
    }
    .select{
      border:1px solid var(--border);background:var(--card);
      color:var(--fg);border-radius:8px;padding:.45rem .7rem
    }
    .switch{
      appearance:none;width:40px;height:22px;border-radius:999px;
      background:#cbd5e1;position:relative;outline:0;
      cursor:pointer;border:1px solid var(--border)
    }
    .switch:checked{background:#3b82f6}
    .switch::after{
      content:"";position:absolute;top:2px;left:2px;
      width:18px;height:18px;border-radius:50%;
      background:#fff;transition:left .18s
    }
    .switch:checked::after{left:20px}

    /* Quickbar (mobile bottom) */
    .quickbar{
      position:fixed;bottom:0;left:0;right:0;z-index:80;
      display:flex;gap:8px;padding:8px 12px;
      background:var(--panel);border-top:1px solid var(--border)
    }
    .quickbar .btn{flex:1}
    .quickbar .btn.active{background:var(--accent);color:#fff}

    /* Responsive workspace */
    @media (max-width:1024px){
      #workspace{grid-template-columns:240px 1fr 0}
      #right{display:none}
    }
    @media (max-width:820px){
      #workspace{grid-template-columns:220px 1fr}
    }
    @media (max-width:480px){
      .topbar{display:none}
      #workspace{
        display:block;grid-template-columns:1fr;
        padding:0;height:calc(100vh - 56px - env(safe-area-inset-bottom,0))
      }
      #left{
        border-radius:0;border-left:none;border-right:none;
        border-top:none;border-bottom:1px solid var(--border)
      }
      #center{
        height:100%;display:flex;flex-direction:column;border-radius:0;border:none
      }
      .editor-wrap{
        height:100%;overflow:auto;padding:10px
      }
      footer{padding-bottom:56px}
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="brand"><div class="logo"></div><div id="i_brand">ThinkHelper</div></div>
    <div class="modes" role="tablist" aria-label="Main modes">
      <button class="tab" id="tabDiscover" role="tab" aria-selected="true"></button>
      <button class="tab" id="tabWorkspace" role="tab" aria-selected="false"></button>
    </div>
    <div class="actions">
      <button class="iconbtn" id="btnTheme" title="Theme">ğŸŒ“</button>
      <button class="iconbtn" id="btnSettings" title="Settings">âš™ï¸</button>
    </div>
  </div>

  <!-- Discover -->
  <section id="discover" data-active="1" aria-label="Discover feed">
    <div class="discover-header">
      <div>
        <div class="discover-title" id="i_discover_title"></div>
        <div class="discover-meta" id="discoverMeta"></div>
      </div>
    </div>
    <div id="discoverGrid"></div>

    <div class="google-login-card">
      <h4 id="i_google_card_title"></h4>
      <p id="i_google_card_body"></p>
      <button class="btn" id="btnGoogleNews"></button>
    </div>
  </section>

  <!-- Workspace -->
  <main id="workspace" style="display:none" aria-label="Workspace">
    <!-- Left -->
    <aside id="left" aria-label="ë¬¸ì„œ/í…œí”Œë¦¿/ë¼ì´ë¸ŒëŸ¬ë¦¬/ê²€ìƒ‰ê¸°ë¡">
      <div class="left-search" role="search">
        <input id="leftSearchInput" type="search" aria-label="search"/>
        <button class="btn" id="leftSearchBtn"></button>
      </div>
      <div class="tabs">
        <button id="tFiles"  data-active="1"></button>
        <button id="tTmpl"   data-active="0"></button>
        <button id="tLib"    data-active="0"></button>
        <button id="tSearch" data-active="0"></button>
      </div>

      <div id="pFiles" class="panel" data-active="1">
        <div class="panel-head">
          <b id="i_myfiles"></b>
          <button class="btn" id="btnNewDocLeft"></button>
        </div>
        <div id="fileList"></div>
      </div>

      <div id="pTmpl" class="panel" data-active="0">
        <div class="panel-head"><b id="i_templates"></b></div>
        <div id="tmplList"></div>
      </div>

      <div id="pLib" class="panel" data-active="0">
        <div class="panel-head"><b id="i_library"></b></div>
        <div id="libList"></div>
      </div>

      <div id="pSearch" class="panel" data-active="0">
        <div class="panel-head"><b id="i_search_history"></b></div>
        <div id="searchList" class="slist"></div>
        <div style="position:sticky;bottom:0;background:var(--panel);padding:8px;border-top:1px dashed var(--border);display:flex;justify-content:flex-end">
          <button class="btn" id="btnClearSearch"></button>
        </div>
      </div>
    </aside>

    <!-- Center -->
    <section id="center" aria-label="Editor">
      <div class="doc-title" id="docTitleBar"></div>
      <div id="center-inner">
        <div class="editor-wrap">
          <div id="editor"></div>
          <!-- Suggestion popup (ì—ë””í„° ê¸°ì¤€ ìœ„ì¹˜) -->
          <div id="suggestionBox" role="listbox" aria-label="Suggestions"></div>
        </div>
      </div>
    </section>

    <!-- Right: AI -->
    <aside id="right" aria-label="AI assistant">
      <div class="ai-head">
        <b id="i_ai_assistant"></b>
        <button class="iconbtn" id="aiToggle" title="toggle">âˆ’</button>
      </div>
      <div class="ai-box" id="aiBox"></div>
      <form class="ai-form" id="aiForm">
        <textarea id="aiInput"></textarea>
        <button class="btn" type="submit" id="i_send_btn"></button>
      </form>
    </aside>
  </main>

  <!-- ëª¨ë°”ì¼ í•˜ë‹¨ í€µë°” -->
  <div class="quickbar" id="quickbar" style="display:none">
    <button class="btn" id="qbDiscover"></button>
    <button class="btn" id="qbWorkspace"></button>
    <button class="btn" id="qbAI"></button>
  </div>

  <!-- Footer -->
  <footer>
    <div class="status-left">
      <span>Â© ThinkHelper</span>
      <span id="wordCount" data-count="0"></span>
      <span id="docState"></span>
    </div>
    <div class="status-right">
      <span class="tip" id="tip"></span>
      <span id="uiLangIndicator"></span>
    </div>
  </footer>

<script>
/* =============== GitHub Demo: no backend, all client-side only =============== */

/* ================= i18n ì‚¬ì „ ================= */
const I18N = {
  ko:{
    discover:"ë””ìŠ¤ì»¤ë²„", workspace:"ì‘ì—…ì‹¤", search_btn:"ê²€ìƒ‰",
    search_ph:"ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”...", my_files:"ë‚´ íŒŒì¼", templates:"í…œí”Œë¦¿",
    library:"ë¼ì´ë¸ŒëŸ¬ë¦¬", search_hist:"ê²€ìƒ‰ ê¸°ë¡", new_doc:"ï¼‹ ìƒˆ ë¬¸ì„œ",
    no_docs:"ë¬¸ì„œ ì—†ìŒ", discover_title:"ì˜¤ëŠ˜ì˜ ì¸ì‚¬ì´íŠ¸ (GitHub Demo)",
    ai_assistant:"AI ë„ìš°ë¯¸ (ë°ëª¨ ëª¨ë“œ)", ai_input_ph:"ì„œë²„ ì—†ëŠ” ë°ëª¨ë¼ ë‹µë³€ì€ ê³ ì • ë©”ì‹œì§€ë¡œ ë‚˜ì™€ìš”.",
    send:"ì „ì†¡", tip:"ğŸ’¡ Tab/Enter=ìë™ì™„ì„± Â· Esc=ë‹«ê¸° Â· â†‘/â†“=ì´ë™",
    words:"ë‹¨ì–´ ìˆ˜", saved:"ë¬¸ì„œ ìƒíƒœ: ì €ì¥ë¨",
    settings:"í™˜ê²½ì„¤ì •", lang_mode:"ì–¸ì–´ ëª¨ë“œ", opt_auto:"ìë™ ê°ì§€", opt_fixed:"ìˆ˜ë™ ì„ íƒ",
    manual_lang:"ìˆ˜ë™ ì–¸ì–´ (ì¼ë³¸ì–´ â†’ ì˜ì–´ â†’ í•œêµ­ì–´)",
    suggest:"ì¶”ì²œì–´(ìë™ì™„ì„±)", personal:"ë§ì¶¤í˜• ì¶”ì²œ", eye:"ì•„ì´ì»¨íƒ ëª¨ë“œ", save:"ì €ì¥",
    ai_hi:"ì•ˆë…•! GitHub Pages ë°ëª¨ë¼ AI ì„œë²„ ì—°ë™ì€ êº¼ì ¸ ìˆê³ , ë¬¸ì„œ í¸ì§‘/ìë™ì™„ì„±/PII ë§ˆìŠ¤í‚¹ë§Œ ë™ì‘í•´.",
    quick_discover:"ğŸ“° ë””ìŠ¤ì»¤ë²„", quick_ws:"ğŸ“ ì‘ì—…ì‹¤", quick_ai:"ğŸ¤– AI ë„ìš°ë¯¸",
    lang_indicator:"UI ì–¸ì–´",
    google_card_title:"GitHub Demo: ìƒ˜í”Œ ë‰´ìŠ¤",
    google_card_body:"ì‹¤ì œ ë‰´ìŠ¤ API ëŒ€ì‹ , ë°ëª¨ìš© ìƒ˜í”Œ ë‰´ìŠ¤ë¥¼ ë³´ì—¬ì¤ë‹ˆë‹¤.",
    google_news_btn:"Google ë‰´ìŠ¤ ì—´ê¸°",
    doc_rename:"ì´ë¦„ ë°”ê¾¸ê¸°",
    doc_delete:"ì‚­ì œ",
    rename_doc_prompt:"ìƒˆ ë¬¸ì„œ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”.",
    delete_doc_confirm:"ì´ ë¬¸ì„œë¥¼ ì‚­ì œí• ê¹Œìš”?"
  },
  en:{
    discover:"Discover", workspace:"Workspace", search_btn:"Search",
    search_ph:"Type to search...", my_files:"My files", templates:"Templates",
    library:"Library", search_hist:"Search history", new_doc:"ï¼‹ New Doc",
    no_docs:"No documents", discover_title:"Todayâ€™s insights (GitHub Demo)",
    ai_assistant:"AI Assistant (Demo mode)", ai_input_ph:"Backend is disabled on GitHub Pages; replies are static.",
    send:"Send", tip:"ğŸ’¡ Tab/Enter=complete Â· Esc=close Â· â†‘/â†“=move",
    words:"Words", saved:"Document state: saved",
    settings:"Settings", lang_mode:"Language mode", opt_auto:"Auto detect", opt_fixed:"Manual",
    manual_lang:"Manual language (Japanese â†’ English â†’ Korean)",
    suggest:"Autocomplete", personal:"Personalized suggestions", eye:"Eye-contact mode", save:"Save",
    ai_hi:"Hi! This is a GitHub Pages demo â€“ AI backend is disabled. Editor/autocomplete/PII masking still work.",
    quick_discover:"ğŸ“° Discover", quick_ws:"ğŸ“ Workspace", quick_ai:"ğŸ¤– AI Assistant",
    lang_indicator:"UI language",
    google_card_title:"GitHub Demo: Sample news",
    google_card_body:"Real news APIs are disabled; showing local sample articles instead.",
    google_news_btn:"Open Google News",
    doc_rename:"Rename",
    doc_delete:"Delete",
    rename_doc_prompt:"Enter a new title for this document.",
    delete_doc_confirm:"Delete this document?"
  },
  ja:{
    discover:"ãƒ‡ã‚£ã‚¹ã‚«ãƒãƒ¼", workspace:"ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹", search_btn:"æ¤œç´¢",
    search_ph:"æ¤œç´¢èªã‚’å…¥åŠ›...", my_files:"ãƒã‚¤ãƒ•ã‚¡ã‚¤ãƒ«", templates:"ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ",
    library:"ãƒ©ã‚¤ãƒ–ãƒ©ãƒª", search_hist:"æ¤œç´¢å±¥æ­´", new_doc:"ï¼‹ æ–°è¦ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ",
    no_docs:"ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãªã—", discover_title:"ä»Šæ—¥ã®ã‚¤ãƒ³ã‚µã‚¤ãƒˆï¼ˆGitHub ãƒ‡ãƒ¢ï¼‰",
    ai_assistant:"AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆï¼ˆãƒ‡ãƒ¢ï¼‰", ai_input_ph:"GitHub Pages ã§ã¯ã‚µãƒ¼ãƒãƒ¼ãŒãªã„ãŸã‚ã€å›ºå®šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã¿è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚",
    send:"é€ä¿¡", tip:"ğŸ’¡ Tab/Enter=è£œå®Œ Â· Esc=é–‰ã˜ã‚‹ Â· â†‘/â†“=ç§»å‹•",
    words:"Words", saved:"æ–‡æ›¸çŠ¶æ…‹: ä¿å­˜æ¸ˆã¿",
    settings:"è¨­å®š", lang_mode:"è¨€èªãƒ¢ãƒ¼ãƒ‰", opt_auto:"è‡ªå‹•æ¤œå‡º", opt_fixed:"æ‰‹å‹•",
    manual_lang:"æ‰‹å‹•è¨€èªï¼ˆæ—¥æœ¬èª â†’ è‹±èª â†’ éŸ“å›½èªï¼‰",
    suggest:"ã‚ªãƒ¼ãƒˆã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆ", personal:"ãƒ‘ãƒ¼ã‚½ãƒŠãƒ©ã‚¤ã‚ºå€™è£œ", eye:"ã‚¢ã‚¤ã‚³ãƒ³ã‚¿ã‚¯ãƒˆãƒ¢ãƒ¼ãƒ‰", save:"ä¿å­˜",
    ai_hi:"ã“ã‚“ã«ã¡ã¯ï¼ã“ã“ã¯ GitHub Pages ãƒ‡ãƒ¢ã®ãŸã‚ã€AI ã‚µãƒ¼ãƒãƒ¼é€£æºã¯ç„¡åŠ¹ã§ã™ã€‚ã‚¨ãƒ‡ã‚£ã‚¿ã¨è£œå®Œæ©Ÿèƒ½ã ã‘å‹•ãã¾ã™ã€‚",
    quick_discover:"ğŸ“° ãƒ‡ã‚£ã‚¹ì»¤ãƒãƒ¼", quick_ws:"ğŸ“ ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹", quick_ai:"ğŸ¤– AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ",
    lang_indicator:"UI è¨€èª",
    google_card_title:"GitHub ãƒ‡ãƒ¢: ã‚µãƒ³ãƒ—ãƒ«ãƒ‹ãƒ¥ãƒ¼ã‚¹",
    google_card_body:"å®Ÿéš›ã®ãƒ‹ãƒ¥ãƒ¼ã‚¹ API ã®ä»£ã‚ã‚Šã«ã€ãƒ­ãƒ¼ã‚«ãƒ«ã®ã‚µãƒ³ãƒ—ãƒ«ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚’è¡¨ç¤ºã—ã¦ã„ã¾ã™ã€‚",
    google_news_btn:"Google ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚’é–‹ã",
    doc_rename:"åå‰ã‚’å¤‰æ›´",
    doc_delete:"å‰Šé™¤",
    rename_doc_prompt:"æ–°ã—ã„ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚",
    delete_doc_confirm:"ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ"
  }
};

// ë¬¸ì„œ/í…œí”Œë¦¿ ì œëª© i18n (id ê¸°ì¤€)
const DOC_TITLES = {
  report_ko: {
    ko: "ë³´ê³ ì„œ í¬ë§· (í•œêµ­ì–´)",
    en: "Report template (Korean)",
    ja: "ãƒ¬ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆéŸ“å›½èªï¼‰"
  },
  self_intro_ko: {
    ko: "ìê¸°ì†Œê°œì„œ (í•œêµ­ì–´)",
    en: "Self-introduction (Korean)",
    ja: "è‡ªå·±ç´¹ä»‹æ–‡ï¼ˆéŸ“å›½èªï¼‰"
  },
  email_en: {
    ko: "Formal Email (ì˜ì–´)",
    en: "Formal Email (English)",
    ja: "ãƒ•ã‚©ãƒ¼ãƒãƒ«ãƒ¡ãƒ¼ãƒ«ï¼ˆè‹±èªï¼‰"
  },
  resume: {
    ko: "ì´ë ¥ì„œ ê¸°ë³¸ êµ¬ì„±",
    en: "Resume structure",
    ja: "å±¥æ­´æ›¸ã®åŸºæœ¬æ§‹æˆ"
  },
  portfolio: {
    ko: "í¬íŠ¸í´ë¦¬ì˜¤ ê°€ì´ë“œ",
    en: "Portfolio guide",
    ja: "ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªã‚¬ã‚¤ãƒ‰"
  },
  cover_letter: {
    ko: "Cover Letter (ì˜ì–´)",
    en: "Cover Letter (English)",
    ja: "ã‚«ãƒãƒ¼ãƒ¬ã‚¿ãƒ¼ï¼ˆè‹±èªï¼‰"
  }
};

/* ================= ìœ í‹¸/ìƒíƒœ ================= */
const $ = id => document.getElementById(id);

function escapeHtml(s){
  return (s==null?"":String(s))
    .replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));
}
function plain(html){
  return (html || "")
    .replace(/&nbsp;/gi, " ")
    .replace(/<[^>]+>/g, " ")
    .replace(/\s+/g, " ")
    .trim();
}

function save(k,v){localStorage.setItem(k,JSON.stringify(v))}
function load(k,def){try{return JSON.parse(localStorage.getItem(k)||"null")??def}catch{ return def }}

/* ================= ì„¤ì • ================= */
const SETTINGS_KEY="th.settings";
let SETTINGS = Object.assign(
  { uiLangMode:"auto", uiLangPref:"ja", langMode:"auto", langPref:"ja",
    suggestOn:true, personalOn:true, eyeMode:false },
  load(SETTINGS_KEY,{})
);
if(!SETTINGS.uiLangMode){ SETTINGS.uiLangMode = SETTINGS.langMode; }
if(!SETTINGS.uiLangPref){ SETTINGS.uiLangPref = SETTINGS.langPref; }

let AUTO_LANG = "ko";

/* GitHubìš©: IP API ì•ˆ ì“°ê³  navigator.languageë§Œ ì‚¬ìš© */
async function detectLangFromIP(){
  const nav = (navigator.language||"en").slice(0,2).toLowerCase();
  if(nav.startsWith("ja")) return "ja";
  if(nav.startsWith("ko")) return "ko";
  return "en";
}
function getUILang(){
  return (SETTINGS.uiLangMode==="fixed") ? SETTINGS.uiLangPref : AUTO_LANG;
}
function t(key){
  const L = I18N[getUILang()] || I18N.en;
  return L[key] || key;
}

/* Untitled íƒ€ì´í‹€ ì–¸ì–´ë³„ ì²˜ë¦¬ */
function localizedUntitledTitle(){
  const lang = getUILang();
  return lang==="en" ? "Untitled" : (lang==="ja" ? "ç„¡é¡Œ" : "ë¬´ì œ");
}

function getTitleByLangKey(langKey){
  const map = DOC_TITLES[langKey];
  if(!map) return "";
  const lang = getUILang();
  return map[lang] || map.en || map.ko || map.ja || "";
}

function displayTitleForDoc(rawTitle, doc){
  const lang = getUILang();

  if (doc && doc.langKey && DOC_TITLES[doc.langKey]) {
    const localized = getTitleByLangKey(doc.langKey);
    if(localized) return localized;
  }

  const name = (rawTitle || "").trim();
  if (!name || /^(ë¬´ì œ|Untitled|ç„¡é¡Œ)$/i.test(name)) {
    return localizedUntitledTitle();
  }
  return name;
}

/* ================= UI í…ìŠ¤íŠ¸ ì ìš© ================= */
function applyI18N(){
  const lang = getUILang();
  document.documentElement.lang = lang;

  $("tabDiscover").textContent = t("discover");
  $("tabWorkspace").textContent = t("workspace");
  $("leftSearchBtn").textContent = t("search_btn");
  $("leftSearchInput").placeholder = t("search_ph");
  $("tFiles").textContent = t("my_files");
  $("tTmpl").textContent  = t("templates");
  $("tLib").textContent   = t("library");
  $("tSearch").textContent= t("search_hist");
  $("btnNewDocLeft").textContent = t("new_doc");
  $("i_myfiles").textContent = t("my_files");
  $("i_templates").textContent = t("templates");
  $("i_library").textContent = t("library");
  $("i_search_history").textContent = t("search_hist");
  $("btnClearSearch").textContent = "ğŸ—‘ï¸ " + t("search_hist");
  $("i_discover_title").textContent = t("discover_title");

  $("i_ai_assistant").textContent = t("ai_assistant");
  $("aiInput").placeholder = t("ai_input_ph");
  $("i_send_btn").textContent = t("send");

  $("wordCount").textContent = `${t("words")}: 0`;
  $("docState").textContent = t("saved");
  $("tip").textContent = t("tip");
  $("uiLangIndicator").textContent =
    `${t("lang_indicator")}: ${lang}${SETTINGS.uiLangMode==="fixed"?"(fixed)":"(auto)"}`;

  $("qbDiscover").textContent = t("quick_discover");
  $("qbWorkspace").textContent = t("quick_ws");
  $("qbAI").textContent = t("quick_ai");

  $("i_settings_title").textContent = t("settings");
  $("i_lang_mode_label").textContent = t("lang_mode");
  $("i_opt_auto").textContent = t("opt_auto");
  $("i_opt_fixed").textContent = t("opt_fixed");
  $("i_manual_lang_label").textContent = t("manual_lang");
  $("i_autocomplete_label").textContent = t("suggest");
  $("i_personal_label").textContent = t("personal");
  $("i_eyemode_label").textContent = t("eye");
  $("btnSettingsSave").textContent = t("save");

  $("i_google_card_title").textContent = t("google_card_title");
  $("i_google_card_body").textContent  = t("google_card_body");
  $("btnGoogleNews").textContent       = t("google_news_btn");

  const box = $("aiBox");
  box.innerHTML = `<div class="bubble ai">${escapeHtml(t("ai_hi"))}</div>`;

  if(!$("docTitleBar").textContent)
    $("docTitleBar").textContent = displayTitleForDoc("");

  renderDiscover(); // ìƒ˜í”Œ ë‰´ìŠ¤ë¡œ ë Œë”
}

/* ================= ë ˆì´ì•„ì›ƒ ì „í™˜ ================= */
const discover = $("discover"), workspace = $("workspace");
function isMobile(){ return matchMedia("(max-width: 480px)").matches; }

function setMode(m){
  const disc = (m==="discover");
  discover.style.display = disc ? "block" : "none";
  workspace.style.display = disc ? "none" : (isMobile() ? "block" : "grid");

  if(isMobile()){
    $("quickbar").style.display = "flex";
    $("qbDiscover").classList.toggle("active", disc);
    $("qbWorkspace").classList.toggle("active", !disc);
    $("qbAI").classList.toggle("active", false);
  }else{
    $("quickbar").style.display = "none";
  }
}
$("tabDiscover").onclick=()=>setMode("discover");
$("tabWorkspace").onclick=()=>setMode("workspace");
$("btnTheme").onclick=()=>{
  const root=document.documentElement;
  root.dataset.theme = root.dataset.theme==="dark"?"light":"dark";
};
$("qbDiscover").onclick=()=>setMode("discover");
$("qbWorkspace").onclick=()=>setMode("workspace");

/* ================= ì¢Œì¸¡ íŒ¨ë„ (íŒŒì¼/ê²€ìƒ‰/í…œí”Œë¦¿/ë¼ì´ë¸ŒëŸ¬ë¦¬) ================= */
const DB = {
  filesKey:"th.files",
  fileKey:id=>"th.file."+id,
  list(){return load(this.filesKey,[])},
  saveList(a){save(this.filesKey,a)},
  get(id){return load(this.fileKey(id),null)},
  set(id,o){save(this.fileKey(id),o)},
  remove(id){localStorage.removeItem(this.fileKey(id))}
};

let curDocId = null;

function newDoc(initialTitle="", meta = {}){
  const now = Date.now();
  const id = "doc_"+now;
  const langKey = meta.langKey || null;
  const title =
    (initialTitle && initialTitle.trim()) ||
    localizedUntitledTitle();

  const full = {
    id, title,
    html:"",
    createdAt:now,
    updatedAt:now,
    langKey
  };
  DB.set(id, full);

  const list = DB.list().filter(x=>x.id!==id);
  const metaRow = {
    id,
    title,
    createdAt:now,
    updatedAt:now,
    langKey
  };
  DB.saveList([metaRow, ...list]);

  curDocId = id;
  renderFiles();
  updateTitleBar();
  return id;
}

function renderFiles(){
  const box = $("fileList");
  const list = DB.list().sort((a,b)=>(b.updatedAt||0)-(a.updatedAt||0));
  const no = `<div class="doc"><div class="ttl">${t("no_docs")}</div></div>`;

  box.innerHTML = list.length ? list.map(it=>`
    <div class="doc" data-id="${it.id}" title="${escapeHtml(t("doc_rename"))}">
      <div class="doc-main">
        <div class="ttl">${escapeHtml(displayTitleForDoc(it.title, it))}</div>
        <div class="date">${
          new Date(it.updatedAt||it.createdAt||Date.now())
            .toLocaleDateString(
              getUILang()==="ja"?"ja-JP":
              getUILang()==="en"?"en-US":"ko-KR"
            )
        }</div>
      </div>
      <div class="doc-actions">
        <button class="icon-mini doc-delete" title="${escapeHtml(t("doc_delete"))}">ğŸ—‘ï¸</button>
      </div>
    </div>
  `).join("") : no;

  box.querySelectorAll(".doc").forEach(row=>{
    const id = row.dataset.id;
    if(!id) return;

    row.addEventListener("click", ()=>openDoc(id), { passive:true });

    row.addEventListener("dblclick", e=>{
      e.stopPropagation();
      renameDoc(id);
    });

    const ttl = row.querySelector(".ttl");
    if(ttl){
      ttl.addEventListener("dblclick", e=>{
        e.stopPropagation();
        renameDoc(id);
      });
    }

    const btnDelete = row.querySelector(".doc-delete");
    if(btnDelete){
      btnDelete.addEventListener("click", e=>{
        e.stopPropagation();
        deleteDoc(id);
      });
    }
  });
}

function openDoc(id){
  const d=DB.get(id); if(!d||!editor) return;
  curDocId=id;
  editor.setData(d.html||"");
  updateWordCount();
  updateTitleBar();
}

function renameDoc(id){
  const d = DB.get(id);
  if(!d) return;

  const currentTitle = d.title || "";
  const newTitle = prompt(t("rename_doc_prompt"), currentTitle);
  if(newTitle == null) return;
  const trimmed = newTitle.trim();
  if(!trimmed) return;

  d.title = trimmed;
  DB.set(id, d);

  DB.saveList(
    DB.list().map(x =>
      x.id === id ? { ...x, title: d.title, langKey: d.langKey } : x
    )
  );

  if(curDocId === id){
    updateTitleBar();
  }
  renderFiles();
}

function deleteDoc(id){
  const d = DB.get(id);
  const name = displayTitleForDoc(d?.title || "", d);

  const ok = confirm(t("delete_doc_confirm") + "\n\n" + name);
  if(!ok) return;

  DB.remove(id);

  DB.saveList(
    DB.list().filter(x => x.id !== id)
  );

  if(curDocId === id){
    curDocId = null;
    if(editor){
      editor.setData("");
      updateWordCount();
    }
    $("docTitleBar").textContent = localizedUntitledTitle();
  }

  renderFiles();
}

$("btnNewDocLeft").onclick=()=>{
  const id = newDoc();
  if(editor){
    editor.setData("");
    updateWordCount();
    saveDoc();
  }
};

/* ---- íƒ­ ì „í™˜ ---- */
function activateTab(tabId){
  ["tFiles","tTmpl","tLib","tSearch"].forEach(id=>{
    $(id).dataset.active = (id===tabId)?"1":"0";
  });
  ["pFiles","pTmpl","pLib","pSearch"].forEach(id=>{
    $(id).dataset.active =
      ( (tabId==="tFiles" && id==="pFiles") ||
        (tabId==="tTmpl"  && id==="pTmpl") ||
        (tabId==="tLib"   && id==="pLib") ||
        (tabId==="tSearch"&& id==="pSearch")) ? "1" : "0";
  });
}
$("tFiles").onclick = ()=>activateTab("tFiles");
$("tTmpl").onclick  = ()=>activateTab("tTmpl");
$("tLib").onclick   = ()=>activateTab("tLib");
$("tSearch").onclick= ()=>activateTab("tSearch");

/* ---- ê²€ìƒ‰ ê¸°ë¡ ---- */
const SEARCH_KEY="th.search.history";
const getSearchHistory=()=>load(SEARCH_KEY,[]);
const setSearchHistory=v=>save(SEARCH_KEY,v);

function resolveSearchTarget(raw){
  const q=(raw||"").trim(); if(!q) return null;
  try{
    let url=q;
    if(!/^https?:\/\//i.test(url)&&/^[\w\-]+(\.[\w\-]+)+/.test(url)) url="https://"+url;
    const u=new URL(url); if(u.hostname) return u.toString();
  }catch(_){}
  const lang=getUILang();
  const hl=lang==="ja"?"ja":lang==="en"?"en":"ko";
  const gl=lang==="ja"?"JP":lang==="en"?"US":"KR";
  const ceid=`${gl}:${hl}`;
  return `https://news.google.com/search?q=${encodeURIComponent(q)}&hl=${hl}&gl=${gl}&ceid=${ceid}`;
}
function renderSearchHistory(){
  const box=$("searchList"); const list=getSearchHistory();
  if(!list.length){
    box.innerHTML=`<div class="doc"><div class="ttl">${t("search_hist")}: 0</div></div>`;
    return;
  }
  box.innerHTML = list.map(it=>`
    <div class="srow" data-q="${escapeHtml(it.q)}">
      <div>
        <div class="ttl">${escapeHtml(it.q)}</div>
        <div class="meta">${
          new Date(it.ts||Date.now())
            .toLocaleString(
              getUILang()==="ja"?"ja-JP":
              getUILang()==="en"?"en-US":"ko-KR"
            )
        }</div>
      </div>
      <button class="del" aria-label="delete">ğŸ—‘ï¸</button>
    </div>
  `).join("");

  box.querySelectorAll(".srow").forEach(row=>{
    const q=row.dataset.q;
    row.addEventListener("click",(e)=>{
      if(e.target.closest(".del")) return;
      const url=resolveSearchTarget(q);
      if(url) window.open(url,"_blank","noopener,noreferrer");
    },{passive:true});
    row.querySelector(".del").addEventListener("click",(e)=>{
      e.stopPropagation();
      setSearchHistory(getSearchHistory().filter(it=>it.q!==q));
      renderSearchHistory();
    });
  });
}
$("leftSearchBtn").addEventListener("click", ()=>{
  const q=$("leftSearchInput").value.trim(); if(!q) return;
  const now=Date.now();
  const list=[{q,ts:now},...getSearchHistory().filter(it=>it.q!==q)].slice(0,100);
  setSearchHistory(list); renderSearchHistory();
  const url=resolveSearchTarget(q);
  if(url) window.open(url,"_blank","noopener,noreferrer");
  $("leftSearchInput").value="";
});
$("leftSearchInput").addEventListener("keydown",e=>{
  if(e.key==="Enter"){
    e.preventDefault(); $("leftSearchBtn").click();
  }
});

/* ---- í…œí”Œë¦¿ & ë¼ì´ë¸ŒëŸ¬ë¦¬ ---- */
const TEMPLATE_LIST = [
  {
    id:"report_ko",
    title:"ë³´ê³ ì„œ í¬ë§· (í•œêµ­ì–´)",
    body:"<h2>ë³´ê³ ì„œ ì œëª©</h2><h3>1. ê°œìš”</h3><p></p><h3>2. ë¶„ì„</h3><p></p><h3>3. ê²°ë¡  ë° ì œì–¸</h3><p></p>"
  },
  {
    id:"self_intro_ko",
    title:"ìê¸°ì†Œê°œì„œ (í•œêµ­ì–´)",
    body:"<h2>ìê¸°ì†Œê°œì„œ</h2><h3>1. ì„±ì¥ ê³¼ì •</h3><p></p><h3>2. ì„±ê²©ì˜ ì¥ë‹¨ì </h3><p></p><h3>3. ì§€ì› ë™ê¸° ë° í¬ë¶€</h3><p></p>"
  },
  {
    id:"email_en",
    title:"Formal Email (English)",
    body:"<p>Dear [Name],</p><p></p><p>Best regards,<br/>[Your Name]</p>"
  }
];
const LIBRARY_LIST = [
  {
    id:"resume",
    title:"ì´ë ¥ì„œ ê¸°ë³¸ êµ¬ì„±",
    body:"<h2>ì´ë ¥ì„œ</h2><ul><li>ê°œì¸ ì •ë³´</li><li>í•™ë ¥</li><li>ê²½ë ¥</li><li>í”„ë¡œì íŠ¸</li><li>ê¸°ìˆ  ìŠ¤íƒ</li></ul>"
  },
  {
    id:"portfolio",
    title:"í¬íŠ¸í´ë¦¬ì˜¤ ê°€ì´ë“œ",
    body:"<h2>í¬íŠ¸í´ë¦¬ì˜¤</h2><p>1. ë‚˜ì˜ í•œ ì¤„ ì†Œê°œ<br/>2. ëŒ€í‘œ í”„ë¡œì íŠ¸ 3ê°œ<br/>3. ì‚¬ìš© ê¸°ìˆ  ë° ì—­í• <br/>4. ì„±ê³¼ì™€ íšŒê³ </p>"
  },
  {
    id:"cover_letter",
    title:"Cover Letter (EN)",
    body:"<h2>Cover Letter</h2><p>To whom it may concern,</p><p></p><p>Sincerely,<br/>[Your Name]</p>"
  }
];

function renderTemplates(){
  const box=$("tmplList");
  box.innerHTML = TEMPLATE_LIST.map(t=>{
    const localized = getTitleByLangKey(t.id) || t.title;
    return `
      <div class="doc" data-id="${t.id}">
        <div class="doc-main">
          <div class="ttl">${escapeHtml(localized)}</div>
        </div>
      </div>`;
  }).join("");
  box.querySelectorAll(".doc").forEach(d=>{
    const id=d.dataset.id;
    const item=TEMPLATE_LIST.find(x=>x.id===id);
    if(!item) return;
    d.onclick=()=>{
      setMode("workspace");
      const title = getTitleByLangKey(item.id) || item.title;
      const docId=newDoc(title,{langKey:item.id});
      if(editor){
        editor.setData(item.body);
        updateWordCount();
        saveDoc();
        buildUserDictFromDoc();
      }
    };
  });
}
function renderLibrary(){
  const box=$("libList");
  box.innerHTML = LIBRARY_LIST.map(t=>{
    const localized = getTitleByLangKey(t.id) || t.title;
    return `
      <div class="doc" data-id="${t.id}">
        <div class="doc-main">
          <div class="ttl">${escapeHtml(localized)}</div>
        </div>
      </div>`;
  }).join("");
  box.querySelectorAll(".doc").forEach(d=>{
    const id=d.dataset.id;
    const item=LIBRARY_LIST.find(x=>x.id===id);
    if(!item) return;
    d.onclick=()=>{
      setMode("workspace");
      const title = getTitleByLangKey(item.id) || item.title;
      const docId=newDoc(title,{langKey:item.id});
      if(editor){
        editor.setData(item.body);
        updateWordCount();
        saveDoc();
        buildUserDictFromDoc();
      }
    };
  });
}

/* ================= CKEditor + ë‹¨ì–´ìˆ˜ ================= */
let editor=null, isApplyingPill=false, pillMaskTimer=null;
ClassicEditor.create($("editor"),{ placeholder:"" })
.then(ed=>{
  editor=ed;
  editor.model.document.on('change:data', ()=>{
    if(!isApplyingPill) schedulePillMask();
    saveDoc(); updateWordCount(); updateTitleBar();
    buildUserDictFromDoc();
  });
  setupAutocomplete();
}).catch(console.error);

function saveDoc(){
  if(!editor||!curDocId) return;
  const d=DB.get(curDocId); if(!d) return;
  const html=editor.getData(); if(d.html===html) return;
  d.html=html; d.updatedAt=Date.now();
  const txt=plain(html);
  const isUntitled = !d.title || /^(ë¬´ì œ|Untitled|ç„¡é¡Œ)$/i.test((d.title||"").trim());
  if(isUntitled){
    d.title = (txt.split(" ").slice(0,8).join(" ") || localizedUntitledTitle());
  }
  DB.set(curDocId,d);
  DB.saveList(
    DB.list().map(x =>
      x.id === curDocId
        ? { ...x, createdAt: d.createdAt, updatedAt: d.updatedAt, title: d.title, langKey:d.langKey }
        : x
    )
  );

  $("docState").textContent=t("saved");
}
function updateWordCount(){
  const count=(plain(editor?editor.getData():"")
    .split(/\s+/).filter(Boolean).length||0);
  $("wordCount").textContent=`${t("words")}: ${count}`;
}
function updateTitleBar(){
  const d = curDocId ? DB.get(curDocId) : null;
  $("docTitleBar").textContent = displayTitleForDoc(d?.title||"", d||undefined);
}

/* ================= PII Pill ================= */
const RE_EMAIL_G=/[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}/g;
const RE_PHONE_G=/01[016789]-?\d{3,4}-?\d{4}/g;
const RE_IDNUM_G=/\d{6}-\d{7}/g;
function pillLabel(type){
  const ko={email:"ì´ë©”ì¼",phone:"ì—°ë½ì²˜",id:"ì£¼ë¯¼ë²ˆí˜¸",secret:"ë¯¼ê° ì •ë³´"};
  return ko[type]||ko.secret;
}
function applyPillMasking(html){
  if(!html) return "";
  try{
    const parser=new DOMParser();
    const doc=parser.parseFromString(html,"text/html");
    doc.querySelectorAll("span[data-pill-type]").forEach(s=>{
      const v=s.getAttribute("data-pill-value")||s.textContent||"";
      s.replaceWith(doc.createTextNode(v));
    });
    let out=doc.body.innerHTML;
    out=out.replace(RE_EMAIL_G,m=>
      `<span class="pill" data-pill-type="email" data-pill-value="${m}" data-hidden="1">${pillLabel("email")}</span>`);
    out=out.replace(RE_PHONE_G,m=>
      `<span class="pill" data-pill-type="phone" data-pill-value="${m}" data-hidden="1">${pillLabel("phone")}</span>`);
    out=out.replace(RE_IDNUM_G,m=>
      `<span class="pill" data-pill-type="id" data-pill-value="${m}" data-hidden="1">${pillLabel("id")}</span>`);
    return out;
  }catch{ return html; }
}
function schedulePillMask(){
  if(!editor) return;
  clearTimeout(pillMaskTimer);
  pillMaskTimer=setTimeout(applyPillMaskToEditor,300);
}
function applyPillMaskToEditor(){
  if(!editor) return;
  const html=editor.getData();
  const masked=applyPillMasking(html);
  if(masked!==html){
    isApplyingPill=true;
    editor.setData(masked);
    isApplyingPill=false;
  }
}
document.addEventListener("click",(e)=>{
  const pill=e.target.closest?.(".pill"); if(!pill) return;
  const value=pill.getAttribute("data-pill-value")||pill.textContent||"";
  const hidden=pill.getAttribute("data-hidden")!=="0";
  if(hidden){ pill.setAttribute("data-hidden","0"); pill.textContent=value; }
  else{ pill.setAttribute("data-hidden","1");
        pill.textContent=pillLabel(pill.getAttribute("data-pill-type")||"secret"); }
},{capture:true});

/* ================= ìë™ì™„ì„± ================= */
let suggestionBox=null, selectedIndex=0, currentCandidates=[];
let suppressUntil=0, lastKeyContext="";

const USER_DICT_KEY = "th.user.dict";
const rawDict = load(USER_DICT_KEY, []) || [];
const cleaned = rawDict.map(w => (w || "").replace(/&nbsp;/gi, " "));
const userDict = new Set(cleaned);
save(USER_DICT_KEY, [...userDict]);

const DICT_KO_BASE=[
  "ë¶„ì„","ì—°êµ¬","ê²°ê³¼","ë°©ë²•","ê³¼ì •","ê²°ë¡ ","ì°¸ê³ ","ì¶œì²˜","ë°ì´í„°","ìš”ì•½",
  "ìŸì ","ë²•ë¦¬","íŒë¡€","ëŒ€ë²•ì›","ì•Œê³ ë¦¬ì¦˜","ì˜¤í”„ë¼ì¸","ìºì‹œ","ë¹„ë™ê¸°",
  "ì„œë¡ ","ë³¸ë¡ ","ë§ˆë¬´ë¦¬","ê°œìš”","ë¬¸ì œì ","í•´ê²°ì±…","ì „ëµ","ì‹œì¥","ë¹„ì¦ˆë‹ˆìŠ¤",
  "ì˜¨ë””ë°”ì´ìŠ¤","ëª¨ë¸","íŒŒë¼ë¯¸í„°","ì‹¤í—˜","ê²€ì¦","ë¦¬ìŠ¤í¬","ê¸°íšŒ","ìš”ì•½ì •ë¦¬"
];
const DICT_EN_BASE=[
  "analysis","baseline","benchmark","context","dataset","embedding",
  "evaluation","feature","insight","latency","model","optimize","pipeline",
  "summary","template","outline","introduction","conclusion","limitation",
  "opportunity","risk","motivation","experiments","results","discussion",
  "on-device","deployment","architecture","parameters","ablation","appendix"
];
const DICT_JA_BASE=[
  "ãŒã„ã‚ˆã†","ã‘ã‚“ã•ã","ã›ã¤ã‚ã„","ã•ã„ã”","ã‚ˆã†ã‘ã‚“","ã»ãã‚“",
  "ã‚Œã‚“ã‘ã„","ã‹ã„ã›ã¤","ã¾ã¨ã‚","ã˜ã‚…ã‚ˆã†","ã‹ã„ã¯ã¤","ã‘ã„ã‹ã",
  "ã‚‚ã‚“ã ã„","ã‹ã„ã‘ã¤","ã‚¹ãƒˆãƒ¼ãƒªãƒ¼","ã‚ªãƒ³ãƒ‡ãƒã‚¤ã‚¹","ãƒ¢ãƒ‡ãƒ«"
];

function currentTypingLang(){
  if(SETTINGS.langMode==="fixed") return SETTINGS.langPref || "ja";
  if(!editor) return "ko";

  const txt = plain(editor.getData());
  if(!txt) return "ko";

  const ch = txt.slice(-1);
  if(/[\u3040-\u30FF\u4E00-\u9FFF]/.test(ch)) return "ja";
  if(/[A-Za-z]/.test(ch) && !/[ê°€-í£]/.test(ch)) return "en";
  if(/[ê°€-í£]/.test(ch)) return "ko";
  return "other";
}

function buildUserDictFromDoc(){
  if(!editor) return;
  const text = plain(editor.getData());
  if(!text) return;

  text.split(/\s+/).forEach(w=>{
    const token = w.trim();
    if(token.length>=2 && token.length<=64){
      userDict.add(token);
    }
  });

  text.split(/[\.!?ã€‚\n]/).forEach(s=>{
    const sent = s.trim();
    if(sent.length>=6 && sent.length<=80){
      userDict.add(sent);
    }
  });

  saveUserDict();
}
function saveUserDict(){
  save(USER_DICT_KEY, [...userDict]);
}

function filterDict(prefix, lang){
  if(!SETTINGS.suggestOn) return [];
  const p = prefix.toLowerCase();

  let base = [];
  if(lang==="ja") base = DICT_JA_BASE;
  else if(lang==="en") base = DICT_EN_BASE;
  else if(lang==="ko") base = DICT_KO_BASE;

  const baseMatches = base.filter(w=>w.toLowerCase().startsWith(p));

  const userMatches = [...userDict].filter(w=>{
    const lw = w.toLowerCase();
    return lw.startsWith(p) &&
           !baseMatches.some(b=>b.toLowerCase()===lw);
  });

  return [...baseMatches, ...userMatches].slice(0,8);
}

function getPrefix(){
  if(!editor) return "";
  const txt = plain(editor.getData());
  const m = txt.match(/[\p{L}\p{N}_\-]{1,32}$/u);
  return m ? m[0] : "";
}

function closeSuggestion(){
  if(!suggestionBox) suggestionBox=$("suggestionBox");
  suggestionBox.style.display='none';
  currentCandidates=[]; selectedIndex=0;
}
function renderList(){
  if(!currentCandidates.length){ closeSuggestion(); return; }
  suggestionBox.innerHTML=`<ul>${
    currentCandidates.map((w,i)=>`<li class="${i===selectedIndex?'active':''}"
      data-w="${w.replace(/"/g,'&quot;')}">${escapeHtml(w)}</li>`).join("")
  }</ul>`;
  suggestionBox.querySelectorAll("li").forEach(li=>{
    li.addEventListener("mousedown",e=>{
      e.preventDefault(); applySuggestion(li.dataset.w);
    });
  });
}
function showSuggestion(){
  if(!suggestionBox) suggestionBox = $("suggestionBox");
  suggestionBox.style.display = "block";

  try{
    if(!editor){
      closeSuggestion();
      return;
    }

    const editableEl = editor.ui.view.editable.element;
    const wrap = editableEl.closest(".editor-wrap") || editableEl.parentElement;
    const wrapRect = wrap.getBoundingClientRect();

    const sel = window.getSelection();
    if(sel && sel.rangeCount > 0){
      const range = sel.getRangeAt(0).cloneRange();
      range.collapse(false);

      const rect = range.getBoundingClientRect();

      const offsetY = 4;
      const offsetX = 0;

      suggestionBox.style.top  = (rect.bottom - wrapRect.top + offsetY) + "px";
      suggestionBox.style.left = (rect.left   - wrapRect.left + offsetX) + "px";
    }else{
      suggestionBox.style.top  = "8px";
      suggestionBox.style.left = "8px";
    }
  }catch(e){
    console.error(e);
    suggestionBox.style.top  = "8px";
    suggestionBox.style.left = "8px";
  }

  renderList();
}

function applySuggestion(word){
  if(!word) return;
  const prefix=getPrefix();
  editor.model.change(writer=>{
    const selRange=editor.model.document.selection.getFirstRange();
    const start=selRange.start;
    const del=writer.createRange(start.getShiftedBy(-prefix.length), start);
    writer.remove(del);
    writer.insertText(word, editor.model.document.selection.getFirstPosition());
  });
  suppressUntil = performance.now()+250;
  closeSuggestion();
}
function setupAutocomplete(){
  if(!suggestionBox) suggestionBox=$("suggestionBox");
  const viewDoc = editor.editing.view.document;

  viewDoc.on('keydown',(evt,data)=>{
    if(suggestionBox.style.display!=='block') return;
    const k=data.keyCode;
    if(k===38||k===40||k===9||k===13||k===27){
      evt.stop(); data.preventDefault();
      suppressUntil = performance.now()+320;
      if(k===38){
        selectedIndex = (selectedIndex>0)?
          selectedIndex-1:currentCandidates.length-1; renderList();
      }else if(k===40){
        selectedIndex = (selectedIndex<currentCandidates.length-1)?
          selectedIndex+1:0; renderList();
      }else if(k===9 || k===13){
        applySuggestion(currentCandidates[selectedIndex]||"");
      }else if(k===27){
        closeSuggestion();
      }
    }
  }, { priority:'highest' });

  viewDoc.on('keyup', ()=>{
    const now = performance.now();
    if(now < suppressUntil) return;

    const prefix = getPrefix();
    if(!prefix){ closeSuggestion(); lastKeyContext = ""; return; }
    const lang = currentTypingLang();

    const list = filterDict(prefix, lang);
    const ctx = `${lang}|${prefix}|${list.join(',')}`;
    if(list.length){
      if(ctx !== lastKeyContext){
        currentCandidates = list;
        if(selectedIndex >= list.length) selectedIndex = 0;
        showSuggestion();
        lastKeyContext = ctx;
      }else{
        showSuggestion();
      }
    }else{
      closeSuggestion(); lastKeyContext = "";
    }
  });
}

/* ================= Discover: GitHubìš© ìƒ˜í”Œ ë‰´ìŠ¤ ================= */
function newsLocale(){
  const l = getUILang();
  return l==="ja"?"ja-JP":l==="en"?"en-US":"ko-KR";
}

/* ì‹¤ì œ API ëŒ€ì‹ , ë¡œì»¬ ìƒ˜í”Œ ë°ì´í„° */
const NEWS_SAMPLE = [
  {
    title:"ThinkHelper GitHub Demo ì‹œì‘",
    desc:"GitHub Pagesì—ì„œ ë°”ë¡œ ì‹¤í–‰ë˜ëŠ” ì˜¨ë””ë°”ì´ìŠ¤ ì›Œí¬ìŠ¤í˜ì´ìŠ¤ & ë””ìŠ¤ì»¤ë²„ ì‹¤í—˜ ë²„ì „ì…ë‹ˆë‹¤.",
    source:"ThinkHelper",
    pubDate:"2025-01-01T09:00:00Z",
    link:"https://thinkhelper.store"
  },
  {
    title:"ì˜¤í”„ë¼ì¸/ë¡œì»¬ ì¹œí™”í˜• AI ë¬¸ì„œë„êµ¬",
    desc:"í´ë¼ìš°ë“œ ì˜ì¡´ë„ë¥¼ ë‚®ì¶”ê³ , ê°œì¸í™” í•™ìŠµê³¼ PII ë³´í˜¸ë¥¼ ë™ì‹œì— ì¡ëŠ” ì˜¨ë””ë°”ì´ìŠ¤ íŒ¨í„´ í•™ìŠµ êµ¬ì¡°ë¥¼ ì‹¤í—˜ ì¤‘ì…ë‹ˆë‹¤.",
    source:"ThinkHelper Lab",
    pubDate:"2025-01-02T09:00:00Z",
    link:"https://thinkhelper.store"
  },
  {
    title:"ë‰´ìŠ¤ API ì—†ì´ë„ UX ê²€ì¦í•˜ê¸°",
    desc:"ì‹¤ì œ API ì—†ì´ë„ UX, í”Œë¡œìš°, ìë™ì™„ì„±, PII ë§ˆìŠ¤í‚¹ ë“± í•µì‹¬ ê¸°ëŠ¥ì„ GitHub ë°ëª¨ì—ì„œ ë¨¼ì € ê²€ì¦í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.",
    source:"Product Notes",
    pubDate:"2025-01-03T09:00:00Z",
    link:"https://github.com"
  },
  {
    title:"í…œí”Œë¦¿/ë¼ì´ë¸ŒëŸ¬ë¦¬ ê¸°ë°˜ ê¸€ì“°ê¸° ì—°ìŠµ",
    desc:"ë³´ê³ ì„œ, ìê¸°ì†Œê°œì„œ, í¬íŠ¸í´ë¦¬ì˜¤ ê°€ì´ë“œ ë“± í…œí”Œë¦¿ì„ ë¶ˆëŸ¬ì™€ ë°”ë¡œ í¸ì§‘í•˜ë©° ìê¸° ê¸€ì“°ê¸° íŒ¨í„´ì„ í•™ìŠµì‹œí‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.",
    source:"ThinkHelper Docs",
    pubDate:"2025-01-04T09:00:00Z",
    link:"https://github.com"
  },
  {
    title:"PII Pill ë§ˆìŠ¤í‚¹ìœ¼ë¡œ ê°œì¸ì •ë³´ ë³´í˜¸",
    desc:"ì´ë©”ì¼, ì „í™”ë²ˆí˜¸, ì£¼ë¯¼ë²ˆí˜¸ í˜•ì‹ì„ ê°ì§€í•´ pillë¡œ ë§ˆìŠ¤í‚¹í•˜ê³ , í´ë¦­ ì‹œ í† ê¸€ ê°€ëŠ¥í•œ êµ¬ì¡°ë¥¼ ì œê³µí•©ë‹ˆë‹¤.",
    source:"Security Note",
    pubDate:"2025-01-05T09:00:00Z",
    link:"https://github.com"
  },
  {
    title:"ìë™ì™„ì„± ë”•ì…”ë„ˆë¦¬ì˜ ì‹¤ì‹œê°„ í•™ìŠµ",
    desc:"ì‚¬ìš©ìê°€ ì“°ëŠ” ë‹¨ì–´ì™€ ë¬¸ì¥ì´ ìë™ì™„ì„± ë”•ì…”ë„ˆë¦¬ì— ì¶•ì ë˜ì–´, ì ì  ë” ë‚˜ì—ê²Œ ë§ëŠ” ì œì•ˆì„ ë³´ì—¬ì¤ë‹ˆë‹¤.",
    source:"UX Lab",
    pubDate:"2025-01-06T09:00:00Z",
    link:"https://github.com"
  }
];

async function loadDailyNews(){
  return NEWS_SAMPLE;
}

function renderDiscoverCards(list){
  const grid = $("discoverGrid");
  if(!list.length){
    grid.innerHTML = "<p>ìƒ˜í”Œ ë‰´ìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>";
    return;
  }

  const items = list.map((it,idx)=>({...it,__idx:idx}));
  const mainItems = items.slice(0,4);
  const sideItems = items.slice(4,10);

  let mainHTML = "";
  if(mainItems[0]){
    const first = mainItems[0];
    mainHTML += `
      <article class="news-card hero" data-idx="${first.__idx}">
        <div class="news-body">
          <div class="news-meta">
            ${escapeHtml(first.source || "")}
            ${first.pubDate ? " Â· " + escapeHtml(new Date(first.pubDate).toLocaleDateString(newsLocale())) : ""}
          </div>
          <div class="news-title">${escapeHtml(first.title || "")}</div>
          <div class="news-desc">${escapeHtml(first.desc || "")}</div>
        </div>
        <div class="news-actions">
          <button class="btn btn-view">ğŸ”— ì›ë¬¸ë³´ê¸°</button>
          <button class="btn btn-newdoc">âœï¸ ìƒˆ ê¸€ì“°ê¸°</button>
        </div>
      </article>
    `;
  }

  if(mainItems.length>1){
    mainHTML += mainItems.slice(1).map(item=>`
      <article class="news-card main" data-idx="${item.__idx}">
        <div class="news-body">
          <div class="news-meta">
            ${escapeHtml(item.source || "")}
            ${item.pubDate ? " Â· " + escapeHtml(new Date(item.pubDate).toLocaleDateString(newsLocale())) : ""}
          </div>
          <div class="news-title">${escapeHtml(item.title || "")}</div>
          <div class="news-desc">${escapeHtml(item.desc || "")}</div>
        </div>
        <div class="news-actions">
          <button class="btn btn-view">ğŸ”— ì›ë¬¸ë³´ê¸°</button>
          <button class="btn btn-newdoc">âœï¸ ìƒˆ ê¸€ì“°ê¸°</button>
        </div>
      </article>
    `).join("");
  }

  let sideHTML = "";
  if(sideItems.length){
    sideHTML = sideItems.map(item=>`
      <article class="news-card compact" data-idx="${item.__idx}">
        <div class="news-body">
          <div class="news-meta">
            ${escapeHtml(item.source || "")}
            ${item.pubDate ? " Â· " + escapeHtml(new Date(item.pubDate).toLocaleDateString(newsLocale())) : ""}
          </div>
          <div class="news-title">${escapeHtml(item.title || "")}</div>
          <div class="news-desc">${escapeHtml(item.desc || "")}</div>
        </div>
      </article>
    `).join("");
  }

  grid.innerHTML = `
    <div class="discover-col discover-main">
      ${mainHTML}
    </div>
    <div class="discover-col discover-side">
      ${sideHTML}
    </div>
  `;

  grid.querySelectorAll(".news-card").forEach(card=>{
    const idx = Number(card.dataset.idx);
    const item = list[idx];
    if(!item) return;

    card.addEventListener("click", (e)=>{
      if(e.target.closest(".btn")) return;
      if(item.link) window.open(item.link, "_blank", "noopener");
    });

    const btnView = card.querySelector(".btn-view");
    if(btnView){
      btnView.onclick = (e)=>{
        e.stopPropagation();
        if(item.link) window.open(item.link, "_blank", "noopener");
      };
    }

    const btnNew = card.querySelector(".btn-newdoc");
    if(btnNew){
      btnNew.onclick = (e)=>{
        e.stopPropagation();
        setMode("workspace");
        const docId = newDoc(`ìƒˆ ê¸€: ${item.title}`);
        if(editor){
          editor.setData(
            `<h2>${escapeHtml(item.title)}</h2>` +
            (item.link ? `<p><a href="${escapeHtml(item.link)}" target="_blank" rel="noopener">ì›ë¬¸ ë³´ê¸°</a></p>` : "") +
            (item.desc ? `<p>${escapeHtml(item.desc)}</p>` : "") +
            `<p></p>`
          );
          updateWordCount();
          saveDoc();
        }
      };
    }
  });
}

async function renderDiscover(){
  const now = new Date();
  $("discoverMeta").textContent = now.toLocaleString(newsLocale());
  const list = await loadDailyNews();
  renderDiscoverCards(list);
}

$("btnGoogleNews").onclick = ()=>{
  const lang=getUILang();
  const hl=lang==="ja"?"ja":lang==="en"?"en":"ko";
  const gl=lang==="ja"?"JP":lang==="en"?"US":"KR";
  const ceid=`${gl}:${hl}`;
  const url=`https://news.google.com/topstories?hl=${encodeURIComponent(hl)}&gl=${encodeURIComponent(gl)}&ceid=${encodeURIComponent(ceid)}`;
  window.open(url,"_blank","noopener");
};

/* ================= AI (GitHub ë°ëª¨: ì„œë²„ ì—†ì´ ê³ ì • ë‹µë³€) ================= */
async function callGemini(messages){
  const lang = getUILang();
  if(lang==="ko"){
    return "âš ï¸ GitHub Pages ë°ëª¨ ëª¨ë“œë¼ ì‹¤ì œ Gemini/OpenAI ì„œë²„ì™€ëŠ” ì—°ê²°ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.\n\n- ì˜¤ë¥¸ìª½ AI ì°½ì€ ëŒ€í™” ë¡œê·¸ë§Œ ì €ì¥\n- ì‹¤ì œ ì¶”ë¡ /ìš”ì•½/ë²ˆì—­ì€ ì„œë²„ ë²„ì „ì—ì„œ ë™ì‘í•´ìš”.\n\nì½”ë“œ ë ˆë²¨ì—ì„œ ë°±ì—”ë“œ URLë§Œ ì—°ê²°í•˜ë©´ ë°”ë¡œ ì‹¤ì„œë¹„ìŠ¤ë¡œ ì „í™˜ ê°€ëŠ¥í•©ë‹ˆë‹¤.";
  }else if(lang==="ja"){
    return "âš ï¸ ã“ã“ã¯ GitHub Pages ãƒ‡ãƒ¢ã®ãŸã‚ã€å®Ÿéš›ã® Gemini / OpenAI ã‚µãƒ¼ãƒãƒ¼ã¨ã¯æ¥ç¶šã—ã¦ã„ã¾ã›ã‚“ã€‚\n\nãƒ»å³å´ã® AI ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã¯ãƒ­ã‚°è¡¨ç¤ºã®ã¿\nãƒ»æœ¬ç•ªç’°å¢ƒã§ã¯ã‚µãƒ¼ãƒãƒ¼ URL ã‚’è¨­å®šã™ã‚‹ã ã‘ã§æ¨è«–/è¦ç´„/ç¿»è¨³ãŒæœ‰åŠ¹ã«ãªã‚Šã¾ã™ã€‚";
  }
  return "âš ï¸ This is a GitHub Pages demo. There is no live Gemini/OpenAI backend attached.\n\n- The right AI pane only logs your prompts\n- In production, you would plug in your own /api/gemini endpoint here.";
}
function addBubble(text, me, html=false){
  const div=document.createElement('div');
  div.className="bubble "+(me?"me":"ai");
  if(html){ div.innerHTML = text; } else { div.textContent = text; }
  $("aiBox").appendChild(div);
  $("aiBox").scrollTop=$("aiBox").scrollHeight;
}
let chatHistory=[];
function getSelectedEditorText(){
  try{
    const sel=window.getSelection();
    if(!sel||sel.rangeCount===0) return "";
    const range=sel.getRangeAt(0);
    return range?.toString?.().trim()||"";
  }catch{return "";}
}
function addAI(input){
  const selected = getSelectedEditorText();
  const prompt = selected ? `[${t("ai_assistant")}]\n${selected}\n\n[Request]\n${input}` : input;
  addBubble(prompt,true);
  chatHistory.push({ role:"user", content: prompt });
  (async()=>{
    const reply = await callGemini(chatHistory);
    const html = escapeHtml(reply)
      .replace(/\bhttps:\/\/[^\s)]+/g,m=>`<a href="${m}" target="_blank" rel="noopener noreferrer">${m}</a>`);
    addBubble(html,false,true);
    chatHistory.push({ role:"assistant", content: reply });
  })();
}
$("aiForm").addEventListener("submit",(e)=>{
  e.preventDefault();
  const v=$("aiInput").value.trim(); if(!v) return;
  $("aiInput").value="";
  addAI(v);
});
$("aiInput").addEventListener("keydown",e=>{
  if(e.key==="Enter" && !e.shiftKey){
    e.preventDefault();
    $("aiForm").requestSubmit();
  }
});
$("aiToggle").onclick=()=>{
  const box=$("aiBox");
  if(box.style.display==="none"){
    box.style.display="flex"; $("aiToggle").textContent="âˆ’";
  }else{
    box.style.display="none"; $("aiToggle").textContent="ï¼‹";
  }
};

/* ================= Settings Modal DOM ì¶”ê°€ ================= */
const settingsModalHtml = `
  <div class="modal-card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <b id="i_settings_title"></b>
      <button class="iconbtn" id="btnCloseSettings">âœ•</button>
    </div>

    <div class="row">
      <div class="row-label" id="i_lang_mode_label"></div>
      <div>
        <select id="selLangMode" class="select">
          <option id="i_opt_auto"  value="auto"></option>
          <option id="i_opt_fixed" value="fixed"></option>
        </select>
      </div>
    </div>

    <div class="row">
      <div class="row-label" id="i_manual_lang_label"></div>
      <div>
        <select id="selLangFixed" class="select">
          <option value="ja">æ—¥æœ¬èª</option>
          <option value="en">English</option>
          <option value="ko">í•œêµ­ì–´</option>
        </select>
      </div>
    </div>

    <div class="row">
      <div class="row-label" id="i_autocomplete_label"></div>
      <input id="swSuggest" type="checkbox" class="switch"/>
    </div>

    <div class="row">
      <div class="row-label" id="i_personal_label"></div>
      <input id="swPersonal" type="checkbox" class="switch"/>
    </div>

    <div class="row">
      <div class="row-label" id="i_eyemode_label"></div>
      <input id="swEye" type="checkbox" class="switch"/>
    </div>

    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:10px">
      <button class="btn" id="btnSettingsSave"></button>
    </div>
  </div>
`;
const modalDiv = document.createElement("div");
modalDiv.className = "modal";
modalDiv.id = "settingsModal";
modalDiv.setAttribute("aria-modal","true");
modalDiv.setAttribute("role","dialog");
modalDiv.innerHTML = settingsModalHtml;
document.body.appendChild(modalDiv);

/* ================= Settings ì—´ê¸°/ì €ì¥ ================= */
function openSettings(){
  $("settingsModal").setAttribute("open","");
  $("selLangMode").value = SETTINGS.uiLangMode;
  $("selLangFixed").value = SETTINGS.uiLangPref;
  $("swSuggest").checked = !!SETTINGS.suggestOn;
  $("swPersonal").checked = !!SETTINGS.personalOn;
  $("swEye").checked = !!SETTINGS.eyeMode;
  $("selLangFixed").disabled = (SETTINGS.uiLangMode!=="fixed");
}
function closeSettings(){ $("settingsModal").removeAttribute("open"); }

const btnSettings = $("btnSettings");
if(btnSettings) btnSettings.onclick=openSettings;

const btnCloseSettings = $("btnCloseSettings");
if(btnCloseSettings) btnCloseSettings.onclick=closeSettings;

const selLangModeEl = $("selLangMode");
if(selLangModeEl){
  selLangModeEl.onchange=()=>{
    $("selLangFixed").disabled = (selLangModeEl.value!=="fixed");
  };
}
const btnSettingsSave = $("btnSettingsSave");
if(btnSettingsSave){
  btnSettingsSave.onclick=()=>{
    const selLangMode = $("selLangMode");
    const selLangFixed = $("selLangFixed");
    const swSuggest = $("swSuggest");
    const swPersonal = $("swPersonal");
    const swEye = $("swEye");

    SETTINGS.uiLangMode = selLangMode ? selLangMode.value : SETTINGS.uiLangMode;
    SETTINGS.uiLangPref = selLangFixed ? selLangFixed.value : SETTINGS.uiLangPref;
    SETTINGS.langMode   = SETTINGS.uiLangMode;
    SETTINGS.langPref   = SETTINGS.uiLangPref;
    SETTINGS.suggestOn  = swSuggest ? swSuggest.checked : SETTINGS.suggestOn;
    SETTINGS.personalOn = swPersonal ? swPersonal.checked : SETTINGS.personalOn;
    SETTINGS.eyeMode    = swEye ? swEye.checked : SETTINGS.eyeMode;

    save(SETTINGS_KEY, SETTINGS);
    applyI18N();
    renderFiles();
    renderSearchHistory();
    renderTemplates();
    renderLibrary();
    closeSettings();
  };
}

/* ================= ì´ˆê¸° ë Œë” ================= */
(async function boot(){
  AUTO_LANG = (SETTINGS.uiLangMode==="auto")
    ? await detectLangFromIP()
    : SETTINGS.uiLangPref;
  applyI18N();
  renderFiles();
  renderSearchHistory();
  renderTemplates();
  renderLibrary();
  setMode("discover");
})();
</script>
</body>
</html>
