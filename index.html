<!DOCTYPE html>
<html lang="ko" data-theme="light">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title data-i18n="page.title">ThinkHelper â€” Editor</title>
<link rel="icon" href="data:,"/>

<!-- GTM -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-NXBQK43Z');</script>

<!-- CKEditor -->
<script src="https://cdn.ckeditor.com/ckeditor5/41.3.1/classic/ckeditor.js"></script>
<!-- Export libs -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" defer></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js" defer></script>

<style>
/* --- Base Styles --- */
:root{--bg:#f6f8fb;--fg:#0b1020;--muted:#6a7691;--panel:#fff;--card:#f2f5ff;--border:#d6deee;--hover:#e9effe;--accent:#2563eb}
:root[data-theme="dark"]{--bg:#0b1020;--fg:#f1f5ff;--muted:#a8b4cf;--panel:#0f172a;--card:#101a30;--border:#273453;--hover:#16213b;--accent:#60a5fa}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--fg);font-family:-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif;display:flex;flex-direction:column;padding-bottom:90px}

/* --- Topbar --- */
.topbar{display:flex;gap:8px;align-items:center;padding:10px 12px;background:var(--panel);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:1000}
.brand{display:flex;align-items:center;gap:8px;font-weight:900}
.logo{width:18px;height:18px;border-radius:4px;background:linear-gradient(135deg,#60a5fa,#34d399)}
.btn{border:1px solid var(--border);background:var(--card);color:var(--fg);border-radius:8px;padding:.45rem .7rem;font-weight:900;cursor:pointer;transition:.2s}
.btn:hover{background:var(--hover)} .btn[disabled]{opacity:.6;cursor:not-allowed}
.iconbtn{border:1px solid var(--border);background:transparent;color:var(--fg);border-radius:6px;padding:.25rem .45rem;cursor:pointer;transition:.2s}
.iconbtn:hover{background:var(--hover)}
.selectlike{height:34px;border:1px solid var(--border);border-radius:8px;background:var(--card);color:var(--fg);padding:.25rem .5rem}
.menu{position:relative;z-index:1001}
.menu>.btn{font-weight:900}
.dropdown{display:none;position:absolute;top:42px;left:0;background:var(--panel);border:1px solid var(--border);border-radius:10px;min-width:320px;box-shadow:0 12px 24px rgba(0,0,0,.12);z-index:1002}
.dropdown .item{padding:.55rem .7rem;border-bottom:1px dashed var(--border);cursor:pointer;display:flex;justify-content:space-between;gap:10px;align-items:center}
.dropdown .item:last-child{border-bottom:none}
.dropdown .item:hover{background:var(--hover)}
.dropdown a.item{text-decoration:none;color:inherit}
.dropdown .item label{display:flex;align-items:center;gap:6px;cursor:pointer;font-size:.9em}
.dropdown .item input[type="checkbox"]{margin:0;transform:scale(.9)}

/* --- Main Layout --- */
main{flex:1;min-height:0;display:grid;grid-template-columns:260px 1fr;gap:10px;padding:10px;position:relative;z-index:2}
main[data-mode="research"]{grid-template-columns:260px 1fr 340px}
@media (max-width:1200px){main{grid-template-columns:0 1fr;padding:6px} main[data-mode="research"]{grid-template-columns:0 1fr 340px} #left{display:none!important}}
@media (max-width:900px){main{grid-template-columns:0 1fr} main[data-mode="research"]{grid-template-columns:0 1fr} #left{display:none!important} aside#right{display:none!important}}

/* --- Left Sidebar --- */
aside#left{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:10px;display:flex;flex-direction:column;min-height:0;position:sticky;top:70px;height:calc(100vh - 90px)}
.listHead{display:flex;gap:8px;align-items:center;margin-bottom:10px}
#docList{flex:1;overflow:auto;display:flex;flex-direction:column;gap:8px}
.doc{display:grid;grid-template-columns:1fr auto auto;gap:6px;align-items:center;padding:8px;border:1px solid var(--border);border-radius:10px;background:var(--card);transition:.2s}
.doc.active{background:var(--hover);border-color:var(--accent)} .doc:hover{background:var(--hover)}
.doc .title{font-weight:900;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;cursor:pointer;padding:2px 4px}
.doc .title[contenteditable="true"]{outline:1.5px solid var(--accent);background:#fff;border-radius:4px;padding:2px 4px;cursor:text}
.doc .time{font-size:.78rem;color:var(--muted)}
.doc .act{display:none}.doc:hover .act{display:inline-flex}

/* --- Center --- */
section#center{display:flex;flex-direction:column;gap:10px;min-width:0;padding-bottom:50px}
#editorWrap{flex:1;border:1px solid var(--border);border-radius:12px;background:var(--panel);padding:8px;position:relative}
#editor{min-height:62vh}
.ck-balloon-panel,.ck-powered-by-balloon{display:none!important}
.ck-editor__editable_inline{min-height:58vh!important;color:#222;background:#fff;padding:12px 12px 140px;border-radius:8px;position:relative;z-index:1}
[data-theme="dark"] .ck-editor__editable_inline{color:#ffe7b3;background:#0b1327}
#ghostSuggest{position:absolute;max-width:60%;font-size:1rem;line-height:1.6;opacity:.35;color:#111;pointer-events:none;z-index:5;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
[data-theme="dark"] #ghostSuggest{color:#fff;opacity:.28}
#commandBar{display:flex;gap:10px;align-items:center;padding:10px;background:var(--panel);border:1px solid var(--border);border-radius:12px;position:relative;}
#cmdInput{flex:1;height:40px;border:1px solid var(--border);border-radius:10px;background:var(--card);color:var(--fg);padding:.5rem .9rem;font-size:15px}
#cmdSuggestions{display:flex;gap:8px}
.chip{background:var(--card);border:1px solid var(--border);border-radius:999px;padding:.3rem .7rem;cursor:pointer;font-weight:900;font-size:.9rem;white-space:nowrap;transition:.2s}
.chip:hover{background:var(--hover)}
@media (max-width:768px){#cmdSuggestions{display:none}}

/* --- Suggestion Popup & AI Chip --- */
#aiChip{position:absolute;display:none;gap:6px;align-items:center;background:var(--panel);border:1px solid var(--border);border-radius:999px;padding:.28rem .55rem;box-shadow:0 8px 20px rgba(0,0,0,.15);z-index:80;font-weight:900}
#aiChip small{opacity:.75}
#suggPopup{position:absolute;display:none;z-index:80;background:var(--panel);color:var(--fg);border:1px solid var(--border);border-radius:10px;box-shadow:0 12px 24px rgba(0,0,0,.18);min-width:300px;max-width:620px}
#suggPopup header{padding:6px 10px;border-bottom:1px solid var(--border);font-size:.82rem;color:var(--muted);display:flex;justify-content:space-between;align-items:center}
#suggPopup ul{list-style:none;margin:0;padding:6px;max-height:280px;overflow:auto}
#suggPopup li{padding:8px 10px;border-radius:8px;display:grid;grid-template-columns:90px 1fr auto;gap:10px;cursor:pointer;align-items:center}
#suggPopup li .kind{opacity:.75;font-size:.75rem}
#suggPopup li .txt{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
#suggPopup li .tag{border:1px solid var(--border);border-radius:6px;font-size:.72rem;padding:.05rem .35rem;opacity:.85}
#suggPopup li[data-active="1"]{background:var(--hover);outline:1.5px solid #8ab4ff66}

/* --- Right Sidebar --- */
aside#right{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:10px;display:none;flex-direction:column;min-height:0;position:sticky;top:70px;height:calc(100vh - 90px)}
main[data-mode="research"] aside#right{display:flex}

.sidebar-nav{display:flex;gap:0;background:var(--card);border-radius:8px;padding:4px;border:1px solid var(--border);margin-bottom:10px}
.sidebar-nav .tab{flex:1;padding:8px 14px;font-weight:700;font-size:.9rem;cursor:pointer;border-radius:6px;text-align:center;color:var(--muted);transition:.2s}
.sidebar-nav .tab:hover{background:var(--hover);color:var(--fg)}
.sidebar-nav .tab[data-active="1"]{background:var(--panel);color:var(--accent);box-shadow:0 1px 3px rgba(0,0,0,.05)}
.sidebar-content{flex:1;overflow:auto;display:none}
.sidebar-content[data-active="1"]{display:block}
#rightSearchResults{display:flex;flex-direction:column;gap:12px}
.search-summary{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:12px;white-space:pre-wrap;font-size:.95rem;line-height:1.6}
.search-sources h4{margin:12px 0 6px;font-size:.9rem;color:var(--muted)}
#rightSearchResults ul{list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:8px}
#rightSearchResults li{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:10px 12px;cursor:pointer;font-weight:500;transition:.2s}
#rightSearchResults li:hover{background:var(--hover)}
#rightFeed{display:flex;flex-direction:column;gap:12px}
a.feed-item{display:block;text-decoration:none;color:inherit;background:var(--card);border:1px solid var(--border);border-radius:10px;overflow:hidden;transition:.2s}
a.feed-item:hover{background:var(--hover)}
a.feed-item img{width:100%;height:140px;object-fit:cover;display:block;background-color:var(--border)}
a.feed-item .feed-content{padding:10px}
a.feed-item .feed-source{font-size:.8rem;color:var(--muted);margin-bottom:4px}
a.feed-item .feed-title{font-weight:900;color:var(--fg)}
#feedMax{margin-left:auto}
#right.max{position:fixed;inset:60px 16px 16px 16px;z-index:120;background:var(--panel);height:auto}
#right.max #rightFeed{height:calc(100% - 52px);overflow:auto}

/* --- Chat Dock --- */
#chatBtn{position:fixed;right:16px;bottom:80px;z-index:60}
#chatDock{position:fixed;right:16px;bottom:16px;width:min(95vw,1000px);height:88vh;display:none;flex-direction:column;background:var(--panel);border:1px solid var(--border);border-radius:14px;box-shadow:0 18px 36px rgba(0,0,0,.28);z-index:75}
#chatHead{display:flex;align-items:center;gap:8px;justify-content:space-between;padding:10px;border-bottom:1px solid var(--border);font-weight:900}
#chatHead .actions{position:relative;display:flex;align-items:center;gap:6px}
#chatPlusMenu{position:absolute;display:none;background:var(--panel);border:1px solid var(--border);border-radius:8px;padding:6px;right:40px;top:40px;z-index:90;width:150px}
#chatPlusMenu .item{padding:6px 8px;border-radius:6px;cursor:pointer;font-size:.9em}
#chatPlusMenu .item:hover{background:var(--hover)}
#chatWrap{flex:1;display:grid;grid-template-columns:220px 1fr;min-height:0}
#chatThreads{border-right:1px solid var(--border);padding:8px;overflow:auto}
.threadRow{display:flex;gap:6px;align-items:center;padding:8px;border:1px solid var(--border);border-radius:10px;background:var(--card);cursor:pointer;margin-bottom:8px;justify-content:space-between;transition:.2s}
.threadRow:hover{background:var(--hover)} .threadRow[data-active="1"]{outline:2px solid #9bbcff;background:var(--hover)}
#chatMain{display:flex;flex-direction:column;min-width:0}
#chatBody{flex:1;overflow:auto;padding:10px;display:flex;flex-direction:column;gap:10px}
.bubble{max-width:85%;padding:.8rem 1.2rem;border:1px solid var(--border);border-radius:14px;background:var(--card);word-break:break-word;font-size:1.05rem;line-height:1.6;white-space:pre-wrap}
.bubble.ai{cursor:pointer}
.me{margin-left:auto;background:#143763;color:#fff;border-color:#143763}
.ai{margin-right:auto;border-color:#3b4b72;background:#15284f;color:#fff}
[data-theme="dark"] .ai{background:#15203baa;border-color:#273453}
.sys{margin:0 auto;background:#eef2ff;border-style:dashed;color:#111;font-size:.9em;text-align:center}
#chatForm{display:flex;gap:8px;padding:10px;border-top:1px solid var(--border)}
#chatInput{flex:1;border:1px solid var(--border);border-radius:10px;background:var(--card);color:var(--fg);padding:.6rem .8rem;font-size:1.02rem;resize:vertical;min-height:80px}
#quota{position:absolute;left:12px;bottom:12px;background:var(--panel);border:1px solid var(--border);border-radius:8px;padding:.25rem .55rem;font-size:.85rem;color:#666}
#filePick{display:none}

/* footer */
footer{position:fixed;bottom:0;left:0;right:0;background:var(--panel);padding:8px 10px;border-top:1px solid var(--border);font-size:.92rem;text-align:center;user-select:none;z-index:10}
footer a{pointer-events:auto}

/* misc and modals */
#gaze{position:fixed;pointer-events:none;width:14px;height:14px;border-radius:50%;background:rgba(37,99,235,.75);box-shadow:0 0 0 3px rgba(37,99,235,.2);mix-blend-mode:multiply;z-index:100;transform:translate(-50%,-50%);display:none}
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;z-index:120;align-items:center;justify-content:center}
.modal{background:#fff;color:#111;border-radius:12px;max-width:760px;width:92vw;max-height:86vh;overflow:auto;padding:18px;border:1px solid var(--border);box-shadow:0 18px 36px rgba(0,0,0,.25)}
[data-theme="dark"] .modal{background:#0f172a;color:#f1f5ff}
.modal h3{margin:.2rem 0 .6rem}
.modal .actions{display:flex;justify-content:flex-end;gap:8px;margin-top:12px}
.modal .btn-plain{background:#f3f4f6;border:1px solid #e5e7eb;border-radius:8px;padding:.45rem .8rem;cursor:pointer}
[data-theme="dark"] .modal .btn-plain{background:#1e293b;border-color:#334155;color:#f1f5ff}
.spinner{border:4px solid rgba(0,0,0,.1);width:24px;height:24px;border-radius:50%;border-left-color:var(--accent);animation:spin 1s ease infinite;margin:20px auto}
@keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
#trendWrap{position:absolute;background:var(--panel);border:1px solid var(--border);border-radius:10px;box-shadow:0 12px 24px rgba(0,0,0,.12);display:none;z-index:70;min-width:260px;max-width:420px}
#trendWrap .row{padding:8px 10px;border-bottom:1px dashed var(--border);cursor:pointer}
#trendWrap .row:last-child{border-bottom:none}
#trendWrap .row:hover{background:var(--hover)}
</style>
</head>
<body data-lang="ko">
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NXBQK43Z"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>

<div id="gaze"></div>

<div class="topbar">
  <button class="iconbtn" id="btnToggleLeft" title="ë¬¸ì„œ íŒ¨ë„ ì ‘ê¸°/í¼ì¹˜ê¸°">â˜°</button>
  <div class="brand"><div class="logo"></div><div id="t_brand" data-i18n="brand.name">ThinkHelper</div></div>

  <div class="menu" data-menu>
    <button class="btn" data-i18n="menu.tools">ë„êµ¬ â–¾</button>
    <div class="dropdown">
      <div class="item" id="iNew"><span data-i18n="tools.newDoc">ìƒˆ ë¬¸ì„œ</span><span>âŒ˜/Ctrl+N</span></div>
      <div class="item" id="iPrint"><span data-i18n="tools.print">ğŸ–¨ï¸ í”„ë¦°í„°ë¡œ ì¸ì‡„</span></div>
      <div class="item" id="iImport"><span data-i18n="tools.import">ğŸ“¥ ë¶ˆëŸ¬ì˜¤ê¸° (ë°ëª¨)</span></div>
      <div class="item" id="iSavePDF"><span data-i18n="tools.savePdf">ğŸ’¾ PDFë¡œ ì €ì¥</span></div>
      <div class="item" id="iSaveWord"><span data-i18n="tools.saveWord">ğŸ’¾ Wordë¡œ ì €ì¥</span></div>
      <div class="item" id="iSaveHWP"><span data-i18n="tools.saveHwp">ğŸ’¾ HWPë¡œ ì €ì¥ (ë°ëª¨)</span></div>
      <div class="item" id="iTranslate"><span data-i18n="tools.translate">ğŸŒ ë²ˆì—­í•˜ê¸° (ë°ëª¨)</span></div>
      <div class="item" id="iCollab"><span data-i18n="tools.collab">ğŸ‘¥ í˜‘ì—… ì´ˆëŒ€í•˜ê¸°</span></div>
      <div class="item" id="iMakePPT"><span data-i18n="tools.makePpt">âœ¨ PPT ìŠ¬ë¼ì´ë“œ ìƒì„±</span></div>
      <div class="item" id="iClipboard"><span data-i18n="tools.share">ê³µìœ í•˜ê¸° (QR/ë§í¬)</span><span>â†—</span></div>
    </div>
  </div>

  <div class="menu" data-menu>
    <button class="btn" data-i18n="menu.settings">ì„¤ì • â–¾</button>
    <div class="dropdown" id="dropSettings">
      <div class="item" style="flex-direction:column;align-items:flex-start;gap:8px">
        <label><input type="checkbox" id="optSugg"> <span data-i18n="settings.showSuggest">ì¶”ì²œì–´ í‘œì‹œ (VSCode ìŠ¤íƒ€ì¼)</span></label>
        <label><input type="checkbox" id="optPersonal"> <span data-i18n="settings.aiSuggest">ë§ì¶¤í˜• AI ì œì•ˆ (ë°ëª¨)</span></label>
        <label><input type="checkbox" id="optGaze"> <span data-i18n="settings.gazeCursor">ì‹œì„  ì»¤ì„œ</span></label>
      </div>
      <div class="item">
        <span data-i18n="settings.mode">ëª¨ë“œ</span>
        <select id="modeSel" class="selectlike" style="width:180px">
          <option value="normal" selected data-i18n="settings.mode.normal">Normal (ì¼ë°˜)</option>
          <option value="research" data-i18n="settings.mode.research">Research (ë¦¬ì„œì¹˜)</option>
        </select>
      </div>
      <div class="item">
        <span data-i18n="settings.language">ì–¸ì–´</span>
        <select id="langSel" class="selectlike" style="width:180px">
          <option value="ko" selected>í•œêµ­ì–´</option>
          <option value="en">English</option>
          <option value="ja">æ—¥æœ¬èª</option>
        </select>
      </div>
      <div class="item" id="toggleTheme">ğŸŒ“ <span data-i18n="settings.toggleTheme">í…Œë§ˆ ì „í™˜</span></div>
    </div>
  </div>

  <div class="menu" data-menu>
    <button class="btn" data-i18n="menu.help">ë„ì›€ë§ â–¾</button>
    <div class="dropdown">
      <div class="item" id="iGuide"><span data-i18n="help.guide">ì„œë¹„ìŠ¤ ì†Œê°œ ë° ê°€ì´ë“œ</span></div>
      <div class="item" id="iShortcuts"><span data-i18n="help.shortcuts">ë‹¨ì¶•í‚¤ ëª©ë¡</span></div>
      <div class="item" id="openPrivacy"><span data-i18n="help.privacy">ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨</span><span>â†—</span></div>
      <div class="item" id="openTerms"><span data-i18n="help.terms">ì„œë¹„ìŠ¤ ì´ìš©ì•½ê´€</span><span>â†—</span></div>
      <a class="item" href="mailto:ho849607@gmail.com"><span data-i18n="help.feedback">í”¼ë“œë°± ë³´ë‚´ê¸°</span><span>â†—</span></a>
    </div>
  </div>

  <button class="btn" id="chatBtn" style="margin-left:auto" title="ì±„íŒ… ì—´ê¸°" data-i18n-title="tooltip.openChat">ğŸ’¬</button>
</div>

<main id="mainLayout" data-mode="normal">
  <aside id="left" aria-label="ë¬¸ì„œëª©ë¡" data-collapsed="0">
    <div class="listHead"><b data-i18n="doclist.title">ë¬¸ì„œ</b><button class="btn" id="addDoc" title="ìƒˆ ë¬¸ì„œ ì¶”ê°€" data-i18n-title="tooltip.addDoc">ï¼‹</button></div>
    <div id="docList"></div>
  </aside>

  <section id="center">
    <div id="editorWrap">
      <div id="editor" aria-label="ì—ë””í„°"></div>
      <div id="ghostSuggest" aria-hidden="true"></div>
      <button id="aiChip">âœ¨ AI <small data-i18n="aiChip.contextHelp">ë¬¸ë§¥ ë„ì›€</small></button>
      <div id="suggPopup" aria-live="polite">
        <header><span data-i18n="suggest.header">ì œì•ˆ (â†‘/â†“, Enter ì„ íƒ)</span><div><button class="min" id="suggClose">âœ–</button></div></header>
        <ul id="suggList"></ul>
      </div>
    </div>
    <div id="commandBar" style="position:relative">
      <div id="cmdSuggestions">
        <button class="chip" data-cmd="create_doc" data-i18n="cmd.createDoc">âœ¨ ë¬¸ì„œ ìƒì„±</button>
        <button class="chip" data-cmd="edit_doc" data-i18n="cmd.editDoc">âœï¸ ì‘ì„± ë„ì›€ ë°›ê¸°</button>
      </div>
      <input id="cmdInput" placeholder="AIì—ê²Œ ìš”ì²­í•˜ê¸° / ê²€ìƒ‰" data-i18n-ph="cmd.inputPhAiOnly"/>
      <div id="trendWrap"></div>
      <button class="btn" id="cmdSend" data-i18n="cmd.send">ì „ì†¡</button>
    </div>
  </section>

  <aside id="right" aria-label="ë¦¬ì„œì¹˜ íŒ¨ë„">
    <nav class="sidebar-nav">
      <button class="tab" data-tab="topics" data-active="0">ğŸ”<span data-i18n="sidebar.tab.topics">íƒìƒ‰</span></button>
      <button class="tab" data-tab="feed" data-active="1">ğŸ“°<span data-i18n="sidebar.tab.feed">í”¼ë“œ</span></button>
      <button class="btn" id="feedMax" title="í”¼ë“œ ìµœëŒ€í™”">â¤¢</button>
    </nav>
    <div id="rightSearchResults" class="sidebar-content" data-active="0">
      <div class="search-summary" style="color:var(--muted);font-style:italic;" data-i18n="topics.placeholder">ì±„íŒ… ë‚´ìš© ê¸°ë°˜ ì¶”ì²œ í† í”½ (ì„œë²„ êµ¬í˜„ í•„ìš”)</div>
    </div>
    <div id="rightFeed" class="sidebar-content" data-active="1">
      <div class="spinner"></div>
    </div>
  </aside>
</main>

<footer>
  <div>Â© ThinkHelper â€” <span data-i18n="footer.warning">âš ï¸ ì¸ê³µì§€ëŠ¥ ê²°ê³¼ëŠ” ê²€í† ê°€ í•„ìš”í•©ë‹ˆë‹¤.</span></div>
  <div id="loc">ğŸ“ <span data-i18n="footer.locationLoading">ìœ„ì¹˜ í™•ì¸ ì¤‘â€¦</span></div>
</footer>

<!-- Chat Dock -->
<div id="chatDock" role="dialog" aria-hidden="true" style="display:none;">
  <div id="chatHead">
    <span><span data-i18n="chat.title">AI ì±„íŒ…</span> <small id="chatModelIndicator">(with Gemini)</small></span>
    <div class="actions">
      <input type="file" id="filePick" accept=".pdf,.txt,image/*"/>
      <button class="iconbtn" id="btnChatPlus" title="ë”ë³´ê¸°" data-i18n-title="tooltip.chatMore">â•</button>
      <div id="chatPlusMenu">
        <div class="item" data-action="github">â†—ï¸ GitHub (ë°ëª¨)</div>
        <div class="item" data-action="word">ğŸ“„ Word (ë°ëª¨)</div>
        <div class="item" data-action="email">âœ‰ï¸ ë©”ì¼ (ë°ëª¨)</div>
      </div>
      <button class="iconbtn" id="btnAttach" title="íŒŒì¼ ì²¨ë¶€ (ì´ë¯¸ì§€/í…ìŠ¤íŠ¸)" data-i18n-title="tooltip.attachFile">ğŸ“</button>
      <button class="iconbtn" id="chatClose" aria-label="ë‹«ê¸°" data-i18n-aria="aria.close">âœ–</button>
    </div>
  </div>
  <div id="chatWrap">
    <aside id="chatThreads" aria-label="ì±„íŒ… ìŠ¤ë ˆë“œ"></aside>
    <section id="chatMain">
      <div style="padding:6px 10px;border-bottom:1px dashed var(--border);display:flex;gap:8px;align-items:center">
        <input id="threadTitleInput" placeholder="ìŠ¤ë ˆë“œ ì œëª©" data-i18n-ph="chat.threadTitlePh" style="flex:1;border:1px solid var(--border);border-radius:8px;padding:.35rem .55rem;background:var(--card)"/>
        <button class="btn" id="renameThread" data-i18n="chat.saveTitle">ì œëª© ì €ì¥</button>
        <button class="btn" id="deleteThread" data-i18n="chat.deleteThread">ì‚­ì œ</button>
      </div>
      <div id="chatBody"></div>
      <form id="chatForm">
        <textarea id="chatInput" rows="3" placeholder="ë©”ì‹œì§€ ì…ë ¥ (Enter=ì „ì†¡, Shift+Enter=ì¤„ë°”ê¿ˆ)" data-i18n-ph="chat.inputPh"></textarea>
        <button class="btn" type="submit" data-i18n="chat.send">ì „ì†¡</button>
      </form>
    </section>
  </div>
  <div id="quota" data-i18n="chat.quotaGemini">Gemini AI ì—°ë™</div>
</div>

<!-- Share / Guide / Policies -->
<div id="shareModal" class="modal-backdrop">
  <div class="modal">
    <h3 data-i18n="share.title">ê³µìœ í•˜ê¸°</h3>
    <p data-i18n="share.desc">ë§í¬/í…ìŠ¤íŠ¸ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤. QRë¡œë„ ì „ì†¡í•  ìˆ˜ ìˆì–´ìš”.</p>
    <div id="qr" style="margin:10px auto;width:200px;height:200px"></div>
    <div class="actions"><button class="btn-plain" id="shareClose" data-i18n="modal.close">ë‹«ê¸°</button></div>
  </div>
</div>

<div id="guideModal" class="modal-backdrop">
  <div class="modal">
    <h3 data-i18n="guide.title">ThinkHelper ì‚¬ìš© ê°€ì´ë“œ</h3>
    <div class="content" style="line-height:1.6">
      <p><b data-i18n="brand.name">ThinkHelper</b><span data-i18n="guide.intro">ëŠ” ë¬¸ì„œ ì‘ì„±ê³¼ ë¦¬ì„œì¹˜ë¥¼ í•œ í™”ë©´ì—ì„œ ëë‚´ëŠ” AI ì—ë””í„°ì…ë‹ˆë‹¤.</span></p>
      <h4 data-i18n="guide.featuresTitle">í•µì‹¬ ê¸°ëŠ¥</h4>
      <ul>
        <li data-i18n="guide.feature1.gemini"><b>AI ì—”ì§„:</b> Google Gemini ëª¨ë¸ ê¸°ë°˜ ì‘ë‹µ.</li>
        <li data-i18n="guide.feature2"><b>íƒìƒ‰/í”¼ë“œ:</b> Research ëª¨ë“œì—ì„œ ìµœì‹  ì •ë³´ í™•ì¸.</li>
        <li data-i18n="guide.feature3"><b>AI ê¸€ì“°ê¸°/ì±„íŒ…:</b> í•˜ë‹¨ ë°” ìš”ì²­ ë˜ëŠ” ìš°ì¸¡ í•˜ë‹¨ ì±„íŒ….</li>
        <li data-i18n="guide.feature4"><b>íŒŒì¼ ì €ì¥:</b> PDF/Word ì €ì¥.</li>
        <li data-i18n="guide.feature5"><b>PPT ìƒì„±:</b> Google Slides ìƒˆ íƒ­.</li>
      </ul>
    </div>
    <div class="actions"><button class="btn-plain" id="guideClose" data-i18n="modal.close">ë‹«ê¸°</button></div>
  </div>
</div>

<div id="privacyModal" class="modal-backdrop">
  <div class="modal">
    <h3>ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨</h3>
    <article>
      <p>ë³¸ ì„œë¹„ìŠ¤ëŠ” ì‚¬ìš©ì ê°œì¸ì •ë³´ë¥¼ ì¤‘ìš”í•˜ê²Œ ìƒê°í•©ë‹ˆë‹¤. ë³¸ ë°©ì¹¨ì€ ìˆ˜ì§‘í•˜ëŠ” ì •ë³´, ì´ìš© ëª©ì , ë³´ê´€ ê¸°ê°„, ì œ3ì ì œê³µ, ì‚¬ìš©ì ê¶Œë¦¬ ë° ë¬¸ì˜ì²˜ë¥¼ ì„¤ëª…í•©ë‹ˆë‹¤.</p>
      <h4>1. ìˆ˜ì§‘ í•­ëª©</h4>
      <p>í•„ìˆ˜: ì´ë©”ì¼, ì„œë¹„ìŠ¤ ì´ìš© ë¡œê·¸, ì¿ í‚¤. ì„ íƒ: í”„ë¡œí•„ ì •ë³´.</p>
      <h4>2. ì´ìš© ëª©ì </h4>
      <p>ê³„ì • ê´€ë¦¬, ê³ ê° ì§€ì›, ì„œë¹„ìŠ¤ í’ˆì§ˆ í–¥ìƒ, ë³´ì•ˆ ëª¨ë‹ˆí„°ë§.</p>
      <h4>3. ë³´ê´€ ë° íŒŒê¸°</h4>
      <p>ê´€ë ¨ ë²•ë ¹ ë˜ëŠ” ì„œë¹„ìŠ¤ ì´ìš© ëª©ì  ë‹¬ì„± ì‹œê¹Œì§€ ë³´ê´€í•˜ë©°, ëª©ì  ë‹¬ì„± ì‹œ ì•ˆì „í•˜ê²Œ íŒŒê¸°í•©ë‹ˆë‹¤.</p>
      <h4>4. ì œ3ì ì œê³µ</h4>
      <p>ë²•ë ¹ì— ì˜í•œ ê²½ìš°ë¥¼ ì œì™¸í•˜ê³  ë™ì˜ ì—†ì´ ì œê³µí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
      <h4>5. ì´ìš©ì ê¶Œë¦¬</h4>
      <p>ì—´ëŒ, ì •ì •, ì‚­ì œ, ì²˜ë¦¬ì •ì§€ ìš”êµ¬ê°€ ê°€ëŠ¥í•˜ë©°, ë¬¸ì˜ì²˜ë¡œ ì—°ë½í•˜ë©´ ì§€ì²´ ì—†ì´ ì¡°ì¹˜í•©ë‹ˆë‹¤.</p>
      <h4>6. ë¬¸ì˜ì²˜</h4>
      <p>ì´ë©”ì¼: support@example.com</p>
    </article>
    <div class="actions"><button class="btn-plain" id="privacyClose">ë‹«ê¸°</button></div>
  </div>
</div>

<div id="termsModal" class="modal-backdrop">
  <div class="modal">
    <h3>ì„œë¹„ìŠ¤ ì´ìš©ì•½ê´€</h3>
    <article>
      <h4>1. ëª©ì </h4>
      <p>ì´ ì•½ê´€ì€ ë³¸ ì„œë¹„ìŠ¤ì˜ ì´ìš©ê³¼ ê´€ë ¨í•˜ì—¬ íšŒì‚¬ì™€ ì‚¬ìš©ì ê°„ ê¶Œë¦¬, ì˜ë¬´ ë° ì±…ì„ ì‚¬í•­ì„ ê·œì •í•©ë‹ˆë‹¤.</p>
      <h4>2. ê³„ì •</h4>
      <p>ì‚¬ìš©ìëŠ” ì •í™•í•œ ì •ë³´ë¥¼ ì œê³µí•´ì•¼ í•˜ë©° ê³„ì • ë³´ì•ˆì„ ìœ ì§€í•  ì±…ì„ì´ ìˆìŠµë‹ˆë‹¤.</p>
      <h4>3. ì‚¬ìš© ì¡°ê±´</h4>
      <p>ë¶ˆë²•, ì¹¨í•´, ìŠ¤íŒ¸ í™œë™ ê¸ˆì§€. ì„œë¹„ìŠ¤ ì •ì±…ì„ ì¤€ìˆ˜í•´ì•¼ í•©ë‹ˆë‹¤.</p>
      <h4>4. ì§€ì ì¬ì‚°ê¶Œ</h4>
      <p>ì„œë¹„ìŠ¤ ë° ì½˜í…ì¸ ì˜ ì €ì‘ê¶Œì€ íšŒì‚¬ ë˜ëŠ” í•´ë‹¹ ê¶Œë¦¬ìì—ê²Œ ìˆìœ¼ë©°, ì‚¬ìš©ìëŠ” í—ˆìš©ëœ ë²”ìœ„ ë‚´ì—ì„œë§Œ ì´ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
      <h4>5. ì±…ì„ ì œí•œ</h4>
      <p>ë¶ˆê°€í•­ë ¥, ì œ3ì ì‚¬ìœ , ì‚¬ìš©ìì˜ ê·€ì±…ìœ¼ë¡œ ë°œìƒí•œ ì†í•´ì— ëŒ€í•´ì„œëŠ” ì±…ì„ì„ ì§€ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
      <h4>6. ë³€ê²½</h4>
      <p>ì•½ê´€ì´ ë³€ê²½ë˜ëŠ” ê²½ìš° ì„œë¹„ìŠ¤ ë‚´ ê³µì§€ ë˜ëŠ” ì´ë©”ì¼ë¡œ í†µì§€í•©ë‹ˆë‹¤.</p>
      <h4>7. ë¬¸ì˜</h4>
      <p>ì´ë©”ì¼: support@example.com</p>
    </article>
    <div class="actions"><button class="btn-plain" id="termsClose">ë‹«ê¸°</button></div>
  </div>
</div>

<script>
/* ========= Helpers ========= */
const $$ = (id)=>document.getElementById(id);
$$("chatInput")?.addEventListener("keydown",(e)=>{if(e.key==="Enter"&&!e.shiftKey){e.preventDefault();$$("chatForm")?.requestSubmit();}});
const sleep=(ms)=>new Promise(r=>setTimeout(r,ms));
const escapeHtml=(s)=>{
  // ì‘ì€ë”°ì˜´í‘œë„ ì´ìŠ¤ì¼€ì´í”„í•´ì„œ onclickë‚´ ë¬¸ìì—´ ê¹¨ì§ ë°©ì§€
  return (s==null?"":String(s)).replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));
};
const SKEY_SETTINGS="th.settings";

/* ========= Config ========= */
const SERVER_API_ENDPOINT="http://54.250.162.208:8000";
const FEED_API_ENDPOINT="https://api-v2.deepsearch.com";
const DEEPSEARCH_API_KEY="";

const TOTAL_FREE_TOKEN_LIMIT=15000;
const NUM_USERS=10;
const USER_SHARE_LIMIT=TOTAL_FREE_TOKEN_LIMIT/NUM_USERS;
const TOKEN_WARN_THRESHOLD=USER_SHARE_LIMIT*0.8;
const TOKEN_COUNT_KEY="th.token.state";
const APPROX_CHARS_PER_TOKEN=2;

/* ========= I18n ========= */
const I18N={
  ko:{status:{copied:"ë³µì‚¬ë¨"},plan:{free:"FREE",plus:"PLUS",trial:"TRIAL"},
      limit:{near:(dt)=>`ë¬´ë£Œ í† í° í•œë„ê°€ ê±°ì˜ ë‹¤ ì‚¬ìš©ë˜ì—ˆì–´ìš”.\n${dt} ì´í›„ ì´ˆê¸°í™”ë©ë‹ˆë‹¤.`,
             hit:(dt)=>`ë¬´ë£Œ í† í° í•œë„ë¥¼ ëª¨ë‘ ì‚¬ìš©í–ˆì–´ìš”.\n${dt} ì´í›„ ì´ˆê¸°í™”ë©ë‹ˆë‹¤.`},
      suggest:{ai:"AI ì¶”ì²œ",local:"ë¡œì»¬ ì¶”ì²œ",error:"ì˜¤ë¥˜"},
      topics:{loading:"ê´€ì‹¬ ì£¼ì œ ë¡œë”© ì¤‘...",error:"ì£¼ì œ ë¡œë”© ì‹¤íŒ¨",empty:"ì¶”ì²œ ì£¼ì œ ì—†ìŒ"},
      error:{serverConnect:"ì„œë²„ ì—°ê²° ì‹¤íŒ¨. (CORS/ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜?)"} },
  en:{status:{copied:"Copied"},plan:{free:"FREE",plus:"PLUS",trial:"TRIAL"},
      limit:{near:(dt)=>`You're nearing the free token limit.\nResets around ${dt}.`,
             hit:(dt)=>`Free token limit reached.\nResets around ${dt}.`},
      suggest:{ai:"AI Suggestion",local:"Local Suggestion",error:"Error"},
      topics:{loading:"Loading topics...",error:"Failed to load topics",empty:"No topics found"},
      error:{serverConnect:"Server connection failed. (CORS/Network error?)"} },
  ja:{status:{copied:"ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ"},plan:{free:"ç„¡æ–™",plus:"ãƒ—ãƒ©ã‚¹",trial:"ãƒˆãƒ©ã‚¤ã‚¢ãƒ«"},
      limit:{near:(dt)=>`ç„¡æ–™ãƒˆãƒ¼ã‚¯ãƒ³ã®åˆ¶é™ã«è¿‘ã¥ã„ã¦ã„ã¾ã™ã€‚\n${dt}é ƒã«ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™ã€‚`,
             hit:(dt)=>`ç„¡æ–™ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ã™ã¹ã¦ä½¿ç”¨ã—ã¾ã—ãŸã€‚\n${dt}é ƒã«ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™ã€‚`},
      suggest:{ai:"AIææ¡ˆ",local:"ãƒ­ãƒ¼ã‚«ãƒ«ææ¡ˆ",error:"ã‚¨ãƒ©ãƒ¼"},
      topics:{loading:"ãƒˆãƒ”ãƒƒã‚¯ã‚’èª­ã¿è¾¼ã¿ä¸­...",error:"ãƒˆãƒ”ãƒƒã‚¯ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ",empty:"ãŠã™ã™ã‚ãƒˆãƒ”ãƒƒã‚¯ãŒã‚ã‚Šã¾ã›ã‚“"},
      error:{serverConnect:"ã‚µãƒ¼ãƒãƒ¼æ¥ç¶šå¤±æ•—ã€‚(CORS/ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ï¼Ÿ)"} }
};
const I18N_TEXT={
  ko:{"page.title":"ThinkHelper â€” ì—ë””í„°","brand.name":"ThinkHelper","menu.tools":"ë„êµ¬","menu.settings":"ì„¤ì •","menu.help":"ë„ì›€ë§",
      "tools.newDoc":"ìƒˆ ë¬¸ì„œ","tools.print":"í”„ë¦°í„°ë¡œ ì¸ì‡„","tools.import":"ë¶ˆëŸ¬ì˜¤ê¸°","tools.savePdf":"PDFë¡œ ì €ì¥","tools.saveWord":"Wordë¡œ ì €ì¥","tools.saveHwp":"HWPë¡œ ì €ì¥","tools.translate":"ë²ˆì—­í•˜ê¸°","tools.collab":"í˜‘ì—… ì´ˆëŒ€","tools.makePpt":"PPT ìƒì„±","tools.share":"ê³µìœ í•˜ê¸°",
      "settings.showSuggest":"ì¶”ì²œì–´ í‘œì‹œ","settings.aiSuggest":"ë§ì¶¤í˜• AI ì œì•ˆ (ë°ëª¨)","settings.gazeCursor":"ì‹œì„  ì»¤ì„œ","settings.language":"ì–¸ì–´","settings.toggleTheme":"í…Œë§ˆ ì „í™˜","settings.mode":"ëª¨ë“œ","settings.mode.normal":"Normal (ì¼ë°˜)","settings.mode.research":"Research (ë¦¬ì„œì¹˜)",
      "help.guide":"ì„œë¹„ìŠ¤ ì†Œê°œ ë° ê°€ì´ë“œ","help.shortcuts":"ë‹¨ì¶•í‚¤ ëª©ë¡","help.privacy":"ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨","help.terms":"ì„œë¹„ìŠ¤ ì´ìš©ì•½ê´€","help.feedback":"í”¼ë“œë°± ë³´ë‚´ê¸°",
      "tooltip.openChat":"ì±„íŒ… ì—´ê¸°","doclist.title":"ë¬¸ì„œ","tooltip.addDoc":"ìƒˆ ë¬¸ì„œ","aiChip.contextHelp":"ë¬¸ë§¥ ë„ì›€","suggest.header":"ì œì•ˆ (â†‘/â†“, Enter)",
      "cmd.createDoc":"ë¬¸ì„œ ìƒì„±","cmd.editDoc":"ì‘ì„± ë„ì›€","cmd.inputPhAiOnly":"AIì—ê²Œ ìš”ì²­í•˜ê¸°","cmd.send":"ì „ì†¡",
      "sidebar.tab.topics":"íƒìƒ‰","sidebar.tab.feed":"í”¼ë“œ","topics.placeholder":"ì±„íŒ… ë‚´ìš© ê¸°ë°˜ ì¶”ì²œ í† í”½ (ì„œë²„ êµ¬í˜„ í•„ìš”)",
      "footer.warning":"AI ê²°ê³¼ëŠ” ê²€í†  í•„ìš”","footer.locationLoading":"ìœ„ì¹˜ í™•ì¸ ì¤‘...",
      "chat.title":"AI ì±„íŒ…","tooltip.chatMore":"ë”ë³´ê¸°","tooltip.attachFile":"íŒŒì¼ ì²¨ë¶€","aria.close":"ë‹«ê¸°",
      "chat.threadTitlePh":"ìŠ¤ë ˆë“œ ì œëª©","chat.saveTitle":"ì œëª© ì €ì¥","chat.deleteThread":"ì‚­ì œ","chat.inputPh":"ë©”ì‹œì§€ ì…ë ¥ (Enter=ì „ì†¡)","chat.send":"ì „ì†¡","chat.quotaGemini":"Gemini AI ì—°ë™",
      "share.title":"ê³µìœ í•˜ê¸°","share.desc":"ë§í¬/í…ìŠ¤íŠ¸ ë³µì‚¬ë¨. QR ì „ì†¡ ê°€ëŠ¥.","modal.close":"ë‹«ê¸°",
      "guide.title":"ThinkHelper ê°€ì´ë“œ","guide.intro":"ëŠ” ë¬¸ì„œ ì‘ì„±ê³¼ ë¦¬ì„œì¹˜ë¥¼ í•œ í™”ë©´ì—ì„œ ëë‚´ëŠ” AI ì—ë””í„°ì…ë‹ˆë‹¤.","guide.featuresTitle":"í•µì‹¬ ê¸°ëŠ¥",
      "guide.feature1.gemini":"AI ì—”ì§„: Google Gemini ëª¨ë¸ ê¸°ë°˜ ì‘ë‹µ.","guide.feature2":"íƒìƒ‰/í”¼ë“œ: 'Research' ëª¨ë“œì—ì„œ ì •ë³´ í™•ì¸","guide.feature3":"AI ê¸€ì“°ê¸°/ì±„íŒ…: í•˜ë‹¨ ë°” ë˜ëŠ” ğŸ’¬","guide.feature4":"íŒŒì¼ ì €ì¥: PDF/Word ì§€ì›.","guide.feature5":"PPT ìƒì„±: Google Slides ì—´ê¸°."},
  en:{"page.title":"ThinkHelper â€” Editor","brand.name":"ThinkHelper","menu.tools":"Tools","menu.settings":"Settings","menu.help":"Help",
      "tools.newDoc":"New Document","tools.print":"Print","tools.import":"Import","tools.savePdf":"Save as PDF","tools.saveWord":"Save as Word","tools.saveHwp":"Save as HWP","tools.translate":"Translate","tools.collab":"Invite Collaborators","tools.makePpt":"Create Slides","tools.share":"Share",
      "settings.showSuggest":"Show Suggestions","settings.aiSuggest":"Personalized AI (Demo)","settings.gazeCursor":"Gaze Cursor","settings.language":"Language","settings.toggleTheme":"Toggle Theme","settings.mode":"Mode","settings.mode.normal":"Normal","settings.mode.research":"Research",
      "help.guide":"Guide","help.shortcuts":"Shortcuts","help.privacy":"Privacy Policy","help.terms":"Terms of Service","help.feedback":"Send Feedback",
      "tooltip.openChat":"Open Chat","doclist.title":"Documents","tooltip.addDoc":"Add New","aiChip.contextHelp":"Context Help","suggest.header":"Suggestions (â†‘/â†“, Enter)",
      "cmd.createDoc":"Create Doc","cmd.editDoc":"Writing Assist","cmd.inputPhAiOnly":"Ask AI","cmd.send":"Send",
      "sidebar.tab.topics":"Explore","sidebar.tab.feed":"Feed","topics.placeholder":"Topics based on chat (Server needed)",
      "footer.warning":"Review AI results","footer.locationLoading":"Checking location...",
      "chat.title":"AI Chat","tooltip.chatMore":"More","tooltip.attachFile":"Attach File","aria.close":"Close",
      "chat.threadTitlePh":"Thread Title","chat.saveTitle":"Save Title","chat.deleteThread":"Delete","chat.inputPh":"Enter message (Enter=Send)","chat.send":"Send","chat.quotaGemini":"Powered by Gemini AI",
      "share.title":"Share","share.desc":"Link/Text copied. QR available.","modal.close":"Close",
      "guide.title":"ThinkHelper Guide","guide.intro":" is an AI editor for writing and research.","guide.featuresTitle":"Key Features",
      "guide.feature1.gemini":"AI Engine: Powered by Google Gemini.","guide.feature2":"Explore/Feed: Info in 'Research' mode","guide.feature3":"AI Writing/Chat: Use command bar or ğŸ’¬","guide.feature4":"Save Files: PDF/Word supported.","guide.feature5":"Create PPT: Opens Google Slides."},
  ja:{"page.title":"ThinkHelper â€” ã‚¨ãƒ‡ã‚£ã‚¿","brand.name":"ThinkHelper","menu.tools":"ãƒ„ãƒ¼ãƒ«","menu.settings":"è¨­å®š","menu.help":"ãƒ˜ãƒ«ãƒ—",
      "tools.newDoc":"æ–°è¦æ–‡æ›¸","tools.print":"å°åˆ·","tools.import":"ã‚¤ãƒ³ãƒãƒ¼ãƒˆ","tools.savePdf":"PDFä¿å­˜","tools.saveWord":"Wordä¿å­˜","tools.saveHwp":"HWPä¿å­˜","tools.translate":"ç¿»è¨³","tools.collab":"å…±åŒç·¨é›†è€…ã‚’æ‹›å¾…","tools.makePpt":"ã‚¹ãƒ©ã‚¤ãƒ‰ä½œæˆ","tools.share":"å…±æœ‰",
      "settings.showSuggest":"ææ¡ˆã‚’è¡¨ç¤º","settings.aiSuggest":"ãƒ‘ãƒ¼ã‚½ãƒŠãƒ©ã‚¤ã‚º AI (ãƒ‡ãƒ¢)","settings.gazeCursor":"è¦–ç·šã‚«ãƒ¼ã‚½ãƒ«","settings.language":"è¨€èª","settings.toggleTheme":"ãƒ†ãƒ¼ãƒåˆ‡æ›¿","settings.mode":"ãƒ¢ãƒ¼ãƒ‰","settings.mode.normal":"ãƒãƒ¼ãƒãƒ«","settings.mode.research":"ãƒªã‚µãƒ¼ãƒ",
      "help.guide":"ã‚¬ã‚¤ãƒ‰","help.shortcuts":"ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ","help.privacy":"ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼","help.terms":"åˆ©ç”¨è¦ç´„","help.feedback":"ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯",
      "tooltip.openChat":"ãƒãƒ£ãƒƒãƒˆã‚’é–‹ã","doclist.title":"æ–‡æ›¸","tooltip.addDoc":"æ–°è¦è¿½åŠ ","aiChip.contextHelp":"æ–‡è„ˆãƒ˜ãƒ«ãƒ—","suggest.header":"ææ¡ˆ (â†‘/â†“, Enter)",
      "cmd.createDoc":"æ–‡æ›¸ä½œæˆ","cmd.editDoc":"åŸ·ç­†æ”¯æ´","cmd.inputPhAiOnly":"AIã«è³ªå•","cmd.send":"é€ä¿¡",
      "sidebar.tab.topics":"æ¢ç´¢","sidebar.tab.feed":"ãƒ•ã‚£ãƒ¼ãƒ‰","topics.placeholder":"ãƒãƒ£ãƒƒãƒˆã«åŸºã¥ããƒˆãƒ”ãƒƒã‚¯ (ã‚µãƒ¼ãƒãƒ¼å®Ÿè£…è¦)",
      "footer.warning":"AIã®çµæœã¯è¦ç¢ºèª","footer.locationLoading":"ä½ç½®æƒ…å ±ç¢ºèªä¸­...",
      "chat.title":"AIãƒãƒ£ãƒƒãƒˆ","tooltip.chatMore":"è©³ç´°","tooltip.attachFile":"ãƒ•ã‚¡ã‚¤ãƒ«æ·»ä»˜","aria.close":"é–‰ã˜ã‚‹",
      "chat.threadTitlePh":"ã‚¹ãƒ¬ãƒƒãƒ‰ã‚¿ã‚¤ãƒˆãƒ«","chat.saveTitle":"ã‚¿ã‚¤ãƒˆãƒ«ä¿å­˜","chat.deleteThread":"å‰Šé™¤","chat.inputPh":"ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å…¥åŠ› (Enter=é€ä¿¡)","chat.send":"é€ä¿¡","chat.quotaGemini":"Gemini AI é€£æº",
      "share.title":"å…±æœ‰","share.desc":"ãƒªãƒ³ã‚¯/ãƒ†ã‚­ã‚¹ãƒˆã‚³ãƒ”ãƒ¼æ¸ˆã€‚QRå¯ã€‚","modal.close":"é–‰ã˜ã‚‹",
      "guide.title":"ThinkHelper ã‚¬ã‚¤ãƒ‰","guide.intro":" ã¯åŸ·ç­†ã¨èª¿æŸ»ã‚’ä¸€ã¤ã®ç”»é¢ã§è¡Œã†AIã‚¨ãƒ‡ã‚£ã‚¿ã§ã™ã€‚","guide.featuresTitle":"ä¸»ãªæ©Ÿèƒ½",
      "guide.feature1.gemini":"AIã‚¨ãƒ³ã‚¸ãƒ³: Google Gemini ãƒ¢ãƒ‡ãƒ«ä½¿ç”¨ã€‚","guide.feature2":"'ãƒªã‚µãƒ¼ãƒ'ãƒ¢ãƒ¼ãƒ‰ã§æƒ…å ±ç¢ºèª","guide.feature3":"ã‚³ãƒãƒ³ãƒ‰ãƒãƒ¼ã¾ãŸã¯ğŸ’¬ã§AIåŸ·ç­†/ãƒãƒ£ãƒƒãƒˆ","guide.feature4":"PDF/Wordä¿å­˜å¯¾å¿œã€‚","guide.feature5":"Google Slidesã‚’é–‹ãã€‚"}
};
function applyI18n(){
  const lang=(settings.lang||"ko").slice(0,2);
  const dict=I18N_TEXT[lang]||I18N_TEXT.ko;
  document.body.dataset.lang=lang;
  document.querySelectorAll("[data-i18n]").forEach(el=>{const k=el.getAttribute("data-i18n"); if(dict[k]) el.textContent=dict[k];});
  document.querySelectorAll("[data-i18n-ph]").forEach(el=>{const k=el.getAttribute("data-i18n-ph"); if(dict[k]) el.setAttribute("placeholder",dict[k]);});
  document.querySelectorAll("[data-i18n-title]").forEach(el=>{const k=el.getAttribute("data-i18n-title"); if(dict[k]) el.setAttribute("title",dict[k]);});
  document.querySelectorAll("[data-i18n-aria]").forEach(el=>{const k=el.getAttribute("data-i18n-aria"); if(dict[k]) el.setAttribute("aria-label",dict[k]);});
  if(typeof updateGhostSuggest==='function' && typeof editor!=='undefined' && editor){updateGhostSuggest();}
}

/* ========= Store ========= */
const store={
  listKey:"th.docs.list",docKey:id=>`th.doc.${id}`,curKey:"th.cur",
  list(){try{return JSON.parse(localStorage.getItem(this.listKey)||"[]")}catch{return[]}},
  saveList(a){localStorage.setItem(this.listKey,JSON.stringify(a||[]))},
  get(id){try{return JSON.parse(localStorage.getItem(this.docKey(id))||"null")}catch{return null}},
  set(id,o){localStorage.setItem(this.docKey(id),JSON.stringify(o))},
  remove(id){localStorage.removeItem(this.docKey(id))},
  current(){return localStorage.getItem(this.curKey)||""},
  setCurrent(id){localStorage.setItem(this.curKey,id||"")}
};
let curId=""; let settings={};

/* ========= Settings ========= */
function loadSettings(){
  settings=JSON.parse(localStorage.getItem(SKEY_SETTINGS)||'{}');
  settings.suggest ??= true;
  settings.personal ??= false;
  settings.gaze ??= false;
  settings.lang ??= (navigator.language||"ko").slice(0,2);
  settings.mode ??= 'normal';
}
const saveSettings=()=>localStorage.setItem(SKEY_SETTINGS,JSON.stringify(settings));

function updateChatUI(plan){
  const indicator=$$("chatModelIndicator"); const quota=$$("quota");
  if(!indicator||!quota) return;
  const lang=settings.lang||'ko';
  const planText=plan?plan.replace('models/','').replace('-latest',''):'Gemini';
  if(plan && (plan.includes("Gemini")||plan.includes("gemini"))){
    indicator.textContent=`(with ${planText})`;
    quota.textContent=lang==='ko'?"Gemini AI ì‚¬ìš© ì¤‘":(lang==='ja'?"Gemini AI ä½¿ç”¨ä¸­":"Using Gemini AI");
  }else if(plan && plan.includes("no_key")){
    indicator.textContent=lang==='ko'?"(í‚¤ ì—†ìŒ)":(lang==='ja'?"(ã‚­ãƒ¼ãªã—)":"(No Key)");
    quota.textContent=lang==='ko'?"ì„œë²„ API í‚¤ ì—†ìŒ":(lang==='ja'?"ã‚µãƒ¼ãƒãƒ¼APIã‚­ãƒ¼ãªã—":"Server API Key Missing");
  }else{
    indicator.textContent=lang==='ko'?"(ì—°ê²° ì•ˆë¨)":(lang==='ja'?"(æ¥ç¶šãªã—)":"(Offline)");
    quota.textContent=lang==='ko'?"ì„œë²„ ì—°ê²° í™•ì¸ í•„ìš”":(lang==='ja'?"ã‚µãƒ¼ãƒãƒ¼æ¥ç¶šç¢ºèªè¦":"Check Server Connection");
  }
}

/* ========= Token Limit ========= */
function getTokenState(){try{const s=JSON.parse(localStorage.getItem(TOKEN_COUNT_KEY)||'{}');const today=new Date().toLocaleDateString('ko-KR');if(s.date!==today){return{used:0,date:today}}return{used:s.used||0,date:today}}catch{return{used:0,date:new Date().toLocaleDateString('ko-KR')}}}
function addUsedTokens(n){if(n<=0)return;const s=getTokenState();s.used=(s.used||0)+n;try{localStorage.setItem(TOKEN_COUNT_KEY,JSON.stringify(s));}catch{}}
function checkTokenLimitOrWarn(estimated){const s=getTokenState();const cur=s.used||0;const langDict=(I18N[settings.lang]||I18N.ko).limit;const reset=settings.lang==='ko'?"ìì •":"midnight";const usage=Math.max(0,estimated||0);if(cur+usage>=USER_SHARE_LIMIT){alert(langDict.hit(reset));return false}else if(cur+usage>=TOKEN_WARN_THRESHOLD&&cur<TOKEN_WARN_THRESHOLD){alert(langDict.near(reset))}return true}

/* ========= Menus / Theme / Panels ========= */
(function(){
  loadSettings();
  const menus=[...document.querySelectorAll('[data-menu]')];
  const closeAll=()=>document.querySelectorAll('.dropdown').forEach(d=>d.style.display='none');
  menus.forEach(m=>{
    const btn=m.querySelector('.btn'); const drop=m.querySelector('.dropdown');
    if(!btn||!drop) return;
    btn.addEventListener('click',(e)=>{e.stopPropagation();const open=drop.style.display==='block';closeAll();drop.style.display=open?'none':'block';});
    drop.addEventListener('click',e=>e.stopPropagation());
  });
  document.addEventListener('click',closeAll);

  $$("toggleTheme")?.addEventListener('click',()=>{
    const root=document.documentElement; root.dataset.theme=root.dataset.theme==="dark"?"light":"dark";
  });
  $$("btnToggleLeft")?.addEventListener('click',()=>{
    const left=$$("left"); if(!left) return;
    const isHidden=left.style.display==='none'; left.style.display=isHidden?'flex':'none';
    const mainLayout=$$('mainLayout'); if(!mainLayout) return;
    const rightCol=settings.mode==='research'?'340px':'';
    if(window.innerWidth<=900){mainLayout.style.gridTemplateColumns='0 1fr'; left.style.display='none';}
    else if(window.innerWidth<=1200){mainLayout.style.gridTemplateColumns=`0 1fr ${rightCol}`.trim(); left.style.display='none';}
    else{mainLayout.style.gridTemplateColumns=`${isHidden?'260px':'0'} 1fr ${rightCol}`.trim().replace(/\s+/g,' ');}
  });
  $$("iGuide")?.addEventListener('click',()=>($$("guideModal").style.display="flex"));
  $$("guideClose")?.addEventListener('click',()=>($$("guideModal").style.display="none"));
  $$("openPrivacy")?.addEventListener('click',()=>($$("privacyModal").style.display="flex"));
  $$("privacyClose")?.addEventListener('click',()=>($$("privacyModal").style.display="none"));
  $$("openTerms")?.addEventListener('click',()=>($$("termsModal").style.display="flex"));
  $$("termsClose")?.addEventListener('click',()=>($$("termsModal").style.display="none"));

  const optSugg=$$("optSugg"); if(optSugg) optSugg.checked=!!settings.suggest;
  const optPersonal=$$("optPersonal"); if(optPersonal) optPersonal.checked=!!settings.personal;
  const optGaze=$$("optGaze"); if(optGaze) optGaze.checked=!!settings.gaze;
  const langSel=$$("langSel"); if(langSel) langSel.value=settings.lang;
  const modeSel=$$("modeSel"); if(modeSel) modeSel.value=settings.mode;

  optSugg?.addEventListener('change',(e)=>{settings.suggest=e.target.checked;saveSettings();updateGhostSuggest();});
  optPersonal?.addEventListener('change',(e)=>{settings.personal=e.target.checked;saveSettings();});
  optGaze?.addEventListener('change',(e)=>{settings.gaze=e.target.checked;saveSettings();setupGazeCursor();});
  langSel?.addEventListener('change',(e)=>{settings.lang=e.target.value;saveSettings();applyI18n();});
  modeSel?.addEventListener('change',(e)=>{
    settings.mode=e.target.value; saveSettings();
    const mainLayout=$$('mainLayout'); if(mainLayout) mainLayout.dataset.mode=settings.mode;
    const left=$$("left"); const isLeftHidden=left ? left.style.display==='none' : true;
    const leftCol=isLeftHidden?'0':'260px';
    const rightCol=settings.mode==='research'?'340px':'';
    if(window.innerWidth<=900){mainLayout.style.gridTemplateColumns='0 1fr';}
    else if(window.innerWidth<=1200){mainLayout.style.gridTemplateColumns=`0 1fr ${rightCol}`.trim();}
    else{mainLayout.style.gridTemplateColumns=`${leftCol} 1fr ${rightCol}`.trim().replace(/\s+/g,' ');}
    if(settings.mode==='research'){const active=document.querySelector('.sidebar-nav .tab[data-active="1"]')?.dataset.tab; if(active==='feed') loadFeed(); else if(active==='topics') loadTopics(); else switchSidebarTab('feed');}
  });

  const mainLayout=$$('mainLayout'); if(mainLayout) mainLayout.dataset.mode=settings.mode;
})();

/* ========= Editor ========= */
let editor=null, autosaveTimer=null;
async function initEditor(restore){
  try{
    editor=await ClassicEditor.create($$("editor"),{placeholder:settings.lang==='ja'?"ã“ã“ã§æ›¸ã„ã¦ãã ã•ã„â€¦":(settings.lang==='en'?"Start writing hereâ€¦":"ì—¬ê¸°ì„œ ì‘ì„±í•˜ì„¸ìš”â€¦")});
    if(restore!=null) editor.setData(restore);
    editor.model.document.on('change:data',()=>{
      clearTimeout(autosaveTimer); autosaveTimer=setTimeout(saveDoc,700);
      trackUserTokens(); triggerSuggest(); updateGhostSuggest();
    });
    editor.editing.view.document.on('selectionChange',()=>{updateGhostSuggest();});
  }catch(e){
    console.error("CKEditor init failed:",e);
    alert(settings.lang==='ja'?"ã‚¨ãƒ‡ã‚£ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚":(settings.lang==='en'?"Editor failed to load. Please refresh.":"ì—ë””í„° ë¡œë”© ì‹¤íŒ¨. ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”."));
  }
}
function newDoc(){
  const id="d_"+Date.now(); curId=id; store.setCurrent(id);
  const title=settings.lang==='ja'?"ç„¡é¡Œ":(settings.lang==='en'?"Untitled":"ë¬´ì œ");
  const row={id,createdAt:Date.now(),updatedAt:Date.now(),title,html:""};
  store.set(id,row); store.saveList([row,...store.list().filter(x=>x.id!==id)]);
  editor?.setData(""); renderList(); updateGhostSuggest();
}
function openDoc(id){
  const d=store.get(id); if(!d||!editor) return;
  curId=id; store.setCurrent(id); editor.setData(d.html||""); renderList(); updateGhostSuggest();
  if(window.innerWidth<=1200){const left=$$("left"); if(left && left.style.display!=='none'){$$("btnToggleLeft")?.click();}}
}
async function saveDoc(){
  if(!editor||!curId) return;
  const d=store.get(curId); if(!d) return;
  const currentHtml=editor.getData();
  if(d.html===currentHtml) return;
  d.html=currentHtml; d.updatedAt=Date.now();
  const plain=d.html.replace(/<[^>]+>/g," ").replace(/\s+/g," ").trim();
  if(!d.title || ["ë¬´ì œ","Untitled","ç„¡é¡Œ"].includes(d.title)){ d.title=(plain.split(" ").slice(0,8).join(" ")||(settings.lang==='ja'?"ç„¡é¡Œ":(settings.lang==='en'?"Untitled":"ë¬´ì œ"))); }
  store.set(curId,d);
  const list=store.list().map(x=>x.id===curId?{id:curId,createdAt:d.createdAt||Date.now(),updatedAt:d.updatedAt,title:d.title}:x);
  store.saveList(list); renderList();
}
function renderList(){
  const list=store.list().sort((a,b)=>(b.updatedAt||0)-(a.updatedAt||0));
  const el=$$("docList"); if(!el) return;
  el.innerHTML=list.map(it=>{
    const title=it.title || (settings.lang==='ja'?"ç„¡é¡Œ":(settings.lang==='en'?"Untitled":"ë¬´ì œ"));
    const when=new Date(it.updatedAt||it.createdAt||Date.now()).toLocaleString(settings.lang==='ja'?'ja-JP':(settings.lang==='en'?'en-US':'ko-KR'),{dateStyle:'short',timeStyle:'short'});
    return `<div class="doc ${it.id===curId?'active':''}" data-id="${it.id}">
      <div class="title" data-rename-id="${it.id}" title="${settings.lang==='ko'?'ì œëª© í´ë¦­í•˜ì—¬ ìˆ˜ì •':'Click title to rename'}">${escapeHtml(title)}</div>
      <div class="time">${escapeHtml(when)}</div>
      <div class="act"><button class="iconbtn" data-del-id="${it.id}" title="${settings.lang==='ko'?'ì‚­ì œ':'Delete'}">ğŸ—‘ï¸</button></div>
    </div>`;
  }).join("") || `<div class="doc"><div class="title" data-i18n="doclist.empty">ì €ì¥ëœ ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤.</div></div>`;
  if(!list.length) applyI18n();
  el.onclick=(e)=>{
    const titleEl=e.target.closest('.title[data-rename-id]');
    const delBtn=e.target.closest('button[data-del-id]');
    const docRow=e.target.closest('.doc[data-id]:not(.active)');
    if(delBtn){
      const id=delBtn.dataset.delId;
      const docTitle=store.get(id)?.title || (settings.lang==='ja'?"ç„¡é¡Œ":(settings.lang==='en'?"Untitled":"ë¬´ì œ"));
      const confirmMsg=settings.lang==='ko'?`'${docTitle}' ë¬¸ì„œë¥¼ ì‚­ì œí• ê¹Œìš”?`:(settings.lang==='ja'?`'${docTitle}' æ–‡æ›¸ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`:`Delete document '${docTitle}'?`);
      if(confirm(confirmMsg)){ store.remove(id); store.saveList(store.list().filter(x=>x.id!==id)); if(curId===id){ const next=store.list()[0]; if(next) openDoc(next.id); else newDoc(); } else { renderList(); } }
    }else if(titleEl){ enableInlineRename(titleEl);
    }else if(docRow){ openDoc(docRow.dataset.id); }
  };
}
function enableInlineRename(el){
  const id=el.dataset.renameId; if(!id||el.contentEditable==="true") return;
  const old=el.textContent; el.contentEditable="true"; el.focus(); document.execCommand('selectAll',false,null);
  const finish=(save=true)=>{ el.contentEditable="false"; el.removeEventListener('blur',onBlur); el.removeEventListener('keydown',onKey); const nv=el.textContent.trim(); if(save && nv && nv!==old){ const d=store.get(id); if(d){ d.title=nv; d.updatedAt=Date.now(); store.set(id,d); renderList();}} else { el.textContent=old; } };
  const onBlur=()=>finish(true);
  const onKey=(e)=>{ if(e.key==="Enter"){e.preventDefault();finish(true);} else if(e.key==="Escape"){e.preventDefault();finish(false);} };
  el.addEventListener('blur',onBlur); el.addEventListener('keydown',onKey);
}
$$("addDoc").onclick=newDoc; $$("iNew").onclick=newDoc;

/* ========= Export & Share ========= */
function exportPDF(){
  if(!editor) return alert("Editor not ready.");
  const content=document.createElement('div');
  content.innerHTML=editor.getData();
  content.style.fontFamily=getComputedStyle(document.body).fontFamily;
  content.style.fontSize='11pt'; content.style.lineHeight='1.5'; content.style.padding='20mm';
  const opt={margin:[20,20,20,20],filename:`ThinkHelper_${Date.now()}.pdf`,image:{type:'jpeg',quality:0.95},html2canvas:{scale:2,useCORS:true},jsPDF:{unit:'mm',format:'a4',orientation:'portrait'}};
  html2pdf().from(content).set(opt).save();
}
function exportWord(){
  if(!editor){alert("Editor not ready.");return;}
  const header = `<!DOCTYPE html>
<html xmlns:o="urn:schemas-microsoft-com:office:office"
      xmlns:w="urn:schemas-microsoft-com:office:word"
      xmlns="http://www.w3.org/TR/REC-html40">
<head><meta charset="utf-8"><title>ThinkHelper Export</title>
<style>body{font-family:${getComputedStyle(document.body).fontFamily};font-size:11pt;}</style></head><body>`;
  const sourceHTML = header + editor.getData() + footer;
  const blob=new Blob([sourceHTML],{type:"application/msword"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a"); a.href=url; a.download=`ThinkHelper_${Date.now()}.doc`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
}
async function sharePad(){
  let urlBase = location.origin + location.pathname;
  if(curId){
    urlBase += "?doc=" + encodeURIComponent(curId);
  }
  try{await navigator.clipboard.writeText(urlBase);}catch(e){}
  const wrap=$$("shareModal"); wrap.style.display="flex";
  const q=$$("qr"); q.innerHTML=""; new QRCode(q,{text:urlBase,width:200,height:200,colorDark:"#000000",colorLight:"#ffffff",correctLevel:QRCode.CorrectLevel.H});
}
$$("iSavePDF").onclick=exportPDF;
$$("iSaveWord").onclick=exportWord;
$$("iClipboard").onclick=sharePad;
$$("shareClose").onclick=()=>($$("shareModal").style.display="none");
$$("iPrint").onclick=()=>window.print();
$$("iImport").onclick=()=>alert("PDF/Word/HWP ë¶ˆëŸ¬ì˜¤ê¸° (ë°ëª¨)");
$$("iSaveHWP").onclick=()=>alert("HWPë¡œ ì €ì¥ì€ ì„œë²„ì˜ ìƒìš© ë³€í™˜ê¸°ê°€ í•„ìš”í•©ë‹ˆë‹¤.");
$$("iTranslate").onclick=()=>alert("ë²ˆì—­(ë°ëª¨): ì„œë²„ ì—°ë™ ì‹œ ì‹¤ì œ ë²ˆì—­ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
$$("iMakePPT").onclick=()=>window.open('https://slides.google.com/create','_blank');
$$("iCollab").onclick=()=>{
  const idCur=curId||"";
  const link = location.origin + location.pathname + (idCur ? ("?doc=" + encodeURIComponent(idCur)) : "");
  const subject=encodeURIComponent("[ThinkHelper] ë¬¸ì„œ í˜‘ì—… ì´ˆëŒ€");
  const body=encodeURIComponent("ì•„ë˜ ë§í¬ë¡œ ì ‘ì†í•˜ë©´ ë¬¸ì„œë¥¼ í•¨ê»˜ í¸ì§‘í•  ìˆ˜ ìˆì–´ìš”(ë°ëª¨).\n\n"+link+"\n\nâ€” ThinkHelper");
  location.href=`mailto:?subject=${subject}&body=${body}`;
};

/* ========= User Token Learning (for personal suggestions & interests) ========= */
const USER_TOK_KEY = "th.user.tokens";
function getUserTokens(){
  try { return JSON.parse(localStorage.getItem(USER_TOK_KEY) || "{}"); }
  catch { return {}; }}
function setUserTokens(map){
  try { localStorage.setItem(USER_TOK_KEY, JSON.stringify(map)); }
  catch {}
}
function trackUserTokens(){
  if (!settings.personal || !editor) return;
  const text = (editor.getData() || "").replace(/<[^>]+>/g, " ").toLowerCase();
  const tokens = text.match(/[\p{L}\p{N}_-]{2,}/gu) || [];
  const map = getUserTokens();
  for (const t of tokens) {
    map[t] = (map[t] || 0) + 1;
  }
  const entries = Object.entries(map).sort((a,b)=>b[1]-a[1]).slice(0,500);
  setUserTokens(Object.fromEntries(entries));
}
function topInterests(n=3){
  const map=getUserTokens();
  const arr=Object.entries(map)
    .filter(([w])=>w.length>=2 && !/^(the|and|you|with|from|ì—ì„œ|ê·¸ë¦¬ê³ |í•˜ëŠ”|í•˜ê¸°|ì…ë‹ˆë‹¤)$/i.test(w))
    .sort((a,b)=>b[1]-a[1])
    .slice(0,n)
    .map(([w])=>w);
  return arr;
}

/* ========= Suggestions / AI Chip ========= */
const aiChip=$$("aiChip"), suggPopup=$$("suggPopup"), suggList=$$("suggList");
let suggActive=-1, suggItems=[], suggDebounce=null;

const KO_DICT=["ê°ì‚¬í•©ë‹ˆë‹¤","ì•ˆë…•í•˜ì„¸ìš”","í”„ë¡œì íŠ¸","ë°ì´í„°","ë¶„ì„","ê²°ê³¼","ìš”ì²­","í™•ì¸","ë¶€íƒë“œë¦½ë‹ˆë‹¤","ì¼ì •","íšŒì˜","ìë£Œ"];
const EN_DICT=["Thank you","Hello","project","data","analysis","result","request","confirm","please","schedule","meeting","document"];
const JA_DICT=["ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™","ã“ã‚“ã«ã¡ã¯","ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ","ãƒ‡ãƒ¼ã‚¿","åˆ†æ","çµæœ","è¦è«‹","ç¢ºèª","ãŠé¡˜ã„ã—ã¾ã™","æ—¥ç¨‹","ä¼šè­°","è³‡æ–™"];

function getPrefix(){
  if(!editor) return "";
  try{
    const model=editor.model;
    const selection=model.document.selection;
    const position=selection.getFirstPosition();
    if(!position) return "";
    const range=model.createRange(model.createPositionAt(position.parent,0),position);
    let textBefore="";
    for(const item of range.getItems()){
      if(item.is('$text')||item.is('$textProxy')) textBefore+=item.data;
    }
    const match=textBefore.match(/[\p{L}\p{N}_-]+$/u);
    return match?match[0]:"";
  }catch(e){
    console.warn("getPrefix failed:",e);
    const text=(editor?.getData()||"").replace(/<[^>]+>/g," ");
    const parts=text.split(/\s+/); return parts[parts.length-1]||"";
  }
}
function getLocalSuggestions(prefix){
  const lang=settings.lang||'ko';
  const dictBase=lang==='en'?EN_DICT:(lang==='ja'?JA_DICT:KO_DICT);
  const userMap=getUserTokens();
  const userWords=Object.keys(userMap).sort((a,b)=>userMap[b]-userMap[a]);
  const dict=[...userWords, ...dictBase];
  const p=(prefix||"").toLowerCase();
  const tag=(I18N[lang]||I18N.ko).suggest.local;
  return dict.filter(w=>w && (lang==='ko'?w.startsWith(prefix):w.toLowerCase().startsWith(p)))
             .filter((w,i,self)=>self.indexOf(w)===i)
             .slice(0,5).map(w=>({kind:"LOCAL",text:w,tag}));
}
function applySuggestion(i){
  const it=suggItems[i]; if(!it||it.kind==='ERR') return;
  const prefix=getPrefix();
  const insert=it.text.startsWith(prefix)?it.text.slice(prefix.length):it.text;
  editor.model.change(writer=>{
    const selection=editor.model.document.selection;
    if(selection.isCollapsed && prefix.length>0){
      const pos=selection.getFirstPosition();
      const startPos=pos.getShiftedBy(-prefix.length);
      if(startPos){
        const rangeBefore=editor.model.createRange(startPos,pos);
        let textInRange=""; for(const item of rangeBefore.getItems()){ if(item.is('$text')||item.is('$textProxy')) textInRange+=item.data; }
        if(textInRange===prefix) writer.remove(rangeBefore);
      }
    }
    editor.model.insertContent(writer.createText(insert), editor.model.document.selection);
  });
  saveDoc(); closeSuggest();

  if(it.kind==='AI' && SERVER_API_ENDPOINT){
    const context=(editor?.getData()||"").replace(/<[^>]+>/g," ").trim().slice(-500);
    fetch(SERVER_API_ENDPOINT+"/log_suggestion",{method:"POST",headers:{"Content-Type":"application/json","Accept-Language":settings.lang||"ko"},body:JSON.stringify({context,chosenSuggestion:it.text,allSuggestions:suggItems.map(x=>x.text)})}).catch(()=>{});
  }
}
function triggerSuggest(){ if(!settings.suggest||!editor) return; clearTimeout(suggDebounce); suggDebounce=setTimeout(openSuggest,350); }
async function openSuggest(){
  if(!editor) return closeSuggest();
  const prefix=getPrefix(); if(!prefix) return closeSuggest();
  let context=""; try{
    const sel=editor.model.document.selection;
    const pos=sel.getFirstPosition();
    const start=pos.parent.startOffset===0?editor.model.createPositionBefore(pos.parent):editor.model.createPositionAt(pos.parent,0);
    const range=editor.model.createRange(start,pos);
    for(const item of range.getItems({shallow:true})){ if(item.is('$text')||item.is('$textProxy')) context+=item.data; }
    context=context.slice(-500);
  }catch(e){ context=(editor.getData()||"").replace(/<[^>]+>/g," ").slice(-500); }
  suggItems=await fetchAiSuggestions(context,prefix);
  renderSugg(suggItems);
}
async function fetchAiSuggestions(context,prefix){
  const lang=settings.lang||'ko';
  const tags=(I18N[lang]||I18N.ko).suggest;
  const est=Math.ceil((context.length+50)/APPROX_CHARS_PER_TOKEN);
  if(!checkTokenLimitOrWarn(est)) return getLocalSuggestions(prefix);
  if(SERVER_API_ENDPOINT){
    try{
      const r=await fetch(SERVER_API_ENDPOINT+"/suggest_word",{method:"POST",headers:{"Content-Type":"application/json","Accept-Language":lang},body:JSON.stringify({context,prefix})});
      if(!r.ok) throw new Error("Server "+r.status);
      const data=await r.json();
      const resp=(data?.suggestions||[]).filter(s=>s && s!==prefix);
      if(!resp.length) return getLocalSuggestions(prefix);
      const consumed=Math.ceil((context.length+(resp.join(" ").length))/APPROX_CHARS_PER_TOKEN); addUsedTokens(consumed);
      return resp.map(s=>({kind:"AI",text:s,tag:tags.ai}));
    }catch(e){ return getLocalSuggestions(prefix); }
  }
  return getLocalSuggestions(prefix);
}
function renderSugg(items){
  if(!items||!items.length){suggPopup.style.display="none";return;}
  const lang=settings.lang||'ko';
  const tags=(I18N[lang]||I18N.ko).suggest;
  suggList.innerHTML=items.map((it,i)=>`<li data-idx="${i}"><div class="kind">${it.kind}</div><div class="txt">${escapeHtml(it.text)}</div><div class="tag">${it.tag||(it.kind==='AI'?tags.ai:it.kind==='LOCAL'?tags.local:tags.error)}</div></li>`).join("");
  let rect; try{rect=editor.editing.view.domConverter.viewRangeToDom(editor.editing.view.document.selection.getFirstRange()).getBoundingClientRect();}catch{}
  const editorRect=$$("editorWrap")?.getBoundingClientRect();
  if(rect&&editorRect){suggPopup.style.top=`${rect.bottom-editorRect.top + 5}px`;suggPopup.style.left=`${rect.left-editorRect.left}px`;} else {suggPopup.style.top='100px';suggPopup.style.left='50px';}
  suggPopup.style.display="block"; suggActive=0; setActive(0);
}
function setActive(i){const lis=[...suggList.querySelectorAll("li")]; lis.forEach(li=>li.dataset.active="0"); if(lis[i]) lis[i].dataset.active="1";}
function closeSuggest(){suggPopup.style.display="none";suggActive=-1;suggItems=[];}
$$("suggClose").onclick=closeSuggest;
document.addEventListener("keydown",(e)=>{
  if(suggPopup.style.display!=="block") return;
  if(e.key==="ArrowDown"){e.preventDefault();suggActive=Math.min(suggActive+1,suggItems.length-1);setActive(suggActive);}
  else if(e.key==="ArrowUp"){e.preventDefault();suggActive=Math.max(suggActive-1,0);setActive(suggActive);}
  else if(e.key==="Enter"||e.key==="Tab"){e.preventDefault();applySuggestion(suggActive);}
  else if(e.key==="Escape"){e.preventDefault();closeSuggest();}
});
$$("suggList").addEventListener("click",(e)=>{const li=e.target.closest("li[data-idx]"); if(li) applySuggestion(Number(li.dataset.idx));});

// Ghost hint
function setGhost(text){const el=$$("ghostSuggest"); if(!el) return; el.textContent=text||""; el.style.display=text?"block":"none";}
function updateGhostSuggest(){
  const el=$$("ghostSuggest"); if(!el||!settings.suggest){ if(el) el.style.display="none"; return; }
  const txt=(editor?editor.getData():"").replace(/<[^>]+>/g," ").trim()||"";
  const hint=settings.lang==="en"?"e.g., â€œSummarize today's meetingâ€":(settings.lang==="ja"?"ä¾‹: ã€Œä»Šæ—¥ã®ä¼šè­°ã‚’è¦ç´„ã€":"ì˜ˆ: â€˜ì˜¤ëŠ˜ íšŒì˜ ìš”ì•½â€™");
  if(!txt){ setGhost(hint); } else { setGhost(""); }
}

/* ========= Right Sidebar (Explore & Feed) ========= */
function switchSidebarTab(tab){
  document.querySelectorAll(".sidebar-nav .tab").forEach(t=>{
    const isActive=t.dataset.tab===tab; t.dataset.active=isActive?"1":"0";
    if(isActive){ if(tab==='feed') loadFeed(); else if(tab==='topics') loadTopics(); }
  });
  document.querySelectorAll(".sidebar-content").forEach(c=>{
    const contentTab=c.id.toLowerCase().includes('search')?'topics':(c.id.toLowerCase().includes('feed')?'feed':'');
    c.dataset.active=(contentTab===tab)?"1":"0";
  });
}
document.querySelectorAll(".sidebar-nav .tab").forEach(t=>t.onclick=()=>switchSidebarTab(t.dataset.tab));

function renderSearch(summary,sources){
  const c=$$("rightSearchResults"); if(!c) return;
  const lang=settings.lang||'ko';
  const sourceTitle=lang==='ko'?'ì¶œì²˜':(lang==='ja'?'å‡ºå…¸':'Sources');
  const noTitle=lang==='ko'?'ì œëª© ì—†ìŒ':(lang==='ja'?'ã‚¿ã‚¤ãƒˆãƒ«ãªã—':'Untitled');
  const noUrl=lang==='ko'?'URL ì—†ìŒ':(lang==='ja'?'URLãªã—':'No URL');
  c.innerHTML=`<div class="search-summary">${escapeHtml(summary)}</div>
  <div class="search-sources"><h4>${sourceTitle}</h4><ul>${
    (sources||[]).map(s=>`<li><a href="${escapeHtml(s.url||'#')}" target="_blank" rel="noopener noreferrer"><strong>${escapeHtml(s.title||noTitle)}</strong><span> ${escapeHtml(s.url||noUrl)}</span></a></li>`).join("")
  }</ul></div>`;
}
async function internalSearch(q){
  const s=q.trim(); if(!s) return renderSearch((I18N[settings.lang]||I18N.ko).topics.empty,[]);
  const lang=settings.lang||'ko';
  renderSearch(lang==='ko'?`'${s}' ê²€ìƒ‰ ì¤‘...`:`Searching for '${s}'...`,[]);
  switchSidebarTab('topics');

  try{
    const langParam=lang==='ko'?'&lang=ko':'';
    const fields='title,url,summary_ko,published_at,provider_name';
    const res=await fetch(`${FEED_API_ENDPOINT}/v1/global-articles?q=${encodeURIComponent(s)}&limit=5&return_fields=${fields}${langParam}`,{method:"GET"});
    if(res.ok){
      const data=await res.json();
      const docs=data?.documents||data?.articles||data?.items||[];
      const summary=docs[0]?.summary_ko || (lang==='ko'?`'${s}'ì— ëŒ€í•œ ê²€ìƒ‰ ê²°ê³¼ì…ë‹ˆë‹¤.`:`Search results for '${s}'.`);
      const sources=docs.map(d=>({title:d.title,url:d.url}));
      renderSearch(summary,sources);
      return;
    }
    throw new Error("Deepsearch status "+res.status);
  }catch(e){
    renderSearch(lang==='ko'?`'${s}'ì— ëŒ€í•œ ê¸°ë³¸ ê²°ê³¼ì…ë‹ˆë‹¤.`:`Basic results for '${s}'.`,[
      {title:`${s} ê´€ë ¨ ìœ„í‚¤ë°±ê³¼`,url:`https://ko.wikipedia.org/wiki/${encodeURIComponent(s)}`},
      {title:`${s} êµ¬ê¸€ ê²€ìƒ‰`,url:`https://www.google.com/search?q=${encodeURIComponent(s)}`}
    ]);
  }
}
async function loadTopics(){
  const c=$$("rightSearchResults"); if(!c) return;
  const lang=settings.lang||'ko'; const dict=(I18N[lang]||I18N.ko).topics;
  c.innerHTML=`<div class="spinner"></div>`;
  try{
    const interests=topInterests(5);
    const base=["AI","IT","í´ë¼ìš°ë“œ","ìŠ¤íƒ€íŠ¸ì—…","ì •ì±…","ê²½ì œ","ë°ì´í„°","ë³´ì•ˆ"];
    const topics=[...interests,...base].filter((v,i,self)=>self.indexOf(v)===i).slice(0,10);
    if(!topics.length){ c.innerHTML=`<div class="search-summary">${dict.empty}</div>`; return; }
    c.innerHTML=`<ul>${topics.map(t=>`<li onclick="internalSearch('${escapeHtml(t)}')">${escapeHtml(t)}</li>`).join("")}</ul>`;
  }catch(e){ c.innerHTML=`<div class="search-summary">${dict.error}: ${e.message}</div>`; }
}
async function loadFeed(topic="IT"){
  const c=$$("rightFeed"); if(!c) return;
  c.innerHTML=`<div class="spinner"></div>`;
  const interests=topInterests(3);
  const q = (settings.personal && interests.length) ? interests.join(" OR ") : topic;
  const langParam = settings.lang==='ko'?'&lang=ko':'';
  const fields='title,url,provider_name,image_url,published_at';

  try{
    const res=await fetch(`${FEED_API_ENDPOINT}/v1/global-articles?q=${encodeURIComponent(q)}&limit=10&sort=latest&return_fields=${fields}${langParam}`,{method:"GET"});
    if(!res.ok) throw new Error("Deepsearch "+res.status);
    const data=await res.json();
    const items=data?.documents||data?.articles||data?.items||[];
    if(!items.length){ throw new Error("no items"); }
    c.innerHTML=items.map(it=>`
      <a href="${escapeHtml(it.url||'#')}" target="_blank" rel="noopener noreferrer" class="feed-item">
        <img src="${escapeHtml(it.image_url||'https://placehold.co/340x140/cccccc/333333?text=No+Image')}" alt="ë‰´ìŠ¤ ì¸ë„¤ì¼" loading="lazy">
        <div class="feed-content">
          <div class="feed-source">${escapeHtml(it.provider_name||"ì¶œì²˜ ë¶ˆëª…")}</div>
          <div class="feed-title">${escapeHtml(it.title||"")}</div>
        </div>
      </a>`).join("");
    return;
  }catch(e){
    const alt = [
      {title:"ì˜¤í”ˆ ì†ŒìŠ¤ ë‰´ìŠ¤ ëª¨ìŒ(ë°ëª¨)",url:"https://news.ycombinator.com/",provider_name:"Hacker News",image_url:""},
      {title:"êµ¬ê¸€ ë‰´ìŠ¤(í‚¤ì›Œë“œ)",url:`https://news.google.com/search?q=${encodeURIComponent(q)}`,provider_name:"Google News",image_url:""}
    ];
    c.innerHTML=alt.map(it=>`
      <a href="${escapeHtml(it.url)}" target="_blank" rel="noopener noreferrer" class="feed-item">
        <img src="${escapeHtml(it.image_url||'https://placehold.co/340x140/cccccc/333333?text=News')}" alt="ë‰´ìŠ¤ ì¸ë„¤ì¼" loading="lazy">
        <div class="feed-content">
          <div class="feed-source">${escapeHtml(it.provider_name)}</div>
          <div class="feed-title">${escapeHtml(it.title)}</div>
        </div>
      </a>`).join("");
  }
}
$$("feedMax")?.addEventListener("click",function(){
  const r=$$("right"); if(!r) return;
  if(r.classList.contains("max")) r.classList.remove("max"); else r.classList.add("max");
});

/* ========= Trend (ì‹¤ê²€ ìŠ¤íƒ€ì¼) ========= */
const TREND_KEY="th.trend.counts";
function getTrend(){try{return JSON.parse(localStorage.getItem(TREND_KEY)||'{}')}catch{return{}}}
function setTrend(m){try{localStorage.setItem(TREND_KEY,JSON.stringify(m));}catch{}}
function bumpTrend(word){if(!word) return; const m=getTrend(); m[word]=(m[word]||0)+1; setTrend(m);}
function topTrends(n=8){
  const m=getTrend();
  const arr=Object.entries(m).filter(([w])=>w.length>=2).sort((a,b)=>b[1]-a[1]).slice(0,n).map(([w])=>w);
  const base=["AI","ì£¼ì‹","ë‚ ì”¨","í™˜ìœ¨","ë¶€ë™ì‚°","ì¶•êµ¬","ì•¼êµ¬","ì•„ì´í°","ì‚¼ì„±","ë„·í”Œë¦­ìŠ¤"];
  const merged=[...new Set([...arr,...base])].slice(0,n);
  return merged;
}
const cmdInput=$$("cmdInput");
const trendWrap=$$("trendWrap");
cmdInput.addEventListener("focus",()=>{
  const trends=topTrends();
  if(!trends.length){trendWrap.style.display="none";return;}
  trendWrap.innerHTML=trends.map(t=>`<div class="row" data-q="${escapeHtml(t)}">ğŸ” ${escapeHtml(t)}</div>`).join("");
  trendWrap.style.top="44px"; trendWrap.style.left="8px"; trendWrap.style.right="auto"; trendWrap.style.display="block";
});
cmdInput.addEventListener("blur",()=>setTimeout(()=>trendWrap.style.display="none",150));
trendWrap.addEventListener("click",(e)=>{
  const row=e.target.closest(".row[data-q]"); if(!row) return;
  const q=row.dataset.q; cmdInput.value=q; bumpTrend(q);
  internalSearch(q);
  switchSidebarTab('feed');
  loadFeed(q);
});

/* ========= Command Bar ========= */
function setupCommandBar(){
  const cmdSend=$$("cmdSend");
  async function handle(){
    const v=(cmdInput.value||"").trim(); if(!v) return;
    bumpTrend(v);
    openChat(); await sendChat(v); cmdInput.value="";
  }
  cmdSend.onclick=handle;
  cmdInput.addEventListener("keydown",(e)=>{ if(e.key==="Enter"&&!e.shiftKey){e.preventDefault();handle();}});
  $$("cmdSuggestions").addEventListener('click',(e)=>{
    const b=e.target.closest?.(".chip"); if(!b) return;
    const lang=settings.lang||"ko";
    if(b.dataset.cmd==="create_doc"){
      const tpl=lang==="ko"?"<h1>ìƒˆ ë¬¸ì„œ í…œí”Œë¦¿</h1><p>ì—¬ê¸°ì— ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.</p>":(lang==="ja"?"<h1>æ–°è¦æ–‡æ›¸ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</h1><p>ã“ã“ã«å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>":"<h1>New Document Template</h1><p>Start writing here.</p>");
      editor.setData(tpl); saveDoc();
    }else if(b.dataset.cmd==="edit_doc"){
      const prompt=lang==="ko"?"ì´ ë¬¸ì„œ ë¬¸ì¥ ë‹¤ë“¬ì–´ì¤˜":(lang==="ja"?"ã“ã®æ–‡æ›¸ã®æ–‡ç« ã‚’æ•´ãˆã¦ãã ã•ã„":"Refine the sentences in this document");
      openChat(); sendChat(prompt);
    }
  });
}

/* ========= Chat ========= */
const THREADS_KEY="th.threads";
function threads(){try{return JSON.parse(localStorage.getItem(THREADS_KEY)||"[]")}catch{return[]}}
function saveThreads(a){localStorage.setItem(THREADS_KEY,JSON.stringify(a||[]))}
let chatHistory=[], threadId=null;

function renderThreads(){
  const box=$$("chatThreads"); if(!box) return;
  const list=threads().sort((a,b)=>(b.updatedAt||0)-(a.updatedAt||0));
  const newThreadText=(settings.lang||"ko")==="ko"?"ìƒˆ ìŠ¤ë ˆë“œ":(settings.lang==="ja"?"æ–°è¦ã‚¹ãƒ¬ãƒƒãƒ‰":"New Thread");
  box.innerHTML=(list.map(t=>`<div class="threadRow" data-id="${t.id}" data-active="${t.id===threadId?'1':'0'}"><div style="font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:150px">${escapeHtml(t.title||newThreadText)}</div><div style="color:#888;font-size:.8rem">${new Date(t.updatedAt||t.createdAt).toLocaleDateString()}</div></div>`).join(""))||'<div class="sys" style="margin:8px" data-i18n="chat.noThreads">ìŠ¤ë ˆë“œ ì—†ìŒ</div>';
  if(!list.length) applyI18n();
  box.onclick=(e)=>{const row=e.target.closest?.(".threadRow"); if(!row) return; if(row.getAttribute("data-id")!==threadId) openThread(row.getAttribute("data-id"));};
}
function newThread(){
  const id="t_"+Date.now();
  const title=(settings.lang||"ko")==="ko"?"ìƒˆ ìŠ¤ë ˆë“œ":(settings.lang==="ja"?"æ–°è¦ã‚¹ãƒ¬ãƒƒãƒ‰":"New Thread");
  const row={id,title,createdAt:Date.now(),updatedAt:Date.now(),history:[]};

  saveThreads([row, ...threads()]);
  threadId = id;
  chatHistory = [];
  renderThreads();

  const titleEl = $$("threadTitleInput");
  if (titleEl) titleEl.value = row.title;

  const bodyEl = $$("chatBody");
  if (bodyEl) bodyEl.innerHTML = "";
}
function openThread(id){
  const list=threads(); const t=list.find(x=>x.id===id); if(!t) return;
  threadId=id; chatHistory=t.history||[]; $$("chatBody").innerHTML="";
  chatHistory.forEach(m=>addBubble(m.content,m.role==="user",m.role==="system",true));
  if($$("threadTitleInput")) $$("threadTitleInput").value=t.title||"";
  renderThreads();
  $$("chatBody").scrollTop=$$("chatBody").scrollHeight;
}
function persistThread(){
  if(!threadId) return; const list=threads(); const idx=list.findIndex(x=>x.id===threadId); if(idx<0) return;
  const title=($$("threadTitleInput")?.value.trim())|| (list[idx].title|| (settings.lang==='ko'?'ìƒˆ ìŠ¤ë ˆë“œ':(settings.lang==='en'?'New Thread':'æ–°è¦ã‚¹ãƒ¬ãƒƒãƒ‰')));
  list[idx]={...list[idx],title,updatedAt:Date.now(),history:chatHistory.slice(-200)}; saveThreads(list); renderThreads();
}
$$("renameThread")?.addEventListener("click",persistThread);
$$("deleteThread")?.addEventListener("click",()=>{
  if(!threadId) return;
  const currentTitle=threads().find(t=>t.id===threadId)?.title || "ìƒˆ ìŠ¤ë ˆë“œ";
  const confirmMsg=settings.lang==="ko"?`'${currentTitle}' ìŠ¤ë ˆë“œë¥¼ ì‚­ì œí• ê¹Œìš”?`:`Delete thread '${currentTitle}'?`;
  if(confirm(confirmMsg)){ saveThreads(threads().filter(x=>x.id!==threadId)); const next=threads()[0]; if(next) openThread(next.id); else newThread(); }
});

const chatDock=$$("chatDock"), chatInput=$$("chatInput");
function openChat(){chatDock.style.display="flex"; chatDock.setAttribute("aria-hidden","false"); if(!threadId) newThread(); $$("chatInput")?.focus();}
function closeChat(){chatDock.style.display="none"; chatDock.setAttribute("aria-hidden","true");}
$$("chatBtn")?.addEventListener("click",openChat);
$$("chatClose")?.addEventListener("click",closeChat);
$$("btnChatPlus")?.addEventListener("click",(e)=>{e.stopPropagation(); const m=$$("chatPlusMenu"); if(m) m.style.display=m.style.display==="block"?"none":"block";});
document.addEventListener("click",()=>{const m=$$("chatPlusMenu"); if(m) m.style.display="none";});

function addBubble(text,me=false,isErr=false,skipPersist=false){
  const b=document.createElement("div"); b.className="bubble "+(me?"me":(isErr?"sys":"ai")); b.textContent=text;
  $$("chatBody").appendChild(b); $$("chatBody").scrollTop=$$("chatBody").scrollHeight;
  if(!skipPersist){chatHistory.push({role:me?"user":(isErr?"system":"assistant"),content:text}); persistThread();}
  return b;
}
async function typeOut(b,text,delay=4){
  b.textContent=""; for(let i=0;i<text.length;i++){ if(!document.body.contains(b)) return; b.textContent+=text[i]; if(i%3===0) await sleep(delay); }
  $$("chatBody").scrollTop=$$("chatBody").scrollHeight;
}
$$("chatBody")?.addEventListener("click",(e)=>{const t=e.target.closest?.(".bubble.ai"); if(!t) return; $$("chatInput").value=t.textContent; $$("chatInput").focus();});

async function sendChat(msg){
  const est=Math.ceil((msg.length+150)/APPROX_CHARS_PER_TOKEN);
  if(!checkTokenLimitOrWarn(est)){addBubble((I18N[settings.lang]||I18N.ko).limit.hit(settings.lang==="ko"?"ìì •":"midnight"),false,true); return;}
  addBubble(msg,true);
  const holder=addBubble("...",false);
  if(SERVER_API_ENDPOINT){
    try{
      const r=await fetch(SERVER_API_ENDPOINT+"/ask",{method:"POST",headers:{"Content-Type":"application/json","Accept-Language":settings.lang||"ko"},body:JSON.stringify({question:msg,id:threadId||""})});
      if(!r.ok){const t=await r.text(); throw new Error("Server Error: "+r.status+" "+t);}
      const data=await r.json(); const reply=(data&&data.answer)?data.answer:"(AI Response Error)";
      const actual=Math.ceil((msg.length+reply.length)/APPROX_CHARS_PER_TOKEN); addUsedTokens(actual);
      await typeOut(holder,reply); const plan=(data&&data.plan)||'Gemini'; updateChatUI(plan);
      chatHistory.push({role:"assistant",content:holder.textContent}); persistThread();
    }catch(e){
      const err=(I18N[settings.lang]||I18N.ko).error.serverConnect; await typeOut(holder,err+" "+e.message,0); holder.classList.add("sys"); updateChatUI("offline");
    }
  }else{ await typeOut(holder,"Server address not configured.",0); holder.classList.add("sys"); updateChatUI("offline"); }
}
$$("chatForm")?.addEventListener("submit",(e)=>{e.preventDefault(); const t=$$("chatInput").value.trim(); if(!t) return; $$("chatInput").value=""; sendChat(t);});
$$("btnAttach")?.addEventListener("click",()=>$$("filePick").click());
$$("filePick")?.addEventListener("change",(e)=>{const f=e.target.files?.[0]; if(!f) return; addBubble("File Received: "+f.name+" ("+Math.round(f.size/1024)+"KB)",false,true);});

/* footer location */
(function(){
  const locEl=$$("loc"); if(!locEl) return;
  fetch("https://ipapi.co/json").then(r=>{if(!r.ok) throw new Error("ipapi "+r.status); return r.json();})
  .then(a=>{ if(a && a.city){ locEl.textContent="ğŸ“ "+a.city+", "+a.country_name; } else { throw new Error("no city"); } })
  .catch(()=>{ locEl.textContent="ğŸ“ ìœ„ì¹˜ í™•ì¸ ë¶ˆê°€"; });
})();

/* gaze cursor */
function setupGazeCursor(){ const g=$$("gaze"); if(g) g.style.display=settings.gaze?"block":"none"; }
document.addEventListener("mousemove",(e)=>{ const g=$$("gaze"); if(g && g.style.display==="block"){ g.style.left=e.clientX+"px"; g.style.top=e.clientY+"px"; }});

/* shortcuts */
document.addEventListener("keydown",(e)=>{ if((e.ctrlKey||e.metaKey)&&String(e.key||"").toLowerCase()==="k"){e.preventDefault(); $$("cmdInput")?.focus(); $$("cmdInput")?.select();}});

/* init */
(async function(){
  loadSettings(); applyI18n();
  try{await initEditor("");}catch(e){return;}
  const last=store.current(); if(last && store.get(last)) openDoc(last); else newDoc(); renderList();
  setupCommandBar(); setupGazeCursor(); updateGhostSuggest(); renderThreads();
  if(settings.mode==='research') switchSidebarTab("feed");
  checkTokenLimitOrWarn(0);
})();
</script>
</body>
</html>
