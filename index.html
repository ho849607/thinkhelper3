<!DOCTYPE html>
<html lang="ko" data-theme="light">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>ThinkHelper 2.1 â€” Workspace & Discover</title>
  <link rel="icon" href="data:,"/>

  <!-- CKEditor -->
  <script src="https://cdn.ckeditor.com/ckeditor5/41.3.1/classic/ckeditor.js"></script>
  <!-- Optional helpers -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js" defer></script>

  <style>
    :root{
      --bg:#f6f8fb;--fg:#0b1020;--muted:#6a7691;--panel:#fff;--card:#f2f5ff;--border:#d6deee;--hover:#e9effe;--accent:#2563eb;
      --touch:48px;
    }
    :root[data-theme="dark"]{--bg:#0b1020;--fg:#f1f5ff;--muted:#a8b4cf;--panel:#0f172a;--card:#101a30;--border:#273453;--hover:#16213b;--accent:#60a5fa}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:var(--bg);color:var(--fg);
      font-family:-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif;
      display:flex;flex-direction:column;min-height:100vh;overflow:hidden;
    }

    /* ===== Topbar ===== */
    .topbar{
      position:sticky;top:0;z-index:50;display:flex;align-items:center;justify-content:space-between;gap:8px;
      padding:calc(8px + env(safe-area-inset-top,0)) 12px 10px;
      background:var(--panel);border-bottom:1px solid var(--border)
    }
    .brand{display:flex;align-items:center;gap:10px;font-weight:900}
    .logo{width:18px;height:18px;border-radius:4px;background:linear-gradient(135deg,#60a5fa,#34d399)}
    .modes{display:flex;gap:8px}
    .tab{border:1px solid var(--border);background:var(--card);padding:.55rem .9rem;border-radius:10px;font-weight:800;cursor:pointer;min-height:var(--touch)}
    .tab[aria-selected="true"]{background:var(--panel);outline:2px solid var(--accent)}
    .actions{display:flex;gap:8px;align-items:center}
    .iconbtn,.btn{border:1px solid var(--border);background:var(--card);color:var(--fg);border-radius:10px;padding:.55rem .9rem;font-weight:800;cursor:pointer;min-height:var(--touch)}
    .iconbtn:hover,.btn:hover{background:var(--hover)}

    /* ===== Main / Grid ===== */
    main{flex:1;min-height:0}
    #workspace{
      height:100%;
      display:grid;
      grid-template-columns:280px 1fr 320px;
      gap:12px;
      padding:12px;
      overflow:hidden;
    }
    aside#left,aside#right,#center{
      background:var(--panel);border:1px solid var(--border);border-radius:12px;min-height:0;
      display:flex;flex-direction:column;overflow:hidden;
    }

    /* ===== Left ===== */
    #left{padding:10px}
    .tabs{display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin-bottom:8px}
    .tabs button{border:1px solid var(--border);background:var(--card);border-radius:8px;padding:.5rem .7rem;font-weight:800;cursor:pointer;min-height:40px}
    .tabs button[data-active="1"]{background:var(--panel);color:var(--accent)}
    .left-search{display:flex;gap:8px;margin:6px 0 10px}
    .left-search input{flex:1;border:1px solid var(--border);background:var(--card);border-radius:10px;padding:.6rem .8rem;font-size:.95rem}
    .panel{flex:1;overflow:auto;display:none}
    .panel[data-active="1"]{display:block}
    .panel-head{display:flex;justify-content:space-between;align-items:center;margin:6px 0 8px}
    .doc{display:flex;justify-content:space-between;align-items:center;padding:.55rem .7rem;border:1px solid var(--border);border-radius:8px;background:var(--card);margin-bottom:6px;cursor:pointer}
    .doc:hover{background:var(--hover)}
    .doc .ttl{font-weight:800;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .doc .date{color:var(--muted);font-size:.82rem;margin-left:8px;white-space:nowrap}
    .tmpl{display:grid;grid-template-columns:1fr;gap:8px}
    .card{border:1px solid var(--border);background:var(--card);border-radius:12px;padding:.9rem;cursor:pointer}
    .card:hover{background:var(--hover)}
    .slist{display:flex;flex-direction:column;gap:2px;padding-bottom:52px}
    .srow{display:flex;align-items:center;gap:8px;padding:.55rem .7rem;border-radius:8px;border:1px solid var(--border);background:var(--card);cursor:pointer;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .srow:hover{background:var(--hover)}
    .srow .q{flex:1;display:flex;align-items:center;gap:8px;min-width:0}
    .srow .meta{color:var(--muted);font-size:.82rem;margin-left:6px;white-space:nowrap}
    .srow .del{margin-left:auto;border:none;background:transparent;cursor:pointer;border-radius:8px;padding:.25rem .4rem;display:none}
    .srow:hover .del{display:block}
    .sfooter{position:sticky;bottom:0;background:var(--panel);padding:8px;border-top:1px dashed var(--border);display:flex;justify-content:flex-end}

    /* ===== Center / Editor ===== */
    #center{padding:0}
    #center-inner{display:flex;flex-direction:column;height:100%}
    .ck-sticky-panel .ck-toolbar{position:sticky;top:0;z-index:5}
    .editor-wrap{flex:1;min-height:0;overflow:auto;padding:10px}
    .ck-editor__editable_inline{
      min-height:60vh!important;background:#fff;color:#222;border-radius:8px;box-shadow:none !important;
    }
    [data-theme="dark"] .ck-editor__editable_inline{color:#ffe7b3;background:#0b1327}
    .doc-title{font-weight:900;font-size:1.05rem;padding:10px;color:var(--muted);border-bottom:1px dashed var(--border);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    /* ===== Right / AI ===== */
    #right{padding:10px}
    .ai-head{display:flex;justify-content:space-between;align-items:center}
    .ai-box{flex:1;overflow:auto;margin-top:8px;display:flex;flex-direction:column;gap:8px}
    .bubble{max-width:85%;padding:.9rem 1rem;border:1px solid var(--border);border-radius:14px;background:var(--card);line-height:1.6;white-space:pre-wrap}
    .me{margin-left:auto;background:#143763;color:#fff;border-color:#143763}
    .ai{margin-right:auto;border-color:#314264;background:#122142;color:#fff}
    .ai-form{display:flex;gap:8px;margin-top:auto}
    .ai-form textarea{flex:1;border:1px solid var(--border);border-radius:10px;background:var(--card);color:var(--fg);padding:.7rem .9rem;min-height:64px;resize:vertical}
    .ai-form button{min-width:92px}

    /* ===== Discover ===== */
    #discover{display:none;padding:12px;height:100%;overflow:auto}
    #discover[data-active="1"]{display:block}
    .grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px}
    .news{border:1px solid var(--border);background:var(--panel);border-radius:12px;overflow:hidden;display:flex;flex-direction:column}
    .news img{width:100%;height:160px;object-fit:cover;background:var(--border)}
    .news .meta{font-size:.82rem;color:var(--muted);padding:6px 10px 0}
    .news .title{padding:6px 10px 6px;font-weight:900}
    .news .desc{padding:0 10px 10px;color:var(--muted);font-size:.92rem}
    .news .actions{margin-top:auto;display:flex;gap:6px;padding:8px;border-top:1px dashed var(--border)}
    .news .actions button{flex:1}

    /* ===== Footer ===== */
    footer{padding:8px 12px calc(8px + env(safe-area-inset-bottom,0));border-top:1px solid var(--border);background:var(--panel);font-size:.95rem;display:flex;flex-wrap:wrap;gap:12px;justify-content:space-between}
    .status-left,.status-right{display:flex;gap:12px;align-items:center}
    .tip{color:var(--muted)}

    /* ===== Modal ===== */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;z-index:80}
    .modal{position:fixed;inset:0;display:none;z-index:90;align-items:center;justify-content:center}
    .modal-inner{width:min(640px,92vw);max-height:80vh;overflow:auto;background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:14px}
    .modal h3{margin:.2rem 0 0.6rem}
    .row{display:flex;gap:10px;align-items:center;margin:8px 0}
    .row label{flex:1}
    .sep{height:1px;background:var(--border);margin:10px 0}
    .row .btnbar{display:flex;gap:8px}

    /* ===== Suggestion Box (VS Code Style) ===== */
    #suggestionBox {
      position: absolute;
      display: none;
      z-index: 9999;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 6px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      min-width: 150px;
      max-width: 240px;
      overflow: hidden;
      font-family: monospace, sans-serif;
    }
    #suggestionBox ul {list-style:none;margin:0;padding:4px 0}
    #suggestionBox li {
      padding:6px 12px;cursor:pointer;font-size:.9rem;color:var(--fg);
      display:flex;justify-content:space-between
    }
    #suggestionBox li.active {background:#007AFF;color:#fff}
    #suggestionBox li:hover:not(.active){background:var(--hover)}
    #suggestionBox li .sub {font-size:.75rem;opacity:.7;margin-left:8px}

    /* ===== Responsive ===== */
    @media (max-width:1024px){ #workspace{grid-template-columns:240px 1fr 300px} .grid{grid-template-columns:repeat(2,1fr)} }
    @media (max-width:820px){ #workspace{grid-template-columns:220px 1fr} #right{display:none} .grid{grid-template-columns:1fr} }
    @media (max-width:480px){
      .modes{gap:6px}
      .tab,.iconbtn,.btn{border-radius:12px}
      #workspace{grid-template-columns:1fr}
      #left{display:none} #right{display:none}
      .ck-editor__editable_inline{min-height:50vh!important}
      .topbar{gap:6px}
      .brand div:last-child{font-size:1rem}
      .quickbar{
        position:fixed;bottom:0;left:0;right:0;z-index:60;display:flex;gap:8px;
        padding:8px calc(12px + env(safe-area-inset-left,0)) calc(8px + env(safe-area-inset-bottom,0)) calc(12px + env(safe-area-inset-right,0));
        background:var(--panel);border-top:1px solid var(--border)
      }
      .quickbar .btn{flex:1}
      footer{padding-bottom:calc(56px + env(safe-area-inset-bottom,0))}
    }
    @media (prefers-reduced-motion: reduce){ *{scroll-behavior:auto;animation:none!important;transition:none!important} }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="topbar">
    <div class="brand"><div class="logo"></div><div data-i18n="brand">ThinkHelper</div></div>
    <div class="modes" role="tablist" aria-label="Main modes">
      <button class="tab" id="tabDiscover" role="tab" aria-selected="true" data-i18n="tab.discover">ğŸ“° ë””ìŠ¤ì»¤ë²„</button>
      <button class="tab" id="tabWorkspace" role="tab" aria-selected="false" data-i18n="tab.work">ğŸ“ ì‘ì—…ì‹¤</button>
    </div>
    <div class="actions">
      <button class="iconbtn" id="btnTheme" data-i18n-title="tip.theme" title="ë‹¤í¬/ë¼ì´íŠ¸ ì „í™˜(âŒ˜/Ctrl+J)">ğŸŒ“</button>
      <button class="iconbtn" id="btnHelp" data-i18n-title="tip.help" title="ë„ì›€ë§/ë‹¨ì¶•í‚¤">â“</button>
      <button class="iconbtn" id="btnSettings" data-i18n-title="tip.settings" title="í™˜ê²½ì„¤ì •">âš™ï¸</button>
    </div>
  </div>

  <!-- Discover -->
  <section id="discover" data-active="1" aria-label="Discover feed">
    <div style="display:flex;justify-content:space-between;align-items:center;margin:6px 0 12px">
      <h3 style="margin:0" data-i18n="insight.today">ì˜¤ëŠ˜ì˜ ì¸ì‚¬ì´íŠ¸</h3>
      <div class="toolbar-hint" data-i18n="insight.hint">ê´€ì‹¬ì‚¬ ì„¤ì • í›„ ë” ì •í™•í•œ í”¼ë“œê°€ ë³´ì—¬ìš”.</div>
    </div>
    <div id="apiNotice" style="display:none;border:1px dashed var(--border);border-radius:10px;padding:8px;margin:0 0 10px;color:var(--muted)">
      <span data-i18n="insight.apiNotice">ì‹¤ì‹œê°„ ë‰´ìŠ¤ API ì‹¤íŒ¨, ìƒ˜í”Œ í”¼ë“œë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.</span>
      <span> </span>
      <a href="https://news.google.com/?hl=ko&gl=KR&ceid=KR:ko" target="_blank" rel="noopener" data-i18n="insight.openGnews">Google ë‰´ìŠ¤ ì—´ê¸°</a>
    </div>
    <div class="grid" id="discoverGrid"></div>
  </section>

  <!-- Workspace -->
  <main id="workspace" style="display:none" aria-label="Workspace">
    <!-- Left -->
    <aside id="left" aria-label="ë¬¸ì„œ/í…œí”Œë¦¿/ë¼ì´ë¸ŒëŸ¬ë¦¬/ê²€ìƒ‰ê¸°ë¡">
      <div class="tabs">
        <button id="tFiles" data-active="1" data-i18n="left.files">ğŸ—‚ï¸ íŒŒì¼</button>
        <button id="tTmpl" data-active="0" data-i18n="left.templates">ğŸ¨ í…œí”Œë¦¿</button>
        <button id="tLib"  data-active="0" data-i18n="left.library">ğŸ“š ë¼ì´ë¸ŒëŸ¬ë¦¬</button>
        <button id="tSearch" data-active="0" data-i18n="left.search">ğŸ” ê²€ìƒ‰ê¸°ë¡</button>
      </div>

      <div class="left-search" role="search">
        <input id="leftSearchInput" type="search" placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." aria-label="ê²€ìƒ‰ì–´ ì…ë ¥"/>
        <button class="btn" id="leftSearchBtn">ê²€ìƒ‰</button>
      </div>

      <div id="pFiles" class="panel" data-active="1">
        <div class="panel-head">
          <b>ë‚´ íŒŒì¼</b>
          <button class="btn" id="btnNewDocLeft">ï¼‹ ìƒˆ ë¬¸ì„œ</button>
        </div>
        <div id="fileList"></div>
      </div>

      <div id="pTmpl" class="panel" data-active="0">
        <div class="panel-head"><b>í…œí”Œë¦¿</b></div>
        <div class="tmpl" id="tmplList"></div>
      </div>

      <div id="pLib" class="panel" data-active="0">
        <div class="panel-head"><b>ë¼ì´ë¸ŒëŸ¬ë¦¬</b></div>
        <div id="libList"></div>
      </div>

      <div id="pSearch" class="panel" data-active="0">
        <div class="panel-head"><b>ê²€ìƒ‰ê¸°ë¡</b></div>
        <div id="searchList" class="slist"></div>
        <div class="sfooter">
          <button class="btn" id="btnClearSearch">ğŸ—‘ï¸ ê¸°ë¡ ì§€ìš°ê¸°</button>
        </div>
      </div>
    </aside>

    <!-- Center -->
    <section id="center" aria-label="ì—ë””í„°">
      <div class="doc-title" id="docTitleBar">ë¬´ì œ</div>
      <div id="center-inner">
        <div class="editor-wrap">
          <div id="editor"></div>
        </div>
      </div>
    </section>

    <!-- Right -->
    <aside id="right" aria-label="AI ì–´ì‹œìŠ¤í„´íŠ¸">
      <div class="ai-head">
        <b data-i18n="ai.title">ğŸ¤– AI ë„ìš°ë¯¸</b>
        <button class="iconbtn" id="aiToggle" data-i18n="ai.toggle" title="ì ‘ê¸°/í¼ì¹˜ê¸°">âˆ’</button>
      </div>
      <div class="ai-box" id="aiBox">
        <div class="bubble ai" data-i18n="ai.welcome">ì•ˆë…•! í•„ìš”í•œ í…œí”Œë¦¿ì„ ë„£ì–´ì£¼ê±°ë‚˜, ì„ íƒí•œ í…ìŠ¤íŠ¸ë¥¼ ìš”ì•½í•´ì¤„ê²Œ.</div>
      </div>
      <form class="ai-form" id="aiForm">
        <textarea id="aiInput" data-i18n-placeholder="ai.placeholder" placeholder="ì˜ˆ) ì„ íƒ ë¶€ë¶„ ìš”ì•½í•´ì¤˜ / SWOT í‹€ ë„£ì–´ì¤˜"></textarea>
        <button class="btn" type="submit" data-i18n="ai.send">ì „ì†¡</button>
      </form>
    </aside>
  </main>

  <!-- Mobile quick bar -->
  <div class="quickbar" id="quickbar" style="display:none">
    <button class="btn" id="qbDiscover" data-i18n="tab.discover">ğŸ“° ë””ìŠ¤ì»¤ë²„</button>
    <button class="btn" id="qbWorkspace" data-i18n="tab.work">ğŸ“ ì‘ì—…ì‹¤</button>
    <button class="btn" id="qbNew" data-i18n="btn.new">ï¼‹ ìƒˆ ë¬¸ì„œ</button>
  </div>

  <!-- Footer -->
  <footer>
    <div class="status-left">
      <span>Â© <span data-i18n="brand">ThinkHelper</span></span>
      <span id="wordCount" data-i18n-prefix="status.words.prefix">Words: </span>
      <span id="docState" data-i18n="status.saved">ë¬¸ì„œ ìƒíƒœ: ì €ì¥ë¨</span>
    </div>
    <div class="status-right">
      <span class="tip" id="tip">ğŸ’¡ <span id="tipText">Tab=ìë™ì™„ì„± Â· Esc=ë‹«ê¸° Â· â†‘/â†“=ì´ë™</span></span>
      <span id="aiStatus">AI: <span id="net" data-i18n="net.online">ì˜¨ë¼ì¸</span></span>
      <span id="langDisp" data-i18n-prefix="status.lang">ì–¸ì–´: <b id="langGuess">ko</b></span>
    </div>
  </footer>

  <!-- Settings Modal -->
  <div class="modal-backdrop" id="backdrop"></div>
  <div class="modal" id="settingsModal" role="dialog" aria-modal="true" aria-labelledby="settingsTitle">
    <div class="modal-inner">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 id="settingsTitle" data-i18n="settings.title">í™˜ê²½ì„¤ì •</h3>
        <button class="iconbtn" id="btnCloseSettings" data-i18n-title="settings.closeTip" title="ë‹«ê¸°">âœ•</button>
      </div>
      <div class="sep"></div>

      <div class="row">
        <label for="selLang" data-i18n="settings.lang">ê¸°ë³¸ ì–¸ì–´</label>
        <select id="selLang" style="padding:.45rem .6rem;border:1px solid var(--border);border-radius:8px;background:var(--card)">
          <option value="ko">í•œêµ­ì–´ (ko)</option>
          <option value="ja">æ—¥æœ¬èª (ja)</option>
          <option value="en">English (en)</option>
        </select>
      </div>

      <div class="row">
        <label for="toggleSuggest" data-i18n="settings.suggest">ì¶”ì²œì–´(ìë™ì™„ì„±) ì‚¬ìš©</label>
        <input id="toggleSuggest" type="checkbox"/>
      </div>

      <div class="row">
        <label for="togglePersonal" data-i18n="settings.personal">ë§ì¶¤í˜• ì¶”ì²œ(í•™ìŠµ ë°˜ì˜) ì‚¬ìš©</label>
        <input id="togglePersonal" type="checkbox"/>
      </div>

      <div class="row">
        <label for="toggleEye" data-i18n="settings.eye">ì•„ì´ì»¨íƒ ëª¨ë“œ(ì¹´ë©”ë¼ ì ‘ê·¼) ì‚¬ìš©</label>
        <input id="toggleEye" type="checkbox"/>
      </div>

      <div class="sep"></div>

      <div class="row">
        <label data-i18n="settings.learnData">í•™ìŠµ ë°ì´í„°</label>
        <div class="btnbar">
          <button class="btn" id="btnMemExport" data-i18n="settings.backup">ğŸ’¾ ë°±ì—… ë‚´ë³´ë‚´ê¸°</button>
          <button class="btn" id="btnMemImport" data-i18n="settings.restore">ğŸ“¥ ê°€ì ¸ì˜¤ê¸°</button>
          <button class="btn" id="btnMemReset" data-i18n="settings.reset">ğŸ—‘ï¸ ì´ˆê¸°í™”</button>
        </div>
      </div>

      <div class="sep"></div>
      <div style="display:flex;justify-content:flex-end;gap:8px">
        <button class="btn" id="btnSettingsReset" data-i18n="settings.default">ê¸°ë³¸ê°’</button>
        <button class="btn" id="btnSettingsSave" data-i18n="settings.save">ì €ì¥</button>
      </div>
    </div>
  </div>

<script>
/* ================= I18N ================= */
const I18N = {
  ko:{brand:"ThinkHelper","tab.discover":"ğŸ“° ë””ìŠ¤ì»¤ë²„","tab.work":"ğŸ“ ì‘ì—…ì‹¤","tip.theme":"ë‹¤í¬/ë¼ì´íŠ¸ ì „í™˜(âŒ˜/Ctrl+J)","tip.help":"ë„ì›€ë§/ë‹¨ì¶•í‚¤","tip.settings":"í™˜ê²½ì„¤ì •","insight.today":"ì˜¤ëŠ˜ì˜ ì¸ì‚¬ì´íŠ¸","insight.hint":"ê´€ì‹¬ì‚¬ ì„¤ì • í›„ ë” ì •í™•í•œ í”¼ë“œê°€ ë³´ì—¬ìš”.","insight.apiNotice":"ì‹¤ì‹œê°„ ë‰´ìŠ¤ API ì‹¤íŒ¨, ìƒ˜í”Œ í”¼ë“œë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.","insight.openGnews":"Google ë‰´ìŠ¤ ì—´ê¸°","left.files":"ğŸ—‚ï¸ íŒŒì¼","left.templates":"ğŸ¨ í…œí”Œë¦¿","left.library":"ğŸ“š ë¼ì´ë¸ŒëŸ¬ë¦¬","left.search":"ğŸ” ê²€ìƒ‰ê¸°ë¡","btn.sync":"ğŸ”„ ì‚¬ì „ ë™ê¸°í™”","btn.new":"ï¼‹ ìƒˆ ë¬¸ì„œ","ai.title":"ğŸ¤– AI ë„ìš°ë¯¸","ai.toggle":"âˆ’","ai.welcome":"ì•ˆë…•! í•„ìš”í•œ í…œí”Œë¦¿ì„ ë„£ì–´ì£¼ê±°ë‚˜, ì„ íƒí•œ í…ìŠ¤íŠ¸ë¥¼ ìš”ì•½í•´ì¤„ê²Œ.","ai.placeholder":"ì˜ˆ) ì„ íƒ ë¶€ë¶„ ìš”ì•½í•´ì¤˜ / SWOT í‹€ ë„£ì–´ì¤˜","ai.send":"ì „ì†¡","status.words.prefix":"Words: ","status.saved":"ë¬¸ì„œ ìƒíƒœ: ì €ì¥ë¨","status.lang":"ì–¸ì–´: ","net.online":"ì˜¨ë¼ì¸","net.offline":"ì˜¤í”„ë¼ì¸","settings.title":"í™˜ê²½ì„¤ì •","settings.closeTip":"ë‹«ê¸°","settings.lang":"ê¸°ë³¸ ì–¸ì–´","settings.suggest":"ì¶”ì²œì–´(ìë™ì™„ì„±) ì‚¬ìš©","settings.personal":"ë§ì¶¤í˜• ì¶”ì²œ(í•™ìŠµ ë°˜ì˜) ì‚¬ìš©","settings.eye":"ì•„ì´ì»¨íƒ ëª¨ë“œ(ì¹´ë©”ë¼ ì ‘ê·¼) ì‚¬ìš©","settings.learnData":"í•™ìŠµ ë°ì´í„°","settings.backup":"ğŸ’¾ ë°±ì—… ë‚´ë³´ë‚´ê¸°","settings.restore":"ğŸ“¥ ê°€ì ¸ì˜¤ê¸°","settings.reset":"ğŸ—‘ï¸ ì´ˆê¸°í™”","settings.default":"ê¸°ë³¸ê°’","settings.save":"ì €ì¥","toast.eye.on":"ì•„ì´ì»¨íƒ ëª¨ë“œê°€ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤. (ë°ëª¨: ê¶Œí•œë§Œ í™•ë³´)","toast.eye.offDeny":"ì¹´ë©”ë¼ ì ‘ê·¼ì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.","toast.settingsSaved":"ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.","toast.mem.import.ok":"í•™ìŠµ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.","toast.mem.import.fail":"ê°€ì ¸ì˜¤ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. JSONì„ í™•ì¸í•˜ì„¸ìš”.","toast.mem.reset.ok":"í•™ìŠµ ë°ì´í„°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.","confirm.mem.reset":"ì •ë§ ì´ˆê¸°í™”í• ê¹Œìš”? (ë˜ëŒë¦´ ìˆ˜ ì—†ìŒ)"},
  ja:{brand:"ThinkHelper","tab.discover":"ğŸ“° ãƒ‡ã‚£ã‚¹ã‚«ãƒãƒ¼","tab.work":"ğŸ“ ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹","tip.theme":"ãƒ©ã‚¤ãƒˆ/ãƒ€ãƒ¼ã‚¯åˆ‡æ›¿(âŒ˜/Ctrl+J)","tip.help":"ãƒ˜ãƒ«ãƒ—/ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ","tip.settings":"è¨­å®š","insight.today":"ä»Šæ—¥ã®ã‚¤ãƒ³ã‚µã‚¤ãƒˆ","insight.hint":"é–¢å¿ƒåˆ†é‡ã‚’è¨­å®šã™ã‚‹ã¨ç²¾åº¦ãŒä¸ŠãŒã‚Šã¾ã™ã€‚","insight.apiNotice":"ãƒ‹ãƒ¥ãƒ¼ã‚¹APIã«æ¥ç¶šã§ãã¾ã›ã‚“ã€‚ã‚µãƒ³ãƒ—ãƒ«ãƒ•ã‚£ãƒ¼ãƒ‰ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚","insight.openGnews":"Google ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚’é–‹ã","left.files":"ğŸ—‚ï¸ ãƒ•ã‚¡ã‚¤ãƒ«","left.templates":"ğŸ¨ ãƒ†ãƒ³ãƒ—ãƒ¬","left.library":"ğŸ“š ãƒ©ã‚¤ãƒ–ãƒ©ãƒª","left.search":"ğŸ” æ¤œç´¢å±¥æ­´","btn.sync":"ğŸ”„ è¾æ›¸åŒæœŸ","btn.new":"ï¼‹ æ–°è¦ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ","ai.title":"ğŸ¤– AI ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ","ai.toggle":"âˆ’","ai.welcome":"å¿…è¦ãªãƒ†ãƒ³ãƒ—ãƒ¬ã‚’å…¥ã‚ŒãŸã‚Šã€é¸æŠç¯„å›²ã‚’è¦ç´„ã—ã¾ã™ã€‚","ai.placeholder":"ä¾‹) é¸æŠéƒ¨åˆ†ã‚’è¦ç´„ / SWOT ã‚’å…¥ã‚Œã¦","ai.send":"é€ä¿¡","status.words.prefix":"Words: ","status.saved":"ä¿å­˜æ¸ˆã¿","status.lang":"è¨€èª: ","net.online":"ã‚ªãƒ³ãƒ©ã‚¤ãƒ³","net.offline":"ã‚ªãƒ•ãƒ©ã‚¤ãƒ³","settings.title":"è¨­å®š","settings.closeTip":"é–‰ã˜ã‚‹","settings.lang":"æ—¢å®šã®è¨€èª","settings.suggest":"ã‚µã‚¸ã‚§ã‚¹ãƒˆã‚’ä½¿ã†","settings.personal":"ãƒ‘ãƒ¼ã‚½ãƒŠãƒ©ã‚¤ã‚º","settings.eye":"ã‚¢ã‚¤ã‚³ãƒ³ã‚¿ã‚¯ãƒˆ(ã‚«ãƒ¡ãƒ©)ä½¿ç”¨","settings.learnData":"å­¦ç¿’ãƒ‡ãƒ¼ã‚¿","settings.backup":"ğŸ’¾ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—","settings.restore":"ğŸ“¥ å¾©å…ƒ","settings.reset":"ğŸ—‘ï¸ åˆæœŸåŒ–","settings.default":"ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ","settings.save":"ä¿å­˜","toast.eye.on":"ã‚¢ã‚¤ã‚³ãƒ³ã‚¿ã‚¯ãƒˆã®æº–å‚™ãŒã§ãã¾ã—ãŸ(æ¨©é™ã®ã¿)ã€‚","toast.eye.offDeny":"ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚","toast.settingsSaved":"è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚","toast.mem.import.ok":"å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚","toast.mem.import.fail":"èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚JSONã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚","toast.mem.reset.ok":"å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‚’åˆæœŸåŒ–ã—ã¾ã—ãŸã€‚","confirm.mem.reset":"æœ¬å½“ã«åˆæœŸåŒ–ã—ã¾ã™ã‹ï¼Ÿ(å…ƒã«æˆ»ã›ã¾ã›ã‚“)"},
  en:{brand:"ThinkHelper","tab.discover":"ğŸ“° Discover","tab.work":"ğŸ“ Workspace","tip.theme":"Toggle Dark/Light (âŒ˜/Ctrl+J)","tip.help":"Help/Shortcuts","tip.settings":"Settings","insight.today":"Todayâ€™s Insights","insight.hint":"Set interests for a sharper feed.","insight.apiNotice":"News API failed. Showing sample feed.","insight.openGnews":"Open Google News","left.files":"ğŸ—‚ï¸ Files","left.templates":"ğŸ¨ Templates","left.library":"ğŸ“š Library","left.search":"ğŸ” Search History","btn.sync":"ğŸ”„ Sync Dict","btn.new":"ï¼‹ New Doc","ai.title":"ğŸ¤– AI Assistant","ai.toggle":"âˆ’","ai.welcome":"Hi! Drop a template or summarize any selection.","ai.placeholder":"e.g., Summarize selection / Insert SWOT","ai.send":"Send","status.words.prefix":"Words: ","status.saved":"Saved","status.lang":"Lang: ","net.online":"Online","net.offline":"Offline","settings.title":"Settings","settings.closeTip":"Close","settings.lang":"Default language","settings.suggest":"Use suggestions (autocomplete)","settings.personal":"Personalized suggestions","settings.eye":"Eye contact mode (camera)","settings.learnData":"Learning data","settings.backup":"ğŸ’¾ Export backup","settings.restore":"ğŸ“¥ Import","settings.reset":"ğŸ—‘ï¸ Reset","settings.default":"Defaults","settings.save":"Save","toast.eye.on":"Eye-contact mode ready (permission only).","toast.eye.offDeny":"Camera access denied.","toast.settingsSaved":"Settings saved.","toast.mem.import.ok":"Learning data imported.","toast.mem.import.fail":"Import failed. Check JSON.","toast.mem.reset.ok":"Learning data reset.","confirm.mem.reset":"Reset learning data? (Irreversible)"}
};
let LANG = (localStorage.getItem("th.ui.lang") || "ko");
function t(key){ const pack=I18N[LANG]||I18N.ko; return pack[key] ?? (I18N.ko[key]||key); }
function translateDOM(){
  document.querySelectorAll("[data-i18n]").forEach(el=>{ el.textContent = t(el.dataset.i18n); });
  document.querySelectorAll("[data-i18n-title]").forEach(el=>{ el.title = t(el.dataset.i18nTitle); });
  document.querySelectorAll("[data-i18n-placeholder]").forEach(el=>{ el.placeholder = t(el.dataset.i18nPlaceholder); });
  const wc=document.getElementById("wordCount");
  if(wc){ const prefix=t("status.words.prefix"); const count=wc.dataset.count||"0"; wc.textContent=prefix + count; }
  const netEl=document.getElementById("net");
  if(netEl){ netEl.textContent = navigator.onLine ? t("net.online") : t("net.offline"); }
  document.documentElement.lang = LANG;
  document.title = "ThinkHelper 2.1 â€” Workspace & Discover";
}
function setLang(newLang){
  LANG=newLang; localStorage.setItem("th.ui.lang", newLang);
  SETTINGS.langPref = newLang; save(SETTINGS_KEY, SETTINGS);
  MEM.langPref = newLang; persistMEM();
  translateDOM();
}

/* ========= Utils ========= */
const $ = (id)=>document.getElementById(id);
const sleep=(ms)=>new Promise(r=>setTimeout(r,ms));
function escapeHtml(s){return (s==null?"":String(s)).replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[m]));}
function plain(html){return (html||"").replace(/<[^>]+>/g," ").replace(/\s+/g," ").trim();}
function save(k,v){localStorage.setItem(k,JSON.stringify(v))}
function load(k,def){try{const v=JSON.parse(localStorage.getItem(k)||"null");return v??def;}catch{return def}}
function daysSince(ts){ if(!ts) return 9999; const d=(Date.now()-ts)/(1000*60*60*24); return Math.max(0, Math.floor(d)); }

/* ========= Settings ========= */
const DEFAULT_SETTINGS = { langPref: LANG||"ko", suggestOn: true, personalOn: true, eyeContactOn: false };
const SETTINGS_KEY = "th.settings";
let SETTINGS = Object.assign({}, DEFAULT_SETTINGS, load(SETTINGS_KEY, DEFAULT_SETTINGS));

/* ========= Modes ========= */
const tabDiscover=$("tabDiscover"), tabWorkspace=$("tabWorkspace");
const discover=$("discover"), workspace=$("workspace");
function setMode(m){
  const disc = (m==="discover");
  discover.dataset.active = disc?"1":"0";
  discover.style.display = disc ? "block" : "none";
  workspace.style.display = disc?"none":"grid";
  tabDiscover.setAttribute("aria-selected", disc?"true":"false");
  tabWorkspace.setAttribute("aria-selected", disc?"false":"true");
  if(window.matchMedia("(max-width: 480px)").matches){ $("quickbar").style.display = "flex"; }
}
tabDiscover.onclick=()=>setMode("discover");
tabWorkspace.onclick=()=>setMode("workspace");

/* Mobile quickbar */
$("qbDiscover").onclick=()=>setMode("discover");
$("qbWorkspace").onclick=()=>setMode("workspace");
$("qbNew").onclick=()=>{ newDoc(); if(editor){ editor.setData(""); $("starter")?.remove(); updateWordCount(); } };

/* ========= Theme & Network ========= */
$("btnTheme").onclick=()=>{ const root=document.documentElement; root.dataset.theme = root.dataset.theme==="dark"?"light":"dark"; };
function refreshNet(){ $("net").textContent = navigator.onLine ? t("net.online") : t("net.offline"); }
window.addEventListener('online',refreshNet); window.addEventListener('offline',refreshNet); refreshNet();

/* ========= Left panels ========= */
const tabsLeft = [
  {btn:$("tFiles"), panel:$("pFiles")},
  {btn:$("tTmpl"), panel:$("pTmpl")},
  {btn:$("tLib"),  panel:$("pLib")},
  {btn:$("tSearch"), panel:$("pSearch")}
];
tabsLeft.forEach(({btn,panel})=>{
  btn.onclick=()=>{ tabsLeft.forEach(tg=>{tg.btn.dataset.active="0"; tg.panel.dataset.active="0";}); btn.dataset.active="1"; panel.dataset.active="1"; };
});

/* ========= Data stores ========= */
const DB = {
  filesKey:"th.files",
  fileKey:(id)=>"th.file."+id,
  list(){return load(this.filesKey,[])},
  saveList(a){save(this.filesKey,a)},
  get(id){return load(this.fileKey(id),null)},
  set(id,o){save(this.fileKey(id),o)},
  del(id){localStorage.removeItem(this.fileKey(id))}
};
function renderFiles(){
  const box=$("fileList");
  const list = DB.list().sort((a,b)=>(b.updatedAt||0)-(a.updatedAt||0));
  box.innerHTML = list.length
    ? list.map(it=>`<div class="doc" data-id="${it.id}">
        <div class="ttl">${escapeHtml(it.title||"Untitled")}</div>
        <div class="date">${new Date(it.updatedAt||it.createdAt||Date.now()).toLocaleDateString(LANG==="ja"?"ja-JP":LANG==="en"?"en-US":"ko-KR")}</div>
      </div>`).join("")
    : `<div class="doc"><div class="ttl">${LANG==="en"?"No documents":LANG==="ja"?"ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãªã—":"ë¬¸ì„œ ì—†ìŒ"}</div></div>`;
  box.querySelectorAll('.doc').forEach(d=>d.onclick=()=>openDoc(d.dataset.id));
}
function renderLibrary(){
  const box=$("libList");
  const items = load("th.library",[]);
  const none = LANG==="en"?"No saved items":LANG==="ja"?"ä¿å­˜ã•ã‚ŒãŸã‚¹ã‚¯ãƒ©ãƒƒãƒ—ãªã—":"ì €ì¥ëœ ìŠ¤í¬ë© ì—†ìŒ";
  box.innerHTML = items.length? items.map((it)=>`<div class="doc">
    <div class="ttl">${escapeHtml(it.title|| (LANG==="en"?"Saved item":"ì €ì¥ í•­ëª©"))}</div>
    <div class="date" style="max-width:60%;overflow:hidden;text-overflow:ellipsis">${escapeHtml(it.url||"")}</div>
  </div>`).join("") : `<div class="doc"><div class="ttl">${none}</div></div>`;
}

/* Templates */
function renderTemplates(){
  const list = [
    {id:"swot", key:"tmpl.swot", body:`<h2>SWOT</h2><p><b>Strengths</b>:</p><p><b>Weaknesses</b>:</p><p><b>Opportunities</b>:</p><p><b>Threats</b>:</p>`},
    {id:"memo", key:"tmpl.memo", body:`<h2>Meeting Minutes</h2><p><b>Time</b>:</p><p><b>Attendees</b>:</p><p><b>Agenda</b>:</p><p><b>Notes</b>:</p><p><b>Action Items</b>:</p>`},
    {id:"press", key:"tmpl.press", body:`<h2>Press Release Title</h2><p>Subheadline</p><p><b>Overview</b>:</p><p><b>Key Message</b>:</p><p><b>Quote</b>:</p>`},
    {id:"resume", key:"tmpl.resume", body:`<div>...ì´ë ¥ì„œ í…œí”Œë¦¿...</div>`},
    {id:"cover", key:"tmpl.cover", body:`<div>...ìì†Œì„œ í…œí”Œë¦¿...</div>`},
    {id:"email", key:"tmpl.email", body:`<div>...ë©”ì¼ í…œí”Œë¦¿...</div>`},
    {id:"docs", key:"tmpl.docs", body:`<div>...Docs ìŠ¤íƒ€ì¼ í…œí”Œë¦¿...</div>`}
  ];
  $("tmplList").innerHTML = list.map(tpl=>`<div class="card" data-id="${tpl.id}">${t(tpl.key)}</div>`).join("");
  $("tmplList").querySelectorAll('.card').forEach(c=>c.onclick=()=>{
    const id=c.dataset.id; const row=list.find(x=>x.id===id);
    if(editor){ editor.setData(row.body); updateWordCount(); }
    setMode("workspace");
  });
}

/* Discover (fallback) */
const FALLBACK_FEED = [
  {title:"êµ­ë‚´ ë°˜ë„ì²´ ì—…ê³„, AI ê°€ì†ê¸° íˆ¬ì í™•ëŒ€", img:"https://picsum.photos/seed/semis/800/450", meta:"ì‚°ì—…Â·AI", desc:"HPC ìˆ˜ìš”ì— ë”°ë¼ ì°¨ì„¸ëŒ€ íŒ¨í‚¤ì§•ê³¼ ì „ë ¥ íš¨ìœ¨ ê¸°ìˆ ì— ëŒ€í•œ ê´€ì‹¬ì´ ì»¤ì§€ê³  ìˆë‹¤."},
  {title:"EU, ìƒì„±í˜• AI ê·œì œ ê°€ì´ë“œ ì—…ë°ì´íŠ¸", img:"https://picsum.photos/seed/eu/800/450", meta:"ì •ì±…", desc:"íˆ¬ëª…ì„±ê³¼ ì±…ì„ì„±ì´ ì¬ì •ë¹„ë˜ë©° ìŠ¤íƒ€íŠ¸ì—… ìƒŒë“œë°•ìŠ¤ í™•ëŒ€."},
  {title:"ì˜¤í”ˆì†ŒìŠ¤ LLM ê²½ëŸ‰í™”, ì˜¨ë””ë°”ì´ìŠ¤ ê²½ìŸ ë³¸ê²©í™”", img:"https://picsum.photos/seed/oss/800/450", meta:"ëª¨ë¸", desc:"4~8B ëª¨ë¸ë“¤ì´ ëª¨ë°”ì¼Â·ì—£ì§€ ìƒìš©ê¶Œìœ¼ë¡œ ì§„ì…."}
];
function gnewsUrl(title){
  const hl = LANG==="ja"?"ja":LANG==="en"?"en":"ko";
  const ceid = LANG==="ja"?"JP:ja":LANG==="en"?"US:en":"KR:ko";
  const gl = LANG==="ja"?"JP":LANG==="en"?"US":"KR";
  return "https://news.google.com/search?q="+encodeURIComponent(title||"")+"&hl="+hl+"&gl="+gl+"&ceid="+ceid;
}
function renderDiscoverCards(list){
  $("discoverGrid").innerHTML = list.map((it,i)=>{
    const gnews = gnewsUrl(it.title);
    const openTxt = LANG==="en"?"Open source":"ì›ë¬¸ë³´ê¸°";
    const toDocTxt = LANG==="en"?"New doc":"ìƒˆ ê¸€ì“°ê¸°";
    const toLibTxt = LANG==="en"?"Library":"ë¼ì´ë¸ŒëŸ¬ë¦¬";
    const analyzeTxt = LANG==="en"?"Summarize/Analyze":"ìš”ì•½/ë¶„ì„";
    return `
      <div class="news" data-i="${i}">
        <img src="${it.img}" alt="">
        <div class="meta">${escapeHtml(it.meta||"")}</div>
        <div class="title">${escapeHtml(it.title)}</div>
        <div class="desc">${escapeHtml(it.desc||"")}</div>
        <div class="actions">
          <button class="btn addLib">ğŸ“š ${escapeHtml(toLibTxt)}</button>
          <a class="btn" href="${gnews}" target="_blank" rel="noopener">ğŸ”— ${escapeHtml(openTxt)}</a>
          <button class="btn toAI">ğŸ¤– ${escapeHtml(analyzeTxt)}</button>
          <button class="btn newDoc">âœï¸ ${escapeHtml(toDocTxt)}</button>
        </div>
      </div>`;
  }).join("");
  document.querySelectorAll('.news .addLib').forEach((b,idx)=>{
    b.onclick=()=>{ const it=list[idx]; const g=gnewsUrl(it.title);
      const ar=load("th.library",[]); ar.unshift({title:it.title,url:g,ts:Date.now()}); save("th.library",ar);
      renderLibrary(); setMode("workspace"); tabsLeft.forEach(t=>t.btn.dataset.active="0"); $("tLib").dataset.active="1"; $("pLib").dataset.active="1";
    };
  });
  document.querySelectorAll('.news .toAI').forEach((b,idx)=>{
    b.onclick=()=>{ const it=list[idx];
      setMode("workspace"); addAI(`ì´ ê¸°ì‚¬ ìš”ì•½í•´ì¤˜:\n${it.title}\n${gnewsUrl(it.title)}`, true);
    };
  });
  document.querySelectorAll('.news .newDoc').forEach((b,idx)=>{
    b.onclick=()=>{ const it=list[idx]; const g=gnewsUrl(it.title);
      setMode("workspace"); newDoc(`ìƒˆ ê¸€: ${it.title}`);
      if(editor){
        editor.setData(`<h2>${escapeHtml(it.title)}</h2><p><a href="${g}" target="_blank" rel="noopener">Google ë‰´ìŠ¤ì—ì„œ ë³´ê¸°</a></p><p>ì—¬ê¸°ì„œë¶€í„° ë¶„ì„ì„ ì‹œì‘í•˜ì„¸ìš”â€¦</p>`);
        updateWordCount(); updateTitleBar();
      }
    };
  });
}
function renderDiscover(){ renderDiscoverCards(FALLBACK_FEED); }

/* ========= Real-time local learning ========= */
const MEM_KEY = 'th.mem';
const DEFAULT_MEM = { acceptCounts:{}, lastUsedAt:{}, perDoc:{}, userDict:{ko:[],ja:[],en:[]}, docFreq:{}, langPref: SETTINGS.langPref || LANG };
let MEM = Object.assign({}, DEFAULT_MEM, load(MEM_KEY, DEFAULT_MEM));
function persistMEM(){ save(MEM_KEY, MEM); }

/* ========= Editor ========= */
let editor=null, curDocId=null;
ClassicEditor.create($("editor"),{
  placeholder: (LANG==="en"?"Start writingâ€¦ e.g., competitor analysis":"ì—¬ê¸°ì„œ ì‘ì„±í•˜ì„¸ìš”â€¦ (ì˜ˆ: ê²½ìŸì‚¬ ë¶„ì„, íšŒì˜ë¡, ë³´ë„ìë£Œ)")
}).then(ed=>{
  editor=ed;
  editor.model.document.on('change:data', ()=>{ saveDoc(); updateWordCount(); scheduleScanTF(); updateTitleBar(); });
  setupAutocomplete();  // ìë™ì™„ì„± ì´ˆê¸°í™”
  updateWordCount();
}).catch(console.error);

function updateWordCount(){
  const count=(plain(editor?editor.getData():"").split(/\s+/).filter(Boolean).length||0);
  const wc=$("wordCount");
  wc.dataset.count = String(count);
  wc.textContent = t("status.words.prefix") + count;
}
function updateTitleBar(){
  const d = curDocId ? DB.get(curDocId) : null;
  $("docTitleBar").textContent = d?.title || "ë¬´ì œ";
}

/* Files */
function newDoc(title= (LANG==="en"?"Untitled":"ë¬´ì œ")){
  const id="d_"+Date.now();
  curDocId=id;
  const row={id,createdAt:Date.now(),updatedAt:Date.now(),title,html:""};
  DB.set(id,row); DB.saveList([row,...DB.list()]); renderFiles();
  if(!MEM.perDoc[id]) MEM.perDoc[id] = {acceptCounts:{}, lastUsedAt:{}}; if(!MEM.docFreq[id]) MEM.docFreq[id] = {};
  persistMEM(); updateTitleBar();
}
function openDoc(id){
  const d=DB.get(id); if(!d||!editor) return;
  curDocId=id; editor.setData(d.html||""); updateWordCount();
  if(!MEM.perDoc[id]) MEM.perDoc[id] = {acceptCounts:{}, lastUsedAt:{}}; if(!MEM.docFreq[id]) MEM.docFreq[id] = {};
  persistMEM(); updateTitleBar();
}
function saveDoc(){
  if(!editor||!curDocId) return;
  const d=DB.get(curDocId); if(!d) return;
  const html=editor.getData(); if(d.html===html) return;
  d.html=html; d.updatedAt=Date.now();
  const txt=plain(html);
  if(!d.title||/^ë¬´ì œ$|^Untitled$/.test(d.title)){
    const fallback = LANG==="en"?"Untitled":"ë¬´ì œ";
    d.title=(txt.split(" ").slice(0,8).join(" ")||fallback);
  }
  DB.set(curDocId,d);
  DB.saveList(DB.list().map(x=>x.id===curDocId?{id:curDocId,createdAt:d.createdAt,updatedAt:d.updatedAt,title:d.title}:x));
  $("docState").textContent=t("status.saved");
}

/* ========= Tokenization & learning ========= */
const DICT_KO_BASE = ["ë¶„ì„","ì—°êµ¬","ê²°ê³¼","ë°©ë²•","ê³¼ì •","ê²°ë¡ ","ì°¸ê³ ","ì¶œì²˜","ë°ì´í„°","ìš”ì•½","ì¢…í•©","í•œê³„","ì „ë§","ìŸì ","ë²•ë¦¬","íŒë¡€","í˜•ë²•","í˜•ì‚¬ì†Œì†¡ë²•","ëŒ€ë²•ì›","ìš”ì§€","ì‚¬ì‹¤ê´€ê³„","ìŸì ì •ë¦¬","ì•Œê³ ë¦¬ì¦˜","í”„ë¡œí† íƒ€ì…","ì»¨í…ìŠ¤íŠ¸","í† í°","ì„ë² ë”©","ì˜¤í”„ë¼ì¸","ìºì‹œ","ìŠ¤ë ˆë“œ","ë¹„ë™ê¸°","ì´ë²¤íŠ¸ë£¨í”„","ë Œë”ë§","ì„±ëŠ¥ìµœì í™”"];
const JA_ROWS = [["ã‚","ã„","ã†","ãˆ","ãŠ"],["ã‹","ã","ã","ã‘","ã“"],["ã•","ã—","ã™","ã›","ã"],["ãŸ","ã¡","ã¤","ã¦","ã¨"],["ãª","ã«","ã¬","ã­","ã®"],["ã¯","ã²","ãµ","ã¸","ã»"],["ã¾","ã¿","ã‚€","ã‚","ã‚‚"],["ã‚„","ã‚†","ã‚ˆ"],["ã‚‰","ã‚Š","ã‚‹","ã‚Œ","ã‚"],["ã‚","ã‚’","ã‚“"]];
const DICT_JA_BASE = ["ã‚ã‚“ãªã„","ã‚ã‚“ãœã‚“","ã„ã‚“ã—ã‚‡ã†","ã†ã‘ã¤ã‘","ãˆã„ãã‚‡ã†","ãŠã—ã‚‰ã›","ã‹ã„ã›ã¤","ãã‚ã","ãã¹ã¤","ã‘ã‚“ã•ã","ã“ã†ã›ã„","ã“ãŸãˆ","ã•ãã‚‡ã†","ã—ã‚…ã†ã‚ã","ã™ã„ã—ã‚‡ã†","ã›ã¤ã‚ã„","ãã†ã•","ãã—ã","ãŸã„ãŠã†","ã¡ã‚…ã†ã„","ã¤ã„ã‹","ã¦ã„ã‚ã‚“","ã¨ã†ã‚ã","ã¨ã‚Šã¾ã¨ã‚","ãªã„ã‚ˆã†","ã«ã‚“ã—ã","ã¬ã‘ã‚‚ã‚Œ","ã­ã‚“ã—ã‚‡","ã®ã†ã‚Šã‚‡ã","ã¯ã£ã´ã‚‡ã†","ã²ã‚‡ã†ã‹","ãµãã›ã„","ã¸ã‚“ã“ã†","ã»ãã‚“","ã¿ãªãŠã—","ã¿ã¨ãŠã—","ã‚€ã ","ã‚ã„ã‚Œã„","ã‚‚ã†ã—ã“ã¿","ã‚„ãã‚ã‚Š","ã‚†ã†ã›ã‚“","ã‚ˆã†ã‘ã‚“","ã‚‰ã‚“ãã‚“ã","ã‚Šã‚ˆã†","ã‚‹ãƒ¼ã‚‹","ã‚Œã‚“ã‘ã„","ã‚ãƒ¼ã©ã¾ã£ã·","ã‚ã‹ã‚Šã‚„ã™ã„","ã‚’ã¤ã‘ã‚‹","ã‚“ã—ã‚‡ã†"];
const DICT_EN_BASE = ["analysis","baseline","benchmark","context","dataset","design","embedding","evaluation","fallback","feature","guide","heuristic","insight","journey","knowledge","latency","model","note","optimize","pipeline","quality","research","summary","template","unit-test","validation","workflow","x-factor","yield","zero-copy"];
const STOP_KO = new Set(["ê·¸ë¦¬ê³ ","ê·¸ëŸ¬ë‚˜","í•˜ì§€ë§Œ","ë˜","ë˜ëŠ”","ë°","ì´ë‹¤","í•˜ëŠ”","í•˜ê²Œ","ì—ì„œ","ìœ¼ë¡œ","ì—ê²Œ","ë¶€í„°","ê¹Œì§€","ë³´ë‹¤","ë³´ë‹¤ë„","ìˆ˜","ê²ƒ","ë“±","ë•Œ"]);
const STOP_EN = new Set(["the","a","an","and","or","to","of","in","on","for","by","with","is","are","this","that","it","be","as","at","from","was","were","will","can","not","we","you","i"]);
function extractTokens(text){
  const out = {ko:[], ja:[], en:[]};
  const ko = text.match(/[ê°€-í£]{2,}/g) || []; out.ko = ko.filter(w=>!STOP_KO.has(w) && w.length<=20);
  const ja = text.match(/[\u3040-\u30FF\u4E00-\u9FFF]{2,}/g) || []; out.ja = ja.slice(0,500);
  const en = text.match(/[A-Za-z][A-Za-z\-]{2,}/g) || []; out.en = en.map(w=>w.toLowerCase()).filter(w=>!STOP_EN.has(w) && w.length<=24);
  return out;
}
let tfScanTimer=null;
function scheduleScanTF(){ if(tfScanTimer) clearTimeout(tfScanTimer); tfScanTimer = setTimeout(scanAndUpdateUserDict, 1200); }
function scanAndUpdateUserDict(){
  if(!editor||!curDocId) return;
  const text = plain(editor.getData());
  const toks = extractTokens(text);
  const freq = {};
  [...toks.ko, ...toks.ja, ...toks.en].forEach(w=>{ freq[w]=(freq[w]||0)+1; });
  MEM.docFreq[curDocId] = freq;

  const caps = {ko:400, ja:400, en:400};
  ['ko','ja','en'].forEach(lang=>{
    const base = lang==='ko'?DICT_KO_BASE: lang==='ja'?DICT_JA_BASE: DICT_EN_BASE;
    const set = new Set(MEM.userDict[lang]||[]);
    const candidates = Object.entries(freq)
      .filter(([w])=>{
        const isLang = (lang==='ko'&&/[ê°€-í£]/.test(w)) || (lang==='ja'&&/[\u3040-\u30FF\u4E00-\u9FFF]/.test(w)) || (lang==='en'&&/^[A-Za-z]/.test(w));
        return isLang && !base.includes(w);
      })
      .sort((a,b)=>b[1]-a[1]).slice(0,50);
    for(const [w] of candidates){ set.add(w); if(set.size>caps[lang]) break; }
    MEM.userDict[lang] = Array.from(set).slice(0,caps[lang]);
  });
  persistMEM();
}
function decay(count, lastTs){ const d = daysSince(lastTs); return (count||0) * Math.pow(0.99, d); }
function scoreWord(word){
  const g = decay(MEM.acceptCounts[word]||0, MEM.lastUsedAt[word]||0);
  let docScore = 0;
  if(curDocId && MEM.perDoc[curDocId]){
    const pd = MEM.perDoc[curDocId];
    docScore = 1.2 * decay((pd.acceptCounts[word]||0), (pd.lastUsedAt[word]||0));
  }
  const freq = (curDocId && MEM.docFreq[curDocId] && MEM.docFreq[curDocId][word]) ? MEM.docFreq[curDocId][word] : 0;
  const freqScore = 0.2 * Math.min(5, freq);
  return g + docScore + freqScore;
}
function bump(word){
  if(!SETTINGS.personalOn) return;
  MEM.acceptCounts[word] = (MEM.acceptCounts[word]||0)+1;
  MEM.lastUsedAt[word] = Date.now();
  if(curDocId){
    if(!MEM.perDoc[curDocId]) MEM.perDoc[curDocId]={acceptCounts:{}, lastUsedAt:{}};
    MEM.perDoc[curDocId].acceptCounts[word] = (MEM.perDoc[curDocId].acceptCounts[word]||0)+1;
    MEM.perDoc[curDocId].lastUsedAt[word] = Date.now();
  }
  persistMEM();
}
function orderBySmart(list){ if(!SETTINGS.personalOn) return list.slice(); return list.slice().sort((a,b)=>{ const sa=scoreWord(a), sb=scoreWord(b); if(sb!==sa) return sb-sa; return a.localeCompare(b); }); }
function orderJAByRow(list){
  return list.slice().sort((a,b)=>{
    const fa=(a[0]||""), fb=(b[0]||"");
    const ra=JA_ROWS.findIndex(row=>row.includes(fa));
    const rb=JA_ROWS.findIndex(row=>row.includes(fb));
    return (ra<0?99:ra)-(rb<0?99:rb) || a.localeCompare(b);
  });
}
function currentLangFromCaret(){
  const sel=window.getSelection(); if(!sel||sel.rangeCount===0) return SETTINGS.langPref||"ko";
  const r=sel.getRangeAt(0).cloneRange(); const node=r.startContainer;
  if(!node||node.nodeType!==Node.TEXT_NODE) return SETTINGS.langPref||"ko";
  const s=(node.textContent||"").slice(0,r.startOffset); if(!s) return SETTINGS.langPref||"ko";
  const ch=s.slice(-1);
  if(/[ê°€-í£]/.test(ch)) return "ko";
  if(/[A-Za-z]/.test(ch)) return "en";
  if(/[\u3040-\u30FF\u4E00-\u9FFF]/.test(ch)) return "ja";
  return SETTINGS.langPref||"ko";
}
function getPrefix(){
  const sel=window.getSelection(); if(!sel||sel.rangeCount===0) return "";
  const r=sel.getRangeAt(0).cloneRange();
  const node=r.startContainer; if(!node||node.nodeType!==Node.TEXT_NODE) return "";
  const txt=node.textContent||""; const pos=r.startOffset||0;
  const left=txt.slice(0,pos);
  const m=left.match(/[\p{L}\p{N}_\-]{1,32}$/u);
  return m?m[0]:"";
}
function filterDict(prefix, lang){
  if(!SETTINGS.suggestOn) return [];
  const p=prefix.toLowerCase();
  let pool=[];
  if(lang==="ko"){
    pool = [...new Set([ ...MEM.userDict.ko, ...DICT_KO_BASE ])];
    const base = pool.filter(w=>w.toLowerCase().startsWith(p));
    return orderBySmart(base).slice(0,8);
  }
  if(lang==="ja"){
    pool = [...new Set([ ...MEM.userDict.ja, ...DICT_JA_BASE ])];
    const base = pool.filter(w=> w.startsWith(prefix) || w.toLowerCase().startsWith(p));
    return orderJAByRow(orderBySmart(base)).slice(0,8);
  }
  pool = [...new Set([ ...MEM.userDict.en, ...DICT_EN_BASE ])];
  const base = pool.filter(w=>w.toLowerCase().startsWith(p));
  return orderBySmart(base).slice(0,8);
}

/* ========= VS Code Style Autocomplete ========= */
let suggestionBox = null;
let selectedIndex = 0;
let currentCandidates = [];

function setupAutocomplete() {
  // 1) DOM ìƒì„±
  if (!suggestionBox) {
    suggestionBox = document.createElement('div');
    suggestionBox.id = 'suggestionBox';
    document.body.appendChild(suggestionBox);
  }

  const viewDoc = editor.editing.view.document;

  // 2) í‚¤ë³´ë“œ ì¸í„°ì…‰íŠ¸
  viewDoc.on('keydown', (evt, data) => {
    if (suggestionBox.style.display !== 'block') return;

    if (data.keyCode === 38) { // Up
      evt.stop(); data.preventDefault();
      selectedIndex = (selectedIndex > 0) ? selectedIndex - 1 : currentCandidates.length - 1;
      renderList();
    } else if (data.keyCode === 40) { // Down
      evt.stop(); data.preventDefault();
      selectedIndex = (selectedIndex < currentCandidates.length - 1) ? selectedIndex + 1 : 0;
      renderList();
    } else if (data.keyCode === 9 || data.keyCode === 13) { // Tab or Enter
      evt.stop(); data.preventDefault();
      applySuggestion(currentCandidates[selectedIndex]);
    } else if (data.keyCode === 27) { // Esc
      evt.stop(); data.preventDefault();
      closeSuggestion();
    }
  }, { priority: 'highest' });

  // 3) íƒ€ì´í•‘ â†’ ëª©ë¡ ê°±ì‹ /í‘œì‹œ
  viewDoc.on('keyup', () => {
    const lg = currentLangFromCaret();
    $("langGuess").textContent = lg;

    const prefix = getPrefix();
    if (!prefix || prefix.length < 1) { closeSuggestion(); return; }

    const list = filterDict(prefix, lg);
    if (list.length > 0) {
      currentCandidates = list;
      selectedIndex = 0;
      showSuggestion(list); // ê°œì„ íŒ í˜¸ì¶œ
    } else {
      closeSuggestion();
    }
  });
}

function renderList() {
  if (!currentCandidates.length) return;
  let html = '<ul>';
  currentCandidates.forEach((word, idx) => {
    const activeClass = (idx === selectedIndex) ? 'active' : '';
    html += `<li class="${activeClass}" onclick="applySuggestion('${word.replace(/'/g,"&#39;")}')">${word}</li>`;
  });
  html += '</ul>';
  suggestionBox.innerHTML = html;
}

// í™”ë©´ì— ë°•ìŠ¤ ë„ìš°ê¸° (ìœ„ì¹˜ ê³„ì‚° ë¡œì§ ê°œì„ íŒ)
function showSuggestion(list) {
  renderList();

  // 1. ë°•ìŠ¤ë¥¼ ì¼ë‹¨ ë³´ì´ê²Œ í•¨ (ê·¸ë˜ì•¼ ì¢Œí‘œ ê³„ì‚° ê°€ëŠ¥)
  suggestionBox.style.display = 'block';

  try {
    // 2. CKEditorì˜ View(ê°€ìƒë”) -> Native DOM(ë¸Œë¼ìš°ì €ë”) ë³€í™˜ê¸°
    const domConverter = editor.editing.view.domConverter;
    const viewSelection = editor.editing.view.document.selection;
    const viewRange = viewSelection.getFirstRange();

    if (!viewRange) return;

    // 3. ê°€ìƒ ë²”ìœ„ë¥¼ ë¸Œë¼ìš°ì €ì˜ ì‹¤ì œ Rangeë¡œ ë³€í™˜
    const domRange = domConverter.viewRangeToDom(viewRange);

    // 4. ì‹¤ì œ í™”ë©´ìƒì˜ ì¢Œí‘œ(Rect) ì¶”ì¶œ
    const rect = domRange.getBoundingClientRect();

    // 5. ì¢Œí‘œê°€ ìœ íš¨í•œì§€ í™•ì¸ (0ì´ë©´ ì‹¤íŒ¨í•œ ê²ƒ)
    if (rect && rect.left !== 0 && rect.top !== 0) {
      // ìŠ¤í¬ë¡¤ ìœ„ì¹˜ê¹Œì§€ ê³ ë ¤í•´ì„œ ì ˆëŒ€ ì¢Œí‘œ ê³„ì‚°
      const topPos = rect.bottom + window.scrollY + 5;
      const leftPos = rect.left + window.scrollX;

      suggestionBox.style.top = topPos + 'px';
      suggestionBox.style.left = leftPos + 'px';
    } else {
      // ì¢Œí‘œë¥¼ ëª» ì°¾ìœ¼ë©´(ì´ˆê¸° ë¡œë”© ë“±) ì¼ë‹¨ ìˆ¨ê¹€
      suggestionBox.style.display = 'none';
    }
  } catch (e) {
    console.error("ì¢Œí‘œ ê³„ì‚° ì‹¤íŒ¨:", e);
    suggestionBox.style.display = 'none';
  }
}

function closeSuggestion() {
  if (suggestionBox) suggestionBox.style.display = 'none';
  currentCandidates = [];
  selectedIndex = 0;
}

function applySuggestion(word) {
  if (!word) return;
  const prefix = getPrefix();

  editor.model.change(writer => {
    const selRange = editor.model.document.selection.getFirstRange();
    const start = selRange.start;
    const deleteRange = writer.createRange(start.getShiftedBy(-prefix.length), start);
    writer.remove(deleteRange);
    writer.insertText(word, editor.model.document.selection.getFirstPosition());
  });

  closeSuggestion();
  bump(word);
}

/* ========= AI Assistant (mock) ========= */
const aiBox=$("aiBox");
function addBubble(text,me){ const div=document.createElement('div'); div.className="bubble "+(me?"me":"ai"); div.textContent=text; aiBox.appendChild(div); aiBox.scrollTop=aiBox.scrollHeight; }
function addAI(text,fromDiscover=false){
  addBubble(text,true);
  const lang = currentLangFromCaret() || SETTINGS.langPref || LANG || "ko";
  const reply =
    lang==="ko" ? `ì¢‹ì•„! ${fromDiscover?"í”¼ë“œ ì´ìŠˆ ê¸°ë°˜ìœ¼ë¡œ ":""}ì¹œê·¼í•˜ê³  ê°„ê²°í•˜ê²Œ ë‹µë³€í• ê²Œ.\n- ì„ íƒ ì˜ì—­ì´ ìˆìœ¼ë©´ ìš”ì•½í•´ì„œ ë¶™ì—¬ì¤„ê²Œ.\n- "SWOT"ë¼ê³  ë§í•˜ë©´ í‹€ì„ ë„£ì–´ì¤„ê²Œ.` :
    lang==="ja" ? `äº†è§£ã§ã™ï¼${fromDiscover?"ãƒ•ã‚£ãƒ¼ãƒ‰ã®è©±é¡Œã«åŸºã¥ã ":""}ä¸å¯§ã§ç°¡æ½”ã«è¿”ç­”ã—ã¾ã™ã€‚\nãƒ»é¸æŠç¯„å›²ãŒã‚ã‚Œã°è¦ç´„ã—ã¾ã™ã€‚\nãƒ»ã€ŒSWOTã€ã§ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’æŒ¿å…¥ã—ã¾ã™ã€‚` :
    `Got it! ${fromDiscover?"Based on the feed ":""}I'll reply concise & friendly.\n- If there's a selection, I'll summarize it.\n- Say "SWOT" to insert the template.`;
  addBubble(reply,false);
}
$("aiForm").addEventListener("submit",(e)=>{ e.preventDefault(); const v=$("aiInput").value.trim(); if(!v) return; $("aiInput").value=""; addAI(v,false); });
$("aiToggle").onclick=()=>{ const box=$("aiBox"); if(box.style.display==="none"){ box.style.display="flex"; $("aiToggle").textContent="âˆ’"; } else { box.style.display="none"; $("aiToggle").textContent="ï¼‹"; } };

/* ========= Tips ========= */
const tipsKO = ["Tab=ìë™ì™„ì„± Â· Esc=ë‹«ê¸° Â· â†‘/â†“=ì´ë™","âŒ˜/Ctrl+B=êµµê²Œ, âŒ˜/Ctrl+I=ê¸°ìš¸ì„","âŒ˜/Ctrl+K=ë§í¬, âŒ˜/Ctrl+Z=ë˜ëŒë¦¬ê¸°","Shift+Enter=ì¤„ë°”ê¿ˆ, Enter=ìƒˆ ë¬¸ë‹¨"];
const tipsJA = ["Tab/Enter=ã‚µã‚¸ã‚§ã‚¹ãƒˆç¢ºå®š Â· Esc=é–‰ã˜ã‚‹","âŒ˜/Ctrl+B=å¤ªå­—, âŒ˜/Ctrl+I=æ–œä½“","âŒ˜/Ctrl+K=ãƒªãƒ³ã‚¯, âŒ˜/Ctrl+Z=å…ƒã«æˆ»ã™","Shift+Enter=æ”¹è¡Œ, Enter=æ–°æ®µè½"];
const tipsEN = ["Tab/Enter=Accept suggestion Â· Esc=Close","âŒ˜/Ctrl=B=Bold, âŒ˜/Ctrl=I=Italic","âŒ˜/Ctrl=K=Link, âŒ˜/Ctrl=Z=Undo","Shift+Enter=Line break, Enter=New paragraph"];
function rotateTips(){ const arr = LANG==="ja"?tipsJA:LANG==="en"?tipsEN:tipsKO; let i=0; setInterval(()=>{ $("tipText").textContent=arr[i=(i+1)%arr.length]; }, 5000); }

/* ========= Search ========= */
function resolveSearchTarget(raw){
  const q = (raw||"").trim();
  if(!q) return null;
  const s = q.toLowerCase();
  const has = (...words)=>words.some(w=> q.includes(w) || s.includes(w));
  if (has("ë„¤ì´ë²„","naver")) return "https://www.naver.com/";
  if (has("ì¿ íŒ¡","coupang")) return "https://www.coupang.com/";
  if (has("ì•„ë§ˆì¡´","amazon")) return "https://www.amazon.com/";
  if (has("êµ­ê°€ë²•ë ¹ì •ë³´ì„¼í„°","law.go.kr")) return "https://www.law.go.kr/";
  try{
    let url = q;
    if (!/^https?:\/\//i.test(url) && /^[\w\-]+(\.[\w\-]+)+/.test(url)) url = "https://" + url;
    const u = new URL(url);
    if (u.hostname) return u.toString();
  }catch(_){}
  return "https://www.google.com/search?q=" + encodeURIComponent(q);
}
function openInNewTab(url){ window.open(url, "_blank", "noopener"); }
const SEARCH_KEY = "th.search.history";
function getSearchHistory(){ return load(SEARCH_KEY, []); }
function setSearchHistory(list){ save(SEARCH_KEY, list); }
function addSearchQuery(q){
  if(!q) return;
  const now = Date.now();
  let list = getSearchHistory().filter(it=>it.q!==q);
  list.unshift({ q, ts: now });
  if(list.length>100) list = list.slice(0,100);
  setSearchHistory(list);
  renderSearchHistory();
}
function deleteSearchQuery(q){ const list = getSearchHistory().filter(it=>it.q!==q); setSearchHistory(list); renderSearchHistory(); }
function clearSearchHistory(){ setSearchHistory([]); renderSearchHistory(); }
function renderSearchHistory(){
  const box = $("searchList");
  const list = getSearchHistory();
  if(!list.length){ box.innerHTML = `<div class="doc"><div class="ttl">ê²€ìƒ‰ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div></div>`; return; }
  box.innerHTML = list.map(it=>{
    const date = new Date(it.ts).toLocaleString(LANG==="ja"?"ja-JP":LANG==="en"?"en-US":"ko-KR");
    return `<div class="srow" data-q="${escapeHtml(it.q)}" title="${escapeHtml(it.q)}">
      <div class="q"><span class="icon">ğŸ”</span><span class="text" style="overflow:hidden;text-overflow:ellipsis">${escapeHtml(it.q)}</span><span class="meta">${date}</span></div>
      <button class="del" title="ì‚­ì œ">âœ•</button>
    </div>`;
  }).join("");
  box.querySelectorAll(".srow").forEach(row=>{
    const q = row.dataset.q;
    row.addEventListener("click", (e)=>{
      if(e.target.closest(".del")) return;
      openSearch(q);
    }, {passive:true});
    row.querySelector(".del").addEventListener("click",(e)=>{ e.stopPropagation(); deleteSearchQuery(q); });
  });
}
function openSearch(q){
  const url = resolveSearchTarget(q);
  if(url) openInNewTab(url);
}
const leftSearchInput = $("leftSearchInput");
$("leftSearchBtn").addEventListener("click", ()=>{
  const q = leftSearchInput.value.trim(); if(!q) return;
  addSearchQuery(q);
  tabsLeft.forEach(t=>{ t.btn.dataset.active="0"; t.panel.dataset.active="0"; });
  $("tSearch").dataset.active="1"; $("pSearch").dataset.active="1";
  openSearch(q);
  leftSearchInput.value = "";
});
leftSearchInput.addEventListener("keydown",(e)=>{ if(e.key==="Enter"){ e.preventDefault(); $("leftSearchBtn").click(); }});
$("btnClearSearch").addEventListener("click", clearSearchHistory);

/* New Doc */
$("btnNewDocLeft").onclick=()=>{ newDoc(); if(editor){ editor.setData(""); updateWordCount(); updateTitleBar(); } };

/* Footer dict sync */
const btnSyncDict = document.createElement("button");
btnSyncDict.className = "btn";
btnSyncDict.textContent = t("btn.sync");
btnSyncDict.title = "ë¬¸ì„œì—ì„œ ì‚¬ìš©ì ì‚¬ì „ ë™ê¸°í™”";
btnSyncDict.style.marginLeft = "auto";
document.querySelector(".status-right")?.appendChild(btnSyncDict);
btnSyncDict.onclick=()=>{ scanAndUpdateUserDict(); alert(LANG==="en"?'Dictionary synced from document.':LANG==="ja"?'æ–‡æ›¸ã‹ã‚‰è¾æ›¸ã‚’åŒæœŸã—ã¾ã—ãŸã€‚':'ë¬¸ì„œ ë‚´ìš© ê¸°ë°˜ ì‚¬ìš©ì ì‚¬ì „ì„ ë™ê¸°í™”í–ˆì–´ìš”.'); };

/* Help */
$("btnHelp").onclick=()=>{ alert('ë‹¨ì¶•í‚¤ ìš”ì•½:\\n- Tab/Enter: ìë™ì™„ì„± ìˆ˜ë½\\n- Esc: íŒì—… ë‹«ê¸°\\n- â†‘/â†“: ì¶”ì²œ ì´ë™\\n- âŒ˜/Ctrl+B: êµµê²Œ, âŒ˜/Ctrl+I: ê¸°ìš¸ì„\\n- Shift+Enter: ì¤„ë°”ê¿ˆ'); };

/* Settings modal */
const modal=$("settingsModal"), backdrop=$("backdrop");
function openSettings(){
  $("selLang").value = SETTINGS.langPref;
  $("toggleSuggest").checked = !!SETTINGS.suggestOn;
  $("togglePersonal").checked = !!SETTINGS.personalOn;
  $("toggleEye").checked = !!SETTINGS.eyeContactOn;
  modal.style.display="flex"; backdrop.style.display="block";
}
function closeSettings(){ modal.style.display="none"; backdrop.style.display="none"; }
$("btnSettings").onclick = (e)=>{ e.preventDefault(); openSettings(); };
$("btnCloseSettings").onclick = closeSettings;
backdrop.onclick = closeSettings;
$("btnSettingsReset").onclick=()=>{
  SETTINGS = Object.assign({}, DEFAULT_SETTINGS);
  $("selLang").value = SETTINGS.langPref;
  $("toggleSuggest").checked = SETTINGS.suggestOn;
  $("togglePersonal").checked = SETTINGS.personalOn;
  $("toggleEye").checked = SETTINGS.eyeContactOn;
  setLang(SETTINGS.langPref);
};
$("btnSettingsSave").onclick=async ()=>{
  const prevEye = SETTINGS.eyeContactOn;
  SETTINGS.langPref = $("selLang").value;
  SETTINGS.suggestOn = $("toggleSuggest").checked;
  SETTINGS.personalOn = $("togglePersonal").checked;
  const newEye = $("toggleEye").checked;
  setLang(SETTINGS.langPref);
  $("langGuess").textContent = SETTINGS.langPref;
  if(newEye && !prevEye){
    try{ await navigator.mediaDevices.getUserMedia({video:true}); SETTINGS.eyeContactOn = true; alert(t("toast.eye.on")); }
    catch(err){ SETTINGS.eyeContactOn = false; $("toggleEye").checked = false; alert(t("toast.eye.offDeny")); }
  }else{ SETTINGS.eyeContactOn = newEye; }
  save(SETTINGS_KEY, SETTINGS);
  MEM.langPref = SETTINGS.langPref; persistMEM();
  closeSettings();
  alert(t("toast.settingsSaved"));
};

/* Init */
translateDOM();
renderDiscover();
renderFiles(); renderTemplates(); renderLibrary(); renderSearchHistory();
rotateTips();
setMode("discover");
</script>
</body>
</html>
