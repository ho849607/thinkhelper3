<!DOCTYPE html>
<html lang="ko" data-theme="light">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>ThinkHelper â€” Editor</title>
<link rel="icon" href="data:,"/>

<script src="https://cdn.ckeditor.com/ckeditor5/41.3.1/classic/ckeditor.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" defer></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js" defer></script>

<style>
/* (ìŠ¤íƒ€ì¼ ì½”ë“œëŠ” ì´ì „ê³¼ ë™ì¼... ìƒëµ) */
:root{--bg:#f6f8fb;--fg:#0b1020;--muted:#6a7691;--panel:#fff;--card:#f2f5ff;--border:#d6deee;--hover:#e9effe;--accent:#2563eb}
:root[data-theme="dark"]{--bg:#0b1020;--fg:#f1f5ff;--muted:#a8b4cf;--panel:#0f172a;--card:#101a30;--border:#273453;--hover:#16213b;--accent:#60a5fa}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--fg);font-family:-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif;display:flex;flex-direction:column;padding-bottom:90px}
.topbar{display:flex;gap:8px;align-items:center;padding:10px 12px;background:var(--panel);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:1000}
.brand{display:flex;align-items:center;gap:8px;font-weight:900}
.logo{width:18px;height:18px;border-radius:4px;background:linear-gradient(135deg,#60a5fa,#34d399)}
.btn{border:1px solid var(--border);background:var(--card);color:var(--fg);border-radius:8px;padding:.45rem .7rem;font-weight:900;cursor:pointer}
.btn:hover{background:var(--hover)} .btn[disabled]{opacity:.6;cursor:not-allowed}
.iconbtn{border:1px solid var(--border);background:transparent;color:var(--fg);border-radius:6px;padding:.25rem .45rem;cursor:pointer}
.iconbtn:hover{background:var(--hover)}
.selectlike{height:34px;border:1px solid var(--border);border-radius:8px;background:var(--card);color:var(--fg);padding:.25rem .5rem}
.menu{position:relative;z-index:1001}
.menu>.btn{font-weight:900}
.dropdown{display:none;position:absolute;top:42px;left:0;background:var(--panel);border:1px solid var(--border);border-radius:10px;min-width:320px;box-shadow:0 12px 24px rgba(0,0,0,.12)}
.dropdown .item{padding:.55rem .7rem;border-bottom:1px dashed var(--border);cursor:pointer;display:flex;justify-content:space-between;gap:10px;align-items:center}
.dropdown .item:last-child{border-bottom:none}
.dropdown .item:hover{background:var(--hover)}
.dropdown a.item{text-decoration:none;color:inherit}
.dropdown .item label{display:flex;align-items:center;gap:6px;cursor:pointer;font-size:.9em}
.dropdown .item input[type="checkbox"]{margin:0;transform:scale(.9)}
main{flex:1;min-height:0;display:grid;grid-template-columns:260px 1fr;gap:10px;padding:10px;position:relative;z-index:2}
main[data-mode="research"]{grid-template-columns:260px 1fr 340px}
@media (max-width:1200px){main{grid-template-columns:0 1fr;padding:6px} main[data-mode="research"]{grid-template-columns:0 1fr 340px} #left{display:none}}
@media (max-width:900px){main{grid-template-columns:0 1fr} main[data-mode="research"]{grid-template-columns:0 1fr} #left{display:none} aside#right{display:none!important}}
aside#left{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:10px;display:flex;flex-direction:column;min-height:0;position:sticky;top:70px;height:calc(100vh - 90px)}
.listHead{display:flex;align-items:center;gap:8px}
#docList{flex:1;overflow:auto;display:flex;flex-direction:column;gap:8px;margin-top:10px}
.doc{display:grid;grid-template-columns:1fr auto auto;gap:6px;align-items:center;padding:8px;border:1px solid var(--border);border-radius:10px;background:var(--card)}
.doc:hover{background:var(--hover)}
.doc .title{font-weight:900;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;cursor:text;padding:2px 4px}
.doc .title[contenteditable="true"]{outline:1.5px solid var(--accent);background:#fff;border-radius:4px;padding:2px 4px}
.doc .time{font-size:.78rem;color:var(--muted)}
.doc .act{display:none}.doc:hover .act{display:inline-flex}
section#center{display:flex;flex-direction:column;gap:10px;min-width:0;padding-bottom: 50px;}
#editorWrap{flex:1;border:1px solid var(--border);border-radius:12px;background:var(--panel);padding:8px;position:relative}
#editor{min-height:62vh}
.ck-balloon-panel,.ck-powered-by-balloon{display:none!important}
.ck-editor__editable_inline{min-height:58vh!important;color:#222;background:#fff;padding:12px 12px 140px;border-radius:8px;position:relative;z-index:1}
[data-theme="dark"] .ck-editor__editable_inline{color:#ffe7b3;background:#0b1327}
#ghostSuggest{position:absolute;right:14px;top:10px;font-size:.9rem;color:#9aa3b2;opacity:.7;pointer-events:none;max-width:45%;text-align:right}
#commandBar{display:flex;gap:10px;align-items:center;padding:10px;background:var(--panel);border:1px solid var(--border);border-radius:12px}
#cmdInput{flex:1;height:40px;border:1px solid var(--border);border-radius:10px;background:var(--card);color:var(--fg);padding:.5rem .9rem;font-size:15px}
#cmdSuggestions{display:flex;gap:8px}
#cmdSuggestions .chip{background:var(--card);border:1px solid var(--border);border-radius:999px;padding:.3rem .7rem;cursor:pointer;font-weight:900;font-size:.9rem;white-space:nowrap}
#cmdSuggestions .chip:hover{background:var(--hover)}
@media (max-width:768px){#cmdSuggestions{display:none}}
#aiChip{position:absolute;display:none;gap:6px;align-items:center;background:var(--panel);border:1px solid var(--border);border-radius:999px;padding:.28rem .55rem;box-shadow:0 8px 20px rgba(0,0,0,.15);z-index:80;font-weight:900}
#aiChip small{opacity:.75}
#suggPopup{position:absolute;display:none;z-index:80;background:var(--panel);color:var(--fg);border:1px solid var(--border);border-radius:10px;box-shadow:0 12px 24px rgba(0,0,0,.18);min-width:300px;max-width:620px}
#suggPopup header{padding:6px 10px;border-bottom:1px solid var(--border);font-size:.82rem;color:var(--muted);display:flex;justify-content:space-between;align-items:center}
#suggPopup ul{list-style:none;margin:0;padding:6px;max-height:280px;overflow:auto}
#suggPopup li{padding:8px 10px;border-radius:8px;display:grid;grid-template-columns:90px 1fr auto;gap:10px;cursor:pointer;align-items:center}
#suggPopup li .kind{opacity:.75;font-size:.75rem}
#suggPopup li .txt{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
#suggPopup li .tag{border:1px solid var(--border);border-radius:6px;font-size:.72rem;padding:.05rem .35rem;opacity:.85}
#suggPopup li[data-active="1"]{background:var(--hover);outline:1.5px solid #8ab4ff66}
aside#right{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:10px;display:none;flex-direction:column;min-height:0;position:sticky;top:70px;height:calc(100vh - 90px)}
main[data-mode="research"] aside#right{display:flex}
.sidebar-nav{display:flex;gap:0;background:var(--card);border-radius:8px;padding:4px;border:1px solid var(--border);margin-bottom:10px}
.sidebar-nav .tab{flex:1;padding:8px 14px;font-weight:700;font-size:.9rem;cursor:pointer;border-radius:6px;text-align:center;color:var(--muted);transition:.2s}
.sidebar-nav .tab:hover{background:var(--hover);color:var(--fg)}
.sidebar-nav .tab[data-active="1"]{background:var(--panel);color:var(--accent);box-shadow:0 1px 3px rgba(0,0,0,.05)}
.sidebar-nav .tab span{margin-left:4px}
.sidebar-content{flex:1;overflow:auto;display:none}
.sidebar-content[data-active="1"]{display:block}
#rightSearchResults{display:flex;flex-direction:column;gap:12px}
.search-summary{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:12px;white-space:pre-wrap;font-size:.95rem;line-height:1.6}
.search-sources h4{margin:12px 0 6px;font-size:.9rem;color:var(--muted)}
.search-sources ul{list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:6px}
.search-sources li a{display:block;padding:8px;border-radius:8px;background:var(--card);border:1px solid var(--border);text-decoration:none;color:var(--fg);font-size:.85rem;transition:.2s}
.search-sources li a:hover{background:var(--hover)}
.search-sources li a strong{display:block;margin-bottom:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.search-sources li a span{color:var(--muted);font-size:.75rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;display:block}
#rightFeed{display:flex;flex-direction:column;gap:12px}
.feed-item{background:var(--card);border:1px solid var(--border);border-radius:10px;overflow:hidden;cursor:pointer}
.feed-item:hover{background:var(--hover)}
.feed-item img{width:100%;height:140px;object-fit:cover;display:block;background-color:var(--border)}
.feed-item .feed-content{padding:10px}
.feed-item .feed-source{font-size:.8rem;color:var(--muted);margin-bottom:4px}
.feed-item .feed-title{font-weight:900}
#chatBtn{position:fixed;right:16px;bottom:80px;z-index:60}
#chatDock{position:fixed;right:16px;bottom:16px;width:min(95vw,1000px);height:88vh;display:none;flex-direction:column;background:var(--panel);border:1px solid var(--border);border-radius:14px;box-shadow:0 18px 36px rgba(0,0,0,.28);z-index:75}
#chatHead{display:flex;align-items:center;gap:8px;justify-content:space-between;padding:10px;border-bottom:1px solid var(--border);font-weight:900}
#chatHead .actions{position:relative;display:flex;align-items:center;gap:6px}
#chatPlusMenu{position:absolute;display:none;background:var(--panel);border:1px solid var(--border);border-radius:8px;padding:6px;right:40px;top:40px;z-index:90;width:150px}
#chatPlusMenu .item{padding:6px 8px;border-radius:6px;cursor:pointer;font-size:.9em}
#chatPlusMenu .item:hover{background:var(--hover)}
#chatWrap{flex:1;display:grid;grid-template-columns:220px 1fr;min-height:0}
#chatThreads{border-right:1px solid var(--border);padding:8px;overflow:auto}
.threadRow{display:flex;gap:6px;align-items:center;padding:8px;border:1px solid var(--border);border-radius:10px;background:var(--card);cursor:pointer;margin-bottom:8px;justify-content:space-between}
.threadRow:hover{background:var(--hover)} .threadRow[data-active="1"]{outline:2px solid #9bbcff}
#chatMain{display:flex;flex-direction:column;min-width:0}
#chatBody{flex:1;overflow:auto;padding:10px;display:flex;flex-direction:column;gap:10px}
.bubble{max-width:85%;padding:.8rem 1.2rem;border:1px solid var(--border);border-radius:14px;background:var(--card);word-break:break-word;font-size:1.05rem;line-height:1.6;white-space:pre-wrap}
.bubble.ai{cursor:pointer}
.me{margin-left:auto;background:#143763;color:#fff;border-color:#143763}
.ai{margin-right:auto;border-color:#3b4b72;background:#15284f;color:#fff}
[data-theme="dark"] .ai{background:#15203baa;border-color:#273453}
.sys{margin:0 auto;background:#eef2ff;border-style:dashed;color:#111}
#chatForm{display:flex;gap:8px;padding:10px;border-top:1px solid var(--border)}
#chatInput{flex:1;border:1px solid var(--border);border-radius:10px;background:var(--card);color:var(--fg);padding:.6rem .8rem;font-size:1.02rem;resize:vertical;min-height:80px}
#quota{position:absolute;left:12px;bottom:12px;background:var(--panel);border:1px solid var(--border);border-radius:8px;padding:.25rem .55rem;font-size:.85rem;color:#666}
#filePick{display:none}
footer{position:fixed;bottom:0;left:0;right:0;background:var(--panel);padding:8px 10px;border-top:1px solid var(--border);font-size:.92rem;text-align:center;user-select:none;pointer-events:none;z-index:10}
footer a{pointer-events:auto}
#gaze{position:fixed;pointer-events:none;width:14px;height:14px;border-radius:50%;background:rgba(37,99,235,.75);box-shadow:0 0 0 3px rgba(37,99,235,.2);mix-blend-mode:multiply;z-index:100;transform:translate(-50%,-50%);display:none}
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;z-index:120;align-items:center;justify-content:center}
.modal{background:#fff;color:#111;border-radius:12px;max-width:560px;width:92vw;padding:18px;border:1px solid var(--border);box-shadow:0 18px 36px rgba(0,0,0,.25)}
[data-theme="dark"] .modal{background:#0f172a;color:#f1f5ff}
.modal h3{margin:.2rem 0 .6rem}.modal .actions{display:flex;justify-content:flex-end;gap:8px;margin-top:12px}
.modal .btn-plain{background:#f3f4f6;border:1px solid #e5e7eb;border-radius:8px;padding:.45rem .8rem;cursor:pointer}
[data-theme="dark"] .modal .btn-plain{background:#1e293b;border-color:#334155;color:#f1f5ff}
#subModal{display:none}
#guideModal .content{max-height:60vh;overflow:auto;padding-right:10px}
kbd{background:var(--card);border:1px solid var(--border);border-radius:4px;padding:2px 5px;font-weight:900;font-family:monospace;display:inline-block}
.spinner{border:4px solid rgba(0,0,0,.1);width:24px;height:24px;border-radius:50%;border-left-color:var(--accent);animation:spin 1s ease infinite;margin:20px auto}
@keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
</style>
</head>
<body>
  <div id="gaze"></div>
  <div class="topbar">
    <button class="iconbtn" id="btnToggleLeft" title="ë¬¸ì„œ íŒ¨ë„ ì ‘ê¸°/í¼ì¹˜ê¸°">â˜°</button>
    <div class="brand"><div class="logo"></div><div id="t_brand">ThinkHelper</div></div>
    <div class="menu" data-menu>
      <button class="btn">ë„êµ¬ â–¾</button>
      <div class="dropdown">
        <div class="item" id="iNew"><span>ìƒˆ ë¬¸ì„œ</span><span>âŒ˜/Ctrl+N</span></div>
        <div class="item" id="iPrint"><span>ğŸ–¨ï¸ í”„ë¦°í„°ë¡œ ì¸ì‡„</span></div>
        <div class="item" id="iImport"><span>ğŸ“¥ ë¶ˆëŸ¬ì˜¤ê¸° (ë°ëª¨)</span></div>
        <div class="item" id="iSavePDF"><span>ğŸ’¾ PDFë¡œ ì €ì¥</span></div>
        <div class="item" id="iSaveWord"><span>ğŸ’¾ Wordë¡œ ì €ì¥</span></div>
        <div class="item" id="iSaveHWP"><span>ğŸ’¾ HWPë¡œ ì €ì¥ (ë°ëª¨)</span></div>
        <div class="item" id="iTranslate"><span>ğŸŒ ë²ˆì—­í•˜ê¸° (ë°ëª¨)</span></div>
        <div class="item" id="iCollab"><span>ğŸ‘¥ í˜‘ì—… ì´ˆëŒ€í•˜ê¸°</span></div>
        <div class="item" id="iMakePPT"><span>âœ¨ PPT ìŠ¬ë¼ì´ë“œ ìƒì„±</span></div>
        <div class="item" id="iClipboard"><span>ê³µìœ í•˜ê¸° (QR/ë§í¬)</span><span>â†—</span></div>
      </div>
    </div>
    <div class="menu" data-menu>
      <button class="btn">ì„¤ì • â–¾</button>
      <div class="dropdown" id="dropSettings">
        <div class="item" style="flex-direction:column;align-items:flex-start;gap:8px">
          <label><input type="checkbox" id="optSugg"> ì¶”ì²œì–´ í‘œì‹œ (VSCode ìŠ¤íƒ€ì¼)</label>
          <label><input type="checkbox" id="optPersonal"> âœ¨ ë§ì¶¤í˜• AI ì œì•ˆ (ë°ëª¨)</label>
          <label><input type="checkbox" id="optGaze"> ì‹œì„  ì»¤ì„œ</label>
        </div>
        <div class="item">
          <span>ëª¨ë“œ</span>
          <select id="modeSel" class="selectlike" style="width:180px">
            <option value="normal" selected>Normal (ì¼ë°˜)</option>
            <option value="research">Research (ë¦¬ì„œì¹˜)</option>
          </select>
        </div>
        <div class="item">
          <span>ì–¸ì–´</span>
          <select id="langSel" class="selectlike" style="width:180px">
            <option value="ko" selected>í•œêµ­ì–´</option>
            <option value="en">English</option>
            <option value="ja">æ—¥æœ¬èª</option>
          </select>
        </div>
        <div class="item" id="toggleTheme">ğŸŒ“ <span>í…Œë§ˆ ì „í™˜</span></div>
      </div>
    </div>
    <div class="menu" data-menu>
      <button class="btn">ë„ì›€ë§ â–¾</button>
      <div class="dropdown">
        <div class="item" id="iGuide"><span>ì„œë¹„ìŠ¤ ì†Œê°œ ë° ê°€ì´ë“œ</span></div>
        <div class="item" id="iShortcuts"><span>ë‹¨ì¶•í‚¤ ëª©ë¡</span></div>
        <a class="item" href="https://docs.google.com/document/d/1kmFzmp3ddJOKOp1TPsvsNzAuBKt6M0Vm0N_G5BIOZEE/edit?usp=sharing" target="_blank" rel="noopener noreferrer"><span>ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨</span><span>â†—</span></a>
        <a class="item" href="https://docs.google.com/document/d/1TLZ2m52s1mAd8BPzXDBQuXF6QZ_hLDZOyX6Y8TKALnE/edit?usp=sharing" target="_blank" rel="noopener noreferrer"><span>ì„œë¹„ìŠ¤ ì´ìš©ì•½ê´€</span><span>â†—</span></a>
        <a class="item" href="mailto:ho849607@gmail.com"><span>í”¼ë“œë°± ë³´ë‚´ê¸°</span><span>â†—</span></a>
      </div>
    </div>
    <button class="btn" id="chatBtn" style="margin-left:auto" title="ì±„íŒ… ì—´ê¸°">ğŸ’¬</button>
  </div>
  <main id="mainLayout">
    <aside id="left" aria-label="ë¬¸ì„œëª©ë¡" data-collapsed="0">
      <div class="listHead"><b>ë¬¸ì„œ</b><button class="btn" id="addDoc" title="ìƒˆ ë¬¸ì„œ ì¶”ê°€">ï¼‹</button></div>
      <div id="docList"></div>
    </aside>
    <section id="center">
      <div id="editorWrap">
        <div id="editor" aria-label="ì—ë””í„°"></div>
        <div id="ghostSuggest" aria-hidden="true"></div>
        <button id="aiChip">âœ¨ AI <small>ë¬¸ë§¥ ë„ì›€</small></button>
        <div id="suggPopup" aria-live="polite">
          <header><span>ì œì•ˆ (â†‘/â†“, Enter ì„ íƒ)</span><div><button class="min" id="suggClose">âœ–</button></div></header>
          <ul id="suggList"></ul>
        </div>
      </div>
      <div id="commandBar">
        <div id="cmdSuggestions">
          <button class="chip" data-cmd="create_doc">âœ¨ ë¬¸ì„œ ìƒì„±</button>
          <button class="chip" data-cmd="edit_doc">âœï¸ ì‘ì„± ë„ì›€ ë°›ê¸°</button>
        </div>
        <input id="cmdInput" placeholder="AIì—ê²Œ ìš”ì²­í•˜ê±°ë‚˜ ê²€ìƒ‰ ( /search ë˜ëŠ” ? )"/>
        <button class="btn" id="cmdSend">ì „ì†¡</button>
      </div>
    </section>
    <aside id="right" aria-label="ë¦¬ì„œì¹˜ íŒ¨ë„">
      <nav class="sidebar-nav">
        <button class="tab" data-tab="search" data-active="0">ğŸ”<span>ê²€ìƒ‰</span></button>
        <button class="tab" data-tab="feed" data-active="1">ğŸ“°<span>í”¼ë“œ</span></button>
      </nav>
      <div id="rightSearchResults" class="sidebar-content" data-active="0">
        <div class="search-summary" style="color:var(--muted);font-style:italic;">í•˜ë‹¨ ì»¤ë§¨ë“œ ë°”ì—ì„œ '/search' ë˜ëŠ” '?'ë¡œ ê²€ìƒ‰í•˜ì„¸ìš”.</div>
      </div>
      <div id="rightFeed" class="sidebar-content" data-active="1">
        <div class="spinner"></div>
      </div>
    </aside>
  </main>
  <footer>
    <div>Â© ThinkHelper â€” âš ï¸ ì¸ê³µì§€ëŠ¥ ê²°ê³¼ëŠ” ê²€í† ê°€ í•„ìš”í•©ë‹ˆë‹¤.</div>
    <div id="loc">ğŸ“ ìœ„ì¹˜ í™•ì¸ ì¤‘â€¦</div>
  </footer>
  <div id="chatDock" role="dialog" aria-hidden="true" style="display:none;">
    <div id="chatHead">
      <span>AI ì±„íŒ… <small id="chatModelIndicator">(í—¬í¼ 1.0)</small></span>
      <div class="actions">
        <input type="file" id="filePick" accept=".pdf,.txt,image/*"/>
        <button class="iconbtn" id="btnChatPlus" title="ë”ë³´ê¸°">â•</button>
        <div id="chatPlusMenu">
          <div class="item" data-action="github">â†—ï¸ GitHub (ë°ëª¨)</div>
          <div class="item" data-action="word">ğŸ“„ Word (ë°ëª¨)</div>
          <div class="item" data-action="email">âœ‰ï¸ ë©”ì¼ (ë°ëª¨)</div>
        </div>
        <button class="iconbtn" id="btnAttach" title="íŒŒì¼ ì²¨ë¶€ (ì´ë¯¸ì§€/í…ìŠ¤íŠ¸)">ğŸ“</button>
        <button class="iconbtn" id="chatClose" aria-label="ë‹«ê¸°">âœ–</button>
      </div>
    </div>
    <div id="chatWrap">
      <aside id="chatThreads" aria-label="ì±„íŒ… ìŠ¤ë ˆë“œ"></aside>
      <section id="chatMain">
        <div style="padding:6px 10px;border-bottom:1px dashed var(--border);display:flex;gap:8px;align-items:center">
          <input id="threadTitleInput" placeholder="ìŠ¤ë ˆë“œ ì œëª©" style="flex:1;border:1px solid var(--border);border-radius:8px;padding:.35rem .55rem;background:var(--card)"/>
          <button class="btn" id="renameThread">ì œëª© ì €ì¥</button>
          <button class="btn" id="deleteThread">ì‚­ì œ</button>
        </div>
        <div id="chatBody"></div>
        <form id="chatForm">
          <textarea id="chatInput" rows="3" placeholder="ë©”ì‹œì§€ ì…ë ¥ (Enter=ì „ì†¡, Shift+Enter=ì¤„ë°”ê¿ˆ)"></textarea>
          <button class="btn" type="submit">ì „ì†¡</button>
        </form>
      </section>
    </div>
    <div id="quota">í—¬í¼ 1.0 ì‚¬ìš© ì¤‘ (ì„œë²„ ì—°ë™ ì‹œ AI ì‚¬ìš© ê°€ëŠ¥)</div>
  </div>
  <div id="shareModal" class="modal-backdrop">
    <div class="modal">
      <h3>ê³µìœ í•˜ê¸°</h3>
      <p>ë§í¬/í…ìŠ¤íŠ¸ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤. QRë¡œë„ ì „ì†¡í•  ìˆ˜ ìˆì–´ìš”.</p>
      <div id="qr" style="margin:10px auto;width:200px;height:200px"></div>
      <div class="actions"><button class="btn-plain" id="shareClose">ë‹«ê¸°</button></div>
    </div>
  </div>
  <div id="guideModal" class="modal-backdrop">
    <div class="modal">
      <h3>ThinkHelper ì‚¬ìš© ê°€ì´ë“œ</h3>
      <div class="content" style="line-height:1.6">
        <p><b>ThinkHelper</b>ëŠ” ë¬¸ì„œ ì‘ì„±ê³¼ ë¦¬ì„œì¹˜ë¥¼ í•œ í™”ë©´ì—ì„œ ëë‚´ëŠ” AI ì—ë””í„°ì…ë‹ˆë‹¤.</p>
        <h4>í•µì‹¬ ê¸°ëŠ¥</h4>
        <ul>
          <li><b>AI ì—”ì§„:</b> ê¸°ë³¸ <b>í—¬í¼ ëª¨ë¸(Helper 1.0)</b>ì´ ì˜¤í”„ë¼ì¸ ìƒíƒœì—ì„œë„ ì‘ë‹µí•©ë‹ˆë‹¤.</li>
          <li><b>ê²€ìƒ‰:</b> í•˜ë‹¨ ë°”ì— <kbd>/search í‚¤ì›Œë“œ</kbd>ë¥¼ ì…ë ¥í•˜ì„¸ìš”. (ë°ëª¨)</li>
          <li><b>AI ê¸€ì“°ê¸°/ì±„íŒ…:</b> í•˜ë‹¨ ë°”ì— ìš”ì²­ì„ ì…ë ¥í•˜ê±°ë‚˜ ìš°ì¸¡ í•˜ë‹¨ ğŸ’¬ì„ í´ë¦­í•˜ì„¸ìš”.</li>
          <li><b>íŒŒì¼ ì €ì¥:</b> PDF/Word ì €ì¥ ì§€ì›.</li>
          <li><b>PPT ìƒì„±:</b> Google Slides ìƒˆ íƒ­ ì—´ê¸°.</li>
        </ul>
      </div>
      <div class="actions"><button class="btn-plain" id="guideClose">ë‹«ê¸°</button></div>
    </div>
  </div>

<script>
/* ========= Helpers ========= */
const $$ = (id)=>document.getElementById(id);
document.getElementById("chatInput").addEventListener("keydown", (e) => {
  if (e.key === "Enter" && !e.shiftKey) {
    e.preventDefault();
    document.getElementById("chatForm").requestSubmit();
  }
});
const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));
const escapeHtml = (s)=> (s==null?"":String(s)).replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m]));
const SKEY_SETTINGS = "th.settings";

/* ========= Config (ë¡œì»¬ ë°ëª¨) ========= */
// â˜…â˜…â˜… (ìˆ˜ì • 1/4) API ì£¼ì†Œ ì„¤ì •
const SERVER_API_ENDPOINT = "http://54.250.162.208:8000"; // â˜…â˜…â˜… ë„¤ EC2 ì„œë²„ (ì œë¯¸ë‚˜ì´ ë‡Œ)
const FEED_API_ENDPOINT = "https://api-v2.deepsearch.com"; // â˜…â˜…â˜… ë”¥ì„œì¹˜ (ë¦¬ì„œì¹˜ ë‡Œ)
const DEEPSEARCH_API_KEY = "YOUR_DEEPSEARCH_API_KEY_HERE"; // ğŸ‘ˆ (í•„ìˆ˜!) ì—¬ê¸°ì— ë„¤ ë”¥ì„œì¹˜ API í‚¤ë¥¼ ë„£ì–´!

/* ========= Store ========= */
const store={
  listKey:"th.docs.list",docKey:id=>`th.doc.${id}`,curKey:"th.cur",
  list(){try{return JSON.parse(localStorage.getItem(this.listKey)||"[]")}catch{return[]}},
  saveList(a){localStorage.setItem(this.listKey,JSON.stringify(a||[]))},
  get(id){try{return JSON.parse(localStorage.getItem(this.docKey(id))||"null")}catch{return null}},
  set(id,o){localStorage.setItem(this.docKey(id),JSON.stringify(o))},
  remove(id){localStorage.removeItem(this.docKey(id))},
  current(){return localStorage.getItem(this.curKey)||""},
  setCurrent(id){localStorage.setItem(this.curKey,id||"")}
};
let curId="";
let settings={};

/* ========= Settings ========= */
function loadSettings(){
  settings = JSON.parse(localStorage.getItem(SKEY_SETTINGS) || '{}');
  settings.suggest ??= true;
  settings.personal ??= false;
  settings.gaze ??= false;
  settings.lang ??= 'ko';
  settings.mode ??= 'normal';
}
const saveSettings=()=>localStorage.setItem(SKEY_SETTINGS, JSON.stringify(settings));
function updateChatUI(plan) {
    const indicator = $$("chatModelIndicator");
    const quota = $$("quota");
    if (!indicator || !quota) return;
    if (plan && plan.includes("Gemini")) {
        indicator.textContent = `(${plan})`;
        quota.textContent = "Gemini AI ì‚¬ìš© ì¤‘";
    } else if (plan && plan.includes("no_key")) {
        indicator.textContent = "(í—¬í¼ 1.0 - í‚¤ ì—†ìŒ)";
        quota.textContent = "ì„œë²„ API í‚¤ ì—†ìŒ (í—¬í¼ 1.0)";
    } else {
        indicator.textContent = "(í—¬í¼ 1.0)";
        quota.textContent = "í—¬í¼ 1.0 ì‚¬ìš© ì¤‘ (ì˜¤í”„ë¼ì¸)";
    }
}

/* ========= Menus / Theme / Panels ========= */
(function(){
  loadSettings();
  const menus=[...document.querySelectorAll('[data-menu]')];
  const closeAll=()=>document.querySelectorAll('.dropdown').forEach(d=>d.style.display='none');
  menus.forEach(m=>{
    const btn=m.querySelector('.btn'); const drop=m.querySelector('.dropdown');
    if(!btn||!drop) return;
    btn.addEventListener('click',(e)=>{e.stopPropagation();const open=drop.style.display==='block';closeAll();drop.style.display=open?'none':'block';});
    drop.addEventListener('click',e=>e.stopPropagation());
  });
  document.addEventListener('click',closeAll);
  $$("toggleTheme")?.addEventListener('click', ()=>{
    const root=document.documentElement;
    root.dataset.theme = root.dataset.theme==="dark"?"light":"dark";
  });
  $$("btnToggleLeft")?.addEventListener('click', ()=>{
    const left=$$("left");
    if(!left) return;
    left.style.display = (left.style.display==='none'?'flex':'none');
  });
  $$("iGuide")?.addEventListener('click', ()=>($$("guideModal").style.display="flex"));
  $$("guideClose")?.addEventListener('click', ()=>($$("guideModal").style.display="none"));
  $$("optSugg").checked = settings.suggest;
  $$("optSugg").onchange = (e)=>{settings.suggest=e.target.checked; saveSettings(); updateGhostSuggest();};
  $$("optPersonal").checked = settings.personal;
  $$("optPersonal").onchange = (e)=>{settings.personal=e.target.checked; saveSettings();};
  $$("optGaze").checked = settings.gaze;
  $$("optGaze").onchange = (e)=>{settings.gaze=e.target.checked; saveSettings(); setupGazeCursor();};
  $$("langSel").value = settings.lang;
  $$("langSel").onchange = (e)=>{settings.lang=e.target.value; saveSettings(); updateGhostSuggest();};
  $$("modeSel").value = settings.mode;
  $$("modeSel").onchange = (e)=>{settings.mode=e.target.value; saveSettings(); $$('mainLayout').dataset.mode=settings.mode; if(settings.mode==='research'){switchSidebarTab('feed'); loadFeed();}};
  $$('mainLayout').dataset.mode=settings.mode;
})();

/* ========= Editor ========= */
// (Editor, Doc, List, Export, Share ê´€ë ¨ í•¨ìˆ˜ëŠ” ì´ì „ê³¼ ë™ì¼... ìƒëµ)
let editor=null, autosaveTimer=null;
async function initEditor(restore){
  editor = await ClassicEditor.create($$("editor"), { placeholder:"ì—¬ê¸°ì„œ ì‘ì„±í•˜ì„¸ìš”â€¦" });
  if(restore!=null) editor.setData(restore);
  editor.model.document.on('change:data', ()=>{
    clearTimeout(autosaveTimer);
    autosaveTimer=setTimeout(saveDoc, 500);
    triggerSuggest(); updateGhostSuggest();
  });
  editor.model.document.on('change:selection', updateGhostSuggest);
}
function newDoc(){
  const id="d_"+Date.now(); curId=id; store.setCurrent(id);
  const row={id,createdAt:Date.now(),updatedAt:Date.now(),title:"ë¬´ì œ",html:""};
  store.set(id,row); store.saveList([row,...store.list().filter(x=>x.id!==id)]);
  editor?.setData(""); renderList(); updateGhostSuggest();
}
function openDoc(id){
  const d=store.get(id); if(!d||!editor) return;
  curId=id; store.setCurrent(id); editor.setData(d.html||""); renderList(); updateGhostSuggest();
}
async function saveDoc(){
  if(!editor || !curId) return;
  const d=store.get(curId); if(!d) return;
  d.html=editor.getData(); d.updatedAt=Date.now();
  const plain=d.html.replace(/<[^>]+>/g," ").replace(/\s+/g," ").trim();
  if(!d.title||d.title==="ë¬´ì œ"){ d.title=(plain.split(" ").slice(0,8).join(" ")||"ë¬´ì œ"); }
  store.set(curId,d);
  const list=store.list().map(x => x.id===curId ? {id:curId,createdAt:d.createdAt||Date.now(),updatedAt:d.updatedAt,title:d.title} : x);
  store.saveList(list); renderList();
}
function renderList(){
  const list=store.list().sort((a,b)=>(b.updatedAt||0)-(a.updatedAt||0));
  const el=$$("docList");
  el.innerHTML=list.map(it=>{
    const d=store.get(it.id)||it;
    const when=new Date(d.updatedAt||d.createdAt||Date.now()).toLocaleString('ko-KR',{dateStyle:'medium',timeStyle:'short'});
    return `<div class="doc" data-id="${it.id}">
      <div class="title" data-rename-id="${it.id}" title="ì œëª© í´ë¦­í•˜ì—¬ ìˆ˜ì •">${escapeHtml(d.title||"ë¬´ì œ")}</div>
      <div class="time">${escapeHtml(when)}</div>
      <div class="act"><button class="iconbtn" data-del-id="${it.id}" title="ì‚­ì œ">ğŸ—‘ï¸</button></div>
    </div>`;
  }).join("") || `<div class="doc"><div class="title">ì €ì¥ëœ ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤.</div></div>`;
  el.onclick=(e)=>{
    const titleEl=e.target.closest('.title[data-rename-id]');
    const delBtn=e.target.closest('button[data-del-id]');
    const docRow=e.target.closest('.doc[data-id]');
    if(delBtn){
      const id=delBtn.dataset.delId;
      const doc=store.get(id);
      if(confirm(`'${doc?.title||'ë¬´ì œ'}' ë¬¸ì„œë¥¼ ì‚­ì œí• ê¹Œìš”?`)){
        store.remove(id);
        store.saveList(store.list().filter(x=>x.id!==id));
        if(curId===id){curId=""; editor?.setData("");}
        renderList();
      }
    }else if(titleEl){
      enableInlineRename(titleEl);
    }else if(docRow){
      openDoc(docRow.dataset.id);
    }
  };
}
function enableInlineRename(el){
  const id=el.dataset.renameId;
  if(!id || el.contentEditable==="true") return;
  const old=el.textContent;
  el.contentEditable="true"; el.focus(); document.execCommand('selectAll', false, null);
  const finish=(save=true)=>{
    el.contentEditable="false"; el.onblur=null; el.onkeydown=null;
    const nv=el.textContent.trim();
    if(save && nv!==old){
      const d=store.get(id); if(d){ d.title=nv||"ë¬´ì œ"; d.updatedAt=Date.now(); store.set(id,d); renderList(); }
    }else if(!save){ el.textContent=old; }
  };
  el.onblur=()=>finish(true);
  el.onkeydown=(e)=>{ if(e.key==="Enter"){e.preventDefault();finish(true)} else if(e.key==="Escape"){e.preventDefault();finish(false)} };
}
$$("addDoc").onclick=newDoc; $$("iNew").onclick=newDoc;
function exportPDF(){
  if(!editor) return alert("ì—ë””í„°ê°€ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
  const content=document.createElement('div');
  content.innerHTML=editor.getData();
  const opt={margin:10,filename:`ThinkHelper_${Date.now()}.pdf`,image:{type:'jpeg',quality:0.95},html2canvas:{scale:2},jsPDF:{unit:'mm',format:'a4',orientation:'portrait'}};
  html2pdf().from(content).set(opt).save();
}
function exportWord(){
  if(!editor) return alert("ì—ë””í„°ê°€ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
  const header = "<html xmlns:o='urn:schemas-microsoft-com:office:office' "+
    "xmlns:w='urn:schemas-microsoft-com:office:word' "+
    "xmlns='http://www.w3.org/TR/REC-html40'><head><meta charset='utf-8'><title>ThinkHelper Export</title></head><body>";
  const footer="</"+"body></html>";
  const sourceHTML=header+editor.getData()+footer;
  const source='data:application/vnd.ms-word;charset=utf-8,'+encodeURIComponent(sourceHTML);
  const a=document.createElement('a');
  document.body.appendChild(a);
  a.href=source; a.download=`ThinkHelper_${Date.now()}.doc`; a.click();
  document.body.removeChild(a);
}
async function sharePad(){
  let url=location.href;
  try{ await navigator.clipboard.writeText(url); }catch{}
  const wrap=$$("shareModal"); wrap.style.display="flex";
  const q=$$("qr"); q.innerHTML=""; new QRCode(q,{text:url,width:200,height:200});
}
$$("iSavePDF").onclick=exportPDF;
$$("iSaveWord").onclick=exportWord;
$$("iClipboard").onclick=sharePad;
$$("shareClose").onclick=()=>($$("shareModal").style.display="none");
$$("iPrint").onclick=()=>window.print();
$$("iImport").onclick=()=>alert("PDF/Word/HWP ë¶ˆëŸ¬ì˜¤ê¸° (ë°ëª¨)");
$$("iSaveHWP").onclick=()=>alert("HWPë¡œ ì €ì¥ì€ ì„œë²„ì˜ ìƒìš© ë³€í™˜ê¸°ê°€ í•„ìš”í•©ë‹ˆë‹¤.");
$$("iTranslate").onclick=()=>alert("ë²ˆì—­(ë°ëª¨): ì„œë²„ ì—°ë™ ì‹œ ì‹¤ì œ ë²ˆì—­ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
$$("iMakePPT").onclick=()=>window.open('https://slides.google.com/create','_blank');
$$("iCollab").onclick=()=>{
  const id=curId||"";
  const link=`${location.origin}${location.pathname}${id?`?doc=${encodeURIComponent(id)}`:""}`;
  const subject=encodeURIComponent("[ThinkHelper] ë¬¸ì„œ í˜‘ì—… ì´ˆëŒ€");
  const body=encodeURIComponent(`ì•„ë˜ ë§í¬ë¡œ ì ‘ì†í•˜ë©´ ë¬¸ì„œë¥¼ í•¨ê»˜ í¸ì§‘í•  ìˆ˜ ìˆì–´ìš”(ë°ëª¨).\n\n${link}\n\nâ€” ThinkHelper`);
  location.href=`mailto:?subject=${subject}&body=${body}`;
};

/* ========= Suggestions / AI Chip ========= */
// (Suggestions ê´€ë ¨ í•¨ìˆ˜ëŠ” ì´ì „ê³¼ ë™ì¼... ìƒëµ)
const aiChip=$$("aiChip"), suggPopup=$$("suggPopup"), suggList=$$("suggList");
let suggActive=-1, suggItems=[], suggDebounce=null;
function getPrefix(){
  const text=editor.getData().replace(/<[^>]+>/g," ");
  const parts=text.split(/\s+/); return parts[parts.length-1]||"";
}
const FILTER_OUT=new Set(["ìš”ì•½","ìš”ì•½í•˜ê¸°","ì§ˆë¬¸","ì •ë¦¬"]);
const KO_DICT=["ê°œë°œ","ê²€ìƒ‰","ê³„íš","ë¶„ì„","ìµœì í™”","í…ŒìŠ¤íŠ¸","í”„ë¡œì íŠ¸","í…œí”Œë¦¿","í”„ë ˆì  í…Œì´ì…˜","ìš”ì•½","ì´ë¯¸ì§€","ì½”ë“œ","ë²ˆì—­","ë°ì´í„°"];
const EN_DICT=["develop","search","plan","analyze","optimize","test","project","template","summary","image","code","translate","data"];
const JA_DICT=["é–‹ç™º","æ¤œç´¢","è¨ˆç”»","åˆ†æ","æœ€é©åŒ–","ãƒ†ã‚¹ãƒˆ","ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ","ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ","è¦ç´„","ç”»åƒ","ã‚³ãƒ¼ãƒ‰","ç¿»è¨³","ãƒ‡ãƒ¼ã‚¿"];
async function buildCandidates(prefix){
  const p=(prefix||"").toLowerCase();
  if(!prefix || prefix==="/") return [];
  const words=(editor.getData().replace(/<[^>]+>/g," ").toLowerCase().match(/[a-zA-Zê°€-í£]+/g)||[]);
  const freq={}; words.forEach(w=>{ if(w.length>2 && w.startsWith(p)) freq[w]=(freq[w]||0)+1; });
  const freqWords=Object.keys(freq).sort((a,b)=>freq[b]-freq[a]);
  const lang=settings.lang; const dict=lang==='en'?EN_DICT:lang==='ja'?JA_DICT:KO_DICT;
  const items=[
    ...freqWords.slice(0,5).map(w=>({kind:"DOC",text:w,tag:"ë¬¸ì„œ"})),
    ...dict.filter(w=> (lang==='ko'?w.startsWith(prefix):w.toLowerCase().startsWith(p))).slice(0,7).map(w=>({kind:"REC",text:w,tag:"ì¶”ì²œ"}))
  ];
  return Array.from(new Map(items.map(i=>[i.text,i])).values());
}
function renderSugg(items){
  if(!items.length){suggPopup.style.display="none";return;}
  suggList.innerHTML=items.map((it,i)=>`<li data-idx="${i}"><div class="kind">${it.kind}</div><div class="txt">${escapeHtml(it.text)}</div><div class="tag">${it.tag||""}</div></li>`).join("");
  suggPopup.style.display="block"; suggActive=0; setActive(0);
}
function setActive(i){
  const lis=[...suggList.querySelectorAll("li")]; lis.forEach(li=>li.dataset.active="0");
  if(lis[i]) lis[i].dataset.active="1";
}
function applySuggestion(i){
  const it=suggItems[i]; if(!it) return;
  const prefix=getPrefix();
  const insert=it.text.slice(prefix.length);
  editor.model.change(w=>{editor.model.insertContent(w.createText(insert), editor.model.document.selection);});
  saveDoc(); closeSuggest();
}
function closeSuggest(){suggPopup.style.display="none"; suggActive=-1; suggItems=[];}
async function openSuggest(){
  const px=getPrefix(); if(!px) return closeSuggest();
  suggItems=await buildCandidates(px); renderSugg(suggItems);
}
function triggerSuggest(){
  if(!settings.suggest) return;
  clearTimeout(suggDebounce); suggDebounce=setTimeout(openSuggest, 220);
}
$$("suggClose").onclick=closeSuggest;
document.addEventListener("keydown",(e)=>{
  if(suggPopup.style.display!=="block") return;
  if(e.key==="ArrowDown"){e.preventDefault();suggActive=Math.min(suggActive+1, suggItems.length-1); setActive(suggActive);}
  else if(e.key==="ArrowUp"){e.preventDefault();suggActive=Math.max(suggActive-1,0); setActive(suggActive);}
  else if(e.key==="Enter"){e.preventDefault();applySuggestion(suggActive);}
});
function updateGhostSuggest(){
  const el=$$("ghostSuggest"); if(!el) return;
  if(!settings.suggest){ el.textContent=""; return; }
  const txt=editor?.getData().replace(/<[^>]+>/g," ").trim()||"";
  if(!txt){
    el.textContent= settings.lang==='en' ? "e.g., 'Summarize today's meeting in 5 bullets'" :
                     settings.lang==='ja' ? "ä¾‹: ã€Œä»Šæ—¥ã®ä¼šè­°ã‚’5è¡Œã§è¦ç´„ã€" :
                     "ì˜ˆ: 'ì˜¤ëŠ˜ íšŒì˜ ìš”ì•½ 5ì¤„'";
  }else{
    el.textContent="â†’ í•µì‹¬ë§Œ 5ì¤„ë¡œ ìš”ì•½í• ê¹Œìš”? Â /search ìµœì‹  ìë£Œ";
  }
}

/* ========= Right Sidebar ========= */
function switchSidebarTab(tab){
  document.querySelectorAll(".sidebar-nav .tab").forEach(t=>t.dataset.active=(t.dataset.tab===tab?"1":"0"));
  document.querySelectorAll(".sidebar-content").forEach(c=>c.dataset.active=(c.id.toLowerCase().includes(tab)?"1":"0"));
}
document.querySelectorAll(".sidebar-nav .tab").forEach(t=>t.onclick=()=>switchSidebarTab(t.dataset.tab));

// â˜…â˜…â˜… (ìˆ˜ì • 2/4) renderSearch í•¨ìˆ˜ëŠ” 'ë°ëª¨' ê¸€ìë§Œ ì‚­ì œ
function renderSearch(summary, sources){
  const c=$$("rightSearchResults");
  c.innerHTML=`<div class="search-summary">${escapeHtml(summary)}</div>
  <div class="search-sources"><h4>ì¶œì²˜</h4><ul>${ // 'ì¶œì²˜(ë°ëª¨)'ì—ì„œ '(ë°ëª¨)' í…ìŠ¤íŠ¸ ì‚­ì œ
    (sources || []).map(s=>`<li><a href="${escapeHtml(s.url || '#')}" target="_blank"><strong>${escapeHtml(s.title || 'ì œëª© ì—†ìŒ')}</strong><span>${escapeHtml(s.url || 'URL ì—†ìŒ')}</span></a></li>`).join("")
  }</ul></div>`;
  switchSidebarTab('search');
}

// â˜…â˜…â˜… (ìˆ˜ì • 3/4) internalSearch í•¨ìˆ˜ë¥¼ DeepSearch API í˜¸ì¶œí•˜ë„ë¡ ìˆ˜ì • (ì„¤ê³„ë„ ë°˜ì˜)
async function internalSearch(q){
  const s = q.replace(/^(\?|\/search)\s*/,'').trim();
  if(!s) return renderSearch("ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.",[]);

  renderSearch(`'${s}'ì— ëŒ€í•œ DeepSearch AI ìš”ì•½ ê²€ìƒ‰ ì¤‘...`,[]);
  
  if (!FEED_API_ENDPOINT || !DEEPSEARCH_API_KEY.startsWith("5e")) {
    renderSearch("DEEPSEARCH_API_KEYê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. (index.html 403ë²ˆì§¸ ì¤„)",[]);
    return;
  }

  try {
    // ğŸ‘ˆ 'ì„¤ê³„ë„' ë°˜ì˜: GET, /v1/global-articles, ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°ë¡œ q
    const res = await fetch(`${FEED_API_ENDPOINT}/v1/global-articles?q=${encodeURIComponent(s)}&limit=5&return_fields=title,url,summary_ko`, { // ğŸ‘ˆ (ì¶”ì¸¡) summary_ko ë°˜í™˜ ìš”ì²­
        method: "GET",
        headers: {
            "Authorization": `Bearer ${DEEPSEARCH_API_KEY}` // ğŸ‘ˆ 'ì„¤ê³„ë„' ë°˜ì˜: í—¤ë” ì¸ì¦
        }
    });
    
    if (!res.ok) throw new Error(`DeepSearch ê²€ìƒ‰ API ì—ëŸ¬: ${res.status}`);
    
    const data = await res.json();

    // ğŸ”´ (ê²½ê³ !) ì´ ë¶€ë¶„ì€ ë‚´ê°€ 100% ì¶”ì¸¡í•œ ê±°ì•¼! API ë¬¸ì„œì˜ 'ì‘ë‹µ ì˜ˆì‹œ'ë¥¼ ë´ì•¼ í•´.
    const summary = data?.summary || "AI ìš”ì•½ì´ ì—†ìŠµë‹ˆë‹¤. (API ì‘ë‹µ êµ¬ì¡° í™•ì¸ í•„ìš”)";
    const sources = (data?.documents || data?.articles || data?.items || []).map(doc => ({
        title: doc.title,
        url: doc.url,
        summary: doc.summary_ko // (ì¶”ì¸¡)
    })); 
    
    // (ì¶”ì¸¡) ìš”ì•½ì´ ë”°ë¡œ ì•ˆ ì˜¤ë©´ ì²« ë²ˆì§¸ ë¬¸ì„œ ìš”ì•½ì„ ì”€
    const finalSummary = summary === "AI ìš”ì•½ì´ ì—†ìŠµë‹ˆë‹¤. (API ì‘ë‹µ êµ¬ì¡° í™•ì¸ í•„ìš”)" 
                         ? (sources[0]?.summary || summary) 
                         : summary;

    renderSearch(finalSummary, sources);

  } catch (e) {
    console.error("internalSearch failed:", e);
    renderSearch(`'${s}' ê²€ìƒ‰ ì‹¤íŒ¨: ${e.message} (API í‚¤/ì‘ë‹µ êµ¬ì¡° í™•ì¸)`, []);
  }
}

// â˜…â˜…â˜… (ìˆ˜ì • 4/4) loadFeed í•¨ìˆ˜ë¥¼ DeepSearch API í˜¸ì¶œí•˜ë„ë¡ ìˆ˜ì • (ì„¤ê³„ë„ ë°˜ì˜)
async function loadFeed(topic="IT"){
  const c=$$("rightFeed");
  if (!FEED_API_ENDPOINT || !DEEPSEARCH_API_KEY.startsWith("5e")) {
    c.innerHTML = `<div class="feed-item"><div class="feed-content">DEEPSEARCH_API_KEYê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</div></div>`;
    return;
  }
  c.innerHTML = `<div class="spinner"></div>`; 
  
  try {
    // ğŸ‘ˆ 'ì„¤ê³„ë„' ë°˜ì˜: GET, /v1/global-articles, ì¿¼ë¦¬ë¡œ topic
    const res = await fetch(`${FEED_API_ENDPOINT}/v1/global-articles?q=${encodeURIComponent(topic)}&limit=10&return_fields=title,url,provider_name,image_url`, {
        method: "GET",
        headers: {
            "Authorization": `Bearer ${DEEPSEARCH_API_KEY}` // ğŸ‘ˆ 'ì„¤ê³„ë„' ë°˜ì˜: í—¤ë” ì¸ì¦
        }
    });
    if (!res.ok) throw new Error(`DeepSearch í”¼ë“œ API ì—ëŸ¬: ${res.status}`);
    
    const data = await res.json();
    
    // ğŸ”´ (ê²½ê³ !) ì´ ë¶€ë¶„ë„ ë‚´ê°€ 100% ì¶”ì¸¡í•œ ê±°ì•¼! API ë¬¸ì„œì˜ 'ì‘ë‹µ ì˜ˆì‹œ'ë¥¼ ë´ì•¼ í•´.
    const items = data?.documents || data?.articles || data?.items || [];
    
    if (!items.length) {
        c.innerHTML = `<div class="feed-item"><div class="feed-content">ì‹¤ì‹œê°„ í”¼ë“œê°€ ì—†ìŠµë‹ˆë‹¤. (API ì‘ë‹µ êµ¬ì¡° í™•ì¸ í•„ìš”)</div></div>`;
        return;
    }
    
    c.innerHTML = items.map(it=>`
      <div class="feed-item" onclick="window.open('${escapeHtml(it.url || '#')}','_blank')">
        <img src="${escapeHtml(it.image_url || 'https://placehold.co/340x140/cccccc/333333?text=No+Image')}" alt="ë‰´ìŠ¤ ì¸ë„¤ì¼">
        <div class="feed-content">
          <div class="feed-source">${escapeHtml(it.provider_name || "ì¶œì²˜ ë¶ˆëª…")}</div>
          <div class="feed-title">${escapeHtml(it.title)}</div>
        </div>
      </div>`).join("");
      
  } catch (e) {
    console.error("loadFeed failed:", e);
    c.innerHTML = `<div class="feed-item"><div class="feed-content">í”¼ë“œ ë¡œë“œ ì‹¤íŒ¨: ${e.message} (API í‚¤/ì‘ë‹µ êµ¬ì¡° í™•ì¸)</div></div>`;
  }
}

/* ========= Command Bar ========= */
function setupCommandBar(){
  const cmdInput=$$("cmdInput"), cmdSend=$$("cmdSend");
  async function handle(){
    const v=(cmdInput.value||"").trim();
    if(!v) return;
    if(v.startsWith("/search") || v.startsWith("?")) { await internalSearch(v); }
    else { openChat(); await sendChat(v); }
    cmdInput.value="";
  }
  cmdSend.onclick=handle;
  cmdInput.addEventListener("keydown",(e)=>{ if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); handle(); }});
  $$("cmdSuggestions").addEventListener('click',(e)=>{
    const b=e.target.closest(".chip"); if(!b) return;
    if(b.dataset.cmd==="create_doc"){ editor.setData("<h1>ìƒˆ ë¬¸ì„œ í…œí”Œë¦¿</h1><p>ì—¬ê¸°ì— ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.</p>"); saveDoc(); }
    if(b.dataset.cmd==="edit_doc"){ openChat(); sendChat("ì´ ë¬¸ì„œ ë¬¸ì¥ ë‹¤ë“¬ì–´ì¤˜"); }
  });
}

/* ========= Helper Model (ì˜¤í”„ë¼ì¸) ========= */
// (callHelperModel í•¨ìˆ˜ëŠ” ì´ì „ê³¼ ë™ì¼... ìƒëµ)
const helperResponses={
  greeting:["ì•ˆë…•í•˜ì„¸ìš”! ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”? (í—¬í¼ 1.0)","ë°˜ê°‘ìŠµë‹ˆë‹¤! (í—¬í¼ 1.0)"],
  thanks:["ì²œë§Œì—ìš”! (í—¬í¼ 1.0)","ì–¸ì œë“ ì§€ìš”! (í—¬í¼ 1.0)"],
  default:["ì¡°ê¸ˆ ë” êµ¬ì²´ì ìœ¼ë¡œ ì•Œë ¤ì£¼ì‹¤ë˜ìš”? (í—¬í¼ 1.0)","ìŒâ€¦ ê·¸ê±´ ì–´ë ¤ì›Œìš”. ë‹¤ë¥¸ ë°©ì‹ìœ¼ë¡œ ë¬¼ì–´ë³¼ê¹Œìš”? (í—¬í¼ 1.0)"]
};
function callHelperModel(prompt){
  const p=prompt.toLowerCase();
  if(/(hi|hello|ì•ˆë…•)/.test(p)) return helperResponses.greeting[Math.floor(Math.random()*helperResponses.greeting.length)];
  if(/(ê³ ë§ˆì›Œ|ê°ì‚¬)/.test(p)) return helperResponses.thanks[Math.floor(Math.random()*helperResponses.thanks.length)];
  if(/ìš”ì•½/.test(p)){
    const text=editor.getData().replace(/<[^>]+>/g," ").trim().slice(0,600);
    if(!text) return "ìš”ì•½í•  ë‚´ìš©ì´ ì—†ì–´ìš”. (í—¬í¼ 1.0)";
    const bullets=text.split(/[.?!]\s+/).slice(0,5).map(s=>"- "+s.trim()).join("\n");
    return "ìš”ì•½(ë°ëª¨):\n"+bullets+"\n(í—¬í¼ 1.0)";
  }
  return helperResponses.default[Math.floor(Math.random()*helperResponses.default.length)];
}

/* ========= Chat ========= */
// (Chat ê´€ë ¨ í•¨ìˆ˜ëŠ” ì´ì „ê³¼ ë™ì¼... EC2 ì„œë²„ /ask í˜¸ì¶œ)
const THREADS_KEY="th.threads";
function threads(){try{return JSON.parse(localStorage.getItem(THREADS_KEY)||"[]")}catch{return[]}}
function saveThreads(a){localStorage.setItem(THREADS_KEY,JSON.stringify(a||[]))}
let chatHistory=[], threadId=null;
function renderThreads(){
  const list=threads();
  const el=$$("chatThreads");
  el.innerHTML=list.map(t=>`<div class="threadRow" data-id="${t.id}" data-active="${t.id===threadId?1:0}">
     <div style="flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${escapeHtml(t.title||"ìƒˆ ìŠ¤ë ˆë“œ")}</div>
     <div class="threadActions"><button class="iconbtn" data-del="${t.id}">ğŸ—‘ï¸</button></div>
  </div>`).join("") || `<div class="threadRow">ìŠ¤ë ˆë“œê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
  el.onclick=(e)=>{
    const d=e.target.closest("[data-del]");
    const r=e.target.closest(".threadRow[data-id]");
    if(d){ const id=d.dataset.del; const ls=threads().filter(x=>x.id!==id); saveThreads(ls); if(threadId===id){threadId=null; chatHistory=[]; $$("chatBody").innerHTML="";} renderThreads(); return; }
    if(r){ openThread(r.dataset.id); }
  };
}
function newThread(){
  const id="t_"+Date.now(); threadId=id; chatHistory=[];
  const list=[{id, title:"ìƒˆ ìŠ¤ë ˆë“œ", history:[]} , ...threads()];
  saveThreads(list); renderThreads(); $$("threadTitleInput").value="ìƒˆ ìŠ¤ë ˆë“œ"; $$("chatBody").innerHTML="";
}
function openThread(id){
  const t=threads().find(x=>x.id===id); if(!t) return;
  threadId=id; chatHistory=t.history||[];
  $$("threadTitleInput").value=t.title||"";
  $$("chatBody").innerHTML="";
  chatHistory.forEach(m=>addBubble(m.content, m.role==='user', false));
  renderThreads();
}
function persistThread(){
  if(!threadId) newThread();
  const title=$$("threadTitleInput").value.trim()||"ìƒˆ ìŠ¤ë ˆë“œ";
  const list=threads();
  const i=list.findIndex(x=>x.id===threadId);
  const obj={ id:threadId, title, history:chatHistory.slice(-50) };
  if(i>=0) list[i]=obj; else list.unshift(obj);
  saveThreads(list); renderThreads();
}
$$("renameThread").onclick=persistThread;
$$("deleteThread").onclick=()=>{ if(threadId){ const list=threads().filter(x=>x.id!==threadId); saveThreads(list); threadId=null; chatHistory=[]; $$("chatBody").innerHTML=""; renderThreads(); }};
const chatDock=$$("chatDock"), chatInput=$$("chatInput");
function openChat(){ chatDock.style.display="flex"; chatDock.setAttribute("aria-hidden","false"); if(!threadId) newThread(); }
function closeChat(){ chatDock.style.display="none"; chatDock.setAttribute("aria-hidden","true"); }
$$("chatBtn").onclick=openChat; $$("chatClose").onclick=closeChat;
$$("btnChatPlus").onclick=(e)=>{e.stopPropagation(); const m=$$("chatPlusMenu"); m.style.display=m.style.display==="block"?"none":"block";};
document.addEventListener("click",()=>{const m=$$("chatPlusMenu"); if(m) m.style.display="none";});
function addBubble(text,me=false,isErr=false){
  const b=document.createElement("div"); b.className="bubble "+(me?"me":"ai")+(isErr?" sys":""); b.textContent=text;
  $$("chatBody").appendChild(b); b.scrollIntoView({behavior:"smooth",block:"end"}); return b;
}
async function typeOut(b,text,delay=4){ b.textContent=""; for(let i=1;i<=text.length;i++){ b.textContent=text.slice(0,i); if(i%3===0 && delay>0) await sleep(delay);} }
$$("chatBody").addEventListener('click', (e)=>{ const bub=e.target.closest(".bubble.ai"); if(!bub) return; chatInput.value=bub.textContent; chatInput.focus(); });

async function sendChat(msg){
  addBubble(msg, true);
  chatHistory.push({role: "user", content: msg});
  persistThread();
  const holder = addBubble("â€¦", false);
  
  if (SERVER_API_ENDPOINT) {
      try {
          const res = await fetch(SERVER_API_ENDPOINT + "/ask", { 
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                  question: msg, 
                  id: threadId || ""
              })
          });
          if (!res.ok) throw new Error(`ì„œë²„ ì—ëŸ¬: ${res.status}`);
          const data = await res.json();
          const reply = data?.answer || "(AI ì‘ë‹µì´ ì—†ìŠµë‹ˆë‹¤)"; 
          await typeOut(holder, reply);
          updateChatUI(data?.plan); 
          chatHistory.push({role: "assistant", content: holder.textContent});
          persistThread();
      } catch (e) {
          console.error("Chat API failed:", e);
          const errMsg = "ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (CORS ë˜ëŠ” ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤)";
          await typeOut(holder, errMsg, 0); 
          holder.classList.add("sys");
          updateChatUI("offline");
      }
  } else {
      const reply = callHelperModel(msg, chatHistory);
      await typeOut(holder, reply);
      updateChatUI("helper_1.0_offline");
      chatHistory.push({role: "assistant", content: holder.textContent});
      persistThread();
  }
}

$$("chatForm").addEventListener("submit",async (e)=>{
  e.preventDefault(); const t=chatInput.value.trim(); if(!t) return; chatInput.value=""; sendChat(t);
});
$$("btnAttach").onclick=()=>$$("filePick").click();
$$("filePick").addEventListener("change",(e)=>{ const f=e.target.files?.[0]; if(!f) return; addBubble(`íŒŒì¼ì„ ë°›ì•˜ì–´ìš”: ${f.name} (${Math.round(f.size/1024)}KB)`, false); });

/* ========= Footer Location ========= */
(async function(){
  try{
    const r=await fetch("https://ipapi.co/json");
    const a=await r.json();
    if(a?.city) $$("loc").textContent=`ğŸ“ ${a.city}, ${a.country_name}`;
    else throw new Error();
  }catch{ $$("loc").textContent="ğŸ“ ìœ„ì¹˜ í™•ì¸ ë¶ˆê°€"; }
})();

/* ========= Gaze Cursor ========= */
function setupGazeCursor(){ $$("gaze").style.display = settings.gaze ? "block" : "none"; }
document.addEventListener("mousemove",(e)=>{ if($$("gaze").style.display==="block"){ const g=$$("gaze"); g.style.left=e.clientX+"px"; g.style.top=e.clientY+"px"; }});

/* ========= Keyboard Shortcuts ========= */
document.addEventListener("keydown",(e)=>{ if((e.ctrlKey||e.metaKey)&&(e.key||"").toLowerCase()==="k"){e.preventDefault(); $$("cmdInput").focus(); $$("cmdInput").select();}});
$$("suggList").addEventListener("click",(e)=>{const li=e.target.closest("li[data-idx]"); if(li) applySuggestion(Number(li.dataset.idx));});

/* ========= Init ========= */
(async function(){
  try{ await initEditor(""); }catch(e){ alert("ì—ë””í„° ë¡œë”© ì‹¤íŒ¨: "+e.message); return; }
  const last=store.current(); if(last && store.get(last)) openDoc(last); else newDoc(); renderList();
  setupCommandBar(); setupGazeCursor(); updateGhostSuggest(); renderThreads(); loadFeed();
})();
</script>
</body>
</html>
