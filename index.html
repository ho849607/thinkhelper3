<!DOCTYPE html>
<html lang="ko" data-theme="light">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>ThinkHelper â€” Editor</title>
<link rel="icon" href="data:,"/>

<!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-NXBQK43Z');</script>
<!-- End Google Tag Manager -->

<!-- CKEditor -->
<script src="https://cdn.ckeditor.com/ckeditor5/41.3.1/classic/ckeditor.js"></script>

<!-- Export (PDFë§Œ ìœ ì§€) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" defer></script>

<!-- WebGazer (ì˜µì…˜) -->
<script src="https://cdn.jsdelivr.net/npm/webgazer/dist/webgazer.min.js" defer></script>

<style>
:root{
  --bg:#f6f8fb; --fg:#0b1020; --muted:#6a7691;
  --panel:#ffffff; --card:#f2f5ff; --border:#d6deee;
  --hover:#e9effe; --accent:#2563eb; --accent-2:#f59e0b;
  --vscode:#1e1e1e; --vscode-2:#252526; --vscode-border:#333842;
}
:root[data-theme="dark"]{
  --bg:#0b1020; --fg:#f1f5ff; --muted:#a8b4cf;
  --panel:#0f172a; --card:#101a30; --border:#273453;
  --hover:#16213b; --accent:#60a5fa; --accent-2:#f59e0b;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--fg);
  font-family:-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif;
  display:flex;flex-direction:column}
body.hide-cursor{cursor:none}

/* Topbar */
.topbar{display:flex;gap:8px;align-items:center;padding:10px 12px;background:var(--panel);
  border-bottom:1px solid var(--border);position:sticky;top:0;z-index:40}
.brand{display:flex;align-items:center;gap:8px;font-weight:900}
.logo{width:18px;height:18px;border-radius:4px;background:linear-gradient(135deg,#60a5fa,#34d399)}
.btn{border:1px solid var(--border);background:var(--card);color:var(--fg);
  border-radius:8px;padding:.45rem .7rem;font-weight:900;cursor:pointer}
.btn:hover{background:var(--hover)}
.btn[disabled]{opacity:.6;cursor:not-allowed}

/* Menus */
.menu{position:relative}
.menu>.btn{font-weight:900}
.dropdown{display:none;position:absolute;top:42px;left:0;background:var(--panel);border:1px solid var(--border);
  border-radius:10px;min-width:280px;box-shadow:0 12px 24px rgba(0,0,0,.12);z-index:50}
.dropdown .item{padding:.55rem .7rem;border-bottom:1px dashed var(--border);cursor:pointer;
  display:flex;justify-content:space-between;gap:10px;align-items:center}
.dropdown .item:last-child{border-bottom:none}
.dropdown .item:hover{background:var(--hover)}
.badge{font-size:.72rem;padding:.1rem .35rem;border-radius:6px;border:1px solid var(--border);opacity:.8}

/* Layout */
main{flex:1;min-height:0;display:grid;grid-template-columns:260px 1fr;gap:10px;padding:10px}
@media (max-width:1200px){ main{grid-template-columns:0 1fr; padding:6px} #left{display:none}}
aside#left{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:10px;display:flex;flex-direction:column;min-height:0}
.listHead{display:flex;align-items:center;gap:8px}
#addDoc{margin-left:auto}
#docList{flex:1;overflow:auto;display:flex;flex-direction:column;gap:8px;margin-top:10px}
.notice{opacity:.75;padding:8px}
.doc{display:flex;gap:8px;align-items:center;padding:8px;background:var(--card);border:1px solid var(--border);border-radius:10px;cursor:pointer}
.doc:hover{background:var(--hover)}
.doc .title{flex:1;font-weight:900;color:var(--fg);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.doc .time{font-size:.78rem;color:var(--muted)}
.doc .act{display:none;gap:6px}
.doc:hover .act{display:inline-flex}
.iconbtn{border:1px solid var(--border);background:transparent;color:var(--fg);border-radius:6px;padding:.1rem .35rem;cursor:pointer}
.iconbtn:hover{background:var(--hover)}

section#center{display:flex;flex-direction:column;gap:10px;min-width:0}
#editorWrap{border:1px solid var(--border);border-radius:12px;background:var(--panel);padding:8px;position:relative}
#editor{min-height:62vh}

/* CKEditor ë°°ì§€ ìˆ¨ê¹€ */
.ck-balloon-panel,.ck-powered-by-balloon{display:none!important}
.ck-editor__editable_inline{
  min-height:58vh!important;color:#222;background:#fff;padding:12px;
  padding-bottom:140px;
  border-radius:8px;
  position:relative; z-index:1;
}
[data-theme="dark"] .ck-editor__editable_inline{color:#ffe7b3;background:#0b1327}

/* VSCode ìŠ¤íƒ€ì¼ ì¶”ì²œì–´ */
#suggPopup{position:absolute;display:none;z-index:60;background:var(--panel);color:var(--fg);
  border:1px solid var(--border);border-radius:10px;box-shadow:0 12px 24px rgba(0,0,0,.18);
  min-width:280px;max-width:560px}
#suggPopup header{padding:6px 10px;border-bottom:1px solid var(--border);font-size:.82rem;color:var(--muted)}
#suggPopup ul{list-style:none;margin:0;padding:6px;max-height:260px;overflow:auto}
#suggPopup li{padding:8px 10px;border-radius:8px;display:flex;gap:8px;cursor:pointer;align-items:center}
#suggPopup li[data-active="1"]{background:var(--hover);outline:1.5px solid #8ab4ff66}
.kind{opacity:.75;font-size:.75rem;width:120px;flex:0 0 auto;color:#ffd58a}

/* Search â€” sticky */
#searchRow{
  display:flex;gap:10px;padding:10px;background:var(--panel);
  border:1px solid var(--border);border-radius:12px;align-items:flex-start;
  position:sticky; top:10px; z-index:25;
}
#searchBox{flex:1;height:44px;border:2px solid var(--border);border-radius:12px;background:var(--card);color:var(--fg);padding:.6rem .9rem;font-size:16px}
#searchBtn{height:44px}
#suggestList{display:none;position:absolute;left:10px;right:96px;top:60px;background:var(--panel);border:1px solid var(--border);border-radius:10px;box-shadow:0 12px 24px rgba(0,0,0,.15);z-index:26;max-height:240px;overflow:auto}
#suggestList .sugg{padding:.55rem .7rem;border-bottom:1px dashed var(--border);cursor:pointer}
#suggestList .sugg:last-child{border-bottom:none}
#suggestList .sugg[data-active="1"]{background:var(--hover)}

/* Footer */
footer {
  position: fixed; bottom: 0; left: 0; right: 0;
  background: var(--bg); padding: 8px 10px; border-top: 1px solid var(--border);
  font-size: 0.92rem; text-align: center; user-select: none; -webkit-user-select: none;
  pointer-events: none; z-index: 10;
}
footer a{pointer-events:auto;}
body { padding-bottom: 64px; }

/* ê°œë°œì ëª¨ë“œ */
body.dev .topbar, body.dev aside#left, body.dev #editorWrap, body.dev #searchRow{background:var(--vscode); border-color:var(--vscode-border)}
body.dev .btn{background:var(--vscode-2); border-color:var(--vscode-border); color:#e6e6e6}
body.dev .btn:hover{background:#2a2d2e}
body.dev .doc{background:#222; border-color:#333}
body.dev .doc:hover{background:#2a2d2e}
body.dev #searchBox{background:#1f1f1f; border-color:#333; color:#e6e6e6}

/* Chat dock */
#chatBtn{position:fixed;right:16px;bottom:80px;z-index:60}
/* í•­ìƒ ë³´ì´ê²Œ */
#chatDock{position:fixed;right:16px;bottom:16px;width:min(92vw,880px);height:74vh;display:flex;flex-direction:column;background:var(--panel);border:1px solid var(--border);border-radius:14px;box-shadow:0 18px 36px rgba(0,0,0,.28);z-index:70}
#chatHead{display:flex;align-items:center;gap:8px;justify-content:space-between;padding:12px;border-bottom:1px solid var(--border);font-weight:900}
#chatWrap{flex:1;display:grid;grid-template-columns:220px 1fr;min-height:0}
#chatThreads{border-right:1px solid var(--border);padding:10px;overflow:auto}
.threadRow{display:flex;gap:6px;align-items:center;padding:8px;border:1px solid var(--border);border-radius:10px;background:var(--card);cursor:pointer;margin-bottom:8px}
.threadRow:hover{background:var(--hover)}
.threadRow[data-active="1"]{outline:2px solid #9bbcff}
#chatMain{display:flex;flex-direction:column;min-width:0}
#chatBody{flex:1;overflow:auto;padding:12px;display:flex;flex-direction:column;gap:10px}
.bubble{max-width:85%;padding:.75rem 1rem;border:1px solid var(--border);border-radius:14px;background:var(--card);word-break:break-word;font-size:1.02rem;line-height:1.55;white-space:pre-wrap;position:relative}
.me{margin-left:auto;background:#143763;color:#fff;border-color:#143763}
.ai{margin-right:auto;border-color:#3b4b72;background:#15284f;color:#fff}
.sys{margin:0 auto;background:#eef2ff;border-style:dashed;color:#111}
.bAct{position:absolute;right:6px;top:6px;opacity:.85}
#chatForm{display:flex;gap:8px;padding:12px;border-top:1px solid var(--border)}
#chatInput{flex:1;border:1px solid var(--border);border-radius:10px;background:var(--card);color:#000;padding:.75rem .9rem;font-size:1.02rem;resize:vertical}
#quota{position:absolute;left:12px;bottom:12px;background:var(--panel);border:1px solid var(--border);border-radius:8px;padding:.25rem .55rem;font-size:.85rem;color:#666}

/* ì‹œì„  ì»¤ì„œ */
#gazeCursor{
  position:fixed; left:0; top:0; width:18px; height:18px; margin:-9px 0 0 -9px;
  border:2px solid var(--accent); border-radius:50%; pointer-events:none; z-index:120; display:none;
  box-shadow:0 0 0 3px rgba(96,165,250,0.25);
  background:radial-gradient(circle at 50% 50%, rgba(96,165,250,.35), rgba(96,165,250,0) 60%);
  transition: transform 0.05s linear;
}

/* ===== ë™ì˜ ëª¨ë‹¬ ===== */
#consentMask{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:200}
#consentCard{width:min(92vw,720px);max-height:82vh;overflow:auto;background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:16px 16px 12px}
#consentCard h3{margin:0 0 8px}
#consentCard .desc{margin:6px 0 12px;color:var(--muted);line-height:1.55}
#consentCard .box{border:1px solid var(--border);border-radius:12px;padding:10px;margin:8px 0;background:var(--card)}
#consentActions{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}
#btnConsentAgree:disabled{opacity:.6;cursor:not-allowed}
</style>
</head>
<body>
  <!-- Google Tag Manager (noscript) -->
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NXBQK43Z" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <!-- End Google Tag Manager (noscript) -->

  <div class="topbar">
    <div class="brand"><div class="logo"></div><div id="t_brand">ThinkHelper</div></div>

    <!-- ë„êµ¬ -->
    <div class="menu" data-menu>
      <button class="btn" id="t_tools">ë„êµ¬ â–¾</button>
      <div class="dropdown" id="dropTools">
        <div class="item" id="iNew"><span id="t_new">ìƒˆ ë¬¸ì„œ</span><span>âŒ˜/Ctrl+N</span></div>
        <div class="item" id="iSave"><span id="t_export">ë‚´ë³´ë‚´ê¸°/ì¸ì‡„</span><span>âŒ˜/Ctrl+S</span></div>
        <div class="item" id="iVSCode" style="display:none"><span id="t_vscode">VSCodeë¡œ ì—´ê¸°</span><span>â†—</span></div>
      </div>
    </div>

    <!-- ì„¤ì • -->
    <div class="menu" data-menu>
      <button class="btn" id="t_settings">ì„¤ì • â–¾</button>
      <div class="dropdown" id="dropSettings">
        <div class="item"><span id="t_lang">ì–¸ì–´</span>
          <select id="langSel">
            <option value="ko">í•œêµ­ì–´</option><option value="en">English</option><option value="ja">æ—¥æœ¬èª</option>
          </select>
        </div>
        <div class="item" style="justify-content:flex-start;gap:10px">
          <label><input type="checkbox" id="optDeep"> <span id="t_deep">ì‹¬ì¸µ ë¦¬ì„œì¹˜</span></label>
        </div>
        <div class="item" style="justify-content:flex-start;gap:10px">
          <label><input type="checkbox" id="optSugg" checked> <span id="t_sugg">ì œì•ˆì–´ í‘œì‹œ</span></label>
        </div>
        <div class="item" style="justify-content:flex-start;gap:10px">
          <label><input type="checkbox" id="optPersonal" checked> <span id="t_personal">ë§ì¶¤í˜• ì œì•ˆ í‘œì‹œ</span></label>
        </div>
        <div class="item" style="justify-content:flex-start;gap:10px">
          <label><input type="checkbox" id="optGaze"> <span id="t_gaze">ì‹œì„  ì»¤ì„œ(ì›¹ìº )</span></label>
        </div>
        <div class="item">
          <span id="t_mode">ëª¨ë“œ</span>
          <select id="modeSel">
            <option value="normal" data-i18n="mode_normal">ì¼ë°˜ ëª¨ë“œ</option>
            <option value="research" data-i18n="mode_research">ë¦¬ì„œì¹˜ ëª¨ë“œ</option>
            <option value="legal" data-i18n="mode_legal">ë¦¬ê±¸ ëª¨ë“œ</option>
            <option value="dev" data-i18n="mode_dev">ê°œë°œì ëª¨ë“œ</option>
          </select>
        </div>
        <div class="item" id="toggleTheme">ğŸŒ“ <span id="t_theme">í…Œë§ˆ ì „í™˜</span></div>
      </div>
    </div>

    <button class="btn" id="chatBtn" style="margin-left:auto">ğŸ’¬ <span id="t_chat">ì±„íŒ…</span></button>
  </div>

  <main>
    <aside id="left" aria-label="ë¬¸ì„œëª©ë¡">
      <div class="listHead">
        <b id="t_docs">ë¬¸ì„œ</b>
        <select id="sortSel" class="btn" style="margin-left:auto">
          <option value="updated" id="t_sort1">ìµœê·¼ ìˆ˜ì •ìˆœ</option>
          <option value="title" id="t_sort2">ì œëª©ìˆœ</option>
          <option value="created" id="t_sort3">ìƒì„±ìˆœ</option>
        </select>
        <button class="btn" id="addDoc" title="ìƒˆ ë¬¸ì„œ ì¶”ê°€">ï¼‹</button>
      </div>
      <div id="docList"></div>
    </aside>

    <section id="center">
      <div id="editorWrap">
        <div id="editor" aria-label="ì—ë””í„°"></div>
        <!-- VSCode ìŠ¤íƒ€ì¼ ì œì•ˆ -->
        <div id="suggPopup">
          <header id="t_sugg_header">ì¶”ì²œ</header>
          <ul id="suggList"></ul>
        </div>
      </div>

      <div id="searchRow">
        <input id="searchBox" placeholder="ê²€ìƒ‰(Enter) / Ctrl+K"/>
        <button class="btn" id="searchBtn"><span id="t_search">ê²€ìƒ‰</span></button>
        <div id="suggestList"></div>
      </div>
    </section>
  </main>

  <footer>
    <div>Â© ThinkHelper â€” âš ï¸ <span id="t_disclaimer">ì¸ê³µì§€ëŠ¥ ëª¨ë¸ì€ ì‹¤ìˆ˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì¤‘ìš”í•œ ì •ë³´ëŠ” ë°˜ë“œì‹œ ì¬ì°¨ í™•ì¸í•˜ì„¸ìš”.</span></div>
    <div id="loc">ğŸ“ <span id="t_loc_wait">ìœ„ì¹˜ í™•ì¸ ì¤‘â€¦</span> Â·
      <a id="lnk_terms" target="_blank" rel="noopener">ì´ìš©ì•½ê´€</a> Â·
      <a id="lnk_privacy" target="_blank" rel="noopener">ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨</a> Â·
      ë¬¸ì˜: <a id="lnk_email" href="mailto:ho849607@gmail.com?subject=ThinkHelper%20ë¬¸ì˜">ho849607@gmail.com</a>
    </div>
  </footer>

  <!-- ì‹œì„  ì»¤ì„œ -->
  <div id="gazeCursor"></div>

  <!-- ë‚´ë³´ë‚´ê¸° ëª¨ë‹¬ -->
  <div id="saveMask" style="position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:120">
    <div id="saveCard" role="dialog" aria-modal="true" style="width:min(92vw,520px);background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:14px">
      <h3 style="margin:0 0 8px" id="t_export_title">ë‚´ë³´ë‚´ê¸° / ì¸ì‡„</h3>
      <div class="save-grid" style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:10px">
        <button class="btn" id="btnExportPDF">PDF</button>
        <button class="btn" id="btnPrint"    >Print</button>
        <button class="btn" disabled>PPT <span class="badge" id="t_coming">ì¤€ë¹„ì¤‘</span></button>
        <button class="btn" disabled>HWP <span class="badge" id="t_coming2">ì¤€ë¹„ì¤‘</span></button>
        <button class="btn" disabled>DOCX <span class="badge" id="t_coming3">ì¤€ë¹„ì¤‘</span></button>
        <button class="btn" id="btnCloseSave" ><span id="t_close">ë‹«ê¸°</span></button>
      </div>
    </div>
  </div>

  <!-- ë™ì˜ ëª¨ë‹¬ (ëª¨ë‘ í•„ìˆ˜) -->
  <div id="consentMask">
    <div id="consentCard" role="dialog" aria-modal="true">
      <h3 id="c_title">ë² íƒ€ ì„œë¹„ìŠ¤ ì•ˆë‚´ ë° ë™ì˜</h3>
      <div class="desc" id="c_desc">
        ThinkHelperëŠ” ë¡œê·¸ì¸ ì—†ì´ ì´ìš©í•  ìˆ˜ ìˆëŠ” ë² íƒ€ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤. ê³„ì† ì‚¬ìš©í•˜ë ¤ë©´ ì•„ë˜ í•­ëª©ì— ëª¨ë‘ ë™ì˜í•´ ì£¼ì„¸ìš”.
      </div>

      <div class="box">
        <label style="display:flex;gap:8px;align-items:flex-start">
          <input type="checkbox" id="chkAuto" />
          <span id="c_auto">ìë™ ì œì•ˆ í‘œì‹œ(ì—ë””í„° ì œì•ˆ, ê²€ìƒ‰ ìë™ì™„ì„± í¬í•¨)ì— ë™ì˜í•©ë‹ˆë‹¤. (í•„ìˆ˜)</span>
        </label>
      </div>

      <div class="box">
        <label style="display:flex;gap:8px;align-items:flex-start">
          <input type="checkbox" id="chkPrivacy" />
          <span id="c_priv">ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨ì— ë™ì˜í•©ë‹ˆë‹¤. (í•„ìˆ˜) â€“
            <a id="c_priv_link" href="https://docs.google.com/document/d/1kmFzmp3ddJOKOp1TPsvsNzAuBKt6M0Vm0N_G5BIOZEE/edit?usp=sharing" target="_blank" rel="noopener">ë³´ê¸°</a></span>
        </label>
      </div>

      <div class="box">
        <label style="display:flex;gap:8px;align-items:flex-start">
          <input type="checkbox" id="chkThird" />
          <span id="c_third">ì œ3ì ì •ë³´ ì œê³µ(ì˜ˆ: IP ê¸°ë°˜ ìœ„ì¹˜í™•ì¸, ì œì•ˆ í˜¸ì¶œ)ì— ë™ì˜í•©ë‹ˆë‹¤. (í•„ìˆ˜)</span>
        </label>
      </div>

      <div class="box">
        <label style="display:flex;gap:8px;align-items:flex-start">
          <input type="checkbox" id="chkPay"/>
          <span id="c_pay">ê²°ì œ/ìš”ê¸ˆ ì•ˆë‚´ë¥¼ í™•ì¸í–ˆê³  ì´ì— ë™ì˜í•©ë‹ˆë‹¤. (í•„ìˆ˜) â€“
            <a id="c_pay_link" href="https://example.com/payments" target="_blank" rel="noopener">ê²°ì œ ì •ë³´</a></span>
        </label>
      </div>

      <div class="box">
        <label style="display:flex;gap:8px;align-items:flex-start">
          <input type="checkbox" id="chkTerms"/>
          <span>ì„œë¹„ìŠ¤ ì´ìš©ì•½ê´€ì— ë™ì˜í•©ë‹ˆë‹¤. (í•„ìˆ˜) â€“
            <a href="https://docs.google.com/document/d/1TLZ2m52s1mAd8BPzXDBQuXF6QZ_hLDZOyX6Y8TKALnE/edit?usp=sharing" target="_blank" rel="noopener">ë³´ê¸°</a></span>
        </label>
      </div>

      <div id="consentActions">
        <button class="btn" id="btnConsentAll">ëª¨ë‘ ì„ íƒ</button>
        <button class="btn" id="btnConsentAgree" disabled>ë™ì˜í•˜ê³  ì‹œì‘</button>
      </div>
      <div class="desc" id="c_contact">ë¬¸ì˜: <a id="c_email" href="mailto:ho849607@gmail.com?subject=ThinkHelper%20ë¬¸ì˜">ho849607@gmail.com</a></div>
    </div>
  </div>

  <!-- Chat Dock -->
  <div id="chatDock" role="dialog" aria-hidden="false">
    <div id="chatHead">
      <span id="t_chatTitle">AI ì±„íŒ…</span>
      <div class="actions" style="display:flex;gap:8px;align-items:center">
        <button class="btn" id="btnNewThread" title="ìƒˆ ì±„íŒ…">ï¼‹ ìƒˆ ì±„íŒ…</button>
        <select id="chatStyle" class="btn" title="ì‘ë‹µ ìŠ¤íƒ€ì¼">
          <option value="auto" selected>auto</option>
          <option value="fast">ì¦‰ì‹œì‘ë‹µ</option>
          <option value="think">ìƒê°ì¤‘</option>
        </select>
        <button class="btn" id="chatClose" aria-label="Close">âœ–</button>
      </div>
    </div>
    <div id="chatWrap">
      <aside id="chatThreads" aria-label="ì±„íŒ… ìŠ¤ë ˆë“œ"></aside>
      <section id="chatMain">
        <div id="chatBody"></div>
        <form id="chatForm">
          <textarea id="chatInput" rows="2" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš” (Enter=ì „ì†¡, Shift+Enter=ì¤„ë°”ê¿ˆ)"></textarea>
          <button class="btn" type="submit" id="t_send">ì „ì†¡</button>
        </form>
      </section>
    </div>
  </div>

<script>
/* =========================
   ThinkHelper front script
   ========================= */

/* ===== ê¸°ë³¸ ë§í¬ ===== */
const LINKS = {
  terms: "https://docs.google.com/document/d/1TLZ2m52s1mAd8BPzXDBQuXF6QZ_hLDZOyX6Y8TKALnE/edit?usp=sharing",
  privacy: "https://docs.google.com/document/d/1kmFzmp3ddJOKOp1TPsvsNzAuBKt6M0Vm0N_G5BIOZEE/edit?usp=sharing",
  payment: "https://example.com/payments",
  email: "ho849607@gmail.com"
};

/* ===== ë‹¤êµ­ì–´ ë¬¸ìì—´(I18N) ===== */
const I18N = {
  ko: {
    brand:"ThinkHelper", tools:"ë„êµ¬", settings:"ì„¤ì •", help:"ë„ì›€ë§", new:"ìƒˆ ë¬¸ì„œ", export:"ë‚´ë³´ë‚´ê¸°/ì¸ì‡„",
    vscode:"VSCodeë¡œ ì—´ê¸°", lang:"ì–¸ì–´", deep:"ì‹¬ì¸µ ë¦¬ì„œì¹˜", sugg:"ì œì•ˆì–´ í‘œì‹œ", personal:"ë§ì¶¤í˜• ì œì•ˆ í‘œì‹œ",
    gaze:"ì‹œì„  ì»¤ì„œ(ì›¹ìº )", mode:"ëª¨ë“œ", theme:"í…Œë§ˆ ì „í™˜", keys:"ë‹¨ì¶•í‚¤", note:"ì£¼ì˜", note_body:"AI ê²°ê³¼ëŠ” í•­ìƒ ê²€í† ",
    chat:"ì±„íŒ…", docs:"ë¬¸ì„œ", sort1:"ìµœê·¼ ìˆ˜ì •ìˆœ", sort2:"ì œëª©ìˆœ", sort3:"ìƒì„±ìˆœ", search:"ê²€ìƒ‰", sugg_header:"ì¶”ì²œ",
    disclaimer:"ì¸ê³µì§€ëŠ¥ ëª¨ë¸ì€ ì‹¤ìˆ˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì¤‘ìš”í•œ ì •ë³´ëŠ” ë°˜ë“œì‹œ ì¬ì°¨ í™•ì¸í•˜ì„¸ìš”.",
    chatTitle:"AI ì±„íŒ…", send:"ì „ì†¡", export_title:"ë‚´ë³´ë‚´ê¸° / ì¸ì‡„", coming:"ì¤€ë¹„ì¤‘", close:"ë‹«ê¸°",
    loc_wait:"ìœ„ì¹˜ í™•ì¸ ì¤‘â€¦", placeholder_search:"ê²€ìƒ‰(Enter) / Ctrl+K",
    placeholder_chat:"ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš” (Enter=ì „ì†¡, Shift+Enter=ì¤„ë°”ê¿ˆ)",
    loc_hidden:"ìœ„ì¹˜ ë¹„ê³µê°œ", untitled:"ë¬´ì œ"
  },
  en: {
    brand:"ThinkHelper", tools:"Tools", settings:"Settings", help:"Help", new:"New", export:"Export/Print",
    vscode:"Open in VSCode", lang:"Language", deep:"Deep research", sugg:"Show suggestions", personal:"Personalized suggestions",
    gaze:"Gaze cursor (webcam)", mode:"Mode", theme:"Toggle theme", keys:"Shortcuts", note:"Note", note_body:"Always review AI results",
    chat:"Chat", docs:"Docs", sort1:"Recently updated", sort2:"Title", sort3:"Created", search:"Search", sugg_header:"Suggestions",
    disclaimer:"AI can make mistakes. Please verify important information.",
    chatTitle:"AI Chat", send:"Send", export_title:"Export / Print", coming:"Coming soon", close:"Close",
    loc_wait:"Detecting locationâ€¦", placeholder_search:"Search (Enter) / Ctrl+K",
    placeholder_chat:"Type a message (Enter=send, Shift+Enter=newline)",
    loc_hidden:"Location hidden", untitled:"Untitled"
  },
  ja: {
    brand:"ThinkHelper", tools:"ãƒ„ãƒ¼ãƒ«", settings:"è¨­å®š", help:"ãƒ˜ãƒ«ãƒ—", new:"æ–°è¦", export:"ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ/å°åˆ·",
    vscode:"VSCodeã§é–‹ã", lang:"è¨€èª", deep:"ãƒªã‚µãƒ¼ãƒå¼·åŒ–", sugg:"ã‚µã‚¸ã‚§ã‚¹ãƒˆè¡¨ç¤º", personal:"ãƒ‘ãƒ¼ã‚½ãƒŠãƒ©ã‚¤ã‚º",
    gaze:"è¦–ç·šã‚«ãƒ¼ã‚½ãƒ«(ã‚«ãƒ¡ãƒ©)", mode:"ãƒ¢ãƒ¼ãƒ‰", theme:"ãƒ†ãƒ¼ãƒåˆ‡æ›¿", keys:"ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ", note:"æ³¨æ„", note_body:"AIçµæœã¯å¿…ãšç¢ºèª",
    chat:"ãƒãƒ£ãƒƒãƒˆ", docs:"ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ", sort1:"æ›´æ–°é †", sort2:"ã‚¿ã‚¤ãƒˆãƒ«é †", sort3:"ä½œæˆé †", search:"æ¤œç´¢", sugg_header:"ãŠã™ã™ã‚",
    disclaimer:"AIã¯èª¤ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚é‡è¦æƒ…å ±ã¯å¿…ãšç¢ºèªã—ã¦ãã ã•ã„ã€‚",
    chatTitle:"AIãƒãƒ£ãƒƒãƒˆ", send:"é€ä¿¡", export_title:"ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ / å°åˆ·", coming:"æº–å‚™ä¸­", close:"é–‰ã˜ã‚‹",
    loc_wait:"ä½ç½®æƒ…å ±ã‚’å–å¾—ä¸­â€¦", placeholder_search:"æ¤œç´¢(Enter) / Ctrl+K",
    placeholder_chat:"ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ› (Enter=é€ä¿¡, Shift+Enter=æ”¹è¡Œ)",
    loc_hidden:"ä½ç½®ã¯éå…¬é–‹", untitled:"ç„¡é¡Œ"
  }
};

/* ===== i18n ì‚¬ì „(ì¶”ì²œì–´ìš©) ===== */
const DICTS = {
  ko: {
    "ã„±": ["ê°œìš”","ê²½ì˜","ê²½ì œ","ê°œë°œ","êµìœ¡","ê²€ìƒ‰","ê¸°íš","ê°€ì´ë“œ","ê²¬ì ","ê²€ì¦"],
    "ã„´": ["ë„¤íŠ¸ì›Œí¬","ë†ì—…","ë‰´ìŠ¤","ë„›ì§€","ëŠ¥ë¥ "],
    "ã„·": ["ë°ì´í„°","ë””ìì¸","ë™ê¸°ë¶€ì—¬","ë™ì‘ì›ë¦¬","ëŒ€ì•ˆ","ëŒ€ì‹œë³´ë“œ"],
    "ã„¹": ["ë ˆí¼ëŸ°ìŠ¤","ë¦¬ë·°","ë¡œë“œë§µ","ë¼ì´ë¸ŒëŸ¬ë¦¬","ë¦¬ìŠ¤í¬"],
    "ã…": ["ëª¨ë¸","ë§ˆì¼€íŒ…","ë¬¸ì œì •ì˜","ë©”íŠ¸ë¦­","ëª¨ë²”ì‚¬ë¡€"],
    "ã…‚": ["ë³´ê³ ì„œ","ë¹„êµ","ë°±ì—”ë“œ","ë³´ì•ˆ","ë¶„ì„","ë¸Œëœë”©"],
    "ã……": ["ì„¤ê³„","ì‚¬ì–‘","ì‚¬ìš©ë²•","ì„±ê³¼","ì‚¬ë¡€","ìŠ¤í™"],
    "ã…‡": ["ì›ë¦¬","ìš”ì•½","ì˜µì…˜","ìš”êµ¬ì‚¬í•­","ì˜ˆì‹œ","ìš´ì˜"],
    "ã…ˆ": ["ì „ëµ","ì ˆì°¨","ìë£Œ","ì •ì±…","ì§€í‘œ","ì œì•ˆ"],
    "ã…Š": ["ì²´í¬ë¦¬ìŠ¤íŠ¸","ì¶œì‹œ","ì¶”ì²œ","ì°¸ê³ ","ìµœì í™”"],
    "ã…‹": ["ì½”ë“œ","ì»´íŒŒì¼","ìº˜ë¦°ë”","ìºì‹œ","í¬ë¡¤ë§"],
    "ã…Œ": ["í…ŒìŠ¤íŠ¸","íŠ¸ëŸ¬ë¸”ìŠˆíŒ…","íŠœí† ë¦¬ì–¼","íƒ€ì„ë¼ì¸"],
    "ã…": ["í”„ë¡œì„¸ìŠ¤","í”„ë¡¬í”„íŠ¸","í”„ë ˆì„ì›Œí¬","í‘œì¤€","í‰ê°€"],
    "ã…": ["í•µì‹¬","íš¨ìœ¨","í™œìš©","íšŒê³ ","íë¦„ë„"]
  },
  en: {
    a:["algorithm","api","architecture","analysis","agenda","ablation"],
    b:["benchmark","best practices","budget","backlog","business case"],
    c:["checklist","comparison","constraints","contract","cache","cloud"],
    d:["design","docs","debugging","data model","discovery"],
    e:["example","estimate","evaluation","experiment","etl"],
    f:["framework","faq","flowchart","features","forecast"],
    g:["guide","goals","glossary","governance","growth"],
    h:["how to","hypothesis","heuristics","handoff","history"],
    i:["intro","impact","implementation","issues","integration"],
    j:["jira tickets","jobs to be done","justification"],
    k:["key points","kpis","knowledge base"],
    l:["lessons learned","limitations","licensing","launch plan"],
    m:["metrics","milestones","mockups","modeling"],
    n:["notes","next steps","naming","network"],
    o:["overview","objectives","ops","observability"],
    p:["plan","proposal","pros & cons","protocol","prompt"],
    q:["quickstart","quality","questions"],
    r:["requirements","roadmap","risks","retrospective"],
    s:["spec","strategy","summary","sample","security"],
    t:["tutorial","timeline","test cases","trade-offs"],
    u:["use cases","user story","ux notes"],
    v:["validation","vision","versioning"],
    w:["workflow","workaround","why","wireframe"],
    x:["xml snippet","x-headers"],
    y:["yardstick","yaml","y-axis labels"],
    z:["zero-shot","z-score","zip steps"]
  },
  ja: {
    "ã‚":["æ¡ˆå†…","è¦ç´„","æŒ¨æ‹¶","å®‰å…¨","ã‚¢ã‚¤ãƒ‡ã‚¢","ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£"],
    "ã‹":["èª²é¡Œ","æ”¹å–„","ä¾¡æ ¼","è€ƒãˆæ–¹","ã‚«ã‚¿ãƒ­ã‚°","é–‹ç™º"],
    "ã•":["ä½œæˆæ‰‹é †","å‚è€ƒè³‡æ–™","ä»•æ§˜","äº‹ä¾‹","å·®åˆ†","ã‚µãƒãƒªãƒ¼"],
    "ãŸ":["å¯¾å¿œç­–","ä½“åˆ¶","ä½“é¨“è«‡","ã‚¿ã‚¹ã‚¯","å¯¾æ¯”","ãƒ†ã‚¹ãƒˆ"],
    "ãª":["æµã‚Œ(ãªãŒã‚Œ)","å†…å®¹","åå‰ä»˜ã‘","ãƒŠãƒ¬ãƒƒã‚¸","å†…è¨³"],
    "ã¯":["èƒŒæ™¯","æ–¹æ³•","åçœ","æ¯”è¼ƒ","ç™ºè¦‹","ãƒãƒ¼ã‚¸ãƒ§ãƒ³"],
    "ã¾":["ç›®çš„","ã¾ã¨ã‚","ãƒãƒ‹ãƒ¥ã‚¢ãƒ«","ãƒ¢ãƒ‡ãƒ«","ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³"],
    "ã‚„":["ã‚„ã‚Šæ–¹","å½¹å‰²","è¦ä»¶","ãƒ¦ãƒ¼ã‚¶ãƒ¼èª¿æŸ»"],
    "ã‚‰":["ç†ç”±","ãƒªã‚¹ã‚¯","ãƒ¬ãƒ“ãƒ¥ãƒ¼","ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—","ä¾‹"],
    "ã‚":["ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼","å‰²å½“","ã‚ã‹ã‚Šã‚„ã™ãèª¬æ˜","æ çµ„ã¿"]
  }
};

function T(k){return (I18N[conf.lang]||I18N.ko)[k];}

/* ===== ì–¸ì–´ ê°ì§€ ===== */
function detectLang(str){
  const s = (str||"").trim();
  if (/[ã-ã‚”ã‚¡-ãƒ´ãƒ¼ä¸€-é¾ ã€…ã€†ãƒµãƒ¶]/.test(s)) return "ja";
  if (/[ê°€-í£]/.test(s)) return "ko";
  return "en";
}

/* ===== í•œê¸€ ì´ˆì„± ê³„ì‚° ===== */
function getKoInitial(ch){
  const code = ch.charCodeAt(0);
  if (code < 0xAC00 || code > 0xD7A3) return null;
  const CHOSEONG = ["ã„±","ã„²","ã„´","ã„·","ã„¸","ã„¹","ã…","ã…‚","ã…ƒ","ã……","ã…†","ã…‡","ã…ˆ","ã…‰","ã…Š","ã…‹","ã…Œ","ã…","ã…"];
  const idx = Math.floor((code - 0xAC00) / (21 * 28));
  return CHOSEONG[idx] || null;
}

/* ===== ì¼ë³¸ì–´ í–‰ íŒë³„ ===== */
function getJaRow(ch){
  const rows={ã‚:"ã‚",ã„:"ã‚",ã†:"ã‚",ãˆ:"ã‚",ãŠ:"ã‚",
    ã‹:"ã‹",ã:"ã‹",ã:"ã‹",ã‘:"ã‹",ã“:"ã‹",
    ã•:"ã•",ã—:"ã•",ã™:"ã•",ã›:"ã•",ã:"ã•",
    ãŸ:"ãŸ",ã¡:"ãŸ",ã¤:"ãŸ",ã¦:"ãŸ",ã¨:"ãŸ",
    ãª:"ãª",ã«:"ãª",ã¬:"ãª",ã­:"ãª",ã®:"ãª",
    ã¯:"ã¯",ã²:"ã¯",ãµ:"ã¯",ã¸:"ã¯",ã»:"ã¯",
    ã¾:"ã¾",ã¿:"ã¾",ã‚€:"ã¾",ã‚:"ã¾",ã‚‚:"ã¾",
    ã‚„:"ã‚„",ã‚†:"ã‚„",ã‚ˆ:"ã‚„",
    ã‚‰:"ã‚‰",ã‚Š:"ã‚‰",ã‚‹:"ã‚‰",ã‚Œ:"ã‚‰",ã‚:"ã‚‰",
    ã‚:"ã‚",ã‚’:"ã‚",ã‚“:"ã‚",
    ã‚¢:"ã‚",ã‚¤:"ã‚",ã‚¦:"ã‚",ã‚¨:"ã‚",ã‚ª:"ã‚",
    ã‚«:"ã‹",ã‚­:"ã‹",ã‚¯:"ã‹",ã‚±:"ã‹",ã‚³:"ã‹",
    ã‚µ:"ã•",ã‚·:"ã•",ã‚¹:"ã•",ã‚»:"ã•",ã‚½:"ã•",
    ã‚¿:"ãŸ",ãƒ:"ãŸ",ãƒ„:"ãŸ",ãƒ†:"ãŸ",ãƒˆ:"ãŸ",
    ãƒŠ:"ãª",ãƒ‹:"ãª",ãƒŒ:"ãª",ãƒ:"ãª",ãƒ:"ãª",
    ãƒ:"ã¯",ãƒ’:"ã¯",ãƒ•:"ã¯",ãƒ˜:"ã¯",ãƒ›:"ã¯",
    ãƒ:"ã¾",ãƒŸ:"ã¾",ãƒ :"ã¾",ãƒ¡:"ã¾",ãƒ¢:"ã¾",
    ãƒ¤:"ã‚„",ãƒ¦:"ã‚„",ãƒ¨:"ã‚„",
    ãƒ©:"ã‚‰",ãƒª:"ã‚‰",ãƒ«:"ã‚‰",ãƒ¬:"ã‚‰",ãƒ­:"ã‚‰",
    ãƒ¯:"ã‚",ãƒ²:"ã‚",ãƒ³:"ã‚"};
  return rows[ch] || null;
}

/* ===== ì‚¬ì „ ì¡°íšŒ ===== */
function dictLookup(lang, token){
  if(!token) return [];
  const first = token[0];

  if (lang === "ko"){
    if (/[ã„±-ã…]/.test(first)) return (DICTS.ko[first] || []).slice(0, 10);
    const cho = getKoInitial(first);
    if (cho) return (DICTS.ko[cho] || []).slice(0, 10);
    return [];
  }
  if (lang === "en"){
    const k = first.toLowerCase();
    if (/[a-z]/.test(k)) return (DICTS.en[k] || []).slice(0, 10);
    return [];
  }
  if (lang === "ja"){
    const row = getJaRow(first);
    if (row) return (DICTS.ja[row] || []).slice(0, 10);
    return [];
  }
  return [];
}

/* ===== ì„¤ì •ê°’ ===== */
const conf={
  lang: localStorage.getItem("th.lang")||"ko",
  mode: localStorage.getItem("th.mode")||"normal",
  deep: localStorage.getItem("th.deep")==="1",
  sugg: localStorage.getItem("th.sugg")!=="0",
  personal: localStorage.getItem("th.personal")!=="0",
  gaze: localStorage.getItem("th.gaze")==="1"
};

/* ===== CKEditor ===== */
let editor=null, _rebuilding=false, _typeTimer=null;
async function initEditor(restoreHtml){
  editor = await ClassicEditor.create(
    document.getElementById('editor'),
    { placeholder: T('placeholder_editor') || '' }
  );
  if(restoreHtml!=null){ editor.setData(restoreHtml); }
  editor.model.document.on("change:data", onType);
  editor.editing.view.document.on("keydown",(evt,data)=>{
    const k=(data.key||"").toLowerCase();
    if((data.ctrlKey||data.metaKey)&&k==="s"){ data.preventDefault(); openSave(); }
    if((data.ctrlKey||data.metaKey)&&k==="k"){ data.preventDefault(); document.getElementById("searchBox").focus(); }
    if((data.ctrlKey||data.metaKey)&&k===" "){ data.preventDefault(); openSuggest(true); }
  });
}
function onType(){ clearTimeout(_typeTimer); _typeTimer=setTimeout(()=>openSuggest(false), 350); }
function getHTML(){ return editor ? editor.getData() : ""; }
function setHTML(h){ if(editor) editor.setData(h||""); }

/* ===== i18n & ë§í¬ ì£¼ì… ===== */
async function applyI18N(){
  const t=I18N[conf.lang]||I18N.ko;
  document.title = `${t.brand} â€” Editor`;
  const map={ t_brand:t.brand,t_tools:t.tools,t_settings:t.settings,t_help:t.help,t_new:t.new,t_export:t.export,
    t_vscode:t.vscode,t_lang:t.lang,t_deep:t.deep,t_sugg:t.sugg,t_personal:t.personal,t_gaze:t.gaze,
    t_mode:t.mode,t_theme:t.theme,t_keys:t.keys,t_note:t.note,t_note_body:t.note_body,t_chat:t.chat,
    t_docs:t.docs,t_sort1:t.sort1,t_sort2:t.sort2,t_sort3:t.sort3,t_search:t.search,t_sugg_header:t.sugg_header,
    t_disclaimer:t.disclaimer,t_chatTitle:t.chatTitle,t_send:t.send,t_export_title:t.export_title,
    t_coming:t.coming,t_close:t.close,t_loc_wait:t.loc_wait };
  for(const id in map){ const el=document.getElementById(id); if(el) el.textContent=map[id]; }
  document.getElementById("searchBox").placeholder=t.placeholder_search;
  const ci=document.getElementById("chatInput"); if(ci) ci.placeholder=t.placeholder_chat;

  // ë§í¬
  document.getElementById("lnk_terms").href=LINKS.terms;
  document.getElementById("lnk_privacy").href=LINKS.privacy;
  document.getElementById("lnk_email").href=`mailto:${LINKS.email}?subject=ThinkHelper%20${encodeURIComponent(conf.lang==="ko"?"ë¬¸ì˜":"Support")}`;

  // ì—ë””í„° ë‹¤ì‹œ ë¶™ì´ê¸°(placeholder ë°˜ì˜)
  if(editor && !_rebuilding){
    _rebuilding=true;
    const htmlBefore=getHTML();
    const hadFocus=document.activeElement && document.activeElement.closest('#editorWrap');
    await editor.destroy(); editor=null;
    await initEditor(htmlBefore);
    if(hadFocus){ document.querySelector('.ck-editor__editable')?.focus(); }
    _rebuilding=false;
  }
  renderList(true);
}

/* ===== ì´ˆê¸°í™” ===== */
document.addEventListener('DOMContentLoaded', async ()=>{
  document.getElementById("langSel").value=conf.lang;
  document.getElementById("modeSel").value=conf.mode;
  document.getElementById("optDeep").checked=conf.deep;
  document.getElementById("optSugg").checked=conf.sugg;
  document.getElementById("optPersonal").checked=conf.personal;
  document.getElementById("optGaze").checked=conf.gaze;
  await initEditor();
  await applyI18N();
  openConsentIfNeeded();
  await detectGeoAndMaybeSetLang();
});

/* ===== ë©”ë‰´ í† ê¸€ ===== */
(function(){
  const menus=[...document.querySelectorAll('[data-menu]')];
  function closeAll(){ document.querySelectorAll('.dropdown').forEach(d=> d.style.display='none'); }
  function toggle(btn){ const drop=btn.nextElementSibling; if(!drop) return;
    const willOpen = drop.style.display!=='block'; closeAll(); drop.style.display = willOpen ? 'block' : 'none'; }
  menus.forEach(m=>{
    const btn=m.querySelector('.btn'); const drop=m.querySelector('.dropdown'); if(!btn||!drop) return;
    btn.addEventListener('click',(e)=>{ e.stopPropagation(); toggle(btn); });
    ['pointerdown','click','change','input'].forEach(ev=> drop.addEventListener(ev,(e)=> e.stopPropagation()));
  });
  document.addEventListener('click',(e)=>{ if(!e.target.closest('[data-menu]')) closeAll(); });
})();

/* ===== ëª¨ë“œ/í…Œë§ˆ ===== */
function applyMode(){
  const bodyEl=document.body;
  bodyEl.classList.toggle('dev', conf.mode==='dev');
  document.getElementById('iVSCode').style.display = conf.mode==='dev' ? 'block':'none';
  const chatBtn=document.getElementById('chatBtn');
  chatBtn.style.display = conf.mode==='research' ? 'none' : 'inline-block';
}
document.getElementById('modeSel').addEventListener('change', (e)=>{
  conf.mode=e.target.value; localStorage.setItem("th.mode", conf.mode); applyMode();
});
document.getElementById('toggleTheme').addEventListener('click', ()=>{
  const isDark = document.documentElement.getAttribute('data-theme')==='dark';
  document.documentElement.setAttribute('data-theme', isDark?'light':'dark');
});
applyMode();

/* ===== ì–¸ì–´ ë³€ê²½ ===== */
document.getElementById("langSel").addEventListener('change', async (e)=>{
  conf.lang=e.target.value; localStorage.setItem("th.lang",conf.lang);
  localStorage.setItem("th.lang.manual","1"); // ì‚¬ìš©ìê°€ ì§ì ‘ ë°”ê¾¼ í”ì 
  await applyI18N();
  openSuggest(false);
});

/* ===== ë¡œì»¬ ì €ì¥ì†Œ(ë¬¸ì„œ) ===== */
const store={listKey:"th.docs.list", docKey:id=>`th.doc.${id}`, curKey:"th.cur",
  list(){try{return JSON.parse(localStorage.getItem(this.listKey)||"[]")}catch(e){return[]}},
  saveList(a){localStorage.setItem(this.listKey,JSON.stringify(a||[]))},
  get(id){try{return JSON.parse(localStorage.getItem(this.docKey(id))||"null")}catch(e){return null}},
  set(id,o){localStorage.setItem(this.docKey(id),JSON.stringify(o))},
  remove(id){localStorage.removeItem(this.docKey(id))},
  current(){return localStorage.getItem(this.curKey)||""},
  setCurrent(id){localStorage.setItem(this.curKey,id||"")}
};
let curId="";
function defaultTitle(){ return (I18N[conf.lang]||I18N.ko).untitled; }
function ensureTitleMap(doc){
  if(!doc.titleMap){
    const t=doc.title||defaultTitle();
    doc.titleMap={ko:t,en:t,ja:t};
  }
}
function listTitleFor(doc){ ensureTitleMap(doc); return doc.titleMap[conf.lang]||defaultTitle(); }
function renderList(migrate=false){
  const sort=document.getElementById("sortSel").value;
  const list=store.list();
  if(migrate){
    list.forEach(it=>{
      const d=store.get(it.id); if(!d) return; ensureTitleMap(d);
      const allUntitled = Object.values(d.titleMap).every(v=>["ë¬´ì œ","Untitled","ç„¡é¡Œ"].includes(v));
      if(allUntitled){ d.titleMap[conf.lang]=defaultTitle(); store.set(it.id,d); it.title=d.titleMap[conf.lang]; }
    });
  }
  list.sort((a,b)=>{
    const at=listTitleFor(store.get(a.id)||a), bt=listTitleFor(store.get(b.id)||b);
    return sort==="title" ? at.localeCompare(bt) :
           sort==="created"?((a.createdAt||0)-(b.createdAt||0)) :
           ((b.updatedAt||0)-(a.updatedAt||0));
  });
  const el=document.getElementById("docList");
  el.innerHTML = list.map(d=>{
    const dd=store.get(d.id)||d; ensureTitleMap(dd);
    const when=new Date(d.updatedAt||d.createdAt||Date.now()).toLocaleString();
    const title = escapeHtml(listTitleFor(dd));
    return `<div class="doc" data-open="${d.id}">
      <div class="title" title="${title}">${title}</div>
      <div class="time">${when}</div>
      <div class="act"><button class="iconbtn" data-rename="${d.id}">âœï¸</button><button class="iconbtn" data-del="${d.id}">âœ–</button></div>
    </div>`;
  }).join("") || `<div class="notice">ì €ì¥ëœ ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
  el.onclick=(e)=>{
    const r=e.target.closest("[data-rename]"); const d=e.target.closest("[data-del]");
    if(r){
      const id=r.dataset.rename; const doc=store.get(id); ensureTitleMap(doc);
      const t=prompt("ìƒˆ ë¬¸ì„œ ì œëª©:", doc.titleMap[conf.lang]||defaultTitle())||defaultTitle();
      doc.titleMap[conf.lang]=t; doc.updatedAt=Date.now(); store.set(id,doc);
      const L=store.list().map(x=>x.id===id?{...x,title:t,updatedAt:doc.updatedAt}:x); store.saveList(L); renderList();
      return;
    }
    if(d){
      const id=d.dataset.del;
      if(confirm("ì‚­ì œí• ê¹Œìš”?")){
        store.remove(id); store.saveList(store.list().filter(x=>x.id!==id)); if(curId===id){curId=""; setHTML("");} renderList();
      }
      return;
    }
    const row=e.target.closest("[data-open]"); if(row) openDoc(row.dataset.open);
  };
}
document.getElementById("sortSel").onchange=()=>renderList();
document.getElementById("addDoc").onclick=newDoc;
function newDoc(){
  const id="d_"+Date.now(); curId=id; store.setCurrent(id);
  const row={id, createdAt:Date.now(), updatedAt:Date.now(), titleMap:{ko:defaultTitle(),en:defaultTitle(),ja:defaultTitle()}};
  store.saveList([row,...store.list().filter(x=>x.id!==id)]);
  setHTML(""); store.set(id,{id, createdAt:row.createdAt, updatedAt:row.updatedAt, titleMap:row.titleMap, payload:btoa(unescape(encodeURIComponent("")))});
  renderList();
}
function doSave(){
  if(!curId) newDoc();
  const html=getHTML(); const doc=store.get(curId)||{id:curId};
  doc.payload=btoa(unescape(encodeURIComponent(html)));
  ensureTitleMap(doc);
  const title=prompt("ë¬¸ì„œ ì œëª©:",doc.titleMap[conf.lang]||defaultTitle())||defaultTitle();
  doc.titleMap[conf.lang]=title; doc.updatedAt=Date.now(); store.set(curId,doc);
  const list=store.list().filter(x=>x.id!==curId);
  list.unshift({id:curId,createdAt:doc.createdAt||Date.now(),updatedAt:doc.updatedAt});
  store.saveList(list); renderList();
}
function openDoc(id){ const d=store.get(id); if(!d) return; curId=id; store.setCurrent(id); const html=decodeURIComponent(escape(atob(d.payload||""))); setHTML(html||""); }
function escapeHtml(s){
  return String(s ?? "")
    .replace(/[&<>"']/g, m => ({
      "&": "&amp;","<": "&lt;",">": "&gt;","\"": "&quot;","'": "&#39;"
    }[m]));
}

/* ===== ë‹¨ì¶•í‚¤ ===== */
document.addEventListener("keydown",(e)=>{
  const k=(e.key||"").toLowerCase();
  if((e.metaKey||e.ctrlKey)&&k==="n"){ e.preventDefault(); newDoc(); }
  if((e.metaKey||e.ctrlKey)&&k==="s"){ e.preventDefault(); openSave(); }
  if((e.metaKey||e.ctrlKey)&&k==="k"){ e.preventDefault(); document.getElementById("searchBox").focus(); }
});

/* ===== ê²€ìƒ‰ ìë™ì™„ì„± + ë¼ìš°íŒ… ===== */
const suggBox=document.getElementById('suggestList');
let sItems=[], sIndex=-1;
async function fetchSuggest(q){
  if(!q){ suggBox.style.display='none'; return; }

  const lang = detectLang(q);
  const local = dictLookup(lang, q);
  if (local.length) {
    sItems = local.slice(0,8);
    renderSuggest();
    return;
  }

  try{
    const r = await fetch('https://suggestqueries.google.com/complete/search?client=firefox&q='+encodeURIComponent(q));
    const j = await r.json();
    sItems = (j && j[1]) ? j[1].slice(0,8) : [];
    renderSuggest();
  }catch{
    sItems=[]; suggBox.style.display='none';
  }
}

function renderSuggest(){
  if(!sItems.length){ suggBox.style.display='none'; return; }
  suggBox.innerHTML = sItems.map((t,i)=>`<div class="sugg" data-i="${i}" ${i===sIndex?'data-active="1"':''}>${escapeHtml(t)}</div>`).join("");
  suggBox.style.display='block';
}
const searchBox=document.getElementById('searchBox');
searchBox.addEventListener('focus',()=> fetchSuggest(searchBox.value.trim()));
searchBox.addEventListener('input',()=> fetchSuggest(searchBox.value.trim()));
searchBox.addEventListener('keydown',(e)=>{
  if(suggBox.style.display!=='block') { if(e.key==='Enter'){e.preventDefault(); runSearch();} return; }
  if(e.key==='ArrowDown'){ e.preventDefault(); sIndex=(sIndex+1)%sItems.length; renderSuggest(); }
  else if(e.key==='ArrowUp'){ e.preventDefault(); sIndex=(sIndex-1+sItems.length)%sItems.length; renderSuggest(); }
  else if(e.key==='Tab' || e.key==='Enter'){
    if(sIndex>=0){ e.preventDefault(); searchBox.value=sItems[sIndex]; suggBox.style.display='none'; runSearch(); }
    else if(e.key==='Enter'){ e.preventDefault(); runSearch(); }
  }
});
suggBox.addEventListener('click',(e)=>{ const it=e.target.closest('.sugg'); if(!it) return; const i=+it.dataset.i; searchBox.value=sItems[i]; suggBox.style.display='none'; runSearch(); });

function routeSearch(q){
  const low=q.toLowerCase().trim();
  const law=parseLaw(q);
  if(/ì¿ íŒ¡|coupang/.test(low)) return {title:"ì¿ íŒ¡", url:`https://www.coupang.com/np/search?q=${encodeURIComponent(q.replace(/ì¿ íŒ¡|coupang/ig,"").trim()||"")}`};
  if(/ì•„ë§ˆì¡´|amazon/.test(low)) return {title:"Amazon", url:`https://www.amazon.com/s?k=${encodeURIComponent(q.replace(/ì•„ë§ˆì¡´|amazon/ig,"").trim()||"")}&s=price-asc-rank`};
  if(/ë„¤ì´ë²„|naver/.test(low)) return {title:"Naver", url:`https://search.naver.com/search.naver?query=${encodeURIComponent(q.replace(/ë„¤ì´ë²„|naver/ig,"").trim()||"")}`};
  if(law) return {title:`${law.code} ì œ${law.article}ì¡°`, url:law.url};
  if(/ë‰´ìŠ¤|news/.test(low)) return {title:"News",url:`https://news.google.com/search?q=${encodeURIComponent(q.replace(/ë‰´ìŠ¤|news/ig,"").trim()||q)}`};
  return {title:"Google", url:`https://www.google.com/search?q=${encodeURIComponent(q)}`};
}
function parseLaw(q){
  const m=q.match(/(í˜•ë²•|ë¯¼ë²•|í˜•ì‚¬ì†Œì†¡ë²•|ë¯¼ì‚¬ì†Œì†¡ë²•|ìƒë²•)\s*ì œ?\s*(\d+)(ì¡°(?:ì˜\d+)*)?/); if(!m) return null;
  const code=m[1], art=m[2]+(m[3]||""); const url=`https://www.law.go.kr/%EB%B2%95%EB%A0%B9/${encodeURIComponent(code)}/${encodeURIComponent('ì œ'+art+'ì¡°')}`; return {code,article:art,url};
}
document.getElementById("searchBtn").onclick=()=> runSearch();
function runSearch(){
  const q=(document.getElementById("searchBox").value||"").trim(); if(!q) return;
  const r=routeSearch(q);
  try{ window.open(r.url,"_blank","noopener,noreferrer"); }catch{ location.href=r.url; }
}

/* ===== ì–¸ì–´ë³„ ì¶”ì²œì–´ ===== */
const TOKEN_RE=/[A-Za-z0-9ê°€-í£ã-ã‚”ã‚¡-ãƒ´ãƒ¼ä¸€-é¾ ã€…ã€†ãƒµãƒ¶ãƒ¼]+/g;
function getPlain(){ return getHTML().replace(/<[^>]+>/g," "); }
function currentToken(){
  const t=getPlain(); const parts=t.match(TOKEN_RE)||[];
  return parts[parts.length-1]||"";
}
const WORDS = {
  ko: ["ì •ì˜","ì›ë¦¬","í•µì‹¬","ì ˆì°¨","ì „ëµ","ì£¼ì˜ì ","ì‚¬ë¡€","í•œê³„","ëŒ€ì•ˆ","ë¹„êµ","í¬ì¸íŠ¸"],
  en: ["definition","principle","key points","process","strategy","pitfalls","examples","limitations","alternatives","comparison","takeaways"],
  ja: ["å®šç¾©","ä»•çµ„ã¿","è¦ç‚¹","æ‰‹é †","æˆ¦ç•¥","æ³¨æ„ç‚¹","äº‹ä¾‹","é™ç•Œ","ä»£æ›¿æ¡ˆ","æ¯”è¼ƒ","ãƒã‚¤ãƒ³ãƒˆ"]
};
const TEMPL = {
  ko: [
    (t)=>`${t}ë¥¼ ì‰½ê²Œ ì„¤ëª…í•´ ì£¼ì„¸ìš”.`,
    (t)=>`${t}ì˜ í•µì‹¬ë§Œ í•œ ë‹¨ë½ìœ¼ë¡œ ì •ë¦¬í•´ ì£¼ì„¸ìš”.`,
    (t)=>`${t}ì˜ ë‹¨ê³„ë³„ ì ˆì°¨ì™€ ì£¼ì˜í•  ì ì„ ì•Œë ¤ ì£¼ì„¸ìš”.`
  ],
  en: [
    (t)=>`Explain ${t} in simple terms.`,
    (t)=>`Summarize the key points of ${t} in one paragraph.`,
    (t)=>`List step-by-step process and pitfalls for ${t}.`
  ],
  ja: [
    (t)=>`${t}ã‚’åˆ†ã‹ã‚Šã‚„ã™ãèª¬æ˜ã—ã¦ãã ã•ã„ã€‚`,
    (t)=>`${t}ã®è¦ç‚¹ã‚’1æ®µè½ã§ã¾ã¨ã‚ã¦ãã ã•ã„ã€‚`,
    (t)=>`${t}ã®æ‰‹é †ã¨æ³¨æ„ç‚¹ã‚’ã‚¹ãƒ†ãƒƒãƒ—ã”ã¨ã«ç¤ºã—ã¦ãã ã•ã„ã€‚`
  ]
};
function smartSuggest(){
  const inputVal = (document.getElementById('chatInput')?.value||"").trim();
  const lang = detectLang(inputVal) || detectLang(getPlain()) || conf.lang;

  const keyToken = (currentToken() || "").slice(0, 30);
  const dictItems = dictLookup(lang, keyToken);
  if (dictItems.length) return dictItems;

  const key = keyToken || (lang==="ko"?"ì£¼ì œ": lang==="ja"?"ãƒ†ãƒ¼ãƒ":"topic");
  const wordList = WORDS[lang] || WORDS.ko;
  const templ    = TEMPL[lang] || TEMPL.ko;
  const words = wordList;
  const sents = templ.map(f=>f(key));
  const items = [...new Set([...words, ...sents])];
  return items.slice(0,10);
}

/* VSCode ìŠ¤íƒ€ì¼ íŒì—… (ì—ë””í„°) */
const suggPopup=document.getElementById("suggPopup"), suggList=document.getElementById("suggList");
let eItems=[], eSel=-1, hideUntilNextType=false;
function caretRect(){
  const sel=window.getSelection(); if(!sel||sel.rangeCount===0) return null;
  const r=sel.getRangeAt(0).cloneRange(); r.collapse(true);
  const rects=r.getClientRects(); if(!rects.length) return null; return rects[0];
}
function openSuggest(){
  if(!conf.sugg) return closeSuggest();
  if(hideUntilNextType){ hideUntilNextType=false; return; }
  const items = smartSuggest();
  if(!items.length) return closeSuggest();
  eItems=items.slice(0,12); eSel=-1;
  const tagLabel = (detectLang((document.getElementById('chatInput')?.value||""))==="en")?"Suggest":"ì¶”ì²œ";
  suggList.innerHTML=eItems.map((it,i)=>`<li data-i="${i}"><span class="kind">${tagLabel}</span><span>${escapeHtml(it)}</span></li>`).join("");
  Array.from(suggList.children).forEach(li=> li.onclick=()=> choose(+li.dataset.i));
  const r=caretRect(); if(!r){ closeSuggest(); return; }
  const host=document.getElementById("editorWrap").getBoundingClientRect();
  suggPopup.style.left=Math.max(6,(r.left-host.left))+"px";
  suggPopup.style.top=(r.bottom-host.top+6)+"px";
  suggPopup.style.display="block";
}
function closeSuggest(){ suggPopup.style.display='none'; eItems=[]; eSel=-1; }
document.addEventListener("keydown",(e)=>{
  if(suggPopup.style.display!=="block") return;
  const list=Array.from(document.querySelectorAll("#suggList li")); if(!list.length) return;
  if(e.key==="ArrowDown"){ e.preventDefault(); eSel=(eSel+1)%list.length; markSel(); }
  else if(e.key==="ArrowUp"){ e.preventDefault(); eSel=(eSel-1+list.length)%list.length; markSel(); }
  else if(e.key==="Enter"||e.key==="Tab"){ e.preventDefault(); if(eSel<0) eSel=0; choose(eSel); }
  else if(e.key==="Escape"){ e.preventDefault(); closeSuggest(); }
});
function markSel(){ Array.from(document.querySelectorAll("#suggList li")).forEach((li,i)=> li.setAttribute("data-active", i===eSel? "1":"0")); }
function choose(i){
  const it=eItems[i]; if(!it) return;
  const text = it + " ";
  editor.model.change(w=> editor.model.insertContent(w.createText(text)));
  closeSuggest(); hideUntilNextType=true;
}

/* ===== ê°„ë‹¨ í† ìŠ¤íŠ¸ ===== */
function toast(msg){
  const t=document.createElement("div");
  t.style.cssText="position:fixed;right:12px;bottom:12px;background:var(--panel);border:1px solid var(--border);padding:8px 10px;border-radius:10px;z-index:9999";
  t.textContent=msg; document.body.appendChild(t);
  setTimeout(()=>document.body.removeChild(t), 2200);
}

/* ===== ë‚´ë³´ë‚´ê¸° ===== */
const saveMask=document.getElementById('saveMask');
function openSave(){ saveMask.style.display='flex'; }
document.getElementById('iSave').onclick=openSave;
document.getElementById('btnCloseSave').onclick=()=>{ saveMask.style.display='none'; };
saveMask.addEventListener('click',(e)=>{ if(e.target===saveMask) saveMask.style.display='none'; });
document.getElementById('btnPrint').onclick=()=> window.print();
document.getElementById('btnExportPDF').onclick=()=>{
  const el=document.createElement('div'); el.innerHTML=getHTML();
  html2pdf().from(el).save('ThinkHelper_'+Date.now()+'.pdf');
};

/* ===== ì˜µì…˜ ìŠ¤ìœ„ì¹˜ ===== */
document.getElementById('optDeep').onchange=e=>{ conf.deep=e.target.checked; localStorage.setItem("th.deep", conf.deep?'1':'0'); };
document.getElementById('optSugg').onchange=e=>{ conf.sugg=e.target.checked; localStorage.setItem("th.sugg", conf.sugg?'1':'0'); };
document.getElementById('optPersonal').onchange=e=>{ conf.personal=e.target.checked; localStorage.setItem("th.personal", conf.personal?'1':'0'); };

/* ===== ì‹œì„  ì»¤ì„œ ===== */
const optGaze=document.getElementById('optGaze');
let gazeRunning=false, emaX=null, emaY=null;
optGaze.onchange=e=>{ conf.gaze=e.target.checked; localStorage.setItem("th.gaze",conf.gaze?"1":"0"); conf.gaze?startGaze():stopGaze(); };
async function startGaze(){
  if(gazeRunning) return;
  const cursor=document.getElementById("gazeCursor");
  try{
    if(!window.webgazer){ alert("WebGazer ë¡œë“œ ì „ì…ë‹ˆë‹¤."); return; }
    emaX=null; emaY=null;
    document.body.classList.add('hide-cursor');
    await webgazer.setRegression('ridge').setGazeListener((data)=>{
      if(!data) return;
      if(emaX===null){ emaX=data.x; emaY=data.y; }
      const a=.15; emaX += a*(data.x-emaX); emaY += a*(data.y-emaY);
      const cx=Math.max(0,Math.min(window.innerWidth,emaX));
      const cy=Math.max(0,Math.min(window.innerHeight,emaY));
      cursor.style.display="block"; cursor.style.transform=`translate(${cx}px,${cy}px)`;
    }).begin();
    webgazer.showVideo(false).showFaceOverlay(false).showFaceFeedbackBox(false);
    gazeRunning=true;
  }catch(e){ alert("ì¹´ë©”ë¼ ê¶Œí•œ í•„ìš”: "+e.message); }
}
async function stopGaze(){
  const c=document.getElementById("gazeCursor");
  c.style.display="none";
  try{ if(window.webgazer){ await webgazer.end(); } }catch{}
  gazeRunning=false;
  document.body.classList.remove('hide-cursor');
}

/* ===== ìœ„ì¹˜/IP í‘œê¸° & ì–¸ì–´ ìë™ì„¸íŒ… ===== */
async function detectGeoAndMaybeSetLang(){
  const el=document.getElementById('loc');
  try{
    const r=await fetch("https://ipapi.co/json/");
    const j=await r.json();
    el.textContent = `ğŸ“ ${[j.city,j.region,j.country_name].filter(Boolean).join(', ')} (IP: ${j.ip}) Â· `;

    const manual = localStorage.getItem("th.lang.manual")==="1";
    const autoFlag = localStorage.getItem("th.lang.autoSet")==="1";
    if(!manual && !autoFlag){
      const cc=(j.country_code||"").toUpperCase();
      const guess = cc==="KR" ? "ko" : cc==="JP" ? "ja" : "en";
      if(conf.lang!==guess){
        conf.lang=guess;
        localStorage.setItem("th.lang",guess);
        localStorage.setItem("th.lang.autoSet","1");
        await applyI18N();
      }else{
        localStorage.setItem("th.lang.autoSet","1");
      }
    }
  }catch{
    el.textContent="ğŸ“ "+(I18N[conf.lang]||I18N.ko).loc_hidden+" Â· ";
  }
  const suffix = document.createElement('span');
  suffix.innerHTML = `<a id="lnk_terms" target="_blank" rel="noopener">${"ì´ìš©ì•½ê´€"}</a> Â·
                      <a id="lnk_privacy" target="_blank" rel="noopener">${"ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨"}</a> Â·
                      ë¬¸ì˜: <a id="lnk_email"></a>`;
  el.appendChild(suffix);
  document.getElementById("lnk_terms").href=LINKS.terms;
  document.getElementById("lnk_privacy").href=LINKS.privacy;
  const e2=document.getElementById("lnk_email");
  e2.href=`mailto:${LINKS.email}?subject=ThinkHelper%20Support`;
  e2.textContent=LINKS.email;
}

/* ===== ì±„íŒ…: Lambda ìš°ì„ , ì‹¤íŒ¨ ì‹œ ë¡œì»¬ ===== */
const CHAT_ENDPOINT = "https://tfmyjwi617.execute-api.ap-northeast-1.amazonaws.com/default/chat";

async function callLambda(messages, timeoutMs=15000){
  const ctrl = new AbortController();
  const t = setTimeout(()=>ctrl.abort(), timeoutMs);
  try{
    const r = await fetch(CHAT_ENDPOINT, {
      method:"POST",
      headers:{ "Content-Type":"application/json", "Accept":"application/json" },
      body: JSON.stringify({ messages }),
      signal: ctrl.signal
    });
    clearTimeout(t);
    if(!r.ok) return "";
    const j = await r.json().catch(()=>null);
    return (j && (j.reply||j.text||j.output||j.message)) || "";
  }catch{
    clearTimeout(t);
    return "";
  }
}

const CHAT_LIST_KEY="th.chat.threads";
const CHAT_THREAD_KEY=(id)=>`th.chat.thread.${id}`;
const chatDock=document.getElementById("chatDock");
const chatBody=document.getElementById("chatBody");
const chatInput=document.getElementById("chatInput");
const chatSend=document.getElementById("t_send");
const chatThreadsEl=document.getElementById("chatThreads");
const chatStyleSel=document.getElementById("chatStyle");
let curThreadId=null;

document.getElementById("chatBtn").onclick=()=>{ chatDock.style.display="flex"; renderThreadList(); if(!curThreadId) newThread(); };
document.getElementById("chatClose").onclick=()=> chatDock.style.display="none";
document.getElementById("btnNewThread").onclick=()=> newThread();

function loadThreadList(){ try{ return JSON.parse(localStorage.getItem(CHAT_LIST_KEY)||"[]"); }catch{return[]}}
function saveThreadList(list){ localStorage.setItem(CHAT_LIST_KEY, JSON.stringify(list)); }
function getThreadData(id){ return JSON.parse(localStorage.getItem(CHAT_THREAD_KEY(id))||'{"messages":[]}'); }
function newThread(){
  const id="c_"+Date.now();
  const item={id, title:"ìƒˆ ì±„íŒ…", createdAt:Date.now(), updatedAt:Date.now()};
  const list=loadThreadList(); list.unshift(item); saveThreadList(list);
  localStorage.setItem(CHAT_THREAD_KEY(id), JSON.stringify({id, messages:[]}));
  openThread(id);
}
function openThread(id){
  curThreadId=id;
  renderThreadList();
  chatBody.innerHTML="";
  const data=getThreadData(id);
  for(const m of (data.messages||[])){ addBubble(m.role==="user"?"me":"ai", m.content); }
  scrollBottom();
}
function saveMessage(role, content){
  if(!curThreadId) newThread();
  const key=CHAT_THREAD_KEY(curThreadId);
  const data=getThreadData(curThreadId);
  data.messages.push({role, content});
  localStorage.setItem(key, JSON.stringify(data));
  const list=loadThreadList();
  const idx=list.findIndex(x=>x.id===curThreadId);
  if(idx>=0){
    if(list[idx].title==="ìƒˆ ì±„íŒ…" && role==="user") list[idx].title=content.slice(0,30);
    list[idx].updatedAt=Date.now();
    saveThreadList(list);
    renderThreadList();
  }
}
function renderThreadList(){
  const list=loadThreadList();
  chatThreadsEl.innerHTML = list.map(it=>`
    <div class="threadRow" data-id="${it.id}" ${curThreadId===it.id?'data-active="1"':''}>
      <div style="flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis" title="${escapeHtml(it.title)}">${escapeHtml(it.title)}</div>
      <button class="iconbtn" data-open="${it.id}" title="ì—´ê¸°">â†©</button>
      <button class="iconbtn" data-del="${it.id}" title="ì‚­ì œ">âœ–</button>
    </div>
  `).join("") || `<div class="notice">ì €ì¥ëœ ì±„íŒ…ì´ ì—†ìŠµë‹ˆë‹¤ã€‚</div>`;
  chatThreadsEl.onclick=(e)=>{
    const o=e.target.closest("[data-open]"); const d=e.target.closest("[data-del]");
    if(o){ openThread(o.dataset.open); }
    if(d){
      const id=d.dataset.del;
      if(confirm("ì±„íŒ…ì„ ì‚­ì œí• ê¹Œìš”?")){
        const list=loadThreadList().filter(x=>x.id!==id); saveThreadList(list);
        localStorage.removeItem(CHAT_THREAD_KEY(id));
        if(curThreadId===id) curThreadId=null;
        renderThreadList();
        const next=list[0]; if(next) openThread(next.id); else { chatBody.innerHTML=""; }
      }
    }
  };
}
function scrollBottom(){ chatBody.scrollTop=chatBody.scrollHeight; }
function addBubble(who,text,cls=""){
  const d=document.createElement("div");
  d.className=`bubble ${who} ${cls}`.trim();
  d.textContent=text;
  const btn=document.createElement("button");
  btn.className="iconbtn bAct";
  btn.title="ì…ë ¥ì°½ìœ¼ë¡œ ê°€ì ¸ì˜¤ê¸°";
  btn.textContent="â†©";
  btn.onclick=(e)=>{ e.stopPropagation(); chatInput.value = (chatInput.value?chatInput.value+"\n":"") + d.textContent; chatInput.focus(); };
  d.appendChild(btn);
  chatBody.appendChild(d);
  scrollBottom();
  return d;
}
function setSending(isSending){ chatSend.disabled = isSending; chatInput.disabled = isSending; chatSend.textContent = isSending ? T('send')+'â€¦' : T('send'); }

/* ë¡œì»¬ ì‘ë‹µê¸° */
function respondLocal(userText, style="auto"){
  const lang = detectLang(userText);
  const greet = {
    ko: ["ì•ˆë…•í•˜ì„¸ìš”! ë„ì›€ì´ í•„ìš”í•˜ì‹ ê°€ìš”?","ì¢‹ì•„ìš”, ê°„ë‹¨íˆ ì •ë¦¬í•´ ë“œë¦´ê²Œìš”.","ìš”ì²­í•˜ì‹  ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ ë‹µí•´ ë³¼ê²Œìš”."],
    en: ["Hi! How can I help?","Sure, let me summarize.","Got it. Here's a quick answer."],
    ja: ["ã“ã‚“ã«ã¡ã¯ã€‚ä½•ã‚’ãŠæ‰‹ä¼ã„ã—ã¾ã—ã‚‡ã†ã‹ã€‚","äº†è§£ã—ã¾ã—ãŸã€‚ç°¡æ½”ã«ã¾ã¨ã‚ã¾ã™ã€‚","ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«åŸºã¥ã„ã¦å›ç­”ã—ã¾ã™ã€‚"]
  }[lang]||["ì•ˆë…•í•˜ì„¸ìš”! ë„ì›€ì´ í•„ìš”í•˜ì‹ ê°€ìš”?","ì¢‹ì•„ìš”, ê°„ë‹¨íˆ ì •ë¦¬í•´ ë“œë¦´ê²Œìš”.","ìš”ì²­í•˜ì‹  ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ ë‹µí•´ ë³¼ê²Œìš”."];

  if(style==="fast")  return `${greet[1]} ${userText}`;
  if(style==="think"){
    const tips = {
      ko: `í•µì‹¬ ìš”ì \nâ€¢ ì˜ë„ íŒŒì•…: ${userText}\nâ€¢ ë°”ë¡œ ì“¸ ìˆ˜ ìˆëŠ” í•œ ë¬¸ì¥: ${userText} â€” í•µì‹¬ë§Œ ìš”ì•½\nâ€¢ ë‹¤ìŒ í–‰ë™: ì¶”ê°€ë¡œ ê¶ê¸ˆí•œ ì ì„ ì•Œë ¤ ì£¼ì„¸ìš”.`,
      en: `Key points\nâ€¢ Intent: ${userText}\nâ€¢ One-liner: concise summary of the above\nâ€¢ Next step: tell me what you want next.`,
      ja: `è¦ç‚¹\nâ€¢ æ„å›³: ${userText}\nâ€¢ ä¸€è¨€ã¾ã¨ã‚: ä¸Šè¨˜ã®ç°¡æ½”ãªè¦ç´„\nâ€¢ æ¬¡ã®ä¸€æ‰‹: æ¬¡ã«çŸ¥ã‚ŠãŸã„ã“ã¨ã‚’æ•™ãˆã¦ãã ã•ã„ã€‚`
    }[lang];
    return `${greet[2]}\n\n${tips}`;
  }
  if (userText.length <= 12) return respondLocal(userText, "fast");
  if (/[?ï¼Ÿ]$/.test(userText)) return respondLocal(userText, "think");
  return `${greet[0]} ${userText}`;
}

chatInput.addEventListener("keydown",(e)=>{
  if(e.key==="Enter" && !e.shiftKey){
    e.preventDefault();
    document.getElementById("chatForm").dispatchEvent(new Event("submit",{cancelable:true}));
  }
});

document.getElementById("chatForm").addEventListener("submit", async (e)=>{
  e.preventDefault();
  const v=(chatInput.value||"").trim();
  if(!v) return;
  chatInput.value="";
  if(!curThreadId) newThread();
  addBubble("me", v);
  saveMessage("user", v);

  const aiBubble = addBubble("ai","â€¦");
  setSending(true);

  const style = chatStyleSel.value; // auto | fast | think
  if(style==="think"){
    aiBubble.textContent = "";
    const chunks = ["ìƒê°ì¤‘","ìƒê°ì¤‘.","ìƒê°ì¤‘..","ìƒê°ì¤‘..."];
    for (let i=0;i<4;i++){ aiBubble.textContent = chunks[i]; await new Promise(r=>setTimeout(r,300)); }
  }

  let text = "";
  if (style === "auto") {
    const history = (getThreadData(curThreadId).messages||[]).slice(-10);
    const sysBase = "You are ThinkHelper's assistant. Be concise and helpful.";
    const lang = detectLang(v);
    const sysLang =
      lang==="ko" ? "í•­ìƒ í•œêµ­ì–´ë¡œ ê°„ê²°íˆ ë‹µí•˜ì„¸ìš”." :
      lang==="ja" ? "å¸¸ã«æ—¥æœ¬èªã§ç°¡æ½”ã«ç­”ãˆã¦ãã ã•ã„ã€‚" :
      "Answer concisely in English.";
    const msgs = [{role:"system",content:`${sysBase} ${sysLang}`}, ...history, {role:"user",content:v}];
    text = await callLambda(msgs, 15000);
  }

  if(!text) text = respondLocal(v, style);

  aiBubble.textContent = text || "(ë¹ˆ ì‘ë‹µ)";
  saveMessage("assistant", text);
  setSending(false);
  renderThreadList();
});

/* ===== ë™ì˜ ëª¨ë‹¬ ===== */
function openConsentIfNeeded(){
  const agreed = localStorage.getItem("th.consent.v2")==="1";
  if(agreed) return;
  const mask=document.getElementById("consentMask");
  mask.style.display="flex";
  const chkAll=()=> {
    const canAgree = document.getElementById("chkAuto").checked &&
                     document.getElementById("chkPrivacy").checked &&
                     document.getElementById("chkThird").checked &&
                     document.getElementById("chkPay").checked &&
                     document.getElementById("chkTerms").checked;
    document.getElementById("btnConsentAgree").disabled = !canAgree;
  };
  ["chkAuto","chkPrivacy","chkThird","chkPay","chkTerms"].forEach(id=>{
    document.getElementById(id).onchange=chkAll;
  });
  document.getElementById("btnConsentAll").onclick=()=>{
    ["chkAuto","chkPrivacy","chkThird","chkPay","chkTerms"].forEach(id=> document.getElementById(id).checked=true);
    chkAll();
  };
  document.getElementById("btnConsentAgree").onclick=()=>{
    localStorage.setItem("th.consent.v2","1");
    mask.style.display="none";
  };
}

/* ===== ë¶€íŠ¸ìŠ¤íŠ¸ë© ===== */
(function boot(){
  const cur=store.current(); if(cur && store.get(cur)) openDoc(cur); else newDoc(); renderList();

  // í˜ì´ì§€ ë¡œë“œì‹œ ì±„íŒ…ì°½ ë³´ì´ê¸° + ì…ë ¥ì°½ í¬ì»¤ìŠ¤
  chatDock.style.display = "flex";
  setTimeout(()=> chatInput?.focus(), 0);
})();
</script>

</body>
</html>
