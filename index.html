<!DOCTYPE html>
<html lang="ko" data-theme="light">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>ThinkHelper â€” Editor</title>
<link rel="icon" href="data:,"/>


<!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-NXBQK43Z');</script>
<!-- End Google Tag Manager -->

<!-- CKEditor -->
<script src="https://cdn.ckeditor.com/ckeditor5/41.3.1/classic/ckeditor.js"></script>

<!-- Export (PDFë§Œ ìœ ì§€) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" defer></script>

<!-- WebGazer (ì˜µì…˜) -->
<script src="https://cdn.jsdelivr.net/npm/webgazer/dist/webgazer.min.js" defer></script>

<style>
:root{
  --bg:#f6f8fb; --fg:#0b1020; --muted:#6a7691;
  --panel:#ffffff; --card:#f2f5ff; --border:#d6deee;
  --hover:#e9effe; --accent:#2563eb; --accent-2:#f59e0b;
  --vscode:#1e1e1e; --vscode-2:#252526; --vscode-border:#333842;
}
:root[data-theme="dark"]{
  --bg:#0b1020; --fg:#f1f5ff; --muted:#a8b4cf;
  --panel:#0f172a; --card:#101a30; --border:#273453;
  --hover:#16213b; --accent:#60a5fa; --accent-2:#f59e0b;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--fg);
  font-family:-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif;
  display:flex;flex-direction:column}
   /* Ribbon */
    .ribbon{background:#fff;border-bottom:1px solid var(--border)}
    :root.dev .ribbon,:root.dark .ribbon{background:#0b1222}
    .rrow{display:flex;align-items:center;gap:10px;padding:8px 10px;flex-wrap:wrap}
    .rbtn{display:flex;flex-direction:column;align-items:center;gap:4px;width:64px;padding:8px 4px;border-radius:8px;cursor:pointer;border:1px solid transparent}
    .rbtn:hover{background:var(--hover)}
    .rbtn .ico{width:22px;height:22px;border:1px solid var(--border);border-radius:6px;display:flex;align-items:center;justify-content:center;background:#fff}
    :root.dev .rbtn .ico,:root.dark .rbtn .ico{background:#0b1222}
 .top{display:flex;align-items:center;gap:8px;padding:6px 10px;background:#f1f5ff;border-bottom:1px solid var(--border)}
    :root.dev .top,:root.dark .top{background:#0b1222}
    .logo{width:18px;height:18px;border-radius:5px;background:linear-gradient(135deg,#60a5fa,#34d399)}
    .badge{background:#edf2ff;border:1px solid #cbdafc;color:var(--accent);border-radius:999px;padding:.25rem .6rem;font-size:.85rem;cursor:pointer}
    :root.dev .badge,:root.dark .badge{background:#101a2e;border-color:#1f2b45}
    .sep{width:1px;height:24px;background:var(--border);margin:0 6px}
    input[type="text"],select{height:30px;border:1px solid var(--border);border-radius:8px;background:#fff;padding:0 8px;color:#0b1020}
    :root.dev input[type="text"],:root.dev select,:root.dark input[type="text"],:root.dark select{background:#0b1222;color:#e5e7eb;border-color:#24324b}
   /* Layout */
    main{flex:1;min-height:0;display:grid;grid-template-columns:240px 1fr 380px;gap:10px;padding:10px}
    @media (max-width:1240px){main{grid-template-columns:0 1fr 0}#left,#right{display:none}}
    aside#left,aside#right{border:1px solid var(--border);border-radius:10px;background:#fff;min-height:0;display:flex;flex-direction:column}
    :root.dev aside#left,:root.dev aside#right,:root.dark aside#left,:root.dark aside#right{background:#0b1222}
    #docList{padding:10px;display:flex;flex-direction:column;gap:6px;overflow:auto}
    .doc{padding:8px;border:1px solid var(--border);border-radius:10px;cursor:default;display:flex;justify-content:space-between;gap:8px;align-items:center}
    .doc:hover{background:var(--hover)}
    .doc .title{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .doc .actions{display:flex;gap:8px}
    .doc .icon-btn{border:1px solid var(--border);background:transparent;border-radius:6px;padding:2px 6px;cursor:pointer}

    #rightHead{display:flex;gap:8px;align-items:center;justify-content:space-between;padding:10px;border-bottom:1px solid var(--border)}
    #preview{border:0;width:100%;height:100%}

/* CKEditor ë°°ì§€ ìˆ¨ê¹€ */
.ck-balloon-panel,.ck-powered-by-balloon{display:none!important}
.ck-editor__editable_inline{
  min-height:58vh!important;color:#222;background:#fff;padding:12px;
  padding-bottom:calc(140px + env(safe-area-inset-bottom, 0px));
  border-radius:8px;
  scroll-padding-bottom:140px;
  position:relative; z-index:1;
}
[data-theme="dark"] .ck-editor__editable_inline{color:#ffe7b3;background:#0b1327}

/* Topbar */
.topbar{display:flex;gap:8px;align-items:center;padding:10px 12px;background:var(--panel);
  border-bottom:1px solid var(--border);position:sticky;top:0;z-index:20}
.brand{display:flex;align-items:center;gap:8px;font-weight:900}
.logo{width:18px;height:18px;border-radius:4px;background:linear-gradient(135deg,#60a5fa,#34d399)}
.btn{border:1px solid var(--border);background:var(--card);color:var(--fg);
  border-radius:8px;padding:.45rem .7rem;font-weight:900;cursor:pointer}
.btn:hover{background:var(--hover)}
.btn[disabled]{opacity:.6;cursor:not-allowed}
.menu{position:relative}
.menu>.btn{font-weight:900}
.dropdown{display:none;position:absolute;top:42px;left:0;background:var(--panel);border:1px solid var(--border);
  border-radius:10px;min-width:280px;box-shadow:0 12px 24px rgba(0,0,0,.12);z-index:30}
.dropdown .item{padding:.55rem .7rem;border-bottom:1px dashed var(--border);cursor:pointer;
  display:flex;justify-content:space-between;gap:10px;align-items:center}
.dropdown .item:last-child{border-bottom:none}
.dropdown .item:hover{background:var(--hover)}
.badge{font-size:.72rem;padding:.1rem .35rem;border-radius:6px;border:1px solid var(--border);opacity:.8}

/* Layout */
main{flex:1;min-height:0;display:grid;grid-template-columns:260px 1fr;gap:10px;padding:10px}
@media (max-width:1200px){ main{grid-template-columns:0 1fr; padding:6px} #left{display:none}}
aside#left{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:10px;display:flex;flex-direction:column;min-height:0}
.listHead{display:flex;align-items:center;gap:8px}
#addDoc{margin-left:auto}
#docList{flex:1;overflow:auto;display:flex;flex-direction:column;gap:8px;margin-top:10px}
.notice{opacity:.75;padding:8px}
.doc{display:flex;gap:8px;align-items:center;padding:8px;background:var(--card);border:1px solid var(--border);border-radius:10px;cursor:pointer}
.doc:hover{background:var(--hover)}
.doc .title{flex:1;font-weight:900;color:var(--fg);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.doc .time{font-size:.78rem;color:var(--muted)}
.doc .act{display:none;gap:6px}
.doc:hover .act{display:inline-flex}
.iconbtn{border:1px solid var(--border);background:transparent;color:var(--fg);border-radius:6px;padding:.1rem .35rem;cursor:pointer}
.iconbtn:hover{background:var(--hover)}

section#center{display:flex;flex-direction:column;gap:10px;min-width:0}
#editorWrap{border:1px solid var(--border);border-radius:12px;background:var(--panel);padding:8px;position:relative}
#editor{min-height:62vh}
.ck-editor__editable_inline{min-height:58vh!important;color:#222;background:#fff;padding:12px;border-radius:8px}
[data-theme="dark"] .ck-editor__editable_inline{color:#ffe7b3;background:#0b1327}

/* VSCode ìŠ¤íƒ€ì¼ ì¶”ì²œì–´ */
#suggPopup{position:absolute;display:none;z-index:60;background:var(--panel);color:var(--fg);
  border:1px solid var(--border);border-radius:10px;box-shadow:0 12px 24px rgba(0,0,0,.18);
  min-width:280px;max-width:560px}
#suggPopup header{padding:6px 10px;border-bottom:1px solid var(--border);font-size:.82rem;color:var(--muted)}
#suggPopup ul{list-style:none;margin:0;padding:6px;max-height:260px;overflow:auto}
#suggPopup li{padding:8px 10px;border-radius:8px;display:flex;gap:8px;cursor:pointer;align-items:center}
#suggPopup li[data-active="1"]{background:var(--hover);outline:1.5px solid #8ab4ff66}
.kind{opacity:.75;font-size:.75rem;width:120px;flex:0 0 auto;color:#ffd58a}

/* Search (ìë™ì™„ì„±ë§Œ) */
#searchRow{display:flex;gap:10px;padding:10px;background:var(--panel);border:1px solid var(--border);border-radius:12px;align-items:flex-start;position:relative}
#searchBox{flex:1;height:44px;border:2px solid var(--border);border-radius:12px;background:var(--card);color:var(--fg);padding:.6rem .9rem;font-size:16px}
#searchBtn{height:44px}
#suggestList{display:none;position:absolute;left:10px;right:96px;top:60px;background:var(--panel);border:1px solid var(--border);border-radius:10px;box-shadow:0 12px 24px rgba(0,0,0,.15);z-index:25;max-height:240px;overflow:auto}
#suggestList .sugg{padding:.55rem .7rem;border-bottom:1px dashed var(--border);cursor:pointer}
#suggestList .sugg:last-child{border-bottom:none}
#suggestList .sugg[data-active="1"]{background:var(--hover)}

/* Footer */
/* Footer â€” ë³µì‚¬/ë“œë˜ê·¸ ë°©í•´ ê¸ˆì§€ */
/* Footer ê³ ì • ë° ë³µì‚¬ ë°©í•´ ì œê±° */
footer {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: var(--bg);
  padding: 8px 10px;
  border-top: 1px solid var(--border);
  font-size: 0.92rem;
  text-align: center;

  /* ë³µì‚¬/ë¶™ì—¬ë„£ê¸° ë°©í•´ ì œê±° */
  user-select: none;
  -webkit-user-select: none;
  pointer-events: none;
  z-index: 10;
}

/* ë³¸ë¬¸ì´ í‘¸í„°ì— ê°€ë ¤ì§€ì§€ ì•Šë„ë¡ ì—¬ë°± ì¶”ê°€ */
body {
  padding-bottom: 50px; /* footer ë†’ì´ë§Œí¼ í™•ë³´ */
}




/* ê°œë°œì ëª¨ë“œ(ì—ë””í„° í”„ë ˆì„ VSCode ëŠë‚Œ) */
body.dev .topbar, body.dev aside#left, body.dev #editorWrap, body.dev #searchRow{background:var(--vscode); border-color:var(--vscode-border)}
body.dev .btn{background:var(--vscode-2); border-color:var(--vscode-border); color:#e6e6e6}
body.dev .btn:hover{background:#2a2d2e}
body.dev .doc{background:#222; border-color:#333}
body.dev .doc:hover{background:#2a2d2e}
body.dev #searchBox{background:#1f1f1f; border-color:#333; color:#e6e6e6}

/* Chat dock */
#chatBtn{position:fixed;right:16px;bottom:16px;z-index:60}
#chatDock{position:fixed;right:16px;bottom:16px;width:min(92vw,880px);height:74vh;display:none;flex-direction:column;background:var(--panel);border:1px solid var(--border);border-radius:14px;box-shadow:0 18px 36px rgba(0,0,0,.28);z-index:70}
#chatHead{display:flex;align-items:center;gap:8px;justify-content:space-between;padding:12px;border-bottom:1px solid var(--border);font-weight:900}
#chatWrap{flex:1;display:grid;grid-template-columns:220px 1fr;min-height:0}
#chatThreads{border-right:1px solid var(--border);padding:10px;overflow:auto}
.threadRow{display:flex;gap:6px;align-items:center;padding:8px;border:1px solid var(--border);border-radius:10px;background:var(--card);cursor:pointer;margin-bottom:8px}
.threadRow:hover{background:var(--hover)}
.threadRow[data-active="1"]{outline:2px solid #9bbcff}
#chatMain{display:flex;flex-direction:column;min-width:0}
#chatBody{flex:1;overflow:auto;padding:12px;display:flex;flex-direction:column;gap:10px}
.bubble{max-width:85%;padding:.75rem 1rem;border:1px solid var(--border);border-radius:14px;background:var(--card);word-break:break-word;font-size:1.02rem;line-height:1.55;white-space:pre-wrap}
.me{margin-left:auto;background:#143763;color:#fff;border-color:#143763}
.ai{margin-right:auto;border-color:#3b4b72;background:#15284f;color:#fff}
.sys{margin:0 auto;background:#eef2ff;border-style:dashed;color:#111}
#chatForm{display:flex;gap:8px;padding:12px;border-top:1px solid var(--border)}
#chatInput{flex:1;border:1px solid var(--border);border-radius:10px;background:var(--card);color:var(--fg);padding:.75rem .9rem;font-size:1.02rem;resize:vertical}
#quota{position:absolute;left:12px;bottom:12px;background:var(--panel);border:1px solid var(--border);border-radius:8px;padding:.25rem .55rem;font-size:.85rem;color:var(--muted)}

/* ì‹œì„  ì»¤ì„œ */
#gazeCursor{
  position:fixed; left:0; top:0; width:18px; height:18px; margin:-9px 0 0 -9px;
  border:2px solid var(--accent); border-radius:50%; pointer-events:none; z-index:120; display:none;
  box-shadow:0 0 0 3px rgba(96,165,250,0.25);
  background:radial-gradient(circle at 50% 50%, rgba(96,165,250,.35), rgba(96,165,250,0) 60%);
  transition: transform 0.05s linear;
}
</style>
</head>
<body>
  <!-- Google Tag Manager (noscript) -->
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NXBQK43Z" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <!-- End Google Tag Manager (noscript) -->

  <div class="topbar">
    <div class="brand"><div class="logo"></div><div id="t_brand">ThinkHelper</div></div>

    <!-- ë„êµ¬ -->
    <div class="menu">
      <button class="btn" id="t_tools">ë„êµ¬ â–¾</button>
      <div class="dropdown" id="dropTools">
        <div class="item" id="iNew"><span id="t_new">ìƒˆ ë¬¸ì„œ</span><span>âŒ˜/Ctrl+N</span></div>
        <div class="item" id="iSave"><span id="t_export">ë‚´ë³´ë‚´ê¸°/ì¸ì‡„</span><span>âŒ˜/Ctrl+S</span></div>
        <div class="item" id="iVSCode" style="display:none"><span id="t_vscode">VSCodeë¡œ ì—´ê¸°</span><span>â†—</span></div>
      </div>
    </div>

    <!-- ì„¤ì • -->
    <div class="menu">
      <button class="btn" id="t_settings">ì„¤ì • â–¾</button>
      <div class="dropdown" id="dropSettings">
        <div class="item"><span id="t_lang">ì–¸ì–´</span>
          <select id="langSel">
            <option value="ko">í•œêµ­ì–´</option><option value="en">English</option><option value="ja">æ—¥æœ¬èª</option>
          </select>
        </div>
        <div class="item" style="justify-content:flex-start;gap:10px">
          <label><input type="checkbox" id="optDeep"> <span id="t_deep">ì‹¬ì¸µ ë¦¬ì„œì¹˜</span></label>
        </div>
        <div class="item" style="justify-content:flex-start;gap:10px">
          <label><input type="checkbox" id="optSugg" checked> <span id="t_sugg">ì œì•ˆì–´ í‘œì‹œ</span></label>
        </div>
        <div class="item" style="justify-content:flex-start;gap:10px">
          <label><input type="checkbox" id="optPersonal" checked> <span id="t_personal">ë§ì¶¤í˜• ì œì•ˆ í‘œì‹œ</span></label>
        </div>
        <div class="item" style="justify-content:flex-start;gap:10px">
          <label><input type="checkbox" id="optGaze"> <span id="t_gaze">ì‹œì„  ì»¤ì„œ(ì›¹ìº )</span></label>
        </div>
        <div class="item">
          <span id="t_mode">ëª¨ë“œ</span>
          <select id="modeSel">
            <option value="normal" data-i18n="mode_normal">ì¼ë°˜ ëª¨ë“œ</option>
            <option value="research" data-i18n="mode_research">ë¦¬ì„œì¹˜ ëª¨ë“œ</option>
            <option value="legal" data-i18n="mode_legal">ë¦¬ê±¸ ëª¨ë“œ</option>
            <option value="dev" data-i18n="mode_dev">ê°œë°œì ëª¨ë“œ</option>
          </select>
        </div>
        <div class="item" id="toggleTheme">ğŸŒ“ <span id="t_theme">í…Œë§ˆ ì „í™˜</span></div>
      </div>
    </div>

    <!-- ë„ì›€ë§ -->
    <div class="menu">
      <button class="btn" id="t_help">ë„ì›€ë§ â–¾</button>
      <div class="dropdown">
        <div class="item"><span id="t_keys">ë‹¨ì¶•í‚¤</span><span>âŒ˜/Ctrl+K, âŒ˜/Ctrl+Space</span></div>
        <div class="item"><span id="t_note">ì£¼ì˜</span><span id="t_note_body">AI ê²°ê³¼ëŠ” í•­ìƒ ê²€í† </span></div>
      </div>
    </div>

    <button class="btn" id="chatBtn" style="margin-left:auto">ğŸ’¬ <span id="t_chat">ì±„íŒ…</span></button>
  </div>

  <main>
    <aside id="left" aria-label="ë¬¸ì„œëª©ë¡">
      <div class="listHead">
        <b id="t_docs">ë¬¸ì„œ</b>
        <select id="sortSel" class="btn" style="margin-left:auto">
          <option value="updated" id="t_sort1">ìµœê·¼ ìˆ˜ì •ìˆœ</option>
          <option value="title" id="t_sort2">ì œëª©ìˆœ</option>
          <option value="created" id="t_sort3">ìƒì„±ìˆœ</option>
        </select>
        <button class="btn" id="addDoc" title="ìƒˆ ë¬¸ì„œ ì¶”ê°€">ï¼‹</button>
      </div>
      <div id="docList"></div>
    </aside>

    <section id="center">
      <div id="editorWrap">
        <div id="editor" aria-label="ì—ë””í„°"></div>
        <!-- VSCode ìŠ¤íƒ€ì¼ ì œì•ˆ -->
        <div id="suggPopup">
          <header id="t_sugg_header">ì¶”ì²œ</header>
          <ul id="suggList"></ul>
        </div>
      </div>

      <div id="searchRow">
        <input id="searchBox" placeholder="ê²€ìƒ‰(Enter) / Ctrl+K"/>
        <button class="btn" id="searchBtn"><span id="t_search">ê²€ìƒ‰</span></button>
        <div id="suggestList"></div>
      </div>
    </section>
  </main>

  <footer>
    <div>Â© ThinkHelper â€” âš ï¸ <span id="t_disclaimer">ì¸ê³µì§€ëŠ¥ ëª¨ë¸ì€ ì‹¤ìˆ˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì¤‘ìš”í•œ ì •ë³´ëŠ” ë°˜ë“œì‹œ ì¬ì°¨ í™•ì¸í•˜ì„¸ìš”.</span></div>
    <div id="loc">ğŸ“ <span id="t_loc_wait">ìœ„ì¹˜ í™•ì¸ ì¤‘â€¦</span></div>
  </footer>

  <!-- ì‹œì„  ì»¤ì„œ -->
  <div id="gazeCursor"></div>

  <!-- ë‚´ë³´ë‚´ê¸° ëª¨ë‹¬ -->
  <div id="saveMask" style="position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:120">
    <div id="saveCard" role="dialog" aria-modal="true" style="width:min(92vw,520px);background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:14px">
      <h3 style="margin:0 0 8px" id="t_export_title">ë‚´ë³´ë‚´ê¸° / ì¸ì‡„</h3>
      <div class="save-grid" style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:10px">
        <button class="btn" id="btnExportPDF">PDF</button>
        <button class="btn" id="btnPrint"    >Print</button>
        <button class="btn" disabled>PPT <span class="badge" id="t_coming">ì¤€ë¹„ì¤‘</span></button>
        <button class="btn" disabled>HWP <span class="badge" id="t_coming2">ì¤€ë¹„ì¤‘</span></button>
        <button class="btn" disabled>DOCX <span class="badge" id="t_coming3">ì¤€ë¹„ì¤‘</span></button>
        <button class="btn" id="btnCloseSave" ><span id="t_close">ë‹«ê¸°</span></button>
      </div>
    </div>
  </div>

  <!-- Chat Dock (ìŠ¤ë ˆë“œ + ìŠ¤íŠ¸ë¦¬ë°/í´ë°±) -->
  <div id="chatDock" role="dialog" aria-hidden="true">
    <div id="chatHead">
      <span id="t_chatTitle">AI ì±„íŒ…</span>
      <div class="actions" style="display:flex;gap:8px;align-items:center">
        <button class="btn" id="btnNewThread" title="ìƒˆ ì±„íŒ…">ï¼‹ ìƒˆ ì±„íŒ…</button>
        <select id="chatProvider" class="btn" disabled title="ë¯¸ìŠ¤íŠ¸ë„ ê³ ì •">
          <option value="mistral" selected>Mistral</option>
          <option value="openai">OpenAI</option>
          <option value="auto">Auto</option>
        </select>
        <button class="btn" id="chatClose" aria-label="Close">âœ–</button>
      </div>
    </div>
    <div id="chatWrap">
      <aside id="chatThreads" aria-label="ì±„íŒ… ìŠ¤ë ˆë“œ"></aside>
      <section id="chatMain">
        <div id="chatBody"></div>
        <form id="chatForm">
          <textarea id="chatInput" rows="2" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš” (Enter=ì „ì†¡, Shift+Enter=ì¤„ë°”ê¿ˆ)"></textarea>
          <button class="btn" type="submit" id="t_send">ì „ì†¡</button>
        </form>
      </section>
    </div>
    <div id="quota">local Â· mistral</div>
  </div>

<script>
/* ===================== i18n ===================== */
const I18N={
  ko:{brand:"ThinkHelper",tools:"ë„êµ¬ â–¾",settings:"ì„¤ì • â–¾",help:"ë„ì›€ë§ â–¾",
      new:"ìƒˆ ë¬¸ì„œ", export:"ë‚´ë³´ë‚´ê¸°/ì¸ì‡„", vscode:"VSCodeë¡œ ì—´ê¸°",
      lang:"ì–¸ì–´", deep:"ì‹¬ì¸µ ë¦¬ì„œì¹˜", sugg:"ì œì•ˆì–´ í‘œì‹œ", personal:"ë§ì¶¤í˜• ì œì•ˆ í‘œì‹œ",
      gaze:"ì‹œì„  ì»¤ì„œ(ì›¹ìº )", mode:"ëª¨ë“œ", theme:"í…Œë§ˆ ì „í™˜",
      mode_normal:"ì¼ë°˜ ëª¨ë“œ", mode_research:"ë¦¬ì„œì¹˜ ëª¨ë“œ", mode_legal:"ë¦¬ê±¸ ëª¨ë“œ", mode_dev:"ê°œë°œì ëª¨ë“œ",
      keys:"ë‹¨ì¶•í‚¤", note:"ì£¼ì˜", note_body:"AI ê²°ê³¼ëŠ” í•­ìƒ ê²€í† ", chat:"ì±„íŒ…",
      docs:"ë¬¸ì„œ", sort1:"ìµœê·¼ ìˆ˜ì •ìˆœ", sort2:"ì œëª©ìˆœ", sort3:"ìƒì„±ìˆœ",
      search:"ê²€ìƒ‰", sugg_header:"ì¶”ì²œ", close:"ë‹«ê¸°",
      disclaimer:"ì¸ê³µì§€ëŠ¥ ëª¨ë¸ì€ ì‹¤ìˆ˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì¤‘ìš”í•œ ì •ë³´ëŠ” ë°˜ë“œì‹œ ì¬ì°¨ í™•ì¸í•˜ì„¸ìš”.",
      chatTitle:"AI ì±„íŒ…", send:"ì „ì†¡",
      loc_wait:"ìœ„ì¹˜ í™•ì¸ ì¤‘â€¦", loc_hidden:"ìœ„ì¹˜ ë¹„ê³µê°œ",
      export_title:"ë‚´ë³´ë‚´ê¸° / ì¸ì‡„", coming:"ì¤€ë¹„ì¤‘",
      placeholder_editor:"ì—¬ê¸°ì„œ ì‘ì„±í•˜ì„¸ìš”â€¦", placeholder_search:"ê²€ìƒ‰(Enter) / Ctrl+K", placeholder_chat:"ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš” (Enter)",
      untitled:"ë¬´ì œ"},
  en:{brand:"ThinkHelper",tools:"Tools â–¾",settings:"Settings â–¾",help:"Help â–¾",
      new:"New", export:"Export/Print", vscode:"Open in VSCode",
      lang:"Language", deep:"Deep research", sugg:"Show suggestions", personal:"Personalized suggestions",
      gaze:"Gaze cursor (webcam)", mode:"Mode", theme:"Toggle theme",
      mode_normal:"Normal mode", mode_research:"Research mode", mode_legal:"Legal mode", mode_dev:"Developer mode",
      keys:"Shortcuts", note:"Note", note_body:"Always verify AI results", chat:"Chat",
      docs:"Documents", sort1:"Recently updated", sort2:"Title", sort3:"Created",
      search:"Search", sugg_header:"Suggestions", close:"Close",
      disclaimer:"AI may make mistakes. Always verify important information.",
      chatTitle:"AI Chat", send:"Send",
      loc_wait:"Checking locationâ€¦", loc_hidden:"Location hidden",
      export_title:"Export / Print", coming:"Coming soon",
      placeholder_editor:"Start writingâ€¦", placeholder_search:"Search (Enter) / Ctrl+K", placeholder_chat:"Type & Enter",
      untitled:"Untitled"},
  ja:{brand:"ThinkHelper",tools:"ãƒ„ãƒ¼ãƒ« â–¾",settings:"è¨­å®š â–¾",help:"ãƒ˜ãƒ«ãƒ— â–¾",
      new:"æ–°è¦", export:"æ›¸ãå‡ºã—/å°åˆ·", vscode:"VSCodeã§é–‹ã",
      lang:"è¨€èª", deep:"æ·±å±¤ãƒªã‚µãƒ¼ãƒ", sugg:"ã‚µã‚¸ã‚§ã‚¹ãƒˆè¡¨ç¤º", personal:"ãƒ‘ãƒ¼ã‚½ãƒŠãƒ©ã‚¤ã‚ºè¡¨ç¤º",
      gaze:"è¦–ç·šã‚«ãƒ¼ã‚½ãƒ«(ã‚«ãƒ¡ãƒ©)", mode:"ãƒ¢ãƒ¼ãƒ‰", theme:"ãƒ†ãƒ¼ãƒåˆ‡æ›¿",
      mode_normal:"é€šå¸¸ãƒ¢ãƒ¼ãƒ‰", mode_research:"ãƒªã‚µãƒ¼ãƒãƒ¢ãƒ¼ãƒ‰", mode_legal:"ãƒªãƒ¼ã‚¬ãƒ«ãƒ¢ãƒ¼ãƒ‰", mode_dev:"é–‹ç™ºè€…ãƒ¢ãƒ¼ãƒ‰",
      keys:"ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ", note:"æ³¨æ„", note_body:"AI ã®çµæœã¯å¿…ãšç¢ºèª", chat:"ãƒãƒ£ãƒƒãƒˆ",
      docs:"ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ", sort1:"æ›´æ–°é †", sort2:"ã‚¿ã‚¤ãƒˆãƒ«é †", sort3:"ä½œæˆé †",
      search:"æ¤œç´¢", sugg_header:"ãŠã™ã™ã‚", close:"é–‰ã˜ã‚‹",
      disclaimer:"AIã¯é–“é•ãˆã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚é‡è¦ãªæƒ…å ±ã¯å¿…ãšç¢ºèªã—ã¦ãã ã•ã„ã€‚",
      chatTitle:"AI ãƒãƒ£ãƒƒãƒˆ", send:"é€ä¿¡",
      loc_wait:"ä½ç½®ç¢ºèªä¸­â€¦", loc_hidden:"ä½ç½®ã¯éè¡¨ç¤º",
      export_title:"æ›¸ãå‡ºã— / å°åˆ·", coming:"æº–å‚™ä¸­",
      placeholder_editor:"ã“ã“ã«å…¥åŠ›â€¦", placeholder_search:"æ¤œç´¢ï¼ˆEnterï¼‰ / Ctrl+K", placeholder_chat:"å…¥åŠ›ã—ã¦ Enter",
      untitled:"ç„¡é¡Œ"}
};
const conf={
  lang: localStorage.getItem("th.lang")||"ko",
  mode: localStorage.getItem("th.mode")||"normal",
  deep: localStorage.getItem("th.deep")==="1",
  sugg: localStorage.getItem("th.sugg")!=="0",
  personal: localStorage.getItem("th.personal")!=="0",
  gaze: localStorage.getItem("th.gaze")==="1"
};
function T(k){return (I18N[conf.lang]||I18N.ko)[k];}
function applyI18N(){
  const t=I18N[conf.lang]||I18N.ko;
  document.title = `${t.brand} â€” Editor`;
  const map={
    t_brand:t.brand,t_tools:t.tools,t_settings:t.settings,t_help:t.help,t_new:t.new,t_export:t.export,
    t_vscode:t.vscode,t_lang:t.lang,t_deep:t.deep,t_sugg:t.sugg,t_personal:t.personal,t_gaze:t.gaze,
    t_mode:t.mode,t_theme:t.theme,t_keys:t.keys,t_note:t.note,t_note_body:t.note_body,t_chat:t.chat,
    t_docs:t.docs,t_sort1:t.sort1,t_sort2:t.sort2,t_sort3:t.sort3,t_search:t.search,t_sugg_header:t.sugg_header,
    t_disclaimer:t.disclaimer,t_chatTitle:t.chatTitle,t_send:t.send,t_export_title:t.export_title,
    t_coming:t.coming,t_coming2:t.coming,t_coming3:t.coming,t_close:t.close,t_loc_wait:t.loc_wait
  };
  for(const id in map){ const el=document.getElementById(id); if(el) el.textContent=map[id]; }
  const sb=document.getElementById("searchBox"); if(sb) sb.placeholder=t.placeholder_search;
  const ci=document.getElementById("chatInput"); if(ci) ci.placeholder=t.placeholder_chat;
  document.querySelectorAll("#modeSel option").forEach(op=>{
    const key=op.getAttribute("data-i18n");
    if(key) op.textContent=t[key];
  });
  if(editor){ editor.destroy().then(initEditor); }
  renderList(true);
}

/* ì´ˆê¸° UI ê°’ ì£¼ì… */
document.addEventListener('DOMContentLoaded', ()=>{
  document.getElementById("langSel").value=conf.lang;
  document.getElementById("modeSel").value=conf.mode;
  document.getElementById("optDeep").checked=conf.deep;
  document.getElementById("optSugg").checked=conf.sugg;
  document.getElementById("optPersonal").checked=conf.personal;
  document.getElementById("optGaze").checked=conf.gaze;
  applyI18N();
});

/* ===================== ë©”ë‰´ í† ê¸€ ===================== */
(function(){
  document.querySelectorAll(".menu").forEach(m=>{
    const btn=m.querySelector(".btn"); const drop=m.querySelector(".dropdown"); if(!btn||!drop) return;
    btn.addEventListener("click",(e)=>{ e.stopPropagation(); document.querySelectorAll(".dropdown").forEach(d=>d.style.display="none"); drop.style.display=drop.style.display==="block"?"none":"block"; });
  });
  document.addEventListener("click",()=> document.querySelectorAll(".dropdown").forEach(d=>d.style.display="none"));
})();

/* ===================== í…Œë§ˆ & ëª¨ë“œ ===================== */
const body = document.body;
function applyMode(){ body.classList.toggle('dev', conf.mode==='dev'); document.getElementById('iVSCode').style.display = conf.mode==='dev' ? 'block':'none'; }
document.getElementById('modeSel').onchange = (e)=>{ conf.mode=e.target.value; localStorage.setItem("th.mode", conf.mode); applyMode(); };
document.getElementById('toggleTheme').onclick = ()=>{
  const isDark = document.documentElement.getAttribute('data-theme')==='dark';
  document.documentElement.setAttribute('data-theme', isDark?'light':'dark');
};
applyMode();

/* ===================== ì–¸ì–´ ë³€ê²½ ===================== */
document.getElementById("langSel").onchange=e=>{
  conf.lang=e.target.value; localStorage.setItem("th.lang",conf.lang); applyI18N();
};

/* ===================== ì—ë””í„° ===================== */
let editor=null;
async function initEditor(){
  editor = await ClassicEditor.create(document.getElementById('editor'),{ placeholder: (I18N[conf.lang]||I18N.ko).placeholder_editor });
  editor.model.document.on("change:data", onType);
  editor.editing.view.document.on("keydown",(evt,data)=>{
    const k=(data.key||"").toLowerCase();
    if((data.ctrlKey||data.metaKey)&&k==="s"){ data.preventDefault(); openSave(); }
    if((data.ctrlKey||data.metaKey)&&k==="k"){ data.preventDefault(); document.getElementById("searchBox").focus(); }
    if((data.ctrlKey||data.metaKey)&&k===" "){ data.preventDefault(); openSuggest(true); }
  });
}
initEditor();
function getHTML(){ return editor ? editor.getData() : ""; }
function setHTML(h){ if(editor) editor.setData(h||""); }

/* ===================== ë¡œì»¬ ì €ì¥ì†Œ(ë¬¸ì„œ) ===================== */
const store={listKey:"th.docs.list", docKey:id=>`th.doc.${id}`, curKey:"th.cur",
  list(){try{return JSON.parse(localStorage.getItem(this.listKey)||"[]")}catch(e){return[]}},
  saveList(a){localStorage.setItem(this.listKey,JSON.stringify(a||[]))},
  get(id){try{return JSON.parse(localStorage.getItem(this.docKey(id))||"null")}catch(e){return null}},
  set(id,o){localStorage.setItem(this.docKey(id),JSON.stringify(o))},
  remove(id){localStorage.removeItem(this.docKey(id))},
  current(){return localStorage.getItem(this.curKey)||""},
  setCurrent(id){localStorage.setItem(this.curKey,id||"")}
};
let curId="";
function defaultTitle(){ return (I18N[conf.lang]||I18N.ko).untitled; }
function ensureTitleMap(doc){
  if(!doc.titleMap){
    const t=doc.title||defaultTitle();
    doc.titleMap={ko:t,en:t,ja:t};
  }
}
function listTitleFor(doc){ ensureTitleMap(doc); return doc.titleMap[conf.lang]||defaultTitle(); }

function renderList(migrate=false){
  const sort=document.getElementById("sortSel").value;
  const list=store.list();
  if(migrate){
    list.forEach(it=>{
      const d=store.get(it.id); if(!d) return; ensureTitleMap(d);
      const allUntitled = Object.values(d.titleMap).every(v=>["ë¬´ì œ","Untitled","ç„¡é¡Œ"].includes(v));
      if(allUntitled){ d.titleMap[conf.lang]=defaultTitle(); store.set(it.id,d); it.title=d.titleMap[conf.lang]; }
    });
  }
  list.sort((a,b)=>{
    const at=listTitleFor(store.get(a.id)||a), bt=listTitleFor(store.get(b.id)||b);
    return sort==="title" ? at.localeCompare(bt) :
           sort==="created"?((a.createdAt||0)-(b.createdAt||0)) :
           ((b.updatedAt||0)-(a.updatedAt||0));
  });
  const el=document.getElementById("docList");
  el.innerHTML = list.map(d=>{
    const dd=store.get(d.id)||d; ensureTitleMap(dd);
    const when=new Date(d.updatedAt||d.createdAt||Date.now()).toLocaleString();
    const title = escapeHtml(listTitleFor(dd));
    return `<div class="doc" data-open="${d.id}">
      <div class="title" title="${title}">${title}</div>
      <div class="time">${when}</div>
      <div class="act"><button class="iconbtn" data-rename="${d.id}">âœï¸</button><button class="iconbtn" data-del="${d.id}">âœ–</button></div>
    </div>`;
  }).join("") || `<div class="notice">${conf.lang==="ko"?"ì €ì¥ëœ ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤.":conf.lang==="ja"?"ä¿å­˜ã•ã‚ŒãŸãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“ã€‚":"No saved documents."}</div>`;
  el.onclick=(e)=>{
    const r=e.target.closest("[data-rename]"); const d=e.target.closest("[data-del]");
    if(r){
      const id=r.dataset.rename; const doc=store.get(id); ensureTitleMap(doc);
      const t=prompt((I18N[conf.lang]||I18N.ko).new+" "+(I18N[conf.lang]||I18N.ko).docs+":", doc.titleMap[conf.lang]||defaultTitle())||defaultTitle();
      doc.titleMap[conf.lang]=t; doc.updatedAt=Date.now(); store.set(id,doc);
      const L=store.list().map(x=>x.id===id?{...x,title:t,updatedAt:doc.updatedAt}:x); store.saveList(L); renderList();
      return;
    }
    if(d){
      const id=d.dataset.del;
      if(confirm(conf.lang==="ko"?"ì‚­ì œí• ê¹Œìš”?":conf.lang==="ja"?"å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ":"Delete?")){
        store.remove(id); store.saveList(store.list().filter(x=>x.id!==id)); if(curId===id){curId=""; setHTML("");} renderList();
      }
      return;
    }
    const row=e.target.closest("[data-open]"); if(row) openDoc(row.dataset.open);
  };
}
document.getElementById("sortSel").onchange=()=>renderList();
document.getElementById("addDoc").onclick=newDoc;

function newDoc(){
  const id="d_"+Date.now(); curId=id; store.setCurrent(id);
  const row={id, createdAt:Date.now(), updatedAt:Date.now(), titleMap:{ko:defaultTitle(),en:defaultTitle(),ja:defaultTitle()}};
  store.saveList([row,...store.list().filter(x=>x.id!==id)]);
  setHTML(""); store.set(id,{id, createdAt:row.createdAt, updatedAt:row.updatedAt, titleMap:row.titleMap, payload:btoa(unescape(encodeURIComponent("")))});
  renderList();
}
function doSave(){
  if(!curId) newDoc();
  const html=getHTML(); const doc=store.get(curId)||{id:curId};
  doc.payload=btoa(unescape(encodeURIComponent(html)));
  ensureTitleMap(doc);
  const title=prompt((I18N[conf.lang]||I18N.ko).docs+" "+(I18N[conf.lang]||I18N.ko).new+":",doc.titleMap[conf.lang]||defaultTitle())||defaultTitle();
  doc.titleMap[conf.lang]=title; doc.updatedAt=Date.now(); store.set(curId,doc);
  const list=store.list().filter(x=>x.id!==curId);
  list.unshift({id:curId,createdAt:doc.createdAt||Date.now(),updatedAt:doc.updatedAt});
  store.saveList(list); renderList();
}
function openDoc(id){ const d=store.get(id); if(!d) return; curId=id; store.setCurrent(id); const html=decodeURIComponent(escape(atob(d.payload||""))); setHTML(html||""); }
function escapeHtml(s){return String(s??"").replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));}

/* ë‹¨ì¶•í‚¤ */
document.addEventListener("keydown",(e)=>{
  const k=(e.key||"").toLowerCase();
  if((e.metaKey||e.ctrlKey)&&k==="n"){ e.preventDefault(); newDoc(); }
  if((e.metaKey||e.ctrlKey)&&k==="s"){ e.preventDefault(); openSave(); }
  if((e.metaKey||e.ctrlKey)&&k==="k"){ e.preventDefault(); document.getElementById("searchBox").focus(); }
});

/* ===================== ê²€ìƒ‰ ìë™ì™„ì„±(ì›¹ ì œì•ˆ) ===================== */
const suggBox = document.getElementById('suggestList');
let sIndex=-1, sItems=[];
async function fetchSuggest(q){
  if(!q){ suggBox.style.display='none'; return; }
  try{
    const r = await fetch('https://suggestqueries.google.com/complete/search?client=firefox&q='+encodeURIComponent(q));
    const j = await r.json(); // [q,[sugg...]]
    sItems = (j && j[1]) ? j[1].slice(0,8) : [];
    renderSuggest();
  }catch{ sItems=[]; suggBox.style.display='none'; }
}
function renderSuggest(){
  if(!sItems.length){ suggBox.style.display='none'; return; }
  suggBox.innerHTML = sItems.map((t,i)=>`<div class="sugg" data-i="${i}" ${i===sIndex?'data-active="1"':''}>${escapeHtml(t)}</div>`).join("");
  suggBox.style.display='block';
}
const searchBox=document.getElementById('searchBox');
searchBox.addEventListener('input',()=> fetchSuggest(searchBox.value.trim()));
searchBox.addEventListener('keydown',(e)=>{
  if(suggBox.style.display!=='block') return;
  if(e.key==='ArrowDown'){ e.preventDefault(); sIndex=(sIndex+1)%sItems.length; renderSuggest(); }
  else if(e.key==='ArrowUp'){ e.preventDefault(); sIndex=(sIndex-1+sItems.length)%sItems.length; renderSuggest(); }
  else if(e.key==='Tab' || e.key==='Enter'){ if(sIndex>=0){ e.preventDefault(); searchBox.value=sItems[sIndex]; suggBox.style.display='none'; } }
});
suggBox.addEventListener('click',(e)=>{ const it=e.target.closest('.sugg'); if(!it) return; const i=+it.dataset.i; searchBox.value=sItems[i]; suggBox.style.display='none'; });

/* ===================== ì—ë””í„° ì¶”ì²œì–´(êµ­/ì˜/ì¼ ì‚¬ì „ ê¸°ë°˜ 5ê°œ) ===================== */
const DICT_KO = [
  "ì¸ê°„","ì¸ê³µ","ì¸ê³µì§€ëŠ¥","ì¸ê¶Œ","ì¸êµ¬","ì¸ê°","ì¸ì¦","ì¸ì‹","ì¸ì","ì¸ì¬",
  "ì¸í„°ë„·","ì¸í„°í˜ì´ìŠ¤","ì¸ì²´","ì¸ì‡„","ì¸ìˆ˜","ì¸ìš©","ì¸í”„ë¼","ì¸í„´","ì¸ìƒ","ì¸í•˜"
];
const DICT_EN = {
  a:["apple","array","algorithm","analysis","assistant","automation","authority"],
  b:["banana","binary","browser","backend","balance","behavior","buffer"],
  c:["cat","cache","client","cloud","compile","control","cursor"],
  d:["data","debug","design","device","docker","domain"],
  e:["edge","email","encode","engine","error","event"],
  f:["file","filter","frontend","function","framework"],
  g:["game","gateway","general","graphic","guide","gpu"],
  h:["hash","header","helper","history","host","hyperlink"],
  i:["image","index","input","interface","internet","issue","iteration"],
  j:["javascript","job","json","judge","join"],
  k:["kernel","key","keyword","knowledge"],
  l:["lambda","language","latency","library","link","load","logic","loop"],
  m:["machine","memory","message","method","model","module","monitor"],
  n:["name","namespace","network","node","notion","number"],
  o:["object","observer","offline","open","option","output"],
  p:["package","page","parse","pattern","performance","policy","prompt"],
  q:["query","queue","quick","quote"],
  r:["random","react","reasoning","record","redirect","request","response","router"],
  s:["sample","scale","schema","script","search","security","server","stream"],
  t:["table","task","template","thread","token","tool","type"],
  u:["unit","update","upload","user","utility"],
  v:["validate","value","variable","vector","version","visualization"],
  w:["web","window","worker","workflow","write"],
  x:["xml","xrange","xgboost"],
  y:["yaml","yield"],
  z:["zero","zip"]
};
const DICT_JA = [
  "ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆ","ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹","ã‚¤ãƒ³ãƒ•ãƒ©","ã‚¤ãƒ³ã‚µã‚¤ãƒˆ","ã‚¤ãƒ³ãƒãƒ¼ãƒˆ",
  "äººå·¥çŸ¥èƒ½","èªè­˜","å°åˆ·","å¼•ç”¨","å…¥åŠ›","æ”¹å–„","é–‹ç™º","å­¦ç¿’","æ¤œç´¢"
];
const TOKEN_RE=/[A-Za-z0-9ê°€-í£ã-ã‚”ã‚¡-ãƒ´ãƒ¼ä¸€-é¾ ã€…ã€†ãƒµãƒ¶ãƒ¼]+/g;

function getPlain(){ return getHTML().replace(/<[^>]+>/g," "); }
function currentToken(){
  const t=getPlain(); const parts=t.match(TOKEN_RE)||[];
  return parts[parts.length-1]||"";
}
function langOfToken(tok){
  if(/[ê°€-í£]/.test(tok)) return "ko";
  if(/[ã-ã‚”ã‚¡-ãƒ´ãƒ¼ä¸€-é¾ ã€…ã€†ãƒµãƒ¶]/.test(tok)) return "ja";
  if(/^[A-Za-z0-9]+$/.test(tok)) return "en";
  return "en";
}
function suggestFromDict(tok){
  const L=langOfToken(tok);
  const max=5;
  if(!tok) return [];
  if(L==="ko"){
    return DICT_KO.filter(w=>w.startsWith(tok)).slice(0,max);
  }else if(L==="en"){
    const t=tok.toLowerCase();
    const pool=(DICT_EN[t[0]]||[]).concat(...Object.values(DICT_EN));
    const seen=new Set(), res=[];
    for(const w of pool){
      if(w.startsWith(t) && !seen.has(w)){ res.push(w); seen.add(w); if(res.length>=max) break; }
    }
    return res;
  }else{
    return DICT_JA.filter(w=>w.startsWith(tok)).slice(0,max);
  }
}

/* VSCode ìŠ¤íƒ€ì¼ íŒì—… */
const suggPopup=document.getElementById("suggPopup"), suggList=document.getElementById("suggList");
let eItems=[], eSel=-1, hideUntilNextType=false;
function caretRect(){
  const sel=window.getSelection(); if(!sel||sel.rangeCount===0) return null;
  const r=sel.getRangeAt(0).cloneRange(); r.collapse(true);
  const rects=r.getClientRects(); if(!rects.length) return null; return rects[0];
}
function openSuggest(force){
  if(!conf.sugg) return closeSuggest();
  if(hideUntilNextType){ hideUntilNextType=false; return; }
  const token=currentToken();
  if(!token && !force) return closeSuggest();
  const items=suggestFromDict(token);
  if(!items.length) return closeSuggest();
  eItems=items; eSel=-1;
  const kindLabel=(langOfToken(token)==="ko"?"êµ­ì–´ì‚¬ì „":langOfToken(token)==="en"?"English":"æ—¥æœ¬èª");
  suggList.innerHTML=items.map((it,i)=>`<li data-i="${i}"><span class="kind">${kindLabel}</span><span>${escapeHtml(it)}</span></li>`).join("");
  Array.from(suggList.children).forEach(li=> li.onclick=()=> choose(+li.dataset.i));
  const r=caretRect(); if(!r){ closeSuggest(); return; }
  const host=document.getElementById("editorWrap").getBoundingClientRect();
  suggPopup.style.left=Math.max(6,(r.left-host.left))+"px";
  suggPopup.style.top=(r.bottom-host.top+6)+"px";
  suggPopup.style.display="block";
}
function closeSuggest(){ suggPopup.style.display='none'; eItems=[]; eSel=-1; }
document.addEventListener("keydown",(e)=>{
  if(suggPopup.style.display!=="block") return;
  const list=Array.from(document.querySelectorAll("#suggList li")); if(!list.length) return;
  if(e.key==="ArrowDown"){ e.preventDefault(); eSel=(eSel+1)%list.length; markSel(); }
  else if(e.key==="ArrowUp"){ e.preventDefault(); eSel=(eSel-1+list.length)%list.length; markSel(); }
  else if(e.key==="Enter"||e.key==="Tab"){ e.preventDefault(); if(eSel<0) eSel=0; choose(eSel); }
  else if(e.key==="Escape"){ e.preventDefault(); closeSuggest(); }
});
function markSel(){ Array.from(document.querySelectorAll("#suggList li")).forEach((li,i)=> li.setAttribute("data-active", i===eSel? "1":"0")); }
function choose(i){
  const it=eItems[i]; if(!it) return;
  const tok=currentToken();
  editor.model.change(w=> editor.model.insertContent(w.createText(it.slice(tok.length)+" ")));
  closeSuggest(); hideUntilNextType=true;
}
function onType(){ if(conf.sugg) openSuggest(false); }

/* ===================== ë‚´ë³´ë‚´ê¸° ===================== */
const saveMask=document.getElementById('saveMask');
function openSave(){ saveMask.style.display='flex'; }
document.getElementById('iSave').onclick=openSave;
document.getElementById('btnCloseSave').onclick=()=>{ saveMask.style.display='none'; };
saveMask.addEventListener('click',(e)=>{ if(e.target===saveMask) saveMask.style.display='none'; });
document.getElementById('btnPrint').onclick=()=> window.print();
document.getElementById('btnExportPDF').onclick=()=>{
  const el=document.createElement('div'); el.innerHTML=getHTML();
  html2pdf().from(el).save('ThinkHelper_'+Date.now()+'.pdf');
};

/* ===================== ë„êµ¬ ë²„íŠ¼ ===================== */
document.getElementById('iNew').onclick=newDoc;
document.getElementById('iVSCode').onclick=()=>{ window.open('http://127.0.0.1:1234','_blank','noopener'); };

/* ===================== ì˜µì…˜ ì €ì¥ ===================== */
document.getElementById('optDeep').onchange=e=>{ conf.deep=e.target.checked; localStorage.setItem("th.deep", conf.deep?'1':'0'); };
document.getElementById('optSugg').onchange=e=>{ conf.sugg=e.target.checked; localStorage.setItem("th.sugg", conf.sugg?'1':'0'); };
document.getElementById('optPersonal').onchange=e=>{ conf.personal=e.target.checked; localStorage.setItem("th.personal", conf.personal?'1':'0'); };

/* ===================== ì‹œì„  ì»¤ì„œ ===================== */
const optGaze=document.getElementById('optGaze');
let gazeRunning=false, emaX=null, emaY=null;
optGaze.onchange=e=>{ conf.gaze=e.target.checked; localStorage.setItem("th.gaze",conf.gaze?"1":"0"); conf.gaze?startGaze():stopGaze(); };
async function startGaze(){
  if(gazeRunning) return;
  const cursor=document.getElementById("gazeCursor");
  try{
    if(!window.webgazer){ alert("WebGazer ë¡œë“œ ì „ì…ë‹ˆë‹¤."); return; }
    emaX=null; emaY=null;
    await webgazer.setRegression('ridge').setGazeListener((data)=>{
      if(!data) return;
      if(emaX===null){ emaX=data.x; emaY=data.y; }
      const a=.15; emaX += a*(data.x-emaX); emaY += a*(data.y-emaY);
      const cx=Math.max(0,Math.min(window.innerWidth,emaX));
      const cy=Math.max(0,Math.min(window.innerHeight,emaY));
      cursor.style.display="block"; cursor.style.transform="translate("+cx+"px,"+cy+"px)";
    }).begin();
    webgazer.showVideo(false).showFaceOverlay(false).showFaceFeedbackBox(false);
    gazeRunning=true;
  }catch(e){ alert("ì¹´ë©”ë¼ ê¶Œí•œ í•„ìš”: "+e.message); }
}
async function stopGaze(){ const c=document.getElementById("gazeCursor"); c.style.display="none"; try{ if(window.webgazer){ await webgazer.end(); } }catch{} gazeRunning=false; }
if(conf.gaze) startGaze();

/* ===================== ìœ„ì¹˜/IP ===================== */
(async function(){
  const el=document.getElementById('loc');
  try{
    const r=await fetch("https://ipapi.co/json/");
    const j=await r.json();
    el.textContent = `ğŸ“ ${[j.city,j.region,j.country_name].filter(Boolean).join(', ')} (IP: ${j.ip})`;
  }catch{ el.textContent="ğŸ“ "+(I18N[conf.lang]||I18N.ko).loc_hidden; }
})();
/* ========= PII ========= */
function maskPII(html){return (html||"").replace(/[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}/gi,"Â«emailÂ»").replace(/\b(01[016789]|02|0[3-9]\d)-?\d{3,4}-?\d{4}\b/g,"Â«phoneÂ»").replace(/\b\d{6}-?\d{7}\b/g,"Â«rrnÂ»").replace(/\b(?:\d[ -]*?){13,19}\b/g,"Â«cardÂ»")}
function hasPII(text){return /([A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,})|\b(01[016789]|02|0[3-9]\d)-?\d{3,4}-?\d{4}\b|\b\d{6}-?\d{7}\b|\b(?:\d[ -]*?){13,19}\b/.test(text||"")}
let optPII=true;

/* ===================== ì±„íŒ…: ìŠ¤ë ˆë“œ ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸° + ìŠ¤íŠ¸ë¦¬ë°/í´ë°± ===================== */
const CHAT_LIST_KEY="th.chat.threads";
const CHAT_THREAD_KEY=(id)=>`th.chat.thread.${id}`;
const chatDock=document.getElementById("chatDock");
const chatBody=document.getElementById("chatBody");
const chatInput=document.getElementById("chatInput");
const chatSend=document.getElementById("t_send");
const chatThreadsEl=document.getElementById("chatThreads");
let curThreadId=null;

/* ìƒë‹¨ ê°€ê¹Œìš´ ê³³ì— ë„£ê¸° */
const CHAT_ENDPOINT = "http://127.0.0.1:1234"; // <= "/chat" ë¹¼ê³  ë£¨íŠ¸ë§Œ
const CHAT_CHAT = CHAT_ENDPOINT + "/chat";     // ìŠ¤íŠ¸ë¦¬ë° ë˜ëŠ” ì „ìš© ì—”ë“œí¬ì¸íŠ¸ê°€ ìˆì„ ë•Œ ì‹œë„

document.getElementById("chatBtn").onclick=()=>{ chatDock.style.display="flex"; renderThreadList(); if(!curThreadId) newThread(); };
document.getElementById("chatClose").onclick=()=> chatDock.style.display="none";
document.getElementById("btnNewThread").onclick=()=> newThread();

/* ìŠ¤ë ˆë“œ CRUD */
function loadThreadList(){ try{ return JSON.parse(localStorage.getItem(CHAT_LIST_KEY)||"[]"); }catch{return[]}}
function saveThreadList(list){ localStorage.setItem(CHAT_LIST_KEY, JSON.stringify(list)); }
function newThread(){
  const id="c_"+Date.now();
  const item={id, title:"ìƒˆ ì±„íŒ…", createdAt:Date.now(), updatedAt:Date.now()};
  const list=loadThreadList(); list.unshift(item); saveThreadList(list);
  localStorage.setItem(CHAT_THREAD_KEY(id), JSON.stringify({id, messages:[]}));
  openThread(id);
}
function openThread(id){
  curThreadId=id;
  renderThreadList();
  chatBody.innerHTML="";
  const data=JSON.parse(localStorage.getItem(CHAT_THREAD_KEY(id))||'{"messages":[]}');
  for(const m of data.messages){ addBubble(m.role==="user"?"me":"ai", m.content); }
  scrollBottom();
}
function saveMessage(role, content){
  if(!curThreadId) newThread();
  const key=CHAT_THREAD_KEY(curThreadId);
  const data=JSON.parse(localStorage.getItem(key)||'{"messages":[]}');
  data.messages.push({role, content});
  localStorage.setItem(key, JSON.stringify(data));
  const list=loadThreadList();
  const idx=list.findIndex(x=>x.id===curThreadId);
  if(idx>=0){
    if(list[idx].title==="ìƒˆ ì±„íŒ…" && role==="user") list[idx].title=content.slice(0,30);
    list[idx].updatedAt=Date.now();
    saveThreadList(list);
    renderThreadList();
  }
}
function renderThreadList(){
  const list=loadThreadList();
  chatThreadsEl.innerHTML = list.map(it=>`
    <div class="threadRow" data-id="${it.id}" ${curThreadId===it.id?'data-active="1"':''}>
      <div style="flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis" title="${escapeHtml(it.title)}">${escapeHtml(it.title)}</div>
      <button class="iconbtn" data-open="${it.id}" title="ì—´ê¸°">â†©</button>
      <button class="iconbtn" data-del="${it.id}" title="ì‚­ì œ">âœ–</button>
    </div>
  `).join("") || `<div class="notice">ì €ì¥ëœ ì±„íŒ…ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
  chatThreadsEl.onclick=(e)=>{
    const o=e.target.closest("[data-open]"); const d=e.target.closest("[data-del]");
    if(o){ openThread(o.dataset.open); }
    if(d){
      const id=d.dataset.del;
      if(confirm("ì±„íŒ…ì„ ì‚­ì œí• ê¹Œìš”?")){
        const list=loadThreadList().filter(x=>x.id!==id); saveThreadList(list);
        localStorage.removeItem(CHAT_THREAD_KEY(id));
        if(curThreadId===id) curThreadId=null;
        renderThreadList();
        if(list[0]) openThread(list[0].id); else { chatBody.innerHTML=""; }
      }
    }
  };
}
function scrollBottom(){ chatBody.scrollTop=chatBody.scrollHeight; }

/* ë§í’ì„  */
function addBubble(who,text,cls=""){
  const d=document.createElement("div");
  d.className=`bubble ${who} ${cls}`.trim();
  d.textContent=text;
  chatBody.appendChild(d);
  scrollBottom();
  return d;
}
function setSending(isSending){
  chatSend.disabled = isSending;
  chatInput.disabled = isSending;
  chatSend.textContent = isSending ? "ì „ì†¡ì¤‘â€¦" : (I18N[conf.lang]||I18N.ko).send;
}

/* Enter=ì „ì†¡, Shift+Enter=ì¤„ë°”ê¿ˆ */
chatInput.addEventListener("keydown",(e)=>{
  if(e.key==="Enter" && !e.shiftKey){
    e.preventDefault();
    document.getElementById("chatForm").dispatchEvent(new Event("submit",{cancelable:true}));
  }
});

/* --- í†µì‹  ìœ í‹¸: ë¹„-ìŠ¤íŠ¸ë¦¬ë° ìš°ì„  -> ìŠ¤íŠ¸ë¦¬ë° í´ë°± --- */
async function sendNonStream(payload){
  const r = await fetch(CHAT_ENDPOINT, {
    method: "POST",
    headers: {"Content-Type":"application/json", "Accept":"application/json"},
    body: JSON.stringify(payload)
  });
  if(!r.ok) throw new Error("HTTP "+r.status);
  const data = await r.json().catch(()=> ({}));
  return data.reply || data.text || data.output || "";
}

/* ìŠ¤íŠ¸ë¦¬ë°: /chat ìš°ì„ , ì‹¤íŒ¨ ì‹œ ë£¨íŠ¸ ë¹„-ìŠ¤íŠ¸ë¦¼ìœ¼ë¡œ ì´ë¯¸ ì²˜ë¦¬ë¨ */
async function streamChat(payload, onChunk){
  let res;
  try{
    res = await fetch(CHAT_CHAT, {
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        "Accept":"text/event-stream, text/plain, application/json"
      },
      body: JSON.stringify(payload)
    });
  }catch(e){
    throw e;
  }
  if(!res.ok) throw new Error("HTTP "+res.status);

  const ctype=(res.headers.get("content-type")||"").toLowerCase();
  const reader = res.body.getReader();
  const decoder = new TextDecoder("utf-8");
  let buffer="";
  const isSSE = ctype.includes("text/event-stream");
  while(true){
    const {value, done} = await reader.read();
    if(done) break;
    const chunk=decoder.decode(value,{stream:true});
    if(isSSE){
      buffer += chunk;
      const lines = buffer.split(/\r?\n/);
      buffer = lines.pop()||"";
      for(const line of lines){
        if(line.startsWith("data:")){
          const data=line.slice(5).trim();
          if(data==="[DONE]") return;
          onChunk(data);
        }
      }
    }else{
      onChunk(chunk);
    }
  }
}

/* í¼ ì „ì†¡: ë¹„-ìŠ¤íŠ¸ë¦¼(JSON) â†’ ë¹„ì—ˆìœ¼ë©´ ìŠ¤íŠ¸ë¦¼(SSE/ì²­í¬) */
document.getElementById("chatForm").addEventListener("submit", async (e)=>{
  e.preventDefault();
  const v=(chatInput.value||"").trim();
  if(!v) return;
  chatInput.value="";
  if(!curThreadId) newThread();
  addBubble("me", v);
  saveMessage("user", v);

  const aiBubble = addBubble("ai",""); // ëˆ„ì  ì˜ì—­
  let acc="";
  const payload = {
    message: v,
    mode: conf.mode,
    lang: conf.lang,
    provider: "mistral",
    thread_id: curThreadId
  };

  try{
    setSending(true);

    /* 1) ë¹„-ìŠ¤íŠ¸ë¦¬ë° ë¨¼ì € (ë£¨íŠ¸ POST) */
    let text = "";
    try{
      text = await sendNonStream(payload);
    }catch(e){ /* ë¬´ì‹œí•˜ê³  ìŠ¤íŠ¸ë¦¼ ì‹œë„ */ }

    if(text){
      acc = text;
      aiBubble.textContent = acc;
    }else{
      /* 2) ë¹„ì–´ìˆìœ¼ë©´ ìŠ¤íŠ¸ë¦¼(/chat) ì‹œë„ */
      await streamChat(payload, (chunk)=>{
        let t = chunk;
        try{
          const obj=JSON.parse(chunk);
          t = obj.reply || obj.delta || obj.text || chunk;
        }catch{}
        acc += t;
        aiBubble.textContent = acc;
        scrollBottom();
      });

      if(!acc){
        // ì—¬ì „íˆ ì—†ìœ¼ë©´ /chatì— ëŒ€í•œ ë¹„-ìŠ¤íŠ¸ë¦¼ JSON ì‹œë„
        const res2=await fetch(CHAT_CHAT,{
          method:"POST",
          headers:{"Content-Type":"application/json","Accept":"application/json"},
          body: JSON.stringify(payload)
        });
        const data=await res2.json().catch(()=>null);
        acc=(data && (data.reply||data.text||data.output)) || "[no reply]";
        aiBubble.textContent=acc;
      }
    }

    saveMessage("assistant", acc || "[no reply]");
  }catch(err){
    aiBubble.classList.add("sys");
    aiBubble.textContent="ì—°ê²° ì‹¤íŒ¨. ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ ë˜ëŠ” ì—”ë“œí¬ì¸íŠ¸ê°€ ë§ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.";
  }finally{
    setSending(false);
    renderThreadList();
  }
});

/* ===================== ê²€ìƒ‰ ì‹¤í–‰(ìƒˆ íƒ­) ===================== */
function routeSearch(q){
  const low=q.toLowerCase().trim();
  const is=(re)=> re.test(low);
  const law=parseLaw(q);
  if(is(/ì¿ íŒ¡|coupang/)) return {title:"ì¿ íŒ¡", url:`https://www.coupang.com/np/search?q=${encodeURIComponent(q.replace(/ì¿ íŒ¡|coupang/ig,"").trim()||"")}`};
  if(is(/ì•„ë§ˆì¡´|amazon/)) return {title:"Amazon", url:`https://www.amazon.com/s?k=${encodeURIComponent(q.replace(/ì•„ë§ˆì¡´|amazon/ig,"").trim()||"")}`};
  if(is(/ë„¤ì´ë²„|naver/)) return {title:"ë„¤ì´ë²„", url:`https://search.naver.com/search.naver?query=${encodeURIComponent(q.replace(/ë„¤ì´ë²„|naver/ig,"").trim()||"")}`};
  if(law) return {title:`${law.code} ì œ${law.article}ì¡°`, url:law.url};
  if(is(/ë‰´ìŠ¤|news/)) return {title:"ë‰´ìŠ¤",url:`https://news.google.com/search?q=${encodeURIComponent(q.replace(/ë‰´ìŠ¤|news/ig,"").trim()||"")}`};
  return {title:"ì›¹ê²€ìƒ‰", url:`https://www.google.com/search?q=${encodeURIComponent(q)}`};
}
function parseLaw(q){
  const m=q.match(/(í˜•ë²•|ë¯¼ë²•|í˜•ì‚¬ì†Œì†¡ë²•|ë¯¼ì‚¬ì†Œì†¡ë²•|ìƒë²•)\s*ì œ?\s*(\d+)(ì¡°(?:ì˜\d+)*)?/); if(!m) return null;
  const code=m[1], art=m[2]+(m[3]||""); const url=`https://www.law.go.kr/%EB%B2%95%EB%A0%B9/${encodeURIComponent(code)}/${encodeURIComponent('ì œ'+art+'ì¡°')}`; return {code,article:art,url};
}
document.getElementById("searchBtn").onclick=()=> runSearch();
document.getElementById("searchBox").addEventListener("keydown",(e)=>{ if(e.key==="Enter"){ e.preventDefault(); runSearch(); }});
function runSearch(){
  const q=(document.getElementById("searchBox").value||"").trim(); if(!q) return;
  const r=routeSearch(q);
  try{ window.open(r.url,"_blank","noopener,noreferrer"); }catch{ location.href=r.url; }
}

/* ===================== ë¶€íŠ¸ìŠ¤íŠ¸ë© ===================== */
(function boot(){
  const cur=store.current(); if(cur && store.get(cur)) openDoc(cur); else newDoc(); renderList();
})();
</script>
</body>
</html>
