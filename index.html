<!DOCTYPE html>
<html lang="ko" data-theme="dark">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>ThinkHelper â€” Editor</title>
<link rel="icon" href="data:,"/>
<!-- CKEditor -->
<script src="https://cdn.ckeditor.com/ckeditor5/41.3.1/classic/ckeditor.js"></script>
<!-- Export helpers -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" defer></script>
<script src="https://unpkg.com/html-docx-js/dist/html-docx.js" defer></script>
<!-- Google Identity Services -->
<script src="https://accounts.google.com/gsi/client" async defer></script>
<style>
:root{
  --bg:#0b1020; --fg:#f1f5ff; --muted:#a8b4cf;
  --panel:#0f172a; --card:#101a30; --border:#273453;
  --hover:#16213b; --accent:#60a5fa; --accent-2:#f59e0b;
}
:root[data-theme="light"]{
  --bg:#f8fafc; --fg:#0b1020; --muted:#54607a;
  --panel:#ffffff; --card:#f1f5ff; --border:#d6deee;
  --hover:#e7eefc; --accent:#2563eb; --accent-2:#f59e0b;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--fg);font-family:-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif;display:flex;flex-direction:column}

/* Topbar */
.topbar{display:flex;gap:8px;align-items:center;padding:10px 12px;background:var(--panel);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:20}
.brand{display:flex;align-items:center;gap:8px;font-weight:900}
.logo{width:22px;height:22px;border-radius:6px;background:linear-gradient(135deg,#60a5fa,#34d399)}
.btn{border:1px solid var(--border);background:var(--card);color:var(--fg);border-radius:8px;padding:.5rem .75rem;font-weight:900;cursor:pointer}
.btn:hover{background:var(--hover)}
.primary{background:var(--accent);color:#fff;border-color:transparent}
.menu{position:relative}
.menu>.btn{font-weight:900}
.dropdown{display:none;position:absolute;top:42px;left:0;background:var(--panel);border:1px solid var(--border);border-radius:10px;min-width:260px;box-shadow:0 12px 24px rgba(0,0,0,.25);z-index:30}
.dropdown .item{padding:.55rem .7rem;border-bottom:1px dashed var(--border);cursor:pointer;display:flex;justify-content:space-between;gap:10px}
.dropdown .item:hover{background:var(--hover)}
.dropdown .item:last-child{border-bottom:none}

/* Layout */
main{flex:1;min-height:0;display:grid;grid-template-columns:280px 1fr 0px;gap:10px;padding:10px}
@media (max-width: 1200px){ main{grid-template-columns: 0px 1fr 0px; padding:6px} #left{display:none}}
aside#left{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:10px;display:flex;flex-direction:column;min-height:0}
#docList{flex:1;overflow:auto;display:flex;flex-direction:column;gap:8px;margin-top:10px}
.doc{display:flex;gap:8px;align-items:center;padding:8px;background:var(--card);border:1px solid var(--border);border-radius:10px;cursor:pointer}
.doc:hover{background:var(--hover)}
.doc .title{flex:1;font-weight:900;color:var(--fg);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.doc .time{font-size:.78rem;color:var(--muted)}
.doc .act{display:none;gap:6px}
.doc:hover .act{display:inline-flex}
.iconbtn{border:1px solid var(--border);background:transparent;color:var(--fg);border-radius:6px;padding:.1rem .35rem;cursor:pointer}
.iconbtn:hover{background:var(--hover)}

section#center{display:flex;flex-direction:column;gap:10px;min-width:0}
#editorWrap{border:1px solid var(--border);border-radius:12px;background:var(--card);padding:8px}
#editor{min-height:62vh}
.ck-editor__editable_inline{min-height:58vh!important;color:#222; background:#fff; padding:12px; border-radius:8px}
[data-theme="dark"] .ck-editor__editable_inline{color:#ffe7b3;background:#0b1327}
#fallbackArea{width:100%;min-height:58vh;background:#fff;color:#222;border:0;outline:none;font-size:17px;padding:12px;border-radius:8px}
[data-theme="dark"] #fallbackArea{background:#0b1327;color:#ffe7b3}

/* Suggest popup */
#suggPopup{position:absolute;display:none;z-index:60;background:var(--panel);color:var(--fg);border:1px solid var(--border);border-radius:10px;box-shadow:0 12px 24px rgba(0,0,0,.25);min-width:280px;max-width:560px}
#suggPopup ul{list-style:none;margin:0;padding:6px;max-height:260px;overflow:auto}
#suggPopup li{padding:8px 10px;border-radius:8px;display:flex;gap:8px;cursor:pointer}
#suggPopup li[data-active="1"]{background:var(--hover);outline:2px solid #8ab4ff66}
.kind{opacity:.7;font-size:.78rem;width:84px;flex:0 0 auto;color:#ffd58a}

/* Search/preview */
#searchRow{display:flex;gap:10px;padding:10px;background:var(--panel);border:1px solid var(--border);border-radius:12px}
#searchBox{flex:1;height:46px;border:2px solid var(--border);border-radius:12px;background:var(--card);color:var(--fg);padding:.6rem .9rem;font-size:16px}
aside#right{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:10px;min-height:0;overflow:auto;display:none}
#rightHeader{display:flex;gap:8px;justify-content:space-between;align-items:center;margin-bottom:8px}
#preview{width:100%;height:72vh;border:1px solid var(--border);border-radius:8px;background:#fff}

/* Chat */
#chatBtn{position:fixed;right:16px;bottom:16px;z-index:60}
#chatDock{position:fixed;right:16px;bottom:16px;width:min(92vw,760px);height:72vh;display:none;flex-direction:column;background:var(--panel);border:1px solid var(--border);border-radius:14px;box-shadow:0 18px 36px rgba(0,0,0,.28);z-index:70}
#chatHead{display:flex;align-items:center;gap:8px;justify-content:space-between;padding:12px;border-bottom:1px solid var(--border);font-weight:900}
#chatBody{flex:1;overflow:auto;padding:12px;display:flex;flex-direction:column;gap:10px}
.bubble{max-width:85%;padding:.75rem 1rem;border:1px solid var(--border);border-radius:14px;background:var(--card);word-break:break-word;font-size:1.02rem;line-height:1.55}
.me{margin-left:auto;background:#143763;color:#fff;border-color:#143763}
.ai{margin-right:auto;border-color:#3b4b72;background:#15284f;color:#fff}
#chatForm{display:flex;gap:8px;padding:12px;border-top:1px solid var(--border)}
#chatInput{flex:1;border:1px solid var(--border);border-radius:10px;background:var(--card);color:var(--fg);padding:.75rem .9rem;font-size:1.02rem}
#quota{position:absolute;left:12px;bottom:12px;background:var(--panel);border:1px solid var(--border);border-radius:8px;padding:.25rem .55rem;font-size:.85rem;color:var(--muted)}

/* Thread selector + auth buttons */
#threadSel{max-width:220px}

/* Consent */
#consentMask{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:100}
#consentCard{width:min(92vw,720px);background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:16px}
#consentCard h3{margin:0 0 8px}
#consentCard p{margin:0 0 12px;color:var(--muted)}
</style>
</head>
<body>
  <div class="topbar">
    <div class="brand"><div class="logo"></div><div id="t_brand">ThinkHelper</div></div>

    <!-- Tools -->
    <div class="menu"><button class="btn" id="t_tools">ë„êµ¬ â–¾</button>
      <div class="dropdown">
        <div class="item" id="iNew"><span id="t_new">ìƒˆ ë¬¸ì„œ</span><span>âŒ˜/Ctrl+N</span></div>
        <div class="item" id="iSave"><span id="t_save">ì €ì¥</span><span>âŒ˜/Ctrl+S</span></div>
        <div class="item" id="iPrint"><span id="t_print">ì¸ì‡„</span></div>
        <div class="item" id="iPDF"><span id="t_pdf">PDF ë‚´ë³´ë‚´ê¸°</span></div>
        <div class="item" id="iDOCX"><span id="t_docx">DOCX ë‚´ë³´ë‚´ê¸°</span></div>
        <div class="item" id="iExportNotion"><span>ë…¸ì…˜ìœ¼ë¡œ ë‚´ë³´ë‚´ê¸°</span></div>
        <div class="item" id="iExportWebhook"><span>ì›¹í›…ìœ¼ë¡œ ë‚´ë³´ë‚´ê¸°</span></div>
        <div class="item" id="iExportHancom"><span>í•œì»´ Spaceë¡œ ë‚´ë³´ë‚´ê¸°</span></div>
      </div>
    </div>

    <!-- Settings -->
    <div class="menu"><button class="btn" id="t_settings">ì„¤ì • â–¾</button>
      <div class="dropdown">
        <div class="item"><span id="t_lang">ì–¸ì–´</span>
          <select id="langSel">
            <option value="ko">í•œêµ­ì–´</option><option value="en">English</option><option value="ja">æ—¥æœ¬èª</option>
          </select>
        </div>
        <div class="item"><label><input type="checkbox" id="optSugg" checked> <span id="t_sugg">ì¶”ì²œì–´ í‘œì‹œ</span></label></div>
        <div class="item"><label><input type="checkbox" id="optPersonal" checked> <span id="t_pers">ë§ì¶¤í˜• ì¶”ì²œ</span></label></div>
        <div class="item"><label><input type="checkbox" id="optContext" checked> <span id="t_ctx">ë¬¸ë§¥ ì¶”ì²œ</span></label></div>
        <div class="item"><span id="t_mode">ëª¨ë“œ</span>
          <select id="modeSel" title="1 General / 2 Research / 3 Legal / 4 Dev">
            <option value="1">1) ì¼ë°˜</option>
            <option value="2">2) ë¦¬ì„œì¹˜</option>
            <option value="3">3) ë¦¬ê±¸</option>
            <option value="4">4) ê°œë°œì</option>
          </select>
        </div>
        <div class="item" id="toggleTheme">ğŸŒ“ <span id="t_theme">í…Œë§ˆ ì „í™˜</span></div>
        <div class="item">
          <details>
            <summary id="t_model">ëª¨ë¸ ì„¤ì • (LM Studio/OpenAI í˜¸í™˜)</summary>
            <div class="row">API Base: <input id="apiBase" placeholder="http://127.0.0.1:1234/v1" style="width:260px"></div>
            <div class="row">API Key: <input id="apiKey" placeholder="(ì„ íƒ)" style="width:180px"></div>
            <div class="row">Model: <input id="apiModel" placeholder="local-model"></div>
            <button class="btn primary" id="saveModel"><span id="t_save2">ì €ì¥</span></button>
          </details>
        </div>
        <div class="item">
          <details>
            <summary>ìë™í™”(ë…¸ì…˜/í•œì»´)</summary>
            <div class="row" style="margin:6px 0">
              <b>Notion</b><br/>
              Token: <input id="notionToken" style="width:240px" placeholder="secret_...">
              DB ID: <input id="notionDB" style="width:220px" placeholder="xxxxxxxx...">
              <label style="margin-left:8px"><input type="checkbox" id="autoExportNotion"> ì €ì¥ ì‹œ ìë™ ë‚´ë³´ë‚´ê¸°</label>
            </div>
            <div class="row" style="margin:6px 0">
              <b>Hancom Space</b><br/>
              Upload API URL: <input id="hancomUrl" style="width:420px" placeholder="https://openapi.hancom.com/drive/upload (ì˜ˆì‹œ)">
              Access Token: <input id="hancomToken" style="width:260px" placeholder="Bearer ...">
              <label style="margin-left:8px"><input type="checkbox" id="autoExportHancom"> ì €ì¥ ì‹œ ìë™ ì—…ë¡œë“œ</label>
            </div>
            <button class="btn" id="saveAutomation">ì €ì¥</button>
          </details>
        </div>
      </div>
    </div>

    <!-- Auth + Threads -->
    <select class="btn" id="threadSel" title="ëŒ€í™” ì„ íƒ"></select>
    <button class="btn" id="btnSignIn">ğŸ” Google ë¡œê·¸ì¸</button>
    <button class="btn" id="btnSignOut" style="display:none">â‹ ë¡œê·¸ì•„ì›ƒ</button>

    <!-- Help -->
    <div class="menu"><button class="btn" id="t_help">ë„ì›€ë§ â–¾</button>
      <div class="dropdown">
        <div class="item"><span id="t_keys">ë‹¨ì¶•í‚¤</span><span>âŒ˜/Ctrl+K, âŒ˜/Ctrl+Space</span></div>
        <div class="item"><span id="t_note">ì£¼ì˜</span><span>AI ê²°ê³¼ëŠ” í•­ìƒ ê²€í† </span></div>
      </div>
    </div>

    <button class="btn primary" id="chatBtn" style="margin-left:auto">ğŸ’¬ <span id="t_chat">ì±„íŒ…</span></button>
    <button class="btn" id="pencilDockToggle">âœï¸ <span id="t_pencil">íœìŠ¬</span></button>
  </div>

  <main>
    <aside id="left" aria-label="ë¬¸ì„œëª©ë¡">
      <div style="display:flex;gap:8px;align-items:center">
        <b id="t_docs">ë¬¸ì„œ</b>
        <select id="sortSel" class="btn" style="margin-left:auto">
          <option value="updated" id="t_sort1">ìµœê·¼ ìˆ˜ì •ìˆœ</option>
          <option value="title" id="t_sort2">ì œëª©ìˆœ</option>
          <option value="created" id="t_sort3">ìƒì„±ìˆœ</option>
        </select>
      </div>
      <div id="docList"></div>
    </aside>

    <section id="center">
      <div id="editorWrap">
        <div id="editor" aria-label="ì—ë””í„°"></div>
        <textarea id="fallbackArea" placeholder="ì—¬ê¸°ì„œ ì‘ì„±í•˜ì„¸ìš”â€¦" style="display:none"></textarea>
      </div>

      <div id="searchRow">
        <input id="searchBox" placeholder="Search (Enter) / Ctrl+K"/>
        <button class="btn" id="searchBtn"><span id="t_search">ê²€ìƒ‰</span></button>
        <button class="btn" id="previewClose" style="display:none"><span id="t_close">ë¯¸ë¦¬ë³´ê¸° ë‹«ê¸°</span></button>
      </div>
    </section>

    <aside id="right">
      <div id="rightHeader"><div id="rightTitle">Preview</div><div><button class="btn" id="openNewTab" title="Open in new tab">â†—</button></div></div>
      <div class="notice" id="rightNote"></div>
      <iframe id="preview" referrerpolicy="no-referrer" sandbox="allow-scripts allow-same-origin allow-forms allow-popups"></iframe>
    </aside>
  </main>

  <footer>Â© ThinkHelper â€” âš ï¸ <span id="t_disclaimer">ì¸ê³µì§€ëŠ¥ ëª¨ë¸ì€ ì‹¤ìˆ˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì¤‘ìš”í•œ ì •ë³´ëŠ” ë°˜ë“œì‹œ ì¬ì°¨ í™•ì¸í•˜ì„¸ìš”.</span></footer>

  <!-- Suggest popup -->
  <div id="suggPopup"><ul id="suggList"></ul></div>

  <!-- Chat -->
  <div id="chatDock" role="dialog" aria-hidden="true">
    <div id="chatHead"><span id="t_chatTitle">AI Chat</span><div><button class="btn" id="chatClose" aria-label="Close">âœ–</button></div></div>
    <div id="chatBody"></div>
    <form id="chatForm"><input id="chatInput" placeholder="Type & Enter"/><button class="btn primary" type="submit" id="t_send">ì „ì†¡</button></form>
    <div id="quota">10 free left</div>
  </div>

  <!-- Pencil -->
  <div id="pencilDock"><div style="display:flex;gap:8px;align-items:center;justify-content:space-between;padding:8px 10px;border-bottom:1px solid var(--border)">
    <b id="t_pencilPad">Pencil Pad</b><div style="display:flex;gap:6px"><button class="btn" id="padClear" type="button" >ğŸ§¹</button><button class="btn" id="padInsert" type="button" >â•</button><button class="btn" id="padClose" type="button" >âœ–</button></div></div>
    <div style="padding:8px"><div id="padHolder"><canvas id="pad"></canvas><canvas id="padGrid"></canvas></div></div>
  </div>

  <!-- Consent (ì ‘ì† ì¦‰ì‹œ í•œ ë²ˆë§Œ) -->
  <div id="consentMask"><div id="consentCard">
    <h3 id="t_consentTitle">ì„œë¹„ìŠ¤ ì´ìš© ì•ˆë‚´</h3>
    <p id="t_consentBody">ì‚¬ìš© ë‚´ì—­ì´ ë¡œì»¬ì— ì €ì¥ë©ë‹ˆë‹¤. â€˜í™•ì¸â€™ì„ ëˆ„ë¥´ë©´ ë‹¤ì‹œ í‘œì‹œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
    <button class="btn primary" id="consentOK">í™•ì¸</button>
  </div></div>

<script>
/* ===================== CONFIG ===================== */
const API_BASE = "https://YOUR-EC2/api"; // â† EC2 REST ì„œë²„
const GOOGLE_CLIENT_ID = "YOUR_GOOGLE_OAUTH_CLIENT_ID.apps.googleusercontent.com";

/* ===================== i18n ===================== */
const I18N={ ko:{brand:"ThinkHelper",tools:"ë„êµ¬ â–¾", new:"ìƒˆ ë¬¸ì„œ", save:"ì €ì¥", print:"ì¸ì‡„", pdf:"PDF ë‚´ë³´ë‚´ê¸°", docx:"DOCX ë‚´ë³´ë‚´ê¸°", settings:"ì„¤ì • â–¾", lang:"ì–¸ì–´", sugg:"ì¶”ì²œì–´ í‘œì‹œ", pers:"ë§ì¶¤í˜• ì¶”ì²œ", ctx:"ë¬¸ë§¥ ì¶”ì²œ", mode:"ëª¨ë“œ", theme:"í…Œë§ˆ ì „í™˜", model:"ëª¨ë¸ ì„¤ì • (LM Studio/OpenAI í˜¸í™˜)", help:"ë„ì›€ë§ â–¾", keys:"ë‹¨ì¶•í‚¤", note:"ì£¼ì˜", chat:"ì±„íŒ…", pencil:"íœìŠ¬", docs:"ë¬¸ì„œ", sort1:"ìµœê·¼ ìˆ˜ì •ìˆœ", sort2:"ì œëª©ìˆœ", sort3:"ìƒì„±ìˆœ", search:"ê²€ìƒ‰", close:"ë¯¸ë¦¬ë³´ê¸° ë‹«ê¸°", disclaimer:"ì¸ê³µì§€ëŠ¥ ëª¨ë¸ì€ ì‹¤ìˆ˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì¤‘ìš”í•œ ì •ë³´ëŠ” ë°˜ë“œì‹œ ì¬ì°¨ í™•ì¸í•˜ì„¸ìš”.", chatTitle:"AI ì±„íŒ…", send:"ì „ì†¡", pencilPad:"Pencil Pad", consentTitle:"ì„œë¹„ìŠ¤ ì´ìš© ì•ˆë‚´", consentBody:"ì‚¬ìš© ë‚´ì—­ì´ ë¡œì»¬ì— ì €ì¥ë©ë‹ˆë‹¤. â€˜í™•ì¸â€™ì„ ëˆ„ë¥´ë©´ ë‹¤ì‹œ í‘œì‹œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤."},
en:{brand:"ThinkHelper",tools:"Tools â–¾", new:"New", save:"Save", print:"Print", pdf:"Export PDF", docx:"Export DOCX", settings:"Settings â–¾", lang:"Language", sugg:"Show suggestions", pers:"Personalized", ctx:"Context aware", mode:"Mode", theme:"Toggle theme", model:"Model Settings (LM Studio / OpenAI compatible)", help:"Help â–¾", keys:"Shortcuts", note:"Note", chat:"Chat", pencil:"Pencil", docs:"Documents", sort1:"Recently updated", sort2:"Title", sort3:"Created", search:"Search", close:"Close preview", disclaimer:"AI may make mistakes. Always verify important information.", chatTitle:"AI Chat", send:"Send", pencilPad:"Pencil Pad", consentTitle:"Notice", consentBody:"Your usage may be stored locally. Click OK to hide this permanently."},
ja:{brand:"ThinkHelper",tools:"ãƒ„ãƒ¼ãƒ« â–¾", new:"æ–°è¦", save:"ä¿å­˜", print:"å°åˆ·", pdf:"PDF ã«æ›¸ãå‡ºã—", docx:"DOCX ã«æ›¸ãå‡ºã—", settings:"è¨­å®š â–¾", lang:"è¨€èª", sugg:"ã‚µã‚¸ã‚§ã‚¹ãƒˆè¡¨ç¤º", pers:"ãƒ‘ãƒ¼ã‚½ãƒŠãƒ©ã‚¤ã‚º", ctx:"æ–‡è„ˆã‚µã‚¸ã‚§ã‚¹ãƒˆ", mode:"ãƒ¢ãƒ¼ãƒ‰", theme:"ãƒ†ãƒ¼ãƒåˆ‡æ›¿", model:"ãƒ¢ãƒ‡ãƒ«è¨­å®šï¼ˆLM Studio/OpenAI äº’æ›ï¼‰", help:"ãƒ˜ãƒ«ãƒ— â–¾", keys:"ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ", note:"æ³¨æ„", chat:"ãƒãƒ£ãƒƒãƒˆ", docs:"ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ", sort1:"æ›´æ–°é †", sort2:"ã‚¿ã‚¤ãƒˆãƒ«é †", sort3:"ä½œæˆé †", search:"æ¤œç´¢", close:"ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹", disclaimer:"AIã¯é–“é•ãˆã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚é‡è¦ãªæƒ…å ±ã¯å¿…ãšç¢ºèªã—ã¦ãã ã•ã„ã€‚", chatTitle:"AI ãƒãƒ£ãƒƒãƒˆ", send:"é€ä¿¡", pencilPad:"ãƒšãƒ³ã‚·ãƒ«ãƒ‘ãƒƒãƒ‰", consentTitle:"åˆ©ç”¨æ¡ˆå†…", consentBody:"åˆ©ç”¨çŠ¶æ³ã¯ãƒ­ãƒ¼ã‚«ãƒ«ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚OKã™ã‚‹ã¨ä»Šå¾Œè¡¨ç¤ºã—ã¾ã›ã‚“ã€‚"} };
function applyI18N(lang){
  const t=I18N[lang]||I18N.ko; document.documentElement.lang=lang;
  const map={t_brand:t.brand,t_tools:t.tools,t_settings:t.settings,t_help:t.help,t_new:t.new,t_save:t.save,t_print:t.print,t_pdf:t.pdf,t_docx:t.docx,t_lang:t.lang,t_sugg:t.sugg,t_pers:t.pers,t_ctx:t.ctx,t_mode:t.mode,t_theme:t.theme,t_model:t.model,t_chat:t.chat,t_pencil:t.pencil,t_docs:t.docs,t_sort1:t.sort1,t_sort2:t.sort2,t_sort3:t.sort3,t_search:t.search,t_close:t.close,t_disclaimer:t.disclaimer,t_chatTitle:t.chatTitle,t_send:t.send,t_pencilPad:t.pencilPad,t_consentTitle:t.consentTitle,t_consentBody:t.consentBody};
  for(const id in map){ const el=document.getElementById(id); if(el) el.textContent=map[id]; }
  const sb=document.getElementById("searchBox"); if(sb) sb.placeholder=(lang==="ko"?"ê²€ìƒ‰(Enter) / Ctrl+K":lang==="ja"?"æ¤œç´¢ï¼ˆEnterï¼‰ / Ctrl+K":"Search (Enter) / Ctrl+K");
  const chatIn=document.getElementById("chatInput"); if(chatIn) chatIn.placeholder=(lang==="ko"?"ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš” (Enter)":lang==="ja"?"ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ï¼ˆEnterï¼‰":"Type & Enter");
}

/* ===================== config/state ===================== */
const conf={
  lang: localStorage.getItem("th.lang")||"ko",
  mode: localStorage.getItem("th.mode")||"1",
  sugg: localStorage.getItem("th.sugg")==="0"?0:1,
  personal: localStorage.getItem("th.personal")==="0"?0:1,
  ctx: localStorage.getItem("th.ctx")==="0"?0:1,
  apiBase: localStorage.getItem("th.apiBase")||"http://127.0.0.1:1234/v1",
  apiKey: localStorage.getItem("th.apiKey")||"",
  model: localStorage.getItem("th.apiModel")||"local-model",
  notionToken: localStorage.getItem("th.notionToken")||"",
  notionDB: localStorage.getItem("th.notionDB")||"",
  autoExportNotion: localStorage.getItem("th.autoExportNotion")==="1",
  hancomUrl: localStorage.getItem("th.hancomUrl")||"",
  hancomToken: localStorage.getItem("th.hancomToken")||"",
  autoExportHancom: localStorage.getItem("th.autoExportHancom")==="1",
};
document.getElementById("langSel").value=conf.lang;
document.getElementById("modeSel").value=conf.mode;
document.getElementById("optSugg").checked=!!conf.sugg;
document.getElementById("optPersonal").checked=!!conf.personal;
document.getElementById("optContext").checked=!!conf.ctx;
applyI18N(conf.lang);

document.getElementById("langSel").onchange=e=>{ conf.lang=e.target.value; localStorage.setItem("th.lang",conf.lang); applyI18N(conf.lang); };
document.getElementById("modeSel").onchange=e=>{ conf.mode=e.target.value; localStorage.setItem("th.mode",conf.mode); };
document.getElementById("optSugg").onchange=e=>{ conf.sugg=e.target.checked?1:0; localStorage.setItem("th.sugg",conf.sugg); };
document.getElementById("optPersonal").onchange=e=>{ conf.personal=e.target.checked?1:0; localStorage.setItem("th.personal",conf.personal); };
document.getElementById("optContext").onchange=e=>{ conf.ctx=e.target.checked?1:0; localStorage.setItem("th.ctx",conf.ctx); };
document.getElementById("toggleTheme").onclick=()=> toggleThemeManual();

/* ===================== Consent: ì ‘ì† ì¦‰ì‹œ í‘œì‹œ, í•œ ë²ˆë§Œ ë¬»ê¸° ===================== */
(function consent(){
  const key="th.consent";
  const mask=document.getElementById("consentMask");
  if(localStorage.getItem(key)==="1"){ mask.style.display="none"; return; }
  mask.style.display="flex";
  document.getElementById("consentOK").onclick=()=>{
    localStorage.setItem(key,"1");
    mask.style.display="none";
  };
})();

/* ===================== iPad detect ===================== */
(function detectiPad(){
  const ua=navigator.userAgent.toLowerCase();
  const isiPad = /ipad/.test(ua) || (navigator.maxTouchPoints>1 && /macintosh/.test(ua));
  if(isiPad) document.body.classList.add("ipad");
})();

/* ===================== Editor ===================== */
let editor=null,useFallback=false;
async function initEditor(){
  const mount=document.getElementById("editor"), fb=document.getElementById("fallbackArea");
  try{
    editor = await ClassicEditor.create(mount,{placeholder: (conf.lang==="ko"?"ì—¬ê¸°ì„œ ì‘ì„±í•˜ì„¸ìš”â€¦":conf.lang==="ja"?"ã“ã“ã«å…¥åŠ›â€¦":"Start writingâ€¦") });
    editor.model.document.on("change:data", onType);
    editor.editing.view.document.on("keydown",(evt,data)=>{
      const k=(data.key||"").toLowerCase();
      if((data.ctrlKey||data.metaKey)&&k==="s"){ data.preventDefault(); doSave(); }
      if((data.ctrlKey||data.metaKey)&&k==="k"){ data.preventDefault(); document.getElementById("searchBox").focus(); }
      if((data.ctrlKey||data.metaKey)&&k===" "){ data.preventDefault(); openSuggest(true); }
    });
  }catch{
    useFallback=true; mount.style.display="none"; fb.style.display="block";
    fb.addEventListener("input", onType);
  }
}
function getHTML(){ return useFallback? document.getElementById("fallbackArea").value : editor.getData(); }
function setHTML(h){ if(useFallback) document.getElementById("fallbackArea").value=h; else editor.setData(h); }

/* ===================== Docs (local) ===================== */
const store={listKey:"th.docs.list", docKey:id=>`th.doc.${id}`, curKey:"th.cur",
  list(){try{return JSON.parse(localStorage.getItem(this.listKey)||"[]")}catch{return[]}},
  saveList(a){localStorage.setItem(this.listKey,JSON.stringify(a||[]))},
  get(id){try{return JSON.parse(localStorage.getItem(this.docKey(id))||"null")}catch{return null}},
  set(id,o){localStorage.setItem(this.docKey(id),JSON.stringify(o))},
  remove(id){localStorage.removeItem(this.docKey(id))},
  current(){return localStorage.getItem(this.curKey)||""},
  setCurrent(id){localStorage.setItem(this.curKey,id||"")}
};
let curId="";
function renderList(){
  const sort=document.getElementById("sortSel").value;
  const list=store.list();
  list.sort((a,b)=> sort==="title"?(a.title||"").localeCompare(b.title||"") : sort==="created"?((a.createdAt||0)-(b.createdAt||0)) : ((b.updatedAt||0)-(a.updatedAt||0)));
  const el=document.getElementById("docList");
  el.innerHTML = list.map(d=>{
    const when=new Date(d.updatedAt||d.createdAt||Date.now()).toLocaleString();
    return `<div class="doc" data-open="${d.id}">
      <div class="title" title="${escapeHtml(d.title||"Untitled")}">${escapeHtml(d.title||"Untitled")}</div>
      <div class="time">${when}</div>
      <div class="act"><button class="iconbtn" data-rename="${d.id}">âœï¸</button><button class="iconbtn" data-del="${d.id}">âœ–</button></div>
    </div>`;
  }).join("") || `<div class="notice">${conf.lang==="ko"?"ì €ì¥ëœ ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤.":conf.lang==="ja"?"ä¿å­˜ã•ã‚ŒãŸãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“ã€‚":"No saved documents."}</div>`;
  el.onclick=(e)=>{
    const r=e.target.closest("[data-rename]"); const d=e.target.closest("[data-del]");
    if(r){ const id=r.dataset.rename; const doc=store.get(id); const t=prompt(conf.lang==="ko"?"ìƒˆ ì œëª©:":conf.lang==="ja"?"æ–°ã—ã„ã‚¿ã‚¤ãƒˆãƒ«:":"New title:",doc?.title||"Untitled")||"Untitled"; if(doc){doc.title=t; doc.updatedAt=Date.now(); store.set(id,doc);} const L=store.list().map(x=>x.id===id?{...x,title:doc.title,updatedAt:doc.updatedAt}:x); store.saveList(L); renderList(); return; }
    if(d){ const id=d.dataset.del; if(confirm(conf.lang==="ko"?"ì‚­ì œí• ê¹Œìš”?":conf.lang==="ja"?"å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ":"Delete?")){ store.remove(id); store.saveList(store.list().filter(x=>x.id!==id)); if(curId===id){curId=""; setHTML("");} renderList(); } return; }
    const row=e.target.closest("[data-open]"); if(row) openDoc(row.dataset.open);
  };
}
function newDoc(){ const id="d_"+Date.now(); curId=id; store.setCurrent(id); const row={id,title:(conf.lang==="ko"?"ë¬´ì œ":"Untitled"),createdAt:Date.now(),updatedAt:Date.now()}; store.saveList([row,...store.list().filter(x=>x.id!==id)]); setHTML(""); renderList(); }
async function doSave(){
  if(!curId) newDoc();
  const html=getHTML(); const doc=store.get(curId)||{id:curId};
  doc.payload=btoa(unescape(encodeURIComponent(html)));
  const title=prompt(conf.lang==="ko"?"ë¬¸ì„œ ì œëª©:":conf.lang==="ja"?"ã‚¿ã‚¤ãƒˆãƒ«:":"Title:",doc.title||"Untitled")||"Untitled";
  doc.title=title; doc.updatedAt=Date.now(); store.set(curId,doc);
  const list=store.list().filter(x=>x.id!==curId);
  list.unshift({id:curId,title:doc.title,createdAt:doc.createdAt||Date.now(),updatedAt:doc.updatedAt});
  store.saveList(list); renderList();

  // ìë™í™”: ì €ì¥ ì‹œ ë‚´ë³´ë‚´ê¸°
  if(conf.autoExportNotion && conf.notionToken && conf.notionDB){
    try{ await exportNotionPage(title, html); }catch(e){ console.warn("Notion export failed:",e); }
  }
  if(conf.autoExportHancom && conf.hancomUrl && conf.hancomToken){
    try{ await exportHancomDocx(title, html); }catch(e){ console.warn("Hancom export failed:",e); }
  }
}
function openDoc(id){ const d=store.get(id); if(!d) return; curId=id; store.setCurrent(id); const html=decodeURIComponent(escape(atob(d.payload||""))); setHTML(html||""); }
function escapeHtml(s){return String(s??"").replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));}

/* ===================== Preview helpers ===================== */
const right      = document.getElementById("right");
const rightTitle = document.getElementById("rightTitle");
const rightNote  = document.getElementById("rightNote");
const preview    = document.getElementById("preview");
const previewCloseBtn = document.getElementById("previewClose");
const searchBox  = document.getElementById("searchBox");
const searchBtn  = document.getElementById("searchBtn");
const openNewTabBtn = document.getElementById("openNewTab");
let previewOriginalURL = "";   // â† ëˆ„ë½ë˜ì–´ ìˆë˜ ì „ì—­ ì„ ì–¸ ì¶”ê°€

function setRight(on){
  const grid = document.querySelector("main");
  right.style.display = on ? "block" : "none";
  previewCloseBtn.style.display = on ? "inline-flex" : "none";
  grid.style.gridTemplateColumns = on
    ? (window.innerWidth > 1200 ? "280px 1fr 420px" : "0px 1fr 420px")
    : (window.innerWidth > 1200 ? "280px 1fr 0px"   : "0px 1fr 0px");
}
previewCloseBtn.onclick = ()=> setRight(false);

/* === ì°¨ë‹¨ ë„ë©”ì¸ íŒ¨í„´ í™•ì¥ === */
const EMBED_ALWAYS_NEW_TAB = [
  /google\./i, /naver\./i, /coupang\./i, /amazon\./i, /law\.go\.kr/i,
  /accounts\.google\.com/i, /twitter\.com/i, /x\.com/i, /instagram\.com/i,
  /tistory\.com/i, /daum\.net/i, /kakao\.com/i, /linkedin\.com/i
];

/* === ë¦¬ë” URL ìƒì„±: ë‚´ EC2 í”„ë¡ì‹œ ìš°ì„ , ì‹¤íŒ¨ì‹œ r.jina.ai === */
const EC2_PROXY_BASE = "https://YOUR-EC2-HOST/proxy?url="; // ë°°í¬ í›„ êµì²´
function toReaderURL(u){
  const url = /^https?:\/\//i.test(u) ? u : ("https://" + u.replace(/^\/+/, ""));
  return {
    primary: EC2_PROXY_BASE + encodeURIComponent(url),
    fallback: "https://r.jina.ai/http/" + url.replace(/^https?:\/\//,'')
  };
}

/* === í…ìŠ¤íŠ¸ ëª¨ë“œ ê°•ì œ ë²„íŠ¼ === */
const forceTextBtn = document.createElement("button");
forceTextBtn.className = "btn";
forceTextBtn.textContent = "í…ìŠ¤íŠ¸ ëª¨ë“œ";
forceTextBtn.style.marginLeft = "8px";
document.getElementById("rightHeader").appendChild(forceTextBtn);
let _lastURL = "";
forceTextBtn.onclick = ()=> { if(_lastURL) showReader(_lastURL, true); };

/* === ë¯¸ë¦¬ë³´ê¸° ë¡œë”(ê°•í™”íŒ) === */
function loadPreview(url, title=""){
  _lastURL = url || "";
  previewOriginalURL = url || "";
  if(title) rightTitle.textContent = title;

  preview.srcdoc = `
    <!doctype html><meta charset="utf-8">
    <style>body{font:14px system-ui;margin:0;color:#111}
    .wrap{padding:14px} .muted{color:#666}</style>
    <div class="wrap">ë¡œë”© ì¤‘â€¦ <span class="muted">(ì„ë² ë“œ ì°¨ë‹¨ ì‹œ í…ìŠ¤íŠ¸ ëª¨ë“œë¡œ ì „í™˜)</span></div>
  `;

  if (EMBED_ALWAYS_NEW_TAB.some(re=>re.test(url))) {
    rightNote.textContent = "ì„ë² ë“œ ì°¨ë‹¨ â€” ìƒˆ íƒ­ìœ¼ë¡œ ì—´ê³ , ì•„ë˜ í…ìŠ¤íŠ¸ ëª¨ë“œ í‘œì‹œí•©ë‹ˆë‹¤.";
    window.open(url, "_blank", "noopener");
    showReader(url);
    return;
  }

  rightNote.textContent = "ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦";
  preview.removeAttribute("srcdoc");
  preview.src = url;

  let switched = false;
  const guard = setTimeout(()=>{
    if(!switched){ switched = true; showReader(url); }
  }, 2000);

  preview.onload = ()=>{
    rightNote.textContent = "";
    clearTimeout(guard);
  };
}

/* === ë¦¬ë”(í…ìŠ¤íŠ¸ ëª¨ë“œ) í‘œì‹œ (EC2 í”„ë¡ì‹œ â†’ ì‹¤íŒ¨ ì‹œ r.jina.ai) === */
function showReader(url, manual=false){
  const {primary, fallback} = toReaderURL(url);
  rightNote.textContent = manual ? "í…ìŠ¤íŠ¸ ëª¨ë“œ(í”„ë¡ì‹œ)ë¡œ í‘œì‹œí•©ë‹ˆë‹¤." : "ì„ë² ë“œ ì°¨ë‹¨ â€” í…ìŠ¤íŠ¸ ëª¨ë“œë¡œ í‘œì‹œí•©ë‹ˆë‹¤.";
  preview.src = primary;

  let swapped = false;
  const guard = setTimeout(()=>{
    if(!swapped){
      swapped = true;
      preview.src = fallback;
      rightNote.textContent = "ì„ë² ë“œ ì°¨ë‹¨ â€” í…ìŠ¤íŠ¸ ëª¨ë“œ(r.jina.ai)ë¡œ í‘œì‹œí•©ë‹ˆë‹¤.";
    }
  }, 1800);

  preview.onload = ()=> clearTimeout(guard);
}

/* â†— ì›ë³¸ ì—´ê¸° */
openNewTabBtn.onclick = ()=>{
  const target = previewOriginalURL || preview.src;
  if(target) window.open(target, "_blank", "noopener");
};

/* ===================== ëª¨ë“œ: ë¦¬ê±¸/ë¦¬ì„œì¹˜/ê°œë°œ ===================== */
function parseKoreanLaw(text){
  const m=(text||"").match(/(í˜•ë²•|ë¯¼ë²•|í˜•ì‚¬ì†Œì†¡ë²•|ë¯¼ì‚¬ì†Œì†¡ë²•|ìƒë²•)\s*ì œ?\s*(\d+)(ì¡°(?:ì˜\d+)*)?/);
  if(!m) return null; const code=m[1], article=(m[2]+(m[3]||""));
  const url=`https://www.law.go.kr/%EB%B2%95%EB%A0%B9/${encodeURIComponent(code)}/${encodeURIComponent("ì œ"+article+"ì¡°")}`;
  return {code, article, url};
}
function renderLawToPreview(title, text, originalUrl){
  previewOriginalURL=originalUrl||""; rightTitle.textContent=title;
  rightNote.textContent=conf.lang==="ko"?"êµ­ê°€ë²•ë ¹ì •ë³´ì„¼í„° ì¡°ë¬¸":"Law.go.kr article";
  preview.srcdoc=`<!doctype html><meta charset="utf-8"><style>body{font:15px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif;margin:0;background:#fff;color:#111}.wrap{padding:16px 18px;max-width:860px;margin:auto}h1{font-size:18px;margin:0 0 10px;font-weight:800}pre{white-space:pre-wrap;word-break:keep-all;background:#f7f8fb;border:1px solid #e5e9f2;border-radius:10px;padding:12px}.meta{color:#6b7280;margin:8px 0 0}</style><div class="wrap"><h1>${escapeHtml(title)}</h1><pre>${escapeHtml(text||"(ë³¸ë¬¸ì„ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤)")}</pre>${originalUrl?`<div class="meta">ì›ë¬¸: <a href="${originalUrl}" target="_blank" rel="noopener">${originalUrl}</a></div>`:""}</div>`;
}
function extractArticleText(fullText, articleNumber){
  const re=new RegExp(`ì œ\\s*${articleNumber}\\s*ì¡°[\\s\\S]*?(?=\\nì œ\\s*\\d+\\s*ì¡°|\\n\\[|$)`);
  const m=fullText.match(re); return m?m[0].trim():"";
}
/* READER_PROXY: ë²•ë ¹ ë³¸ë¬¸ ì¶”ì¶œì€ r.jina.aiì˜ í…ìŠ¤íŠ¸ ì‘ë‹µì„ ì‚¬ìš© */
function READER_PROXY(u){
  const url = /^https?:\/\//i.test(u) ? u : ("https://" + u.replace(/^\/+/, ""));
  return "https://r.jina.ai/http/" + url.replace(/^https?:\/\//,'');
}
async function fetchLawArticleText(url, articleNumber){
  const res=await fetch(READER_PROXY(url));
  const txt=await res.text();
  return extractArticleText(txt, articleNumber)||"";
}

const DEV_SNIPPETS={python:`# quick template
def main():
    print("Hello")
if __name__ == "__main__":
    main()`, javascript:`// quick template
function main(){ console.log("Hello"); }
main();`, sql:`-- quick template
SELECT col, COUNT(*) FROM table
WHERE created_at >= CURRENT_DATE - INTERVAL '7 day'
GROUP BY col ORDER BY 2 DESC;`, go:`package main
import "fmt"
func main(){ fmt.Println("Hello") }`};
function detectDevLang(s){
  const t=(s||"").toLowerCase();
  if(/python|py\b/.test(t)) return {lang:"python", snippet:DEV_SNIPPETS.python, doc:"https://docs.python.org/3/"};
  if(/\bjs|javascript|node\b/.test(t)) return {lang:"javascript", snippet:DEV_SNIPPETS.javascript, doc:"https://developer.mozilla.org/en-US/docs/Web/JavaScript"};
  if(/\bsql|postgres|mysql|sqlite\b/.test(t)) return {lang:"sql", snippet:DEV_SNIPPETS.sql, doc:"https://www.postgresql.org/docs/"};
  if(/\bgo(lang)?\b/.test(t)) return {lang:"go", snippet:DEV_SNIPPETS.go, doc:"https://go.dev/doc/"};
  return null;
}
function researchGuide(q){ return `<div>ğŸ” <i>${escapeHtml(q)}</i> â€” Scholar/ë‰´ìŠ¤ ì—´ë¦¼<br>â€¢ í•µì‹¬ ì£¼ì¥ 2~3ê°œë§Œ ê¸°ë¡ â€¢ ì¶œì²˜(ì œëª©/ì €ì/ì—°ë„/ë§í¬)</div>`; }
function showInfoCard(kind,title,html){ const host=document.getElementById("chatBody"); const card=document.createElement("div"); card.className="bubble ai"; card.innerHTML=`ğŸ“Œ <b>${kind}</b> â€” ${escapeHtml(title)}<br>`+html; host.appendChild(card); host.scrollTop=host.scrollHeight; }

/* ===================== Search / Preview Router ===================== */
function routeSearchByMode(q){
  const leg=parseKoreanLaw(q);
  if(conf.mode==="3"&&leg) return {title:`${leg.code} ì œ${leg.article}ì¡°`, url:leg.url, kind:"legal", law:leg};
  if(conf.mode==="2") return {title:"Google Scholar", url:`https://scholar.google.com/scholar?q=${encodeURIComponent(q)}`, kind:"scholar"};
  if(/ë‰´ìŠ¤|news/i.test(q)) return {title:(conf.lang==="ko"?"ë‰´ìŠ¤":"News"), url:`https://news.google.com/search?q=${encodeURIComponent(q.replace(/ë‰´ìŠ¤|news/ig,"").trim())}`, kind:"news"};
  return {title:"Google", url:`https://www.google.com/search?q=${encodeURIComponent(q)}`, kind:"web"};
}
function runSearch(){
  const q=(searchBox.value||"").trim(); if(!q){ setRight(false); return; }
  const r=routeSearchByMode(q); setRight(true);
  if(r.kind==="legal"&&r.law){
    rightTitle.textContent=r.title;
    fetchLawArticleText(r.url, r.law.article).then(txt=>{ if(txt) renderLawToPreview(r.title, txt, r.url); else loadPreview(r.url, r.title); }).catch(()=> loadPreview(r.url, r.title));
    return;
  }
  rightTitle.textContent=r.title; loadPreview(r.url, r.title);
}
searchBtn.onclick=()=>runSearch();
searchBox.addEventListener("keydown",(e)=>{ if(e.key==="Enter"){ e.preventDefault(); runSearch(); }});

/* ===================== Suggestions ===================== */
const BANK={general:{items:[{label:"í•µì‹¬ ìš”ì•½",insert:"â–  í•µì‹¬ ìš”ì•½\n- í¬ì¸íŠ¸ 1\n- í¬ì¸íŠ¸ 2\n- í¬ì¸íŠ¸ 3\n"},{label:"ì²´í¬ë¦¬ìŠ¤íŠ¸",insert:"â–  ì²´í¬ë¦¬ìŠ¤íŠ¸\n1) \n2) \n3) \n"},{label:"ê²°ë¡  í•œ ì¤„",insert:"â–  ê²°ë¡ \n- \n"}]},
travel:{items:[{label:"ì¼ì •í‘œ(ë‚ ì§œ/ë¹„ìš©/ë©”ëª¨)",insert:"â–  ì—¬í–‰ ì¼ì •í‘œ\në‚ ì§œ | ì¥ì†Œ | ë¹„ìš© | ë©”ëª¨\n---|---|---|---\n"},{label:"ë§›ì§‘ í›„ë³´",insert:"â–  ë§›ì§‘ í›„ë³´\n- \n- \n- \n"}]},
legal:{items:[{label:"ì ìš© ê·œì œ ëª©ë¡",insert:"â–  ì ìš© ê°€ëŠ¥ ê·œì œ\n- ë²•ë ¹ëª…: ì¡°ë¬¸\n- ë²•ë ¹ëª…: ì¡°ë¬¸\n"},{label:"ìš”ê±´ í‘œ",insert:"â–  ìš”ê±´ ì •ë¦¬\ní•­ëª© | ë‚´ìš© | ê·¼ê±°ì¡°ë¬¸\n---|---|---\n"}]},
research:{items:[{label:"ì—°êµ¬ì§ˆë¬¸(RQ)",insert:"â–  ì—°êµ¬ì§ˆë¬¸(RQ)\n- \n"},{label:"ê°€ì„¤(H)",insert:"â–  ê°€ì„¤(H)\n- \n"},{label:"ë°ì´í„°/í‘œë³¸",insert:"â–  ë°ì´í„°/í‘œë³¸\n- ì¶œì²˜:\n- í¬ê¸°:\n- ë³€ìˆ˜:\n"},{label:"ë°©ë²•",insert:"â–  ë°©ë²•\n- \n"},{label:"í•µì‹¬ê²°ê³¼",insert:"â–  í•µì‹¬ê²°ê³¼\n- \n"},{label:"í•œê³„/í›„ì†",insert:"â–  í•œê³„/í›„ì†ì—°êµ¬\n- \n"}]},
dev:{items:[{label:"API ëª…ì„¸",insert:"â–  API ëª…ì„¸\n- endpoint:\n- input:\n- output:\n- error:\n"},{label:"ì„±ëŠ¥ ì ê²€",insert:"â–  ì„±ëŠ¥ ì ê²€\n- RPS:\n- p95:\n- ë³‘ëª©:\n"},{label:"ë°°í¬ ì²´í¬ë¦¬ìŠ¤íŠ¸",insert:"â–  ë°°í¬ ì²´í¬ë¦¬ìŠ¤íŠ¸\n- ENV\n- CORS\n- SECRET\n- HEALTHCHECK\n"}]}};
let geo={city:"",lat:null,lon:null}; if(navigator.geolocation){ navigator.geolocation.getCurrentPosition(p=>{ geo.lat=p.coords.latitude; geo.lon=p.coords.longitude; autoThemeBySun(); },()=>{}, {maximumAge:6e5,timeout:2500}); }
fetch("https://ipapi.co/json/").then(r=>r.json()).then(j=>{ geo.city=j.city||""; if(!geo.lat){ geo.lat=j.latitude; geo.lon=j.longitude; autoThemeBySun(); } }).catch(()=>{});
const suggPopup=document.getElementById("suggPopup"), suggList=document.getElementById("suggList");
let suggItems=[], suggSel=-1, hideUntilNextType=false;
function caretRect(){ const sel=window.getSelection(); if(!sel||sel.rangeCount===0) return null; const r=sel.getRangeAt(0).cloneRange(); r.collapse(true); const rects=r.getClientRects(); if(!rects.length) return null; return rects[0]; }
function getPlain(){ return getHTML().replace(/<[^>]+>/g," "); }
function currentToken(){ const t=getPlain(); const parts=t.split(/\s/).filter(Boolean); return parts[parts.length-1]||""; }
function detectTopic(text){ const s=(text||"").toLowerCase(); if(/ì—¬í–‰|í•­ê³µ|í˜¸í…”|ë§›ì§‘|trip|travel/.test(s)) return "travel"; if(/ë²•|ê·œì œ|privacy|ê°œì¸ì •ë³´|ê³„ì•½/.test(s)) return "legal"; if(/ë…¼ë¬¸|ì—°êµ¬|dataset|ì°¸ê³ ë¬¸í—Œ|ê°€ì„¤/.test(s)) return "research"; if(/ê°œë°œ|api|í…ŒìŠ¤íŠ¸|ë°°í¬|ì„±ëŠ¥|ë¦¬íŒ©í„°/.test(s)) return "dev"; return "general"; }
function topPersonal(prefix="",limit=5){ if(!conf.personal) return []; const freq=JSON.parse(localStorage.getItem("th.freq")||"{}"); return Object.entries(freq).filter(([w])=>!prefix||w.startsWith(prefix.toLowerCase())).sort((a,b)=>b[1]-a[1]).slice(0,limit).map(([w])=>w); }
function learn(text){ if(!conf.personal) return; const freq=JSON.parse(localStorage.getItem("th.freq")||"{}"); text.toLowerCase().split(/\s+/).filter(Boolean).forEach(t=>{ freq[t]=(freq[t]||0)+1; }); localStorage.setItem("th.freq",JSON.stringify(freq)); }
function propose(token){
  if(!conf.sugg) return [];
  const topic=conf.ctx?detectTopic(getPlain()):"general";
  const dict=(conf.mode==="3")?BANK.legal:(conf.mode==="4")?BANK.dev:(conf.mode==="2")?BANK.research:BANK[topic];
  const items=[];
  (dict.items||[]).forEach(it=>{ if(token && !it.label.toLowerCase().includes(token.toLowerCase())) return; items.push({kind:"í•µì‹¬", text:it.label, type:"insert", payload:it.insert}); });
  const lk=parseKoreanLaw(getPlain().slice(-80))||parseKoreanLaw(token); if(lk) items.unshift({kind:"ë²•ë ¹", text:`${lk.code} ì œ${lk.article}ì¡° ì¡°ë¬¸ ë³´ê¸°`, type:"law", payload:lk});
  if(conf.personal){ topPersonal(token,4).forEach(w=> items.push({kind:"ë§ì¶¤", text:w, type:"insert", payload:`${w}\n`})); }
  if(topic==="travel"&&(geo.city||geo.lat)){ items.push({kind:"ì§€ì—­", text:`${geo.city||"ë‚´ ì£¼ë³€"} ë§›ì§‘ ì§€ë„`, type:"open", payload:`https://www.google.com/maps/search/${encodeURIComponent((geo.city||"nearby")+" restaurants")}`}); }
  return items.slice(0,10);
}
function insertText(text){
  if(useFallback){ const ta=document.getElementById("fallbackArea"); const s=ta.selectionStart??ta.value.length; const e=ta.selectionEnd??s; ta.setRangeText(text,s,e,"end"); ta.dispatchEvent(new Event("input")); }
  else editor.model.change(w=> editor.model.insertContent(w.createText(text)));
}
function openSuggest(force){
  if(!conf.sugg) return closeSuggest();
  if(hideUntilNextType){ hideUntilNextType=false; return; }
  const token=currentToken(); if(!token && !force) return closeSuggest();
  const items=propose(token); if(!items.length) return closeSuggest();
  suggItems=items; suggSel=-1;
  suggList.innerHTML=items.map((it,i)=>`<li data-i="${i}"><span class="kind">${it.kind}</span><span>${escapeHtml(it.text)}</span></li>`).join("");
  Array.from(suggList.children).forEach(li=> li.onclick=()=> choose(+li.dataset.i));
  const r=caretRect(); if(!r){ closeSuggest(); return; }
  const host=document.getElementById("editorWrap").getBoundingClientRect();
  suggPopup.style.left=(r.left-host.left)+"px"; suggPopup.style.top=(r.bottom-host.top+6)+"px"; suggPopup.style.display="block";
}
function closeSuggest(){ suggPopup.style.display="none"; suggItems=[]; suggSel=-1; }
document.addEventListener("keydown",(e)=>{
  if(suggPopup.style.display!=="block") return;
  const list=Array.from(document.querySelectorAll("#suggList li")); if(!list.length) return;
  if(e.key==="ArrowDown"){ e.preventDefault(); suggSel=(suggSel+1)%list.length; markSel(); }
  else if(e.key==="ArrowUp"){ e.preventDefault(); suggSel=(suggSel-1+list.length)%list.length; markSel(); }
  else if(e.key==="Enter"||e.key==="Tab"){ e.preventDefault(); if(suggSel<0) suggSel=0; choose(suggSel); }
  else if(e.key==="Escape"){ e.preventDefault(); closeSuggest(); }
});
function markSel(){ Array.from(document.querySelectorAll("#suggList li")).forEach((li,i)=> li.setAttribute("data-active", i===suggSel? "1":"0")); }

async function choose(i){
  const it=suggItems[i]; if(!it) return;
  if(it.type==="insert"){ insertText(it.payload); }
  else if(it.type==="open"){ window.open(it.payload,"_blank","noopener"); }
  else if(it.type==="law"&&it.payload){
    const lk=it.payload; setRight(true); rightTitle.textContent=`${lk.code} ì œ${lk.article}ì¡°`; rightNote.textContent=conf.lang==="ko"?"ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦":"Loadingâ€¦";
    try{ const text=await fetchLawArticleText(lk.url, lk.article); if(text) renderLawToPreview(`${lk.code} ì œ${lk.article}ì¡°`, text, lk.url); else loadPreview(lk.url, `${lk.code} ì œ${lk.article}ì¡°`); }
    catch{ loadPreview(lk.url, `${lk.code} ì œ${lk.article}ì¡°`); }
  }
  closeSuggest(); hideUntilNextType=true;
}

/* ===================== onType ===================== */
function onType(){
  const plain=getPlain(); learn(plain.slice(-64)); openSuggest(false);
  if(conf.mode==="3"){
    const lk=parseKoreanLaw(plain.slice(-32));
    if(lk){ setRight(true); rightTitle.textContent=`${lk.code} ì œ${lk.article}ì¡°`;
      fetchLawArticleText(lk.url, lk.article).then(txt=>{ if(txt) renderLawToPreview(`${lk.code} ì œ${lk.article}ì¡°`, txt, lk.url); else loadPreview(lk.url, `${lk.code} ì œ${lk.article}ì¡°`); }).catch(()=> loadPreview(lk.url, `${lk.code} ì œ${lk.article}ì¡°`)); }
  }
}

/* ===================== Chat (LM Studio/OpenAI) + EC2 ì„¸ì…˜ ===================== */
const chatDock=document.getElementById("chatDock"), chatBody=document.getElementById("chatBody");
document.getElementById("chatBtn").onclick=()=> chatDock.style.display="flex";
document.getElementById("chatClose").onclick=()=> chatDock.style.display="none";
document.getElementById("apiBase").value=conf.apiBase; document.getElementById("apiKey").value=conf.apiKey; document.getElementById("apiModel").value=conf.model;
document.getElementById("saveModel").onclick=()=>{ conf.apiBase=document.getElementById("apiBase").value.trim(); conf.apiKey=document.getElementById("apiKey").value.trim(); conf.model=document.getElementById("apiModel").value.trim()||"local-model"; localStorage.setItem("th.apiBase",conf.apiBase); localStorage.setItem("th.apiKey",conf.apiKey); localStorage.setItem("th.apiModel",conf.model); alert(conf.lang==="ko"?"ì €ì¥ë¨":"Saved"); };
document.getElementById("saveAutomation").onclick=()=>{
  conf.notionToken=document.getElementById("notionToken").value.trim(); conf.notionDB=document.getElementById("notionDB").value.trim(); conf.autoExportNotion=document.getElementById("autoExportNotion").checked;
  conf.hancomUrl=document.getElementById("hancomUrl").value.trim(); conf.hancomToken=document.getElementById("hancomToken").value.trim(); conf.autoExportHancom=document.getElementById("autoExportHancom").checked;
  localStorage.setItem("th.notionToken",conf.notionToken); localStorage.setItem("th.notionDB",conf.notionDB); localStorage.setItem("th.autoExportNotion",conf.autoExportNotion?"1":"0");
  localStorage.setItem("th.hancomUrl",conf.hancomUrl); localStorage.setItem("th.hancomToken",conf.hancomToken); localStorage.setItem("th.autoExportHancom",conf.autoExportHancom?"1":"0");
  alert("ìë™í™” ì„¤ì • ì €ì¥ë¨");
};
// ì´ˆê¸° ìë™í™” ì…ë ¥ê°’ ì„¸íŒ…
document.getElementById("notionToken").value=conf.notionToken;
document.getElementById("notionDB").value=conf.notionDB;
document.getElementById("autoExportNotion").checked=conf.autoExportNotion;
document.getElementById("hancomUrl").value=conf.hancomUrl;
document.getElementById("hancomToken").value=conf.hancomToken;
document.getElementById("autoExportHancom").checked=conf.autoExportHancom;

let chatCount=+localStorage.getItem("th.chatCount")||0;
function updateQuota(){ const left=Math.max(0,10-chatCount); document.getElementById("quota").textContent = conf.lang==="ko" ? (left?`ë¬´ë£Œ ${left}íšŒ ë‚¨ìŒ`:"ì œí•œ ë„ë‹¬ â€” Google ë¡œê·¸ì¸ í•„ìš”") : (left?`${left} free left`:"Limit reached â€” Google login required"); }
updateQuota();
function addBubble(who,text){ const d=document.createElement("div"); d.className=`bubble ${who}`; d.textContent=text; chatBody.appendChild(d); chatBody.scrollTop=chatBody.scrollHeight; }

const threadSel=document.getElementById("threadSel");
const btnIn=document.getElementById("btnSignIn");
const btnOut=document.getElementById("btnSignOut");
let USER=null, CUR_THREAD=null;

async function api(path,opt={}){
  const res=await fetch(API_BASE+path,{credentials:"include",headers:{"Content-Type":"application/json",...(opt.headers||{})},method:opt.method||"GET",body:opt.body?JSON.stringify(opt.body):undefined});
  if(res.status===401){ USER=null; setAuthUI(); throw new Error("unauthorized"); }
  if(!res.ok) throw new Error(await res.text());
  return res.status===204?null:res.json();
}
function setAuthUI(){ if(USER){ btnIn.style.display="none"; btnOut.style.display="inline-flex"; } else { btnIn.style.display="inline-flex"; btnOut.style.display="none"; } chatCount=0; updateQuota(); }

btnIn.onclick=()=>{
  google.accounts.id.initialize({client_id:GOOGLE_CLIENT_ID, callback: async (resp)=>{
    try{ await api("/auth/google",{method:"POST", body:{idToken:resp.credential}}); USER=await api("/me"); setAuthUI(); await loadThreadList(); if(!CUR_THREAD && threadSel.options.length) CUR_THREAD=threadSel.value; if(CUR_THREAD) await loadThread(CUR_THREAD);}catch(e){ alert("ë¡œê·¸ì¸ ì‹¤íŒ¨: "+e.message); }
  }});
  google.accounts.id.prompt();
};
btnOut.onclick=async()=>{ await api("/auth/logout",{method:"POST"}); USER=null; CUR_THREAD=null; threadSel.innerHTML=""; setAuthUI(); };

async function loadThreadList(){
  const list=await api("/threads"); threadSel.innerHTML="";
  list.forEach(t=>{ const o=document.createElement("option"); o.value=t.id; o.textContent=t.title||t.id; threadSel.appendChild(o); });
  if(list.length){ CUR_THREAD=list[0].id; threadSel.value=CUR_THREAD; }
}
threadSel.onchange=async(e)=>{ CUR_THREAD=e.target.value; await loadThread(CUR_THREAD); };
async function loadThread(id){
  if(!id) return; const msgs=await api(`/threads/${id}/messages`);
  const chatBody=document.getElementById("chatBody"); chatBody.innerHTML="";
  msgs.forEach(m=> addBubble(m.role==="user"?"me":"ai", m.content));
}
async function ensureThread(){ if(CUR_THREAD) return CUR_THREAD; const t=await api("/threads",{method:"POST", body:{title:"ìƒˆ ëŒ€í™”"}}); CUR_THREAD=t.id; await loadThreadList(); threadSel.value=CUR_THREAD; return CUR_THREAD; }
async function saveMessage(role, content){ if(!USER) return; const id=await ensureThread(); await api(`/threads/${id}/messages`,{method:"POST", body:{role, content}}); await loadThreadList(); }

document.getElementById("chatForm").addEventListener("submit", async (e)=>{
  e.preventDefault();
  const msg=document.getElementById("chatInput").value.trim(); if(!msg) return;
  document.getElementById("chatInput").value=""; addBubble("me",msg);

  if(conf.mode==="3"){ const lk=parseKoreanLaw(msg); if(lk){ showInfoCard("ë²•ë ¹", `${lk.code} ì œ${lk.article}ì¡°`, `ğŸ”— <a href="${lk.url}" target="_blank" rel="noopener">law.go.kr ì—´ê¸°</a>`); setRight(true); rightTitle.textContent=`${lk.code} ì œ${lk.article}ì¡°`; fetchLawArticleText(lk.url, lk.article).then(txt=>{ if(txt) renderLawToPreview(`${lk.code} ì œ${lk.article}ì¡°`, txt, lk.url); else loadPreview(lk.url, `${lk.code} ì œ${lk.article}ì¡°`); }).catch(()=> loadPreview(lk.url, `${lk.code} ì œ${lk.article}ì¡°`)); } }
  if(conf.mode==="2"){ showInfoCard("ë¦¬ì„œì¹˜","ê·¼ê±° ìˆ˜ì§‘",researchGuide(msg)); setRight(true); rightTitle.textContent="Google Scholar"; loadPreview(`https://scholar.google.com/scholar?q=${encodeURIComponent(msg)}`,"Google Scholar"); }
  if(conf.mode==="4"){ const dev=detectDevLang(msg); if(dev){ showInfoCard("ê°œë°œ", `${dev.lang} snippet`, `<pre style="white-space:pre-wrap">${escapeHtml(dev.snippet)}</pre>ğŸ”— <a href="${dev.doc}" target="_blank" rel="noopener">Docs</a>`); setRight(true); rightTitle.textContent=`${dev.lang} Docs`; loadPreview(dev.doc, `${dev.lang} Docs`); } }

  if(USER){ try{ await saveMessage("user", msg); }catch{} }

  const ghost=document.createElement("div"); ghost.className="bubble ai"; ghost.textContent=(conf.lang==="ko"?"ìƒê° ì¤‘â€¦":"Thinkingâ€¦"); chatBody.appendChild(ghost);
  if(chatCount>=10){ ghost.textContent=conf.lang==="ko"?"ë¬´ë£Œ í•œë„ ì´ˆê³¼ â€” Google ë¡œê·¸ì¸ í•„ìš”":"Free limit exceeded â€” please sign in with Google."; return; }
  try{
    if(conf.apiBase){
      const res=await fetch(conf.apiBase+"/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",...(conf.apiKey?{"Authorization":"Bearer "+conf.apiKey}:{})},body:JSON.stringify({model:conf.model,messages:[{role:"system",content:"You are a helpful assistant."},{role:"user",content:msg}],temperature:0.3})});
      const js=await res.json(); const text=js.choices?.[0]?.message?.content || JSON.stringify(js); ghost.textContent=text;
      if(USER){ try{ await saveMessage("assistant", text); }catch{} }
    }else{ ghost.textContent="(Offline demo) summarize in 3 bullets."; if(USER){ try{ await saveMessage("assistant", ghost.textContent); }catch{} } }
    chatCount++; localStorage.setItem("th.chatCount",chatCount); updateQuota();
  }catch(err){ ghost.textContent="Network error: "+err; }
});

/* ===================== Exporters ===================== */
async function getThreadMarkdown(threadId){
  const msgs=await api(`/threads/${threadId}/messages`);
  return msgs.map(m=> (m.role==="user"?"**You:** ":"**AI:** ")+(m.content||"")).join("\n\n");
}
async function exportNotionPage(title, html){
  const token=conf.notionToken, db=conf.notionDB;
  if(!token||!db) throw new Error("Notion ì„¤ì • í•„ìš”");
  const plain=html.replace(/<[^>]+>/g," ").replace(/\s+/g," ").trim().slice(0,1800);
  const payload={ parent:{database_id:db}, properties:{ Name:{ title:[{ text:{content:title} }] } }, children:[{object:"block",type:"paragraph",paragraph:{rich_text:[{type:"text",text:{content:plain}}]}}]};
  const res=await fetch("https://api.notion.com/v1/pages",{method:"POST",headers:{"Authorization":"Bearer "+token,"Notion-Version":"2022-06-28","Content-Type":"application/json"},body:JSON.stringify(payload)});
  if(!res.ok) throw new Error(await res.text());
}
document.getElementById("iExportNotion").onclick=async()=>{
  const d=store.get(curId); if(!d) return alert("ë¨¼ì € ë¬¸ì„œë¥¼ ì €ì¥í•˜ì„¸ìš”.");
  try{ await exportNotionPage(d.title, decodeURIComponent(escape(atob(d.payload||""))) ); alert("ë…¸ì…˜ìœ¼ë¡œ ë³´ëƒˆìŠµë‹ˆë‹¤ âœ…"); }catch(e){ alert("ë…¸ì…˜ ì˜¤ë¥˜: "+e.message); }
};
document.getElementById("iExportWebhook").onclick=async()=>{
  if(!USER||!CUR_THREAD) return alert("ë¡œê·¸ì¸ ë° ëŒ€í™”ë¥¼ ì„ íƒí•˜ì„¸ìš”.");
  const url=prompt("Webhook URL ì…ë ¥"); if(!url) return; const md=await getThreadMarkdown(CUR_THREAD);
  const res=await fetch(url,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:threadSel.selectedOptions[0]?.textContent, markdown:md})});
  if(!res.ok) return alert("ì›¹í›… ì˜¤ë¥˜: "+await res.text()); alert("ì›¹í›…ìœ¼ë¡œ ë³´ëƒˆìŠµë‹ˆë‹¤ âœ…");
};
async function exportHancomDocx(title, html){
  const url=conf.hancomUrl, token=conf.hancomToken;
  if(!url||!token) throw new Error("Hancom ì„¤ì • í•„ìš”");
  const blob=window.htmlDocx.asBlob(html, {orientation:"portrait", margins:{top:720,right:720,bottom:720,left:720}});
  const form=new FormData();
  const filename=(title||"ThinkHelper") + ".docx";
  form.append("file", blob, filename);
  form.append("path", "/ThinkHelper");
  const res=await fetch(url,{method:"POST",headers:{Authorization:token},body:form});
  if(!res.ok) throw new Error(await res.text());
}
document.getElementById("iExportHancom").onclick=async()=>{
  const d=store.get(curId); if(!d) return alert("ë¨¼ì € ë¬¸ì„œë¥¼ ì €ì¥í•˜ì„¸ìš”.");
  try{
    await exportHancomDocx(d.title, decodeURIComponent(escape(atob(d.payload||""))));
    alert("í•œì»´ Spaceë¡œ ì—…ë¡œë“œ ì™„ë£Œ âœ…");
  }catch(e){ alert("í•œì»´ ì—…ë¡œë“œ ì˜¤ë¥˜: "+e.message); }
};

/* ===================== Menus ===================== */
(function bindMenus(){
  document.querySelectorAll(".menu").forEach(m=>{ const btn=m.querySelector(".btn"); const drop=m.querySelector(".dropdown"); if(!btn||!drop) return; btn.addEventListener("click",(e)=>{ e.stopPropagation(); document.querySelectorAll(".dropdown").forEach(d=>d.style.display="none"); drop.style.display=drop.style.display==="block"?"none":"block"; }); });
  document.addEventListener("click",()=> document.querySelectorAll(".dropdown").forEach(d=>d.style.display="none"));
})();
document.getElementById("iNew").onclick=()=> newDoc();
document.getElementById("iSave").onclick=()=> doSave();
document.getElementById("iPrint").onclick=()=> window.print();
document.getElementById("iPDF").onclick=()=>{ const el=document.createElement("div"); el.innerHTML=getHTML(); html2pdf().from(el).save(`ThinkHelper_${Date.now()}.pdf`); };
document.getElementById("iDOCX").onclick=()=>{ const blob=window.htmlDocx.asBlob(getHTML()); const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download=`ThinkHelper_${Date.now()}.docx`; a.click(); URL.revokeObjectURL(a.href); };

/* ===================== Pencil (iPad only) ===================== */
const pad=document.getElementById("pad"), padGrid=document.getElementById("padGrid"), holder=document.getElementById("padHolder");
let ctx=null, dpr=window.devicePixelRatio||1, drawing=false, last={x:0,y:0};
function resizePad(){ const rect=holder.getBoundingClientRect(); const w=Math.max(320, rect.width), h=Math.max(260, rect.height||420); pad.width=Math.floor(w*dpr); pad.height=Math.floor(h*dpr); pad.style.width=w+"px"; pad.style.height=h+"px"; padGrid.width=pad.width; padGrid.height=pad.height; padGrid.style.width=pad.style.width; padGrid.style.height=pad.style.height; ctx=pad.getContext("2d"); ctx.setTransform(dpr,0,0,dpr,0,0); ctx.lineCap="round"; ctx.lineJoin="round"; ctx.strokeStyle="#fff"; ctx.lineWidth=3; const g=padGrid.getContext("2d"); g.setTransform(dpr,0,0,dpr,0,0); g.clearRect(0,0,padGrid.width,padGrid.height); g.globalAlpha=.12; g.strokeStyle="#9fb6ff"; for(let x=0;x<w;x+=24){g.beginPath();g.moveTo(x,0);g.lineTo(x,h);g.stroke()} for(let y=0;y<h;y+=24){g.beginPath();g.moveTo(0,y);g.lineTo(w,y);g.stroke()} }
function openPad(){ document.getElementById("pencilDock").style.display="flex"; resizePad(); }
function closePad(){ document.getElementById("pencilDock").style.display="none"; }
document.getElementById("pencilDockToggle").onclick=openPad; document.getElementById("padClose").onclick=closePad;
document.getElementById("padClear").onclick=()=>{ ctx.clearRect(0,0,pad.width,pad.height); resizePad(); };
pad.addEventListener("pointerdown",(e)=>{ drawing=true; pad.setPointerCapture(e.pointerId); const r=pad.getBoundingClientRect(); last={x:e.clientX-r.left,y:e.clientY-r.top}; });
pad.addEventListener("pointermove",(e)=>{ if(!drawing) return; const r=pad.getBoundingClientRect(); const x=e.clientX-r.left, y=e.clientY-r.top; ctx.beginPath(); ctx.moveTo(last.x,last.y); ctx.lineTo(x,y); ctx.stroke(); last={x,y}; });
["pointerup","pointercancel","pointerout"].forEach(ev=> pad.addEventListener(ev,()=> drawing=false));
document.getElementById("padInsert").onclick=()=>{ const dataURL=pad.toDataURL("image/png"); insertText(`\n<p><img src="${dataURL}" style="max-width:100%"/></p>\n`); closePad(); };

/* ===================== Auto theme ===================== */
function dayOfYear(d){const n=new Date(d.getFullYear(),0,0); return Math.floor((d-n)/(24*60*60*1000));}
function toRad(d){return d*Math.PI/180} function toDeg(r){return r*180/Math.PI}
function solarDeclination(g){return 0.006918-0.399912*Math.cos(g)+0.070257*Math.sin(g)-0.006758*Math.cos(2*g)+0.000907*Math.sin(2*g)-0.002697*Math.cos(3*g)+0.00148*Math.sin(3*g);}
function equationOfTime(g){return 229.18*(0.000075+0.001868*Math.cos(g)-0.032077*Math.sin(g)-0.014615*Math.cos(2*g)-0.040849*Math.sin(2*g));}
function hourAngle(lat,decl){return Math.acos(Math.cos(toRad(90.833))/(Math.cos(toRad(lat))*Math.cos(decl)) - Math.tan(toRad(lat))*Math.tan(decl));}
function solarTimeOffset(lon,eot){return eot + 4*lon;}
function minutesToDate(base, m){const d=new Date(base); d.setMinutes(0,0,0); return new Date(d.getFullYear(),d.getMonth(),d.getDate(),0,m);}
function sunriseSunset(date, lat, lon){ if(lat==null||lon==null) return {sunrise:null, sunset:null}; const N=dayOfYear(date); const g=2*Math.PI/365*(N-1+((date.getHours()-12)/24)); const decl=solarDeclination(g); const eot=equationOfTime(g); const ha=hourAngle(lat,decl); const offset=solarTimeOffset(lon,eot); const noon=720-offset; const haMin=toDeg(ha)*4; return {sunrise:minutesToDate(date,Math.round(noon-haMin)), sunset:minutesToDate(date,Math.round(noon+haMin))}; }
function setTheme(mode){ document.documentElement.setAttribute("data-theme", mode); }
function isDarkTime(now, lat, lon){ const s=sunriseSunset(now, lat, lon); if(!s.sunrise||!s.sunset){ const h=now.getHours(); return (h>=18||h<6); } return (now<s.sunrise||now>s.sunset); }
let autoThemeTimer=null;
function autoThemeBySun(){ clearTimeout(autoThemeTimer); const now=new Date(); const dark=isDarkTime(now, geo.lat, geo.lon); setTheme(dark?"dark":"light"); autoThemeTimer=setTimeout(autoThemeBySun, 5*60*1000); }
function toggleThemeManual(){ const cur=document.documentElement.getAttribute("data-theme")||"dark"; setTheme(cur==="dark"?"light":"dark"); }

/* ===================== Boot ===================== */
(async function boot(){
  await initEditor();
  document.getElementById("sortSel").onchange=renderList; renderList();
  const cur=store.current(); if(cur && store.get(cur)) openDoc(cur); else newDoc();
  autoThemeBySun();
})();
</script>
</body>
</html>
