<!DOCTYPE html>
<html lang="ko" data-theme="light">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title data-i18n="page.title">ThinkHelper â€” Editor</title>
<link rel="icon" href="data:,"/>

<!-- Google Tag Manager (optional) -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-NXBQK43Z');</script>

<!-- libs -->
<script src="https://cdn.ckeditor.com/ckeditor5/41.3.1/classic/ckeditor.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" defer></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js" defer></script>

<style>
:root{--bg:#f6f8fb;--fg:#0b1020;--muted:#6a7691;--panel:#fff;--card:#f2f5ff;--border:#d6deee;--hover:#e9effe;--accent:#2563eb}
:root[data-theme="dark"]{--bg:#0b1020;--fg:#f1f5ff;--muted:#a8b4cf;--panel:#0f172a;--card:#101a30;--border:#273453;--hover:#16213b;--accent:#60a5fa}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--fg);font-family:-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif;display:flex;flex-direction:column;padding-bottom:90px}

/* topbar */
.topbar{display:flex;gap:8px;align-items:center;padding:10px 12px;background:var(--panel);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:1000}
.brand{display:flex;align-items:center;gap:8px;font-weight:900}
.logo{width:18px;height:18px;border-radius:4px;background:linear-gradient(135deg,#60a5fa,#34d399)}
.btn{border:1px solid var(--border);background:var(--card);color:var(--fg);border-radius:8px;padding:.45rem .7rem;font-weight:900;cursor:pointer;transition:.2s}
.btn:hover{background:var(--hover)} .btn[disabled]{opacity:.6;cursor:not-allowed}
.iconbtn{border:1px solid var(--border);background:transparent;color:var(--fg);border-radius:6px;padding:.25rem .45rem;cursor:pointer;transition:.2s}
.iconbtn:hover{background:var(--hover)}
.selectlike{height:34px;border:1px solid var(--border);border-radius:8px;background:var(--card);color:var(--fg);padding:.25rem .5rem}
.menu{position:relative;z-index:1001}
.menu>.btn{font-weight:900}
.dropdown{display:none;position:absolute;top:42px;left:0;background:var(--panel);border:1px solid var(--border);border-radius:10px;min-width:320px;box-shadow:0 12px 24px rgba(0,0,0,.12);z-index:1002}
.dropdown .item{padding:.55rem .7rem;border-bottom:1px dashed var(--border);cursor:pointer;display:flex;justify-content:space-between;gap:10px;align-items:center}
.dropdown .item:last-child{border-bottom:none}
.dropdown .item:hover{background:var(--hover)}
.dropdown a.item{text-decoration:none;color:inherit}
.dropdown .item label{display:flex;align-items:center;gap:6px;cursor:pointer;font-size:.9em}
.dropdown .item input[type="checkbox"]{margin:0;transform:scale(.9)}

/* layout */
main{flex:1;min-height:0;display:grid;grid-template-columns:260px 1fr;gap:10px;padding:10px;position:relative;z-index:2}
main[data-mode="research"]{grid-template-columns:260px 1fr 340px}
@media (max-width:1200px){
  main{grid-template-columns:0 1fr;padding:6px}
  main[data-mode="research"]{grid-template-columns:0 1fr 340px}
  #left{display:none!important}
}
@media (max-width:900px){
  main{grid-template-columns:0 1fr}
  main[data-mode="research"]{grid-template-columns:0 1fr}
  #left{display:none!important}
  aside#right{display:none!important}
}

/* left */
aside#left{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:10px;display:flex;flex-direction:column;min-height:0;position:sticky;top:70px;height:calc(100vh - 90px)}
.listHead{display:flex;align-items:center;gap:8px;margin-bottom:10px}
#docList{flex:1;overflow:auto;display:flex;flex-direction:column;gap:8px}
.doc{display:grid;grid-template-columns:1fr auto auto;gap:6px;align-items:center;padding:8px;border:1px solid var(--border);border-radius:10px;background:var(--card);transition:.2s}
.doc.active{background:var(--hover);border-color:var(--accent)}
.doc:hover{background:var(--hover)}
.doc .title{font-weight:900;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;cursor:pointer;padding:2px 4px}
.doc .title[contenteditable="true"]{outline:1.5px solid var(--accent);background:#fff;border-radius:4px;padding:2px 4px;cursor:text}
.doc .time{font-size:.78rem;color:var(--muted)}
.doc .act{display:none}.doc:hover .act{display:inline-flex}

/* center */
section#center{display:flex;flex-direction:column;gap:10px;min-width:0;padding-bottom:50px}
#editorWrap{flex:1;border:1px solid var(--border);border-radius:12px;background:var(--panel);padding:8px;position:relative}
#editor{min-height:62vh}
.ck-balloon-panel,.ck-powered-by-balloon{display:none!important}
.ck-editor__editable_inline{min-height:58vh!important;color:#222;background:#fff;padding:12px 12px 140px;border-radius:8px;position:relative;z-index:1}
[data-theme="dark"] .ck-editor__editable_inline{color:#ffe7b3;background:#0b1327}
#ghostSuggest{position:absolute;right:14px;top:10px;font-size:.9rem;color:#9aa3b2;opacity:.7;pointer-events:none;max-width:45%;text-align:right}
#commandBar{display:flex;gap:10px;align-items:center;padding:10px;background:var(--panel);border:1px solid var(--border);border-radius:12px}
#cmdInput{flex:1;height:40px;border:1px solid var(--border);border-radius:10px;background:var(--card);color:var(--fg);padding:.5rem .9rem;font-size:15px}
#cmdSuggestions{display:flex;gap:8px}
#cmdSuggestions .chip{background:var(--card);border:1px solid var(--border);border-radius:999px;padding:.3rem .7rem;cursor:pointer;font-weight:900;font-size:.9rem;white-space:nowrap;transition:.2s}
#cmdSuggestions .chip:hover{background:var(--hover)}
@media (max-width:768px){#cmdSuggestions{display:none}}

/* suggest popup */
#aiChip{position:absolute;display:none;gap:6px;align-items:center;background:var(--panel);border:1px solid var(--border);border-radius:999px;padding:.28rem .55rem;box-shadow:0 8px 20px rgba(0,0,0,.15);z-index:80;font-weight:900}
#aiChip small{opacity:.75}
#suggPopup{position:absolute;display:none;z-index:80;background:var(--panel);color:var(--fg);border:1px solid var(--border);border-radius:10px;box-shadow:0 12px 24px rgba(0,0,0,.18);min-width:300px;max-width:620px}
#suggPopup header{padding:6px 10px;border-bottom:1px solid var(--border);font-size:.82rem;color:var(--muted);display:flex;justify-content:space-between;align-items:center}
#suggPopup ul{list-style:none;margin:0;padding:6px;max-height:280px;overflow:auto}
#suggPopup li{padding:8px 10px;border-radius:8px;display:grid;grid-template-columns:90px 1fr auto;gap:10px;cursor:pointer;align-items:center}
#suggPopup li .kind{opacity:.75;font-size:.75rem}
#suggPopup li .txt{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
#suggPopup li .tag{border:1px solid var(--border);border-radius:6px;font-size:.72rem;padding:.05rem .35rem;opacity:.85}
#suggPopup li[data-active="1"]{background:var(--hover);outline:1.5px solid #8ab4ff66}

/* right */
aside#right{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:10px;display:none;flex-direction:column;min-height:0;position:sticky;top:70px;height:calc(100vh - 90px)}
main[data-mode="research"] aside#right{display:flex}
.sidebar-nav{display:flex;gap:0;background:var(--card);border-radius:8px;padding:4px;border:1px solid var(--border);margin-bottom:10px}
.sidebar-nav .tab{flex:1;padding:8px 14px;font-weight:700;font-size:.9rem;cursor:pointer;border-radius:6px;text-align:center;color:var(--muted);transition:.2s}
.sidebar-nav .tab:hover{background:var(--hover);color:var(--fg)}
.sidebar-nav .tab[data-active="1"]{background:var(--panel);color:var(--accent);box-shadow:0 1px 3px rgba(0,0,0,.05)}
.sidebar-content{flex:1;overflow:auto;display:none}
.sidebar-content[data-active="1"]{display:block}
#rightSearchResults{display:flex;flex-direction:column;gap:12px}
.search-summary{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:12px;white-space:pre-wrap;font-size:.95rem;line-height:1.6}
.search-sources h4{margin:12px 0 6px;font-size:.9rem;color:var(--muted)}
.search-sources ul{list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:6px}
.search-sources li a{display:block;padding:8px;border-radius:8px;background:var(--card);border:1px solid var(--border);text-decoration:none;color:var(--fg);font-size:.85rem;transition:.2s}
.search-sources li a:hover{background:var(--hover)}
.search-sources li a strong{display:block;margin-bottom:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.search-sources li a span{color:var(--muted);font-size:.75rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;display:block}
#rightFeed{display:flex;flex-direction:column;gap:12px}
a.feed-item{display:block;text-decoration:none;color:inherit;background:var(--card);border:1px solid var(--border);border-radius:10px;overflow:hidden;transition:.2s}
a.feed-item:hover{background:var(--hover)}
a.feed-item img{width:100%;height:140px;object-fit:cover;display:block;background-color:var(--border)}
a.feed-item .feed-content{padding:10px}
a.feed-item .feed-source{font-size:.8rem;color:var(--muted);margin-bottom:4px}
a.feed-item .feed-title{font-weight:900;color:var(--fg)}

/* chat dock */
#chatBtn{position:fixed;right:16px;bottom:80px;z-index:60}
#chatDock{position:fixed;right:16px;bottom:16px;width:min(95vw,1000px);height:88vh;display:none;flex-direction:column;background:var(--panel);border:1px solid var(--border);border-radius:14px;box-shadow:0 18px 36px rgba(0,0,0,.28);z-index:75}
#chatHead{display:flex;align-items:center;gap:8px;justify-content:space-between;padding:10px;border-bottom:1px solid var(--border);font-weight:900}
#chatHead .actions{position:relative;display:flex;align-items:center;gap:6px}
#chatPlusMenu{position:absolute;display:none;background:var(--panel);border:1px solid var(--border);border-radius:8px;padding:6px;right:40px;top:40px;z-index:90;width:150px}
#chatPlusMenu .item{padding:6px 8px;border-radius:6px;cursor:pointer;font-size:.9em}
#chatPlusMenu .item:hover{background:var(--hover)}
#chatWrap{flex:1;display:grid;grid-template-columns:220px 1fr;min-height:0}
#chatThreads{border-right:1px solid var(--border);padding:8px;overflow:auto}
.threadRow{display:flex;gap:6px;align-items:center;padding:8px;border:1px solid var(--border);border-radius:10px;background:var(--card);cursor:pointer;margin-bottom:8px;justify-content:space-between;transition:.2s}
.threadRow:hover{background:var(--hover)} .threadRow[data-active="1"]{outline:2px solid #9bbcff;background:var(--hover)}
#chatMain{display:flex;flex-direction:column;min-width:0}
#chatBody{flex:1;overflow:auto;padding:10px;display:flex;flex-direction:column;gap:10px}
.bubble{max-width:85%;padding:.8rem 1.2rem;border:1px solid var(--border);border-radius:14px;background:var(--card);word-break:break-word;font-size:1.05rem;line-height:1.6;white-space:pre-wrap}
.bubble.ai{cursor:pointer}
.me{margin-left:auto;background:#143763;color:#fff;border-color:#143763}
.ai{margin-right:auto;border-color:#3b4b72;background:#15284f;color:#fff}
[data-theme="dark"] .ai{background:#15203baa;border-color:#273453}
.sys{margin:0 auto;background:#eef2ff;border-style:dashed;color:#111;font-size:.9em;text-align:center}
#chatForm{display:flex;gap:8px;padding:10px;border-top:1px solid var(--border)}
#chatInput{flex:1;border:1px solid var(--border);border-radius:10px;background:var(--card);color:var(--fg);padding:.6rem .8rem;font-size:1.02rem;resize:vertical;min-height:80px}
#quota{position:absolute;left:12px;bottom:12px;background:var(--panel);border:1px solid var(--border);border-radius:8px;padding:.25rem .55rem;font-size:.85rem;color:#666}
#filePick{display:none}

/* footer */
footer{position:fixed;bottom:0;left:0;right:0;background:var(--panel);padding:8px 10px;border-top:1px solid var(--border);font-size:.92rem;text-align:center;user-select:none;z-index:10}
footer a{pointer-events:auto}

/* misc and modals */
#gaze{position:fixed;pointer-events:none;width:14px;height:14px;border-radius:50%;background:rgba(37,99,235,.75);box-shadow:0 0 0 3px rgba(37,99,235,.2);mix-blend-mode:multiply;z-index:100;transform:translate(-50%,-50%);display:none}
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;z-index:120;align-items:center;justify-content:center}
.modal{background:#fff;color:#111;border-radius:12px;max-width:760px;width:92vw;max-height:86vh;overflow:auto;padding:18px;border:1px solid var(--border);box-shadow:0 18px 36px rgba(0,0,0,.25)}
[data-theme="dark"] .modal{background:#0f172a;color:#f1f5ff}
.modal h3{margin:.2rem 0 .6rem}
.modal .actions{display:flex;justify-content:flex-end;gap:8px;margin-top:12px}
.modal .btn-plain{background:#f3f4f6;border:1px solid #e5e7eb;border-radius:8px;padding:.45rem .8rem;cursor:pointer}
[data-theme="dark"] .modal .btn-plain{background:#1e293b;border-color:#334155;color:#f1f5ff}
.spinner{border:4px solid rgba(0,0,0,.1);width:24px;height:24px;border-radius:50%;border-left-color:var(--accent);animation:spin 1s ease infinite;margin:20px auto}
@keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
#rightSearchResults ul{list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:8px}
#rightSearchResults li{background:var(--card);border:1px solid var(--border);border-radius:8px;padding:10px 12px;cursor:pointer;font-weight:500;transition:.2s}
#rightSearchResults li:hover{background:var(--hover)}
.modal article h4{margin:12px 0 6px}
.modal article p{line-height:1.6;margin:8px 0}
</style>
</head>
<body data-lang="ko">
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NXBQK43Z" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>

<div id="gaze"></div>

<div class="topbar">
  <button class="iconbtn" id="btnToggleLeft" title="ë¬¸ì„œ íŒ¨ë„ ì ‘ê¸°/í¼ì¹˜ê¸°">â˜°</button>
  <div class="brand"><div class="logo"></div><div id="t_brand" data-i18n="brand.name">ThinkHelper</div></div>

  <div class="menu" data-menu>
    <button class="btn" data-i18n="menu.tools">ë„êµ¬ â–¾</button>
    <div class="dropdown">
      <div class="item" id="iNew"><span data-i18n="tools.newDoc">ìƒˆ ë¬¸ì„œ</span><span>âŒ˜/Ctrl+N</span></div>
      <div class="item" id="iPrint"><span data-i18n="tools.print">ğŸ–¨ï¸ í”„ë¦°í„°ë¡œ ì¸ì‡„</span></div>
      <div class="item" id="iImport"><span data-i18n="tools.import">ğŸ“¥ ë¶ˆëŸ¬ì˜¤ê¸° (ë°ëª¨)</span></div>
      <div class="item" id="iSavePDF"><span data-i18n="tools.savePdf">ğŸ’¾ PDFë¡œ ì €ì¥</span></div>
      <div class="item" id="iSaveWord"><span data-i18n="tools.saveWord">ğŸ’¾ Wordë¡œ ì €ì¥</span></div>
      <div class="item" id="iSaveHWP"><span data-i18n="tools.saveHwp">ğŸ’¾ HWPë¡œ ì €ì¥ (ë°ëª¨)</span></div>
      <div class="item" id="iTranslate"><span data-i18n="tools.translate">ğŸŒ ë²ˆì—­í•˜ê¸° (ë°ëª¨)</span></div>
      <div class="item" id="iCollab"><span data-i18n="tools.collab">ğŸ‘¥ í˜‘ì—… ì´ˆëŒ€í•˜ê¸°</span></div>
      <div class="item" id="iMakePPT"><span data-i18n="tools.makePpt">âœ¨ PPT ìŠ¬ë¼ì´ë“œ ìƒì„±</span></div>
      <div class="item" id="iClipboard"><span data-i18n="tools.share">ê³µìœ í•˜ê¸° (QR/ë§í¬)</span><span>â†—</span></div>
    </div>
  </div>

  <div class="menu" data-menu>
    <button class="btn" data-i18n="menu.settings">ì„¤ì • â–¾</button>
    <div class="dropdown" id="dropSettings">
      <div class="item" style="flex-direction:column;align-items:flex-start;gap:8px">
        <label><input type="checkbox" id="optSugg"> <span data-i18n="settings.showSuggest">ì¶”ì²œì–´ í‘œì‹œ (VSCode ìŠ¤íƒ€ì¼)</span></label>
        <label><input type="checkbox" id="optPersonal"> <span data-i18n="settings.aiSuggest">ë§ì¶¤í˜• AI ì œì•ˆ (ë°ëª¨)</span></label>
        <label><input type="checkbox" id="optGaze"> <span data-i18n="settings.gazeCursor">ì‹œì„  ì»¤ì„œ</span></label>
      </div>
      <div class="item">
        <span data-i18n="settings.mode">ëª¨ë“œ</span>
        <select id="modeSel" class="selectlike" style="width:180px">
          <option value="normal" selected data-i18n="settings.mode.normal">Normal (ì¼ë°˜)</option>
          <option value="research" data-i18n="settings.mode.research">Research (ë¦¬ì„œì¹˜)</option>
        </select>
      </div>
      <div class="item">
        <span data-i18n="settings.language">ì–¸ì–´</span>
        <select id="langSel" class="selectlike" style="width:180px">
          <option value="ko" selected>í•œêµ­ì–´</option>
          <option value="en">English</option>
          <option value="ja">æ—¥æœ¬èª</option>
        </select>
      </div>
      <div class="item" id="toggleTheme">ğŸŒ“ <span data-i18n="settings.toggleTheme">í…Œë§ˆ ì „í™˜</span></div>
    </div>
  </div>

  <div class="menu" data-menu>
    <button class="btn" data-i18n="menu.help">ë„ì›€ë§ â–¾</button>
    <div class="dropdown">
      <div class="item" id="iGuide"><span data-i18n="help.guide">ì„œë¹„ìŠ¤ ì†Œê°œ ë° ê°€ì´ë“œ</span></div>
      <div class="item" id="iShortcuts"><span data-i18n="help.shortcuts">ë‹¨ì¶•í‚¤ ëª©ë¡</span></div>
      <div class="item" id="openPrivacy"><span data-i18n="help.privacy">ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨</span><span>â†—</span></div>
      <div class="item" id="openTerms"><span data-i18n="help.terms">ì„œë¹„ìŠ¤ ì´ìš©ì•½ê´€</span><span>â†—</span></div>
      <a class="item" href="mailto:ho849607@gmail.com"><span data-i18n="help.feedback">í”¼ë“œë°± ë³´ë‚´ê¸°</span><span>â†—</span></a>
    </div>
  </div>

  <button class="btn" id="chatBtn" style="margin-left:auto" title="ì±„íŒ… ì—´ê¸°" data-i18n-title="tooltip.openChat">ğŸ’¬</button>
</div>

<main id="mainLayout" data-mode="normal">
  <aside id="left" aria-label="ë¬¸ì„œëª©ë¡" data-collapsed="0">
    <div class="listHead"><b data-i18n="doclist.title">ë¬¸ì„œ</b><button class="btn" id="addDoc" title="ìƒˆ ë¬¸ì„œ ì¶”ê°€" data-i18n-title="tooltip.addDoc">ï¼‹</button></div>
    <div id="docList"></div>
  </aside>

  <section id="center">
    <div id="editorWrap">
      <div id="editor" aria-label="ì—ë””í„°"></div>
      <div id="ghostSuggest" aria-hidden="true"></div>
      <button id="aiChip">âœ¨ AI <small data-i18n="aiChip.contextHelp">ë¬¸ë§¥ ë„ì›€</small></button>
      <div id="suggPopup" aria-live="polite">
        <header><span data-i18n="suggest.header">ì œì•ˆ (â†‘/â†“, Enter ì„ íƒ)</span><div><button class="min" id="suggClose">âœ–</button></div></header>
        <ul id="suggList"></ul>
      </div>
    </div>
    <div id="commandBar">
      <div id="cmdSuggestions">
        <button class="chip" data-cmd="create_doc" data-i18n="cmd.createDoc">âœ¨ ë¬¸ì„œ ìƒì„±</button>
        <button class="chip" data-cmd="edit_doc" data-i18n="cmd.editDoc">âœï¸ ì‘ì„± ë„ì›€ ë°›ê¸°</button>
      </div>
      <input id="cmdInput" placeholder="AIì—ê²Œ ìš”ì²­í•˜ê¸°" data-i18n-ph="cmd.inputPhAiOnly"/>
      <button class="btn" id="cmdSend" data-i18n="cmd.send">ì „ì†¡</button>
    </div>
  </section>

  <aside id="right" aria-label="ë¦¬ì„œì¹˜ íŒ¨ë„">
    <nav class="sidebar-nav">
      <button class="tab" data-tab="topics" data-active="0">ğŸ”<span data-i18n="sidebar.tab.topics">íƒìƒ‰</span></button>
      <button class="tab" data-tab="feed" data-active="1">ğŸ“°<span data-i18n="sidebar.tab.feed">í”¼ë“œ</span></button>
    </nav>
    <div id="rightSearchResults" class="sidebar-content" data-active="0">
      <div class="search-summary" style="color:var(--muted);font-style:italic;" data-i18n="topics.placeholder">ì±„íŒ… ë‚´ìš© ê¸°ë°˜ ì¶”ì²œ í† í”½ (ì„œë²„ êµ¬í˜„ í•„ìš”)</div>
    </div>
    <div id="rightFeed" class="sidebar-content" data-active="1">
      <div class="spinner"></div>
    </div>
  </aside>
</main>

<footer>
  <div>Â© ThinkHelper â€” <span data-i18n="footer.warning">âš ï¸ ì¸ê³µì§€ëŠ¥ ê²°ê³¼ëŠ” ê²€í† ê°€ í•„ìš”í•©ë‹ˆë‹¤.</span></div>
  <div id="loc">ğŸ“ <span data-i18n="footer.locationLoading">ìœ„ì¹˜ í™•ì¸ ì¤‘â€¦</span></div>
</footer>

<!-- Chat Dock -->
<div id="chatDock" role="dialog" aria-hidden="true" style="display:none;">
  <div id="chatHead">
    <span><span data-i18n="chat.title">AI ì±„íŒ…</span> <small id="chatModelIndicator">(with Gemini)</small></span>
    <div class="actions">
      <input type="file" id="filePick" accept=".pdf,.txt,image/*"/>
      <button class="iconbtn" id="btnChatPlus" title="ë”ë³´ê¸°" data-i18n-title="tooltip.chatMore">â•</button>
      <div id="chatPlusMenu">
        <div class="item" data-action="github">â†—ï¸ GitHub (ë°ëª¨)</div>
        <div class="item" data-action="word">ğŸ“„ Word (ë°ëª¨)</div>
        <div class="item" data-action="email">âœ‰ï¸ ë©”ì¼ (ë°ëª¨)</div>
      </div>
      <button class="iconbtn" id="btnAttach" title="íŒŒì¼ ì²¨ë¶€ (ì´ë¯¸ì§€/í…ìŠ¤íŠ¸)" data-i18n-title="tooltip.attachFile">ğŸ“</button>
      <button class="iconbtn" id="chatClose" aria-label="ë‹«ê¸°" data-i18n-aria="aria.close">âœ–</button>
    </div>
  </div>
  <div id="chatWrap">
    <aside id="chatThreads" aria-label="ì±„íŒ… ìŠ¤ë ˆë“œ"></aside>
    <section id="chatMain">
      <div style="padding:6px 10px;border-bottom:1px dashed var(--border);display:flex;gap:8px;align-items:center">
        <input id="threadTitleInput" placeholder="ìŠ¤ë ˆë“œ ì œëª©" data-i18n-ph="chat.threadTitlePh" style="flex:1;border:1px solid var(--border);border-radius:8px;padding:.35rem .55rem;background:var(--card)"/>
        <button class="btn" id="renameThread" data-i18n="chat.saveTitle">ì œëª© ì €ì¥</button>
        <button class="btn" id="deleteThread" data-i18n="chat.deleteThread">ì‚­ì œ</button>
      </div>
      <div id="chatBody"></div>
      <form id="chatForm">
        <textarea id="chatInput" rows="3" placeholder="ë©”ì‹œì§€ ì…ë ¥ (Enter=ì „ì†¡, Shift+Enter=ì¤„ë°”ê¿ˆ)" data-i18n-ph="chat.inputPh"></textarea>
        <button class="btn" type="submit" data-i18n="chat.send">ì „ì†¡</button>
      </form>
    </section>
  </div>
  <div id="quota" data-i18n="chat.quotaGemini">Gemini AI ì—°ë™</div>
</div>

<!-- Share Modal -->
<div id="shareModal" class="modal-backdrop">
  <div class="modal">
    <h3 data-i18n="share.title">ê³µìœ í•˜ê¸°</h3>
    <p data-i18n="share.desc">ë§í¬/í…ìŠ¤íŠ¸ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤. QRë¡œë„ ì „ì†¡í•  ìˆ˜ ìˆì–´ìš”.</p>
    <div id="qr" style="margin:10px auto;width:200px;height:200px"></div>
    <div class="actions"><button class="btn-plain" id="shareClose" data-i18n="modal.close">ë‹«ê¸°</button></div>
  </div>
</div>

<!-- Guide Modal -->
<div id="guideModal" class="modal-backdrop">
  <div class="modal">
    <h3 data-i18n="guide.title">ThinkHelper ì‚¬ìš© ê°€ì´ë“œ</h3>
    <div class="content" style="line-height:1.6">
      <p><b data-i18n="brand.name">ThinkHelper</b><span data-i18n="guide.intro">ëŠ” ë¬¸ì„œ ì‘ì„±ê³¼ ë¦¬ì„œì¹˜ë¥¼ í•œ í™”ë©´ì—ì„œ ëë‚´ëŠ” AI ì—ë””í„°ì…ë‹ˆë‹¤.</span></p>
      <h4 data-i18n="guide.featuresTitle">í•µì‹¬ ê¸°ëŠ¥</h4>
      <ul>
        <li data-i18n="guide.feature1.gemini"><b>AI ì—”ì§„:</b> Google Gemini ëª¨ë¸ ê¸°ë°˜ ì‘ë‹µ.</li>
        <li data-i18n="guide.feature2"><b>íƒìƒ‰/í”¼ë“œ:</b> Research ëª¨ë“œì—ì„œ ìµœì‹  ì •ë³´ í™•ì¸.</li>
        <li data-i18n="guide.feature3"><b>AI ê¸€ì“°ê¸°/ì±„íŒ…:</b> í•˜ë‹¨ ë°” ìš”ì²­ ë˜ëŠ” ìš°ì¸¡ í•˜ë‹¨ ì±„íŒ….</li>
        <li data-i18n="guide.feature4"><b>íŒŒì¼ ì €ì¥:</b> PDF/Word ì €ì¥.</li>
        <li data-i18n="guide.feature5"><b>PPT ìƒì„±:</b> Google Slides ìƒˆ íƒ­.</li>
      </ul>
    </div>
    <div class="actions"><button class="btn-plain" id="guideClose" data-i18n="modal.close">ë‹«ê¸°</button></div>
  </div>
</div>

<!-- Privacy Policy Modal -->
<div id="privacyModal" class="modal-backdrop">
  <div class="modal">
    <h3>ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨</h3>
    <article>
      <p>ë³¸ ì„œë¹„ìŠ¤ëŠ” ì‚¬ìš©ì ê°œì¸ì •ë³´ë¥¼ ì¤‘ìš”í•˜ê²Œ ìƒê°í•©ë‹ˆë‹¤. ë³¸ ë°©ì¹¨ì€ ìˆ˜ì§‘í•˜ëŠ” ì •ë³´, ì´ìš© ëª©ì , ë³´ê´€ ê¸°ê°„, ì œ3ì ì œê³µ, ì‚¬ìš©ì ê¶Œë¦¬ ë° ë¬¸ì˜ì²˜ë¥¼ ì„¤ëª…í•©ë‹ˆë‹¤.</p>
      <h4>1. ìˆ˜ì§‘ í•­ëª©</h4>
      <p>í•„ìˆ˜: ì´ë©”ì¼, ì„œë¹„ìŠ¤ ì´ìš© ë¡œê·¸, ì¿ í‚¤. ì„ íƒ: í”„ë¡œí•„ ì •ë³´.</p>
      <h4>2. ì´ìš© ëª©ì </h4>
      <p>ê³„ì • ê´€ë¦¬, ê³ ê° ì§€ì›, ì„œë¹„ìŠ¤ í’ˆì§ˆ í–¥ìƒ, ë³´ì•ˆ ëª¨ë‹ˆí„°ë§.</p>
      <h4>3. ë³´ê´€ ë° íŒŒê¸°</h4>
      <p>ê´€ë ¨ ë²•ë ¹ ë˜ëŠ” ì„œë¹„ìŠ¤ ì´ìš© ëª©ì  ë‹¬ì„± ì‹œê¹Œì§€ ë³´ê´€í•˜ë©°, ëª©ì  ë‹¬ì„± ì‹œ ì•ˆì „í•˜ê²Œ íŒŒê¸°í•©ë‹ˆë‹¤.</p>
      <h4>4. ì œ3ì ì œê³µ</h4>
      <p>ë²•ë ¹ì— ì˜í•œ ê²½ìš°ë¥¼ ì œì™¸í•˜ê³  ë™ì˜ ì—†ì´ ì œê³µí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
      <h4>5. ì´ìš©ì ê¶Œë¦¬</h4>
      <p>ì—´ëŒ, ì •ì •, ì‚­ì œ, ì²˜ë¦¬ì •ì§€ ìš”êµ¬ê°€ ê°€ëŠ¥í•˜ë©°, ë¬¸ì˜ì²˜ë¡œ ì—°ë½í•˜ë©´ ì§€ì²´ ì—†ì´ ì¡°ì¹˜í•©ë‹ˆë‹¤.</p>
      <h4>6. ë¬¸ì˜ì²˜</h4>
      <p>ì´ë©”ì¼: support@example.com</p>
    </article>
    <div class="actions"><button class="btn-plain" id="privacyClose">ë‹«ê¸°</button></div>
  </div>
</div>

<!-- Terms of Service Modal -->
<div id="termsModal" class="modal-backdrop">
  <div class="modal">
    <h3>ì„œë¹„ìŠ¤ ì´ìš©ì•½ê´€</h3>
    <article>
      <h4>1. ëª©ì </h4>
      <p>ì´ ì•½ê´€ì€ ë³¸ ì„œë¹„ìŠ¤ì˜ ì´ìš©ê³¼ ê´€ë ¨í•˜ì—¬ íšŒì‚¬ì™€ ì‚¬ìš©ì ê°„ ê¶Œë¦¬, ì˜ë¬´ ë° ì±…ì„ ì‚¬í•­ì„ ê·œì •í•©ë‹ˆë‹¤.</p>
      <h4>2. ê³„ì •</h4>
      <p>ì‚¬ìš©ìëŠ” ì •í™•í•œ ì •ë³´ë¥¼ ì œê³µí•´ì•¼ í•˜ë©° ê³„ì • ë³´ì•ˆì„ ìœ ì§€í•  ì±…ì„ì´ ìˆìŠµë‹ˆë‹¤.</p>
      <h4>3. ì‚¬ìš© ì¡°ê±´</h4>
      <p>ë¶ˆë²•, ì¹¨í•´, ìŠ¤íŒ¸ í™œë™ ê¸ˆì§€. ì„œë¹„ìŠ¤ ì •ì±…ì„ ì¤€ìˆ˜í•´ì•¼ í•©ë‹ˆë‹¤.</p>
      <h4>4. ì§€ì ì¬ì‚°ê¶Œ</h4>
      <p>ì„œë¹„ìŠ¤ ë° ì½˜í…ì¸ ì˜ ì €ì‘ê¶Œì€ íšŒì‚¬ ë˜ëŠ” í•´ë‹¹ ê¶Œë¦¬ìì—ê²Œ ìˆìœ¼ë©°, ì‚¬ìš©ìëŠ” í—ˆìš©ëœ ë²”ìœ„ ë‚´ì—ì„œë§Œ ì´ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
      <h4>5. ì±…ì„ ì œí•œ</h4>
      <p>ë¶ˆê°€í•­ë ¥, ì œ3ì ì‚¬ìœ , ì‚¬ìš©ìì˜ ê·€ì±…ìœ¼ë¡œ ë°œìƒí•œ ì†í•´ì— ëŒ€í•´ì„œëŠ” ì±…ì„ì„ ì§€ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
      <h4>6. ë³€ê²½</h4>
      <p>ì•½ê´€ì´ ë³€ê²½ë˜ëŠ” ê²½ìš° ì„œë¹„ìŠ¤ ë‚´ ê³µì§€ ë˜ëŠ” ì´ë©”ì¼ë¡œ í†µì§€í•©ë‹ˆë‹¤.</p>
      <h4>7. ë¬¸ì˜</h4>
      <p>ì´ë©”ì¼: support@example.com</p>
    </article>
    <div class="actions"><button class="btn-plain" id="termsClose">ë‹«ê¸°</button></div>
  </div>
</div>

<script>
function $$(id){return document.getElementById(id);}
if($$("chatInput")){$$("chatInput").addEventListener("keydown",function(e){if(e.key==="Enter"&&!e.shiftKey){e.preventDefault(); if($$("chatForm")){$$("chatForm").requestSubmit();}}});}
function sleep(ms){return new Promise(function(r){setTimeout(r,ms);});}
function escapeHtml(s){return (s==null?"":String(s)).replace(/[&<>\"']/g,function(m){return {"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m];});}
var SKEY_SETTINGS="th.settings";

var SERVER_API_ENDPOINT="http://54.250.162.208:8000";
var FEED_API_ENDPOINT="https://api-v2.deepsearch.com";
var DEEPSEARCH_API_KEY="YOUR_DEEPSEARCH_API_KEY_HERE";
var TOTAL_FREE_TOKEN_LIMIT=15000, NUM_USERS=10;
var USER_SHARE_LIMIT=TOTAL_FREE_TOKEN_LIMIT/NUM_USERS;
var TOKEN_WARN_THRESHOLD=USER_SHARE_LIMIT*0.8;
var TOKEN_COUNT_KEY="th.token.state";
var APPROX_CHARS_PER_TOKEN=2;

var I18N={ko:{limit:{near:function(dt){return "ë¬´ë£Œ í† í° í•œë„ê°€ ê±°ì˜ ë‹¤ ì‚¬ìš©ë˜ì—ˆì–´ìš”.\n"+dt+" ì´í›„ ì´ˆê¸°í™”ë©ë‹ˆë‹¤.";},hit:function(dt){return "ë¬´ë£Œ í† í° í•œë„ë¥¼ ëª¨ë‘ ì‚¬ìš©í–ˆì–´ìš”.\n"+dt+" ì´í›„ ì´ˆê¸°í™”ë©ë‹ˆë‹¤.";}} ,suggest:{ai:"AI ì¶”ì²œ",local:"ë¡œì»¬ ì¶”ì²œ",error:"ì˜¤ë¥˜"},error:{serverConnect:"ì„œë²„ ì—°ê²° ì‹¤íŒ¨. (CORS/ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜?)"}},
en:{limit:{near:function(dt){return "You are nearing the free token limit.\nResets around "+dt+".";},hit:function(dt){return "Free token limit reached.\nResets around "+dt+".";}} ,suggest:{ai:"AI Suggestion",local:"Local Suggestion",error:"Error"},error:{serverConnect:"Server connection failed. (CORS/Network error?)"}},
ja:{limit:{near:function(dt){return "ç„¡æ–™ãƒˆãƒ¼ã‚¯ãƒ³ã®åˆ¶é™ã«è¿‘ã¥ã„ã¦ã„ã¾ã™ã€‚\n"+dt+"é ƒã«ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™ã€‚";},hit:function(dt){return "ç„¡æ–™ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ã™ã¹ã¦ä½¿ç”¨ã—ã¾ã—ãŸã€‚\n"+dt+"é ƒã«ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™ã€‚";}} ,suggest:{ai:"AIææ¡ˆ",local:"ãƒ­ãƒ¼ã‚«ãƒ«ææ¡ˆ",error:"ã‚¨ãƒ©ãƒ¼"},error:{serverConnect:"ã‚µãƒ¼ãƒãƒ¼æ¥ç¶šå¤±æ•—ã€‚(CORS/ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ï¼Ÿ)"}}};
var I18N_TEXT={ko:{"page.title":"ThinkHelper â€” ì—ë””í„°","brand.name":"ThinkHelper","menu.tools":"ë„êµ¬","menu.settings":"ì„¤ì •","menu.help":"ë„ì›€ë§","tools.newDoc":"ìƒˆ ë¬¸ì„œ","tools.print":"í”„ë¦°í„°ë¡œ ì¸ì‡„","tools.import":"ë¶ˆëŸ¬ì˜¤ê¸°","tools.savePdf":"PDFë¡œ ì €ì¥","tools.saveWord":"Wordë¡œ ì €ì¥","tools.saveHwp":"HWPë¡œ ì €ì¥","tools.translate":"ë²ˆì—­í•˜ê¸°","tools.collab":"í˜‘ì—… ì´ˆëŒ€","tools.makePpt":"PPT ìƒì„±","tools.share":"ê³µìœ í•˜ê¸°","settings.showSuggest":"ì¶”ì²œì–´ í‘œì‹œ","settings.aiSuggest":"ë§ì¶¤í˜• AI ì œì•ˆ","settings.gazeCursor":"ì‹œì„  ì»¤ì„œ","settings.language":"ì–¸ì–´","settings.toggleTheme":"í…Œë§ˆ ì „í™˜","settings.mode":"ëª¨ë“œ","settings.mode.normal":"Normal (ì¼ë°˜)","settings.mode.research":"Research (ë¦¬ì„œì¹˜)","help.guide":"ì„œë¹„ìŠ¤ ì†Œê°œ ë° ê°€ì´ë“œ","help.shortcuts":"ë‹¨ì¶•í‚¤ ëª©ë¡","help.privacy":"ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨","help.terms":"ì„œë¹„ìŠ¤ ì´ìš©ì•½ê´€","help.feedback":"í”¼ë“œë°± ë³´ë‚´ê¸°","tooltip.openChat":"ì±„íŒ… ì—´ê¸°","doclist.title":"ë¬¸ì„œ","tooltip.addDoc":"ìƒˆ ë¬¸ì„œ","aiChip.contextHelp":"ë¬¸ë§¥ ë„ì›€","suggest.header":"ì œì•ˆ (â†‘/â†“, Enter)","cmd.createDoc":"ë¬¸ì„œ ìƒì„±","cmd.editDoc":"ì‘ì„± ë„ì›€","cmd.inputPhAiOnly":"AIì—ê²Œ ìš”ì²­í•˜ê¸°","cmd.send":"ì „ì†¡","sidebar.tab.topics":"íƒìƒ‰","sidebar.tab.feed":"í”¼ë“œ","topics.placeholder":"ì±„íŒ… ë‚´ìš© ê¸°ë°˜ ì¶”ì²œ í† í”½ (ì„œë²„ êµ¬í˜„ í•„ìš”)","footer.warning":"AI ê²°ê³¼ëŠ” ê²€í†  í•„ìš”","footer.locationLoading":"ìœ„ì¹˜ í™•ì¸ ì¤‘...","chat.title":"AI ì±„íŒ…","tooltip.chatMore":"ë”ë³´ê¸°","tooltip.attachFile":"íŒŒì¼ ì²¨ë¶€","aria.close":"ë‹«ê¸°","chat.threadTitlePh":"ìŠ¤ë ˆë“œ ì œëª©","chat.saveTitle":"ì œëª© ì €ì¥","chat.deleteThread":"ì‚­ì œ","chat.inputPh":"ë©”ì‹œì§€ ì…ë ¥ (Enter=ì „ì†¡)","chat.send":"ì „ì†¡","chat.quotaGemini":"Gemini AI ì—°ë™","share.title":"ê³µìœ í•˜ê¸°","share.desc":"ë§í¬/í…ìŠ¤íŠ¸ ë³µì‚¬ë¨. QR ì „ì†¡ ê°€ëŠ¥.","modal.close":"ë‹«ê¸°","guide.title":"ThinkHelper ê°€ì´ë“œ","guide.intro":"ëŠ” ë¬¸ì„œ ì‘ì„±ê³¼ ë¦¬ì„œì¹˜ë¥¼ í•œ í™”ë©´ì—ì„œ ëë‚´ëŠ” AI ì—ë””í„°ì…ë‹ˆë‹¤.","guide.featuresTitle":"í•µì‹¬ ê¸°ëŠ¥","guide.feature1.gemini":"AI ì—”ì§„: Google Gemini ëª¨ë¸ ê¸°ë°˜ ì‘ë‹µ.","guide.feature2":"íƒìƒ‰/í”¼ë“œ: Research ëª¨ë“œì—ì„œ ì •ë³´ í™•ì¸","guide.feature3":"AI ê¸€ì“°ê¸°/ì±„íŒ…: í•˜ë‹¨ ë°” ë˜ëŠ” ì±„íŒ…","guide.feature4":"íŒŒì¼ ì €ì¥: PDF/Word ì§€ì›.","guide.feature5":"PPT ìƒì„±: Google Slides ì—´ê¸°."}};

var store={listKey:"th.docs.list",docKey:function(id){return "th.doc."+id;},curKey:"th.cur",
  list:function(){try{return JSON.parse(localStorage.getItem(this.listKey)||"[]");}catch(e){return[];}},
  saveList:function(a){localStorage.setItem(this.listKey,JSON.stringify(a||[]));},
  get:function(id){try{return JSON.parse(localStorage.getItem(this.docKey(id))||"null");}catch(e){return null;}},
  set:function(id,o){localStorage.setItem(this.docKey(id),JSON.stringify(o));},
  remove:function(id){localStorage.removeItem(this.docKey(id));},
  current:function(){return localStorage.getItem(this.curKey)||"";},
  setCurrent:function(id){localStorage.setItem(this.curKey,id||"");}
};
var curId=""; var settings={};

function loadSettings(){try{settings=JSON.parse(localStorage.getItem(SKEY_SETTINGS)||"{}");}catch(e){settings={};}
settings.suggest = (settings.suggest!==false);
settings.personal = !!settings.personal;
settings.gaze = !!settings.gaze;
settings.lang = (settings.lang || (navigator.language||"ko").slice(0,2));
settings.mode = settings.mode || "normal";
}
function saveSettings(){localStorage.setItem(SKEY_SETTINGS,JSON.stringify(settings));}
function applyI18n(){
  var lang=(settings.lang||"ko").slice(0,2); var dict=I18N_TEXT[lang]||I18N_TEXT.ko;
  document.body.dataset.lang=lang;
  var n=document.querySelectorAll("[data-i18n]");
  for(var i=0;i<n.length;i++){var el=n[i]; var k=el.getAttribute("data-i18n"); if(dict[k]) el.textContent=dict[k];}
  n=document.querySelectorAll("[data-i18n-ph]");
  for(i=0;i<n.length;i++){el=n[i]; k=el.getAttribute("data-i18n-ph"); if(dict[k]) el.setAttribute("placeholder",dict[k]);}
  n=document.querySelectorAll("[data-i18n-title]");
  for(i=0;i<n.length;i++){el=n[i]; k=el.getAttribute("data-i18n-title"); if(dict[k]) el.setAttribute("title",dict[k]);}
  n=document.querySelectorAll("[data-i18n-aria]");
  for(i=0;i<n.length;i++){el=n[i]; k=el.getAttribute("data-i18n-aria"); if(dict[k]) el.setAttribute("aria-label",dict[k]);}
  updateGhostSuggest();
}

function getTokenState(){try{var s=JSON.parse(localStorage.getItem(TOKEN_COUNT_KEY)||"{}"); var today=new Date().toLocaleDateString("ko-KR"); if(s.date!==today) return {used:0,date:today}; return {used:s.used||0,date:today};}catch(e){return {used:0,date:new Date().toLocaleDateString("ko-KR")};}}
function addUsedTokens(n){if(n<=0) return; var s=getTokenState(); s.used=(s.used||0)+n; try{localStorage.setItem(TOKEN_COUNT_KEY,JSON.stringify(s));}catch(e){}}
function checkTokenLimitOrWarn(need){var s=getTokenState(); var cur=s.used||0; var langDict=(I18N[settings.lang]||I18N.ko).limit; var reset=settings.lang==="ko"?"ìì •":"midnight"; var use=Math.max(0,need||0); if(cur+use>=USER_SHARE_LIMIT){alert(langDict.hit(reset)); return false;} else if(cur+use>=TOKEN_WARN_THRESHOLD && cur<TOKEN_WARN_THRESHOLD){alert(langDict.near(reset));} return true;}

(function(){
  loadSettings();
  var menus=[].slice.call(document.querySelectorAll("[data-menu]"));
  function closeAll(){var d=document.querySelectorAll(".dropdown"); for(var i=0;i<d.length;i++){d[i].style.display="none";}}
  for(var mi=0; mi<menus.length; mi++){
    var m=menus[mi]; var btn=m.querySelector(".btn"); var drop=m.querySelector(".dropdown"); if(!btn||!drop) continue;
    btn.addEventListener("click",function(e){e.stopPropagation(); var d=this.nextElementSibling; var open=d.style.display==="block"; closeAll(); d.style.display=open?"none":"block";});
    drop.addEventListener("click",function(e){e.stopPropagation();});
  }
  document.addEventListener("click",closeAll);
  if($$("toggleTheme")){$$("toggleTheme").addEventListener("click",function(){var root=document.documentElement; root.dataset.theme=root.dataset.theme==="dark"?"light":"dark";});}
  if($$("btnToggleLeft")){$$("btnToggleLeft").addEventListener("click",function(){var left=$$("left"); if(!left) return; var hidden=left.style.display==="none"; left.style.display=hidden?"flex":"none"; var main=$$("mainLayout"); if(!main) return; var rightCol=settings.mode==="research"?"340px":""; if(window.innerWidth<=900){main.style.gridTemplateColumns="0 1fr"; left.style.display="none";} else if(window.innerWidth<=1200){main.style.gridTemplateColumns=("0 1fr "+(rightCol?rightCol:"")).trim(); left.style.display="none";} else {main.style.gridTemplateColumns=((hidden?"260px":"0")+" 1fr "+(rightCol?rightCol:"")).replace(/\s+/g," ").trim();}});}
  if($$("iGuide")){$$("iGuide").addEventListener("click",function(){$$("guideModal").style.display="flex";});}
  if($$("guideClose")){$$("guideClose").addEventListener("click",function(){$$("guideModal").style.display="none";});}
  if($$("openPrivacy")){$$("openPrivacy").addEventListener("click",function(){$$("privacyModal").style.display="flex";});}
  if($$("privacyClose")){$$("privacyClose").addEventListener("click",function(){$$("privacyModal").style.display="none";});}
  if($$("openTerms")){$$("openTerms").addEventListener("click",function(){$$("termsModal").style.display="flex";});}
  if($$("termsClose")){$$("termsClose").addEventListener("click",function(){$$("termsModal").style.display="none";});}

  var optSugg=$$("optSugg"); if(optSugg) optSugg.checked=!!settings.suggest;
  var optPersonal=$$("optPersonal"); if(optPersonal) optPersonal.checked=!!settings.personal;
  var optGaze=$$("optGaze"); if(optGaze) optGaze.checked=!!settings.gaze;
  var langSel=$$("langSel"); if(langSel) langSel.value=settings.lang;
  var modeSel=$$("modeSel"); if(modeSel) modeSel.value=settings.mode;

  if(optSugg){optSugg.addEventListener("change",function(e){settings.suggest=e.target.checked; saveSettings(); updateGhostSuggest();});}
  if(optPersonal){optPersonal.addEventListener("change",function(e){settings.personal=e.target.checked; saveSettings();});}
  if(optGaze){optGaze.addEventListener("change",function(e){settings.gaze=e.target.checked; saveSettings(); setupGazeCursor();});}
  if(langSel){langSel.addEventListener("change",function(e){settings.lang=e.target.value; saveSettings(); applyI18n();});}
  if(modeSel){modeSel.addEventListener("change",function(e){
    settings.mode=e.target.value; saveSettings();
    var main=$$("mainLayout"); if(main) main.dataset.mode=settings.mode;
    var left=$$("left"); var isLeftHidden=left?left.style.display==="none":true;
    var leftCol=isLeftHidden?"0":"260px"; var rightCol=settings.mode==="research"?"340px":"";
    if(window.innerWidth<=900) main.style.gridTemplateColumns="0 1fr";
    else if(window.innerWidth<=1200) main.style.gridTemplateColumns=("0 1fr "+(rightCol?rightCol:"")).trim();
    else main.style.gridTemplateColumns=(leftCol+" 1fr "+(rightCol?rightCol:"")).replace(/\s+/g," ").trim();
    if(settings.mode==="research"){
      var at=document.querySelector(".sidebar-nav .tab[data-active='1']");
      var activeTab=at?at.getAttribute("data-tab"):null;
      if(activeTab==="feed") loadFeed();
      else if(activeTab==="topics") loadTopics();
      else switchSidebarTab("feed");
    }
  });}

  var main=$$("mainLayout"); if(main) main.dataset.mode=settings.mode;
  applyI18n();
})();

/* CKEditor */
var editor=null, autosaveTimer=null;
async function initEditor(restore){
  try{
    editor=await ClassicEditor.create($$("editor"),{placeholder:settings.lang==="ja"?"ã“ã“ã§æ›¸ã„ã¦ãã ã•ã„...":settings.lang==="en"?"Start writing here...":"ì—¬ê¸°ì„œ ì‘ì„±í•˜ì„¸ìš”..."});
    if(restore!=null) editor.setData(restore);
    editor.model.document.on("change:data",function(){clearTimeout(autosaveTimer); autosaveTimer=setTimeout(saveDoc,700); triggerSuggest(); updateGhostSuggest();});
    editor.editing.view.document.on("selectionChange",function(){updateGhostSuggest();});
  }catch(e){console.error("CKEditor init failed",e); alert(settings.lang==="ja"?"ã‚¨ãƒ‡ã‚£ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚":settings.lang==="en"?"Editor failed to load. Please refresh.":"ì—ë””í„° ë¡œë”© ì‹¤íŒ¨. ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”.");}
}
function newDoc(){
  var id="d_"+Date.now(); curId=id; store.setCurrent(id);
  var title=settings.lang==="ja"?"ç„¡é¡Œ":settings.lang==="en"?"Untitled":"ë¬´ì œ";
  var row={id:id,createdAt:Date.now(),updatedAt:Date.now(),title:title,html:""};
  store.set(id,row);
  var list=store.list().filter(function(x){return x.id!==id;});
  list=[row].concat(list);
  store.saveList(list);
  if(editor) editor.setData("");
  renderList(); updateGhostSuggest();
}
function openDoc(id){
  var d=store.get(id); if(!d||!editor) return;
  curId=id; store.setCurrent(id); editor.setData(d.html||""); renderList(); updateGhostSuggest();
  if(window.innerWidth<=1200){var left=$$("left"); if(left && left.style.display!=="none"){ if($$("btnToggleLeft")) $$("btnToggleLeft").click(); }}
}
async function saveDoc(){
  if(!editor||!curId) return;
  var d=store.get(curId); if(!d) return;
  var html=editor.getData();
  var t=d.title||(settings.lang==="ja"?"ç„¡é¡Œ":settings.lang==="en"?"Untitled":"ë¬´ì œ");
  if(d.html===html && d.title===t) return;
  d.html=html; d.updatedAt=Date.now();
  var plain=d.html.replace(/<[^>]+>/g," ").replace(/\s+/g," ").trim();
  if(!d.title||d.title==="ë¬´ì œ"||d.title==="Untitled"||d.title==="ç„¡é¡Œ"){
    d.title=(plain.split(" ").slice(0,8).join(" ")||(settings.lang==="ja"?"ç„¡é¡Œ":settings.lang==="en"?"Untitled":"ë¬´ì œ"));
  }
  store.set(curId,d);
  var list=store.list().map(function(x){return x.id===curId?{id:curId,createdAt:d.createdAt||Date.now(),updatedAt:d.updatedAt,title:d.title}:x;});
  store.saveList(list); renderList();
}
function renderList(){
  var list=store.list().sort(function(a,b){return (b.updatedAt||0)-(a.updatedAt||0);});
  var el=$$("docList"); if(!el) return;
  var titleTip=(settings.lang==='ko'?'ì œëª© í´ë¦­í•˜ì—¬ ìˆ˜ì •':'Click title to rename');
  var delTip=(settings.lang==='ko'?'ì‚­ì œ':'Delete');
  el.innerHTML = (list.map(function(it){
    var title=it.title||(settings.lang==="ja"?"ç„¡é¡Œ":settings.lang==="en"?"Untitled":"ë¬´ì œ");
    var when=new Date(it.updatedAt||it.createdAt||Date.now()).toLocaleString(
      settings.lang==="ja"?"ja-JP":settings.lang==="en"?"en-US":"ko-KR",{dateStyle:"short",timeStyle:"short"});
    return '<div class="doc '+(it.id===curId?'active':'')+'" data-id="'+it.id+'">'+
      '<div class="title" data-rename-id="'+it.id+'" title="'+titleTip+'">'+escapeHtml(title)+'</div>'+
      '<div class="time">'+escapeHtml(when)+'</div>'+
      '<div class="act"><button class="iconbtn" data-del-id="'+it.id+'" title="'+delTip+'">ğŸ—‘ï¸</button></div>'+
    '</div>';
  }).join("")) || '<div class="doc"><div class="title" data-i18n="doclist.empty">ì €ì¥ëœ ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤.</div></div>';
  if(!list.length) applyI18n();
  el.onclick=function(e){
    var titleEl=e.target.closest?e.target.closest(".title[data-rename-id]"):null;
    var delBtn=e.target.closest?e.target.closest("button[data-del-id]"):null;
    var docRow=e.target.closest?e.target.closest(".doc[data-id]:not(.active)"):null;
    if(delBtn){
      var id=delBtn.getAttribute("data-del-id");
      var docTitle=(store.get(id)||{}).title||(settings.lang==="ja"?"ç„¡é¡Œ":settings.lang==="en"?"Untitled":"ë¬´ì œ");
      var msg=settings.lang==="ko"?"'"+docTitle+"' ë¬¸ì„œë¥¼ ì‚­ì œí• ê¹Œìš”?":settings.lang==="ja"?"'"+docTitle+"' æ–‡æ›¸ã‚’å‰Šé™¤ã—ã¾ã™ã‹?":"Delete document '"+docTitle+"'?";
      if(confirm(msg)){
        store.remove(id);
        store.saveList(store.list().filter(function(x){return x.id!==id;}));
        if(curId===id){
          var next=store.list()[0];
          if(next) openDoc(next.id);
          else newDoc();
        }else{
          renderList();
        }
      }
    } else if(titleEl){
      enableInlineRename(titleEl);
    } else if(docRow){
      openDoc(docRow.getAttribute("data-id"));
    }
  };
}
function enableInlineRename(el){
  var id=el.getAttribute("data-rename-id"); if(!id||el.contentEditable==="true") return;
  var old=el.textContent; el.contentEditable="true"; el.focus(); document.execCommand("selectAll",false,null);
  function finish(save){
    if(save===void 0) save=true;
    el.contentEditable="false"; el.removeEventListener("blur",onBlur); el.removeEventListener("keydown",onKey);
    var nv=el.textContent.trim();
    if(save && nv && nv!==old){ var d=store.get(id); if(d){ d.title=nv; d.updatedAt=Date.now(); store.set(id,d); renderList(); } }
    else { el.textContent=old; }
  }
  function onBlur(){finish(true);}
  function onKey(e){ if(e.key==="Enter"){e.preventDefault(); finish(true);} else if(e.key==="Escape"){e.preventDefault(); finish(false);} }
  el.addEventListener("blur",onBlur); el.addEventListener("keydown",onKey);
}
if($$("addDoc")){$$("addDoc").onclick=newDoc;}
if($$("iNew")){$$("iNew").onclick=newDoc;}

/* Export & Share */
function exportPDF(){
  if(!editor) return alert("Editor not ready.");
  var content=document.createElement("div");
  content.innerHTML=editor.getData();
  content.style.fontFamily=getComputedStyle(document.body).fontFamily;
  content.style.fontSize="11pt";
  content.style.lineHeight="1.5";
  content.style.padding="20mm";
  var opt={margin:[20,20,20,20],filename:"ThinkHelper_"+Date.now()+".pdf",image:{type:"jpeg",quality:0.95},html2canvas:{scale:2,useCORS:true},jsPDF:{unit:"mm",format:"a4",orientation:"portrait"}};
  html2pdf().from(content).set(opt).save();
}
function exportWord(){
  if(!editor) return alert("Editor not ready.");
  var header="<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'><head><meta charset='utf-8'><title>ThinkHelper Export</title><style> body { font-family: '"+getComputedStyle(document.body).fontFamily+"'; font-size: 11pt; } </style></head><body>";
  var src=header+editor.getData()+footer;
  var href='data:application/vnd.ms-word;charset=utf-8,'+encodeURIComponent(src);
  var a=document.createElement("a");
  document.body.appendChild(a);
  a.href=href; a.download="ThinkHelper_"+Date.now()+".doc"; a.click();
  document.body.removeChild(a);
}
async function sharePad(){
  var url=location.origin+location.pathname+(curId?("?doc="+encodeURIComponent(curId)):"");
  try{await navigator.clipboard.writeText(url);}catch(e){}
  var wrap=$$("shareModal"); wrap.style.display="flex";
  var q=$$("qr"); q.innerHTML="";
  new QRCode(q,{text:url,width:200,height:200,colorDark:"#000000",colorLight:"#ffffff",correctLevel:QRCode.CorrectLevel.H});
}
if($$("iSavePDF")){$$("iSavePDF").onclick=exportPDF;}
if($$("iSaveWord")){$$("iSaveWord").onclick=exportWord;}
if($$("iClipboard")){$$("iClipboard").onclick=sharePad;}
if($$("shareClose")){$$("shareClose").onclick=function(){$$("shareModal").style.display="none";};}
if($$("iPrint")){$$("iPrint").onclick=function(){window.print();};}
if($$("iImport")){$$("iImport").onclick=function(){alert("PDF/Word/HWP ë¶ˆëŸ¬ì˜¤ê¸° (ë°ëª¨)");};}
if($$("iSaveHWP")){$$("iSaveHWP").onclick=function(){alert("HWPë¡œ ì €ì¥ì€ ì„œë²„ ë³€í™˜ê¸°ê°€ í•„ìš”í•©ë‹ˆë‹¤.");};}
if($$("iTranslate")){$$("iTranslate").onclick=function(){alert("ë²ˆì—­ ë°ëª¨: ì„œë²„ ì—°ë™ í•„ìš”");};}
if($$("iMakePPT")){$$("iMakePPT").onclick=function(){window.open("https://slides.google.com/create","_blank");};}
if($$("iCollab")){$$("iCollab").onclick=function(){var id=curId||""; var link=location.origin+location.pathname+(id?("?doc="+encodeURIComponent(id)):""); var subject=encodeURIComponent("[ThinkHelper] ë¬¸ì„œ í˜‘ì—… ì´ˆëŒ€"); var body=encodeURIComponent("ì•„ë˜ ë§í¬ë¡œ ì ‘ì†í•˜ë©´ ë¬¸ì„œë¥¼ í•¨ê»˜ í¸ì§‘í•  ìˆ˜ ìˆì–´ìš”(ë°ëª¨).\n\n"+link+"\n\n- ThinkHelper"); location.href="mailto:?subject="+subject+"&body="+body;};}

/* Suggestions */
var aiChip=$$("aiChip"), suggPopup=$$("suggPopup"), suggList=$$("suggList");
var suggActive=-1, suggItems=[], suggDebounce=null;
var KO_DICT=["ê°ì‚¬í•©ë‹ˆë‹¤","ì•ˆë…•í•˜ì„¸ìš”","í”„ë¡œì íŠ¸","ë°ì´í„°","ë¶„ì„","ê²°ê³¼","ìš”ì²­","í™•ì¸","ë¶€íƒë“œë¦½ë‹ˆë‹¤","ì¼ì •","íšŒì˜","ìë£Œ"];
var EN_DICT=["Thank you","Hello","project","data","analysis","result","request","confirm","please","schedule","meeting","document"];
var JA_DICT=["ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™","ã“ã‚“ã«ã¡ã¯","ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ","ãƒ‡ãƒ¼ã‚¿","åˆ†æ","çµæœ","è¦è«‹","ç¢ºèª","ãŠé¡˜ã„ã—ã¾ã™","æ—¥ç¨‹","ä¼šè­°","è³‡æ–™"];
function getPrefix(){
  if(!editor) return "";
  try{
    var model=editor.model; var sel=model.document.selection; var pos=sel.getFirstPosition(); if(!pos) return "";
    var range=model.createRange(model.createPositionAt(pos.parent,0),pos); var text="";
    var it=range.getItems(); var item;
    for(item of it){ if(item.is && (item.is("$text")||item.is("$textProxy"))) text+=item.data; }
    var m=text.match(/[A-Za-z0-9_-]+$/);
    return m?m[0]:"";
  }catch(e){
    var t=editor.getData().replace(/<[^>]+>/g," ");
    var parts=t.split(/\s+/); return parts[parts.length-1]||"";
  }
}
function getLocalSuggestions(prefix){
  var lang=settings.lang||"ko"; var dict=lang==="en"?EN_DICT:lang==="ja"?JA_DICT:KO_DICT;
  var p=(prefix||"").toLowerCase(); var tag=(I18N[lang]||I18N.ko).suggest.local;
  return dict.filter(function(w){return (lang==="ko"?w.indexOf(prefix)===0:w.toLowerCase().indexOf(p)===0);})
             .slice(0,5).map(function(w){return {kind:"LOCAL",text:w,tag:tag};});
}
function applySuggestion(i){
  var it=suggItems[i]; if(!it) return;
  var prefix=getPrefix();
  var ins=it.text.indexOf(prefix)===0?it.text.slice(prefix.length):it.text;
  editor.model.change(function(w){
    var sel=editor.model.document.selection;
    if(sel.isCollapsed && prefix.length>0){
      var pos=sel.getFirstPosition();
      var start=pos.getShiftedBy(-prefix.length);
      if(start){
        var r=editor.model.createRange(start,pos); var s="";
        var iter=r.getItems(); var itm;
        for(itm of iter){ if(itm.is && (itm.is("$text")||itm.is("$textProxy"))) s+=itm.data; }
        if(s===prefix){w.remove(r);}
      }
    }
    editor.model.insertContent(w.createText(ins),sel);
  });
  saveDoc(); closeSuggest();
}
function triggerSuggest(){ if(!settings.suggest||!editor) return; clearTimeout(suggDebounce); suggDebounce=setTimeout(openSuggest,350); }
async function openSuggest(){ if(!editor) return closeSuggest(); var prefix=getPrefix(); if(!prefix) return closeSuggest(); var context=editor.getData().replace(/<[^>]+>/g," ").slice(-500); suggItems=await fetchAiSuggestions(context,prefix); renderSugg(suggItems);}
async function fetchAiSuggestions(context,prefix){
  var lang=settings.lang||"ko"; var label=(I18N[lang]||I18N.ko).suggest;
  var est=Math.ceil((context.length+50)/APPROX_CHARS_PER_TOKEN); if(!checkTokenLimitOrWarn(est)) return getLocalSuggestions(prefix);
  if(SERVER_API_ENDPOINT){
    try{
      var r=await fetch(SERVER_API_ENDPOINT+"/suggest_word",{method:"POST",headers:{"Content-Type":"application/json","Accept-Language":lang},body:JSON.stringify({context:context,prefix:prefix})});
      if(!r.ok) throw new Error("Server "+r.status);
      var data=await r.json();
      var arr=(data&&data.suggestions?data.suggestions:[]).filter(function(s){return s && s!==prefix;});
      var token=Math.ceil((context.length+(arr.join(" ").length))/APPROX_CHARS_PER_TOKEN); addUsedTokens(token);
      if(!arr.length) return getLocalSuggestions(prefix);
      return arr.map(function(s){return {kind:"AI",text:s,tag:label.ai};});
    }catch(e){
      return getLocalSuggestions(prefix);
    }
  }
  return getLocalSuggestions(prefix);
}
function renderSugg(items){
  if(!items||!items.length){suggPopup.style.display="none"; return;}
  var lang=settings.lang||"ko"; var labels=(I18N[lang]||I18N.ko).suggest;
  suggList.innerHTML=items.map(function(it,i){
    return '<li data-idx="'+i+'"><div class="kind">'+escapeHtml(it.kind)+'</div><div class="txt">'+escapeHtml(it.text)+'</div><div class="tag">'+escapeHtml(it.tag||(it.kind==="AI"?labels.ai:it.kind==="LOCAL"?labels.local:labels.error))+'</div></li>';
  }).join("");
  var rect=null; try{rect=editor.editing.view.getDomRoot().getBoundingClientRect();}catch(e){}
  var wrap=($$("editorWrap")?$$("editorWrap").getBoundingClientRect():null);
  if(rect&&wrap){suggPopup.style.top=(rect.top+80-wrap.top)+"px"; suggPopup.style.left=(rect.left+20-wrap.left)+"px";}
  else {suggPopup.style.top="100px"; suggPopup.style.left="50px";}
  suggPopup.style.display="block"; suggActive=0; setActive(0);
}
function setActive(i){var lis=[].slice.call(suggList.querySelectorAll("li")); for(var k=0;k<lis.length;k++){lis[k].dataset.active="0";} if(lis[i]) lis[i].dataset.active="1";}
function closeSuggest(){suggPopup.style.display="none"; suggActive=-1; suggItems=[];}
if($$("suggClose")){$$("suggClose").onclick=closeSuggest;}
document.addEventListener("keydown",function(e){
  if(suggPopup.style.display!=="block") return;
  if(e.key==="ArrowDown"){e.preventDefault(); suggActive=Math.min(suggActive+1, suggItems.length-1); setActive(suggActive);}
  else if(e.key==="ArrowUp"){e.preventDefault(); suggActive=Math.max(suggActive-1,0); setActive(suggActive);}
  else if(e.key==="Enter"||e.key==="Tab"){e.preventDefault(); applySuggestion(suggActive);}
  else if(e.key==="Escape"){e.preventDefault(); closeSuggest();}
});
if(suggList){suggList.addEventListener("click",function(e){var li=e.target.closest?e.target.closest("li[data-idx]"):null; if(li) applySuggestion(Number(li.getAttribute("data-idx")));});}
function updateGhostSuggest(){
  var el=$$("ghostSuggest"); if(!el||!settings.suggest){ if(el) el.textContent=""; return; }
  var txt=(editor?editor.getData():"").replace(/<[^>]+>/g," ").trim()||"";
  var lang=settings.lang||"ko";
  if(!txt){el.textContent=lang==="en"?"e.g., 'Summarize today's meeting'":lang==="ja"?"ä¾‹: ã€Œä»Šæ—¥ã®ä¼šè­°ã‚’è¦ç´„ã€":"ì˜ˆ: 'ì˜¤ëŠ˜ íšŒì˜ ìš”ì•½'";}
  else {el.textContent=lang==="ko"?"â†’ ë‹¤ìŒì— ì“¸ ë‚´ìš©ì€?":"â†’ next?";}
}

/* Right sidebar */
function switchSidebarTab(tab){
  var tabs=[].slice.call(document.querySelectorAll(".sidebar-nav .tab"));
  for(var i=0;i<tabs.length;i++){
    var t=tabs[i]; var on=t.getAttribute("data-tab")===tab;
    t.setAttribute("data-active", on?"1":"0");
    if(on){ if(tab==="feed") loadFeed(); else if(tab==="topics") loadTopics(); }
  }
  var cont=[].slice.call(document.querySelectorAll(".sidebar-content"));
  for(i=0;i<cont.length;i++){
    var c=cont[i]; var k=c.id.toLowerCase().indexOf("search")>-1?"topics":(c.id.toLowerCase().indexOf("feed")>-1?"feed":"");
    c.setAttribute("data-active", (k===tab)?"1":"0");
  }
}
var tabBtns=document.querySelectorAll(".sidebar-nav .tab");
for(var tb=0;tb<tabBtns.length;tb++){tabBtns[tb].onclick=function(){switchSidebarTab(this.getAttribute("data-tab"));};}

/* ì•ˆì „í•œ DOM ë Œë”ë§ (ë¬¸ìì—´ ì—°ê²° ì œê±°) */
function renderSearch(summary,sources){
  var wrap=$$("rightSearchResults"); if(!wrap) return;
  wrap.innerHTML="";
  var sum=document.createElement("div");
  sum.className="search-summary";
  sum.textContent=summary||"";
  wrap.appendChild(sum);

  var sec=document.createElement("div"); sec.className="search-sources";
  var h=document.createElement("h4"); h.textContent=(settings.lang==="ko"?"ì¶œì²˜":settings.lang==="ja"?"å‡ºå…¸":"Sources");
  sec.appendChild(h);
  var ul=document.createElement("ul");
  (sources||[]).forEach(function(s){
    var li=document.createElement("li");
    var a=document.createElement("a");
    a.target="_blank"; a.rel="noopener noreferrer";
    a.href=s.url||"#";
    var st=document.createElement("strong"); st.textContent=s.title|| (settings.lang==="ko"?"ì œëª© ì—†ìŒ":settings.lang==="ja"?"ã‚¿ã‚¤ãƒˆãƒ«ãªã—":"Untitled");
    var sp=document.createElement("span"); sp.textContent=s.url|| (settings.lang==="ko"?"URL ì—†ìŒ":settings.lang==="ja"?"URLãªã—":"No URL");
    a.appendChild(st); a.appendChild(sp); li.appendChild(a); ul.appendChild(li);
  });
  sec.appendChild(ul); wrap.appendChild(sec);
}

async function internalSearch(q){
  var s=(q||"").trim(); if(!s){ renderSearch("ê²€ìƒ‰ì–´ ì—†ìŒ",[]); return; }
  var lang=settings.lang||"ko"; renderSearch((lang==="ko"?"'"+s+"' ê²€ìƒ‰ ì¤‘...":"Searching for '"+s+"'..."),[]);
  if(!FEED_API_ENDPOINT||!DEEPSEARCH_API_KEY||DEEPSEARCH_API_KEY==="YOUR_DEEPSEARCH_API_KEY_HERE"){renderSearch("DEEPSEARCH_API_KEYê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.",[]); return;}
  try{
    var fields="title,url,summary_ko,published_at,provider_name";
    var langParam=lang==="ko"?"&lang=ko":"";
    var r=await fetch(FEED_API_ENDPOINT+"/v1/global-articles?q="+encodeURIComponent(s)+"&limit=5&return_fields="+fields+langParam,{headers:{Authorization:"Bearer "+DEEPSEARCH_API_KEY}});
    if(!r.ok) throw new Error("DeepSearch Search API Error: "+r.status);
    var data=await r.json();
    var docs=data.documents||data.articles||data.items||[];
    var summary=(docs[0]&&docs[0].summary_ko)?docs[0].summary_ko:(lang==="ko"?"'"+s+"'ì— ëŒ€í•œ ê²€ìƒ‰ ê²°ê³¼ì…ë‹ˆë‹¤.":"Search results for '"+s+"'.");
    var src=docs.map(function(d){return {title:d.title,url:d.url};});
    renderSearch(summary,src);
  }catch(e){ renderSearch("'"+s+"' ê²€ìƒ‰ ì‹¤íŒ¨: "+e.message,[]); }
}

async function loadTopics(){
  var c=$$("rightSearchResults"); if(!c) return;
  c.innerHTML='<div class="spinner"></div>';
  if(SERVER_API_ENDPOINT){
    try{
      var last5=chatHistory.slice(-5).map(function(m){return (m.role==="user"?"User":"AI")+": "+m.content;}).join("\n");
      var editorCtx=(editor?editor.getData():"").replace(/<[^>]+>/g," ").trim().slice(-500)||"";
      var r=await fetch(SERVER_API_ENDPOINT+"/get_topics",{method:"POST",headers:{"Content-Type":"application/json","Accept-Language":settings.lang||"ko"},body:JSON.stringify({context:(last5+"\n\n"+editorCtx).trim()})});
      if(!r.ok) throw new Error("Server "+r.status);
      var data=await r.json(); var topics=data.topics||[];
      if(!topics.length){ c.innerHTML='<div class="search-summary">ì¶”ì²œ ì£¼ì œ ì—†ìŒ</div>'; return; }
      var ul=document.createElement("ul");
      topics.forEach(function(t){
        var li=document.createElement("li");
        li.textContent=t;
        li.onclick=function(){internalSearch(t);};
        ul.appendChild(li);
      });
      c.innerHTML=""; c.appendChild(ul);
    }catch(e){ c.innerHTML='<div class="search-summary">ì£¼ì œ ë¡œë”© ì‹¤íŒ¨: '+e.message+'</div>'; }
  }else{
    c.innerHTML='<div class="search-summary">ì„œë²„ ì„¤ì • í•„ìš”</div>';
  }
}

async function loadFeed(topic){
  if(topic===void 0) topic="IT";
  var c=$$("rightFeed"); if(!c) return;
  if(!FEED_API_ENDPOINT||!DEEPSEARCH_API_KEY||DEEPSEARCH_API_KEY==="YOUR_DEEPSEARCH_API_KEY_HERE"){
    c.innerHTML='<div class="feed-item"><div class="feed-content">DEEPSEARCH_API_KEYê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</div></div>'; return;
  }
  c.innerHTML='<div class="spinner"></div>';
  try{
    var langParam=settings.lang==="ko"?"&lang=ko":"";
    var query=(topic==="IT"&&settings.lang==="ko")?"ìµœì‹  IT ë‰´ìŠ¤":topic;
    var fields="title,url,provider_name,image_url,published_at";
    var r=await fetch(FEED_API_ENDPOINT+"/v1/global-articles?q="+encodeURIComponent(query)+"&limit=10&sort=latest&return_fields="+fields+langParam,{headers:{Authorization:"Bearer "+DEEPSEARCH_API_KEY}});
    if(!r.ok) throw new Error("DeepSearch Feed API Error: "+r.status);
    var data=await r.json();
    var items=data.documents||data.articles||data.items||[];
    c.innerHTML="";
    if(!items.length){ c.innerHTML='<div class="feed-item"><div class="feed-content">ì‹¤ì‹œê°„ í”¼ë“œê°€ ì—†ìŠµë‹ˆë‹¤.</div></div>'; return; }

    items.forEach(function(it){
      var a=document.createElement("a");
      a.className="feed-item"; a.target="_blank"; a.rel="noopener noreferrer";
      a.href=it.url || "#";

      var img=document.createElement("img");
      img.alt="ë‰´ìŠ¤ ì¸ë„¤ì¼"; img.loading="lazy";
      img.src = it.image_url ? it.image_url : "https://placehold.co/340x140/cccccc/333333?text=No+Image";

      var content=document.createElement("div"); content.className="feed-content";
      var src=document.createElement("div"); src.className="feed-source"; src.textContent=it.provider_name || "ì¶œì²˜ ë¶ˆëª…";
      var title=document.createElement("div"); title.className="feed-title"; title.textContent=it.title || "";

      content.appendChild(src); content.appendChild(title);
      a.appendChild(img); a.appendChild(content);
      c.appendChild(a);
    });
  }catch(e){
    c.innerHTML='<div class="feed-item"><div class="feed-content">ì—ëŸ¬: '+e.message+'</div></div>';
  }
}

/* Command bar & chat */
function setupCommandBar(){
  var input=$$("cmdInput"), send=$$("cmdSend");
  async function handle(){var v=(input.value||"").trim(); if(!v) return; openChat(); await sendChat(v); input.value="";}
  if(send) send.onclick=handle;
  if(input){input.addEventListener("keydown",function(e){if(e.key==="Enter"&&!e.shiftKey){e.preventDefault(); handle();}});}
  var sugWrap=$$("cmdSuggestions");
  if(sugWrap){
    sugWrap.addEventListener("click",function(e){
      var b=e.target.closest?e.target.closest(".chip"):null; if(!b) return;
      var lang=settings.lang||"ko";
      if(b.getAttribute("data-cmd")==="create_doc"){
        var tpl=lang==="ko"?"<h1>ìƒˆ ë¬¸ì„œ í…œí”Œë¦¿</h1><p>ì—¬ê¸°ì— ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.</p>":lang==="ja"?"<h1>æ–°è¦æ–‡æ›¸ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</h1><p>ã“ã“ã«å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>":"<h1>New Document Template</h1><p>Start writing here.</p>";
        if(editor) editor.setData(tpl); saveDoc();
      }else if(b.getAttribute("data-cmd")==="edit_doc"){
        var prompt=lang==="ko"?"ì´ ë¬¸ì„œ ë¬¸ì¥ ë‹¤ë“¬ì–´ì¤˜":lang==="ja"?"ã“ã®æ–‡æ›¸ã®æ–‡ç« ã‚’æ•´ãˆã¦ãã ã•ã„":"Refine the sentences in this document";
        openChat(); sendChat(prompt);
      }
    });
  }
}

var THREADS_KEY="th.threads";
function threads(){try{return JSON.parse(localStorage.getItem(THREADS_KEY)||"[]");}catch(e){return [];}}
function saveThreads(a){localStorage.setItem(THREADS_KEY,JSON.stringify(a||[]));}
var chatHistory=[], threadId=null;
function renderThreads(){
  var box=$$("chatThreads"); if(!box) return;
  var list=threads().sort(function(a,b){return (b.updatedAt||0)-(a.updatedAt||0);});
  box.innerHTML = (list.map(function(t){
    return '<div class="threadRow" data-id="'+t.id+'" data-active="'+(t.id===threadId?'1':'0')+'">'+
           '<div style="font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:150px">'+escapeHtml(t.title||"ìƒˆ ìŠ¤ë ˆë“œ")+'</div>'+
           '<div style="color:#888;font-size:.8rem">'+new Date(t.updatedAt||t.createdAt).toLocaleDateString()+'</div></div>';
  }).join("")) || '<div class="sys" style="margin:8px">ìŠ¤ë ˆë“œ ì—†ìŒ</div>';
  box.onclick=function(e){var row=e.target.closest?e.target.closest(".threadRow"):null; if(!row) return; openThread(row.getAttribute("data-id"));};
}
function newThread(){
  var id="t_"+Date.now();
  var row={id:id,title:"ìƒˆ ìŠ¤ë ˆë“œ",createdAt:Date.now(),updatedAt:Date.now(),history:[]};
  var merged=[row].concat(threads());
  saveThreads(merged);
  threadId=id; chatHistory=[];
  renderThreads();
  if($$("threadTitleInput")) $$("threadTitleInput").value=row.title;
  if($$("chatBody")) $$("chatBody").innerHTML="";
}
function openThread(id){
  var list=threads(); var t=null;
  for(var i=0;i<list.length;i++){if(list[i].id===id){t=list[i]; break;}}
  if(!t) return;
  threadId=id; chatHistory=t.history||[];
  $$("chatBody").innerHTML="";
  for(var j=0;j<chatHistory.length;j++){var m=chatHistory[j]; addBubble(m.content,m.role==="user",false,true);}
  if($$("threadTitleInput")) $$("threadTitleInput").value=t.title||"";
  renderThreads();
}
function persistThread(){
  if(!threadId) return;
  var list=threads(); var idx=-1; for(var i=0;i<list.length;i++){if(list[i].id===threadId){idx=i;break;}}
  if(idx<0) return;
  var title=($$("threadTitleInput")?($$("threadTitleInput").value.trim()||"ìƒˆ ìŠ¤ë ˆë“œ"):(list[idx].title||"ìƒˆ ìŠ¤ë ˆë“œ"));
  list[idx]=Object.assign({}, list[idx], {
    title: title,
    updatedAt: Date.now(),
    history: chatHistory.slice(-200)
  });
  saveThreads(list); renderThreads();
}
if($$("renameThread")){$$("renameThread").onclick=persistThread;}
if($$("deleteThread")){$$("deleteThread").onclick=function(){ if(!threadId) return; var list=threads().filter(function(x){return x.id!==threadId;}); saveThreads(list); threadId=null; chatHistory=[]; $$("chatBody").innerHTML=""; renderThreads(); };}

var chatDock=$$("chatDock"), chatInput=$$("chatInput");
function openChat(){chatDock.style.display="flex"; chatDock.setAttribute("aria-hidden","false"); if(!threadId) newThread(); if($$("chatInput")) $$("chatInput").focus();}
function closeChat(){chatDock.style.display="none"; chatDock.setAttribute("aria-hidden","true");}
if($$("chatBtn")){$$("chatBtn").onclick=openChat;}
if($$("chatClose")){$$("chatClose").onclick=closeChat;}
if($$("btnChatPlus")){$$("btnChatPlus").onclick=function(e){e.stopPropagation(); var m=$$("chatPlusMenu"); if(m) m.style.display=m.style.display==="block"?"none":"block";};}
document.addEventListener("click",function(){var m=$$("chatPlusMenu"); if(m) m.style.display="none";});
function addBubble(text,me,isErr,skipPersist){ if(me===void 0) me=false; if(isErr===void 0) isErr=false; if(skipPersist===void 0) skipPersist=false;
  var b=document.createElement("div");
  b.className="bubble "+(me?"me":(isErr?"sys":"ai"));
  b.textContent=text;
  $$("chatBody").appendChild(b);
  $$("chatBody").scrollTop=$$("chatBody").scrollHeight;
  if(!skipPersist){chatHistory.push({role:me?"user":"assistant",content:text}); persistThread();}
  return b;
}
async function typeOut(b,text,delay){ if(delay===void 0) delay=4;
  b.textContent="";
  for(var i=0;i<text.length;i++){ b.textContent+=text[i]; if(i%3===0) await sleep(delay); }
  $$("chatBody").scrollTop=$$("chatBody").scrollHeight;
}
if($$("chatBody")){$$("chatBody").addEventListener("click",function(e){var t=e.target.closest?e.target.closest(".bubble.ai"):null; if(!t) return; $$("chatInput").value=t.textContent; $$("chatInput").focus();});}
async function sendChat(msg){
  var est=Math.ceil((msg.length+150)/APPROX_CHARS_PER_TOKEN); if(!checkTokenLimitOrWarn(est)){addBubble((I18N[settings.lang]||I18N.ko).limit.hit(settings.lang==="ko"?"ìì •":"midnight"),false,true); return;}
  addBubble(msg,true); chatHistory.push({role:"user",content:msg}); persistThread();
  var holder=addBubble("...",false);
  if(SERVER_API_ENDPOINT){
    try{
      var r=await fetch(SERVER_API_ENDPOINT+"/ask",{method:"POST",headers:{"Content-Type":"application/json","Accept-Language":settings.lang||"ko"},body:JSON.stringify({question:msg,id:threadId||""})});
      if(!r.ok){var t=await r.text(); throw new Error("Server Error: "+r.status+" "+t);}
      var data=await r.json(); var reply=(data&&data.answer)?data.answer:"(AI Response Error)";
      var actual=Math.ceil((msg.length+reply.length)/APPROX_CHARS_PER_TOKEN); addUsedTokens(actual);
      await typeOut(holder,reply);
      chatHistory.push({role:"assistant",content:holder.textContent}); persistThread();
    }catch(e){
      await typeOut(holder,(I18N[settings.lang]||I18N.ko).error.serverConnect+" "+e.message,0); holder.classList.add("sys");
    }
  }else{
    await typeOut(holder,"Server address not configured.",0); holder.classList.add("sys");
  }
}
if($$("chatForm")){$$("chatForm").addEventListener("submit",function(e){e.preventDefault(); var t=chatInput.value.trim(); if(!t) return; chatInput.value=""; sendChat(t);});}
if($$("btnAttach")){$$("btnAttach").onclick=function(){$$("filePick").click();};}
if($$("filePick")){$$("filePick").addEventListener("change",function(e){var f=e.target.files&&e.target.files[0]; if(!f) return; addBubble("File Received: "+f.name+" ("+Math.round(f.size/1024)+"KB)",false,true);});}

/* footer location */
(function(){
  var locEl=$$("loc"); if(!locEl) return;
  fetch("https://ipapi.co/json").then(function(r){if(!r.ok) throw new Error("ipapi status "+r.status); return r.json();})
  .then(function(a){ if(a && a.city){ locEl.textContent="ğŸ“ "+a.city+", "+a.country_name; } else { throw new Error("no city"); } })
  .catch(function(){ locEl.textContent="ğŸ“ ìœ„ì¹˜ í™•ì¸ ë¶ˆê°€"; });
})();

/* gaze cursor */
function setupGazeCursor(){ if($$("gaze")) $$("gaze").style.display=settings.gaze?"block":"none"; }
document.addEventListener("mousemove",function(e){ var g=$$("gaze"); if(g && g.style.display==="block"){ g.style.left=e.clientX+"px"; g.style.top=e.clientY+"px"; }});

/* shortcuts */
document.addEventListener("keydown",function(e){ if((e.ctrlKey||e.metaKey)&&String(e.key||"").toLowerCase()==="k"){e.preventDefault(); if($$("cmdInput")){$$("cmdInput").focus(); $$("cmdInput").select();}}});

/* init */
(async function(){
  loadSettings();
  try{await initEditor("");}catch(e){return;}
  var last=store.current(); if(last && store.get(last)) openDoc(last); else newDoc(); renderList();
  setupCommandBar(); setupGazeCursor(); updateGhostSuggest(); renderThreads();
  switchSidebarTab("feed");
  checkTokenLimitOrWarn(0);
})();
</script>
</body>
</html>
