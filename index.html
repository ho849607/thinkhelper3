<!DOCTYPE html>
<html lang="ko" data-theme="light">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>ThinkHelper â€” Editor</title>
  <link rel="icon" href="data:,"/>

  <!-- Google Tag Manager -->
  <script>
    (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-NXBQK43Z');
  </script>
  <!-- End Google Tag Manager -->

  <script src="https://cdn.ckeditor.com/ckeditor5/41.3.1/classic/ckeditor.js"></script>
  <style>
    :root{--bg:#f6f8fb;--fg:#0b1020;--muted:#6a7691;--panel:#fff;--card:#f2f5ff;--border:#d6deee;--hover:#e9effe;--accent:#2563eb}
    :root[data-theme="dark"]{--bg:#0b1020;--fg:#f1f5ff;--muted:#a8b4cf;--panel:#0f172a;--card:#101a30;--border:#273453;--hover:#16213b;--accent:#60a5fa}
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--fg);font-family:-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif;display:flex;flex-direction:column}
    .topbar{display:flex;gap:8px;align-items:center;padding:10px 12px;background:var(--panel);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:1000}
    .brand{display:flex;align-items:center;gap:8px;font-weight:900}.logo{width:18px;height:18px;border-radius:4px;background:linear-gradient(135deg,#60a5fa,#34d399)}
    .btn{border:1px solid var(--border);background:var(--card);color:var(--fg);border-radius:8px;padding:.45rem .7rem;font-weight:900;cursor:pointer}
    .btn:hover{background:var(--hover)} .iconbtn{border:1px solid var(--border);background:transparent;color:var(--fg);border-radius:6px;padding:.25rem .45rem;cursor:pointer}
    .iconbtn:hover{background:var(--hover)} .selectlike{height:34px;border:1px solid var(--border);border-radius:8px;background:var(--card);color:var(--fg);padding:.25rem .5rem}
    .menu{position:relative;z-index:1001}.dropdown{display:none;position:absolute;top:42px;left:0;background:var(--panel);border:1px solid var(--border);border-radius:10px;min-width:320px;box-shadow:0 12px 24px rgba(0,0,0,.12)}
    .dropdown .item{padding:.55rem .7rem;border-bottom:1px dashed var(--border);cursor:pointer;display:flex;justify-content:space-between;gap:10px;align-items:center}
    .dropdown .item:last-child{border-bottom:none}.dropdown .item:hover{background:var(--hover)} .dropdown a.item{text-decoration:none;color:inherit}

    main{flex:1;min-height:0;display:grid;grid-template-columns:260px 1fr 380px;gap:10px;padding:10px}
    @media (max-width:1200px){main{grid-template-columns:0 1fr 360px}#left{display:none}}
    @media (max-width:900px){main{grid-template-columns:0 1fr 0}#left,#right{display:none}}

    aside#left{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:10px;display:flex;flex-direction:column;min-height:0;position:sticky;top:70px;height:calc(100vh - 90px)}
    .listHead{display:flex;align-items:center;gap:8px}
    #docList{flex:1;overflow:auto;display:flex;flex-direction:column;gap:8px;margin-top:10px}
    .doc{display:flex;gap:8px;align-items:center;padding:8px;background:var(--card);border:1px solid var(--border);border-radius:10px;cursor:pointer}
    .doc:hover{background:var(--hover)} .doc .title{flex:1;font-weight:900;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.doc .time{font-size:.78rem;color:var(--muted)} .doc .act{display:none;gap:6px}.doc:hover .act{display:inline-flex}

    section#center{display:flex;flex-direction:column;gap:10px;min-width:0}
    #editorWrap{flex:1;border:1px solid var(--border);border-radius:12px;background:var(--panel);padding:8px;position:relative}
    #editor{min-height:62vh}
    .ck-balloon-panel,.ck-powered-by-balloon{display:none!important}
    .ck-editor__editable_inline{min-height:58vh!important;color:#222;background:#fff;padding:12px 12px;border-radius:8px;position:relative}
    [data-theme="dark"] .ck-editor__editable_inline{color:#ffe7b3;background:#0b1327}

    #ghostSuggest{position:absolute;right:14px;top:14px;font-size:.92rem;color:#9aa3b2;opacity:.7;pointer-events:none;max-width:40%;text-align:right}

    #commandBar{display:flex;gap:10px;align-items:center;padding:10px;background:var(--panel);border:1px solid var(--border);border-radius:12px}
    #cmdInput{flex:1;height:40px;border:1px solid var(--border);border-radius:10px;background:var(--card);color:var(--fg);padding:.5rem .9rem;font-size:15px}

    aside#right{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:10px;display:flex;flex-direction:column;min-height:0;position:sticky;top:70px;height:calc(100vh - 90px)}
    .sidebar-nav{display:flex;gap:8px;border-bottom:1px solid var(--border);margin-bottom:10px}
    .sidebar-nav .tab{padding:8px 14px;font-weight:900;cursor:pointer;border-bottom:3px solid transparent}
    .sidebar-nav .tab:hover{background:var(--hover)}
    .sidebar-nav .tab[data-active="1"]{color:var(--accent);border-bottom-color:var(--accent)}
    .sidebar-content{flex:1;overflow:auto;display:none}.sidebar-content[data-active="1"]{display:block}

    #searchBox{display:flex;gap:6px;margin-bottom:8px}
    #searchInput{flex:1;border:1px solid var(--border);border-radius:8px;background:var(--card);padding:.45rem .6rem}

    #rightSearchResults .result{border:1px dashed var(--border);border-radius:10px;padding:8px;background:var(--card);margin:6px 0}
    #rightFeed{display:flex;flex-direction:column;gap:12px}
    .card{display:grid;grid-template-columns:120px 1fr;gap:10px;border:1px solid var(--border);border-radius:10px;background:var(--card);padding:8px;margin:8px 0;cursor:pointer}
    .card:hover{background:var(--hover)} .card img{width:120px;height:80px;object-fit:cover;border-radius:8px}
    .card .ttl{font-weight:900} .card .meta{font-size:.86rem;color:var(--muted);margin-top:2px}

    /* Chat Dock */
    #chatBtn{position:fixed;right:16px;bottom:18px;z-index:60}
    #chatDock{position:fixed;right:16px;bottom:16px;width:min(95vw,1000px);height:85vh;display:none;flex-direction:column;background:var(--panel);border:1px solid var(--border);border-radius:14px;box-shadow:0 18px 36px rgba(0,0,0,.28);z-index:75}
    #chatHead{display:flex;align-items:center;gap:8px;justify-content:space-between;padding:10px;border-bottom:1px solid var(--border);font-weight:900}
    #chatWrap{flex:1;display:grid;grid-template-columns:220px 1fr;min-height:0}
    #chatThreads{border-right:1px solid var(--border);padding:8px;overflow:auto}
    .threadRow{display:flex;gap:6px;align-items:center;padding:8px;border:1px solid var(--border);border-radius:10px;background:var(--card);cursor:pointer;margin-bottom:8px;justify-content:space-between}
    .threadRow:hover{background:var(--hover)} .threadRow[data-active="1"]{outline:2px solid #9bbcff}
    #chatMain{display:flex;flex-direction:column;min-width:0}
    #chatBody{flex:1;overflow:auto;padding:10px;display:flex;flex-direction:column;gap:10px}
    .bubble{max-width:85%;padding:.7rem 1rem;border:1px solid var(--border);border-radius:14px;background:var(--card);white-space:pre-wrap;line-height:1.55}
    .me{margin-left:auto;background:#143763;color:#fff;border-color:#143763}
    .ai{margin-right:auto;border-color:#3b4b72;background:#15284f;color:#fff}
    .sys{margin:0 auto;background:#eef2ff;border-style:dashed;color:#111}
    #chatForm{display:flex;gap:8px;padding:10px;border-top:1px solid var(--border)}
    #chatInput{flex:1;border:1px solid var(--border);border-radius:10px;background:var(--card);color:#000;padding:.6rem .8rem;font-size:1.02rem}

    footer{padding:10px 12px;text-align:center;color:var(--muted)}
  </style>
</head>
<body>
  <!-- Google Tag Manager (noscript) -->
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NXBQK43Z"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <!-- End Google Tag Manager (noscript) -->

  <div class="topbar">
    <button class="iconbtn" id="btnToggleLeft">â˜°</button>
    <div class="brand"><div class="logo"></div><div>ThinkHelper</div></div>

    <div class="menu" data-menu>
      <button class="btn">ë„êµ¬ â–¾</button>
      <div class="dropdown">
        <div class="item" id="iNew"><span>ìƒˆ ë¬¸ì„œ</span></div>
        <div class="item" id="iSave"><span>ë¬¸ì„œ ì €ì¥</span></div>
      </div>
    </div>

    <div class="menu" data-menu>
      <button class="btn">ì„¤ì • â–¾</button>
      <div class="dropdown">
        <div class="item" id="toggleTheme">ğŸŒ“ <span>í…Œë§ˆ ì „í™˜</span></div>
      </div>
    </div>

    <div class="menu" data-menu>
      <button class="btn">ë„ì›€ë§ â–¾</button>
      <div class="dropdown">
        <a class="item" href="mailto:ho8949607@gmail.com"><span>í”¼ë“œë°± ë³´ë‚´ê¸°</span><span>â†—</span></a>
        <a class="item" href="https://docs.google.com/document/d/1kmFzmp3ddJOKOp1TPsvsNzAuBKt6M0Vm0N_G5BIOZEE/edit?usp=sharing" target="_blank"><span>ê°œì¸ì •ë³´</span><span>â†—</span></a>
        <a class="item" href="https://docs.google.com/document/d/1TLZ2m52s1mAd8BPzXDBQuXF6QZ_hLDZOyX6Y8TKALnE/edit?usp=sharing" target="_blank"><span>ì„œë¹„ìŠ¤ ì•½ê´€</span><span>â†—</span></a>
      </div>
    </div>

    <button class="btn" id="chatBtn" style="margin-left:auto">ğŸ’¬</button>
  </div>

  <main>
    <aside id="left">
      <div class="listHead"><b>ë¬¸ì„œ</b><button class="btn" id="addDoc">ï¼‹</button></div>
      <div id="docList"></div>
    </aside>

    <section id="center">
      <div id="editorWrap">
        <div id="editor"></div>
        <!-- ë¶€ë“œëŸ¬ìš´ íšŒìƒ‰ ë¬¸ì¥ ì¶”ì²œ(ê³ ìŠ¤íŠ¸) -->
        <div id="ghostSuggest" aria-hidden="true"></div>
      </div>

      <div id="commandBar">
        <input id="cmdInput" placeholder="AIì—ê²Œ ìš”ì²­í•˜ê±°ë‚˜ ê²€ìƒ‰ (/search ë˜ëŠ” ? )"/>
        <button class="btn" id="cmdSend">ì „ì†¡</button>
      </div>
    </section>

    <aside id="right">
      <nav class="sidebar-nav">
        <button class="tab" data-tab="search" data-active="1">ê²€ìƒ‰</button>
        <button class="tab" data-tab="feed" data-active="0">í”¼ë“œ</button>
      </nav>

      <div id="rightSearchResults" class="sidebar-content" data-active="1">
        <div id="searchBox">
          <input id="searchInput" placeholder="ì˜ˆ) cnn.com / site:naver.com ì¸ê³µì§€ëŠ¥ / ì¸ê³µì§€ëŠ¥ ìµœì‹  ë™í–¥"/>
          <button class="btn" id="searchBtn">ê²€ìƒ‰</button>
        </div>
        <div class="result">ê²€ìƒ‰ì–´ë‚˜ URLì„ ì…ë ¥í•˜ì„¸ìš”.</div>
      </div>

      <div id="rightFeed" class="sidebar-content" data-active="0">
        <div class="result">í”¼ë“œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>
      </div>
    </aside>
  </main>

  <footer>Â© ThinkHelper â€” ì¸ê³µì§€ëŠ¥ ê²°ê³¼ëŠ” ê²€í† ê°€ í•„ìš”í•©ë‹ˆë‹¤.</footer>

  <!-- Chat Dock -->
  <div id="chatDock" role="dialog" aria-hidden="true">
    <div id="chatHead">
      <span>AI ì±„íŒ…</span>
      <div class="actions" style="display:flex;gap:6px;align-items:center">
        <button class="iconbtn" id="btnNewThread">ï¼‹</button>
        <button class="iconbtn" id="chatClose">âœ–</button>
      </div>
    </div>
    <div id="chatWrap">
      <aside id="chatThreads"></aside>
      <section id="chatMain">
        <div style="padding:6px 10px;border-bottom:1px dashed var(--border);display:flex;gap:8px;align-items:center">
          <input id="threadTitleInput" placeholder="ìŠ¤ë ˆë“œ ì œëª©" style="flex:1;border:1px solid var(--border);border-radius:8px;padding:.35rem .55rem;background:var(--card)"/>
          <button class="btn" id="renameThread">ì œëª© ì €ì¥</button>
          <button class="btn" id="deleteThread">ì‚­ì œ</button>
        </div>
        <div id="chatBody"></div>
        <form id="chatForm">
          <textarea id="chatInput" rows="2" placeholder="ë©”ì‹œì§€ ì…ë ¥ (Enter=ì „ì†¡)"></textarea>
          <button class="btn" type="submit">ì „ì†¡</button>
        </form>
      </section>
    </div>
  </div>

<script>
/* =================== ê¸°ë³¸ ìœ í‹¸ =================== */
const $$ = (id)=>document.getElementById(id);
const esc = (s)=> (s??"").toString().replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m]));
const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));

/* =================== ë©”ë‰´ ë™ì‘ =================== */
(function(){
  const menus=[...document.querySelectorAll('[data-menu]')];
  const closeAll=()=>document.querySelectorAll('.dropdown').forEach(d=>d.style.display='none');
  menus.forEach(m=>{
    const btn=m.querySelector('.btn'); const drop=m.querySelector('.dropdown');
    btn.addEventListener('click',(e)=>{e.stopPropagation();const open=drop.style.display==='block';closeAll();drop.style.display=open?'none':'block';});
    drop.addEventListener('click',e=>e.stopPropagation());
  });
  document.addEventListener('click',closeAll);
  $$("toggleTheme").onclick=()=>{const r=document.documentElement; r.dataset.theme=r.dataset.theme==="dark"?"light":"dark";};
  $$("btnToggleLeft").onclick=()=>{ const left=$$("left"); left.style.display = (left.style.display==='none'?'flex':'none'); };
})();
</script>

<!-- ===== Lambda Bridge (í˜¸í™˜) ===== -->
<script>
window.lambdaBridge = window.lambdaBridge || {
  endpoint: "/lambda",               // í•„ìš” ì‹œ ì ˆëŒ€ê²½ë¡œ/ë„ë©”ì¸ìœ¼ë¡œ êµì²´
  async call(action, payload) {
    try {
      const r = await fetch(this.endpoint, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ action, payload })
      });
      if (!r.ok) throw new Error(`lambda ${r.status}`);
      return await r.json();         // { ok: true, data: ... } í˜•íƒœ ì¶”ì²œ
    } catch (e) {
      return null;                   // ëŒë‹¤ ë¯¸ì—°ë™/ì˜¤ë¥˜ ì‹œ null -> ë¡œì»¬ í´ë°±
    }
  }
};
</script>

<!-- ===== Proxy fetch & HTML helpers ===== -->
<script>
const PROXY = (url)=>`https://r.jina.ai/http://${url.replace(/^https?:\/\//,'')}`;
const fetchText = async (url)=> (await fetch(PROXY(url))).text();

function stripTags(s){ return (s||"").replace(/<script[\s\S]*?<\/script>/gi,'')
  .replace(/<style[\s\S]*?<\/style>/gi,'').replace(/<!\[CDATA\[|\]\]>/g,'')
  .replace(/<[^>]+>/g,' ').replace(/\s+/g,' ').trim(); }

function pickOG(html){
  const get = (n)=> (html.match(new RegExp(`<meta[^>]+property=["']og:${n}["'][^>]*content=["']([^"']+)["'][^>]*>`,`i`))||
                     html.match(new RegExp(`<meta[^>]+name=["']${n}["'][^>]*content=["']([^"']+)["'][^>]*>`,`i`)))?.[1]||"";
  return {
    title: get("title") || (html.match(/<title[^>]*>([\s\S]*?)<\/title>/i)?.[1]||""),
    desc:  get("description") || "",
    image: get("image") || "",
    site:  get("site_name") || ""
  };
}

function firstParagraphs(html, n=3){
  const ps=[...html.matchAll(/<p[^>]*>([\s\S]*?)<\/p>/gi)].map(m=>stripTags(m[1])).filter(t=>t.length>30);
  return ps.slice(0,n).join("\n");
}
</script>

<script>
/* =================== ì—ë””í„°/ì €ì¥ =================== */
let editor;
const store={listKey:"th.docs.list",docKey:id=>`th.doc.${id}`,curKey:"th.cur",
  list(){try{return JSON.parse(localStorage.getItem(this.listKey)||"[]")}catch{return[]}},
  saveList(a){localStorage.setItem(this.listKey,JSON.stringify(a||[]))},
  get(id){try{return JSON.parse(localStorage.getItem(this.docKey(id))||"null")}catch{return null}},
  set(id,o){localStorage.setItem(this.docKey(id),JSON.stringify(o))},
  remove(id){localStorage.removeItem(this.docKey(id))},
  current(){return localStorage.getItem(this.curKey)||""},
  setCurrent(id){localStorage.setItem(this.curKey,id||"")}
};
let curId="";

async function initEditor(){
  editor=await ClassicEditor.create($$("editor"),{placeholder:"ì—¬ê¸°ì„œ ì‘ì„±í•˜ì„¸ìš”â€¦"});
  editor.model.document.on('change:data', ()=>{ saveDocDebounced(); renderGhost(); });
}
let saveTimer=null;
function saveDocDebounced(){ clearTimeout(saveTimer); saveTimer=setTimeout(saveDoc,500); }

function newDoc(){const id="d_"+Date.now(); curId=id; store.setCurrent(id);
  const row={id,createdAt:Date.now(),updatedAt:Date.now(),title:"ë¬´ì œ"}; store.saveList([row,...store.list().filter(x=>x.id!==id)]);
  editor.setData(""); store.set(id,{...row,html:""}); renderList();}

function openDoc(id){const d=store.get(id); if(!d) return; curId=id; store.setCurrent(id); editor.setData(d.html||"");}
function getPlain(){ return editor.getData().replace(/<[^>]+>/g," ").replace(/\s+/g," ").trim(); }

async function saveDoc(){
  if(!curId) newDoc();
  const d=store.get(curId)||{id:curId};
  d.html=editor.getData(); d.updatedAt=Date.now();
  const plain=getPlain();
  d.title=(d.title&&d.title!=="ë¬´ì œ")? d.title : (plain.split(" ").slice(0,8).join(" ")||"ë¬´ì œ");
  store.set(curId,d);
  const list=store.list().filter(x=>x.id!==curId);
  list.unshift({id:curId,createdAt:d.createdAt||Date.now(),updatedAt:d.updatedAt,title:d.title}); store.saveList(list);
  renderList();
}

function renderList(){
  const list=store.list().sort((a,b)=>(b.updatedAt||0)-(a.updatedAt||0));
  $$("docList").innerHTML=list.map(d=>{
    const when=new Date(d.updatedAt||d.createdAt||Date.now()).toLocaleString();
    const title=(store.get(d.id)?.title)||"ë¬´ì œ";
    return `<div class="doc" data-open="${d.id}">
      <div class="title">${esc(title)}</div>
      <div class="time">${esc(when)}</div>
      <div class="act"><button class="iconbtn" data-rename="${d.id}">âœï¸</button><button class="iconbtn" data-del="${d.id}">ğŸ—‘ï¸</button></div>
    </div>`;
  }).join("")||`<div class="doc"><div class="title">ì €ì¥ëœ ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤.</div></div>`;
  $$("docList").onclick=(e)=>{
    const r=e.target.closest("[data-rename]"), d=e.target.closest("[data-del]"), o=e.target.closest("[data-open]");
    if(r){const id=r.dataset.rename; const doc=store.get(id)||{}; const t=prompt("ì œëª©",doc?.title||"ë¬´ì œ")||"ë¬´ì œ"; doc.title=t; doc.updatedAt=Date.now(); store.set(id,doc); renderList(); return;}
    if(d){const id=d.dataset.del; if(confirm("ì‚­ì œí• ê¹Œìš”?")){store.remove(id); store.saveList(store.list().filter(x=>x.id!==id)); if(curId===id){curId=""; editor.setData("");} renderList();} return;}
    if(o){openDoc(o.dataset.open);}
  };
}
$$("addDoc").onclick=newDoc; $$("iNew").onclick=newDoc; $$("iSave").onclick=saveDoc;

/* ë¬¸ì¥ ì¶”ì²œ(ê³ ìŠ¤íŠ¸ í…ìŠ¤íŠ¸) - ì—°í•œ íšŒìƒ‰ */
function renderGhost(){
  try{
    const txt = getPlain();
    if(!txt){ $$("ghostSuggest").textContent = "ì˜ˆ: 'ì˜¤ëŠ˜ íšŒì˜ ìš”ì•½ 5ì¤„' ì²˜ëŸ¼ ì…ë ¥í•´ ë³´ì„¸ìš”."; return; }
    const last = txt.slice(-160);
    const suggestion = last.length>30 ? "â†’ í•µì‹¬ë§Œ 5ì¤„ë¡œ ìš”ì•½í•´ ë“œë¦´ê¹Œìš”?  /search ìµœì‹  ìë£Œ" : "â†’ '/search ì£¼ì œ'ë¡œ ë°”ë¡œ ì¡°ì‚¬í•˜ê¸°";
    $$("ghostSuggest").textContent = suggestion;
  }catch{ $$("ghostSuggest").textContent = ""; }
}

function insertAtCursor(t){
  editor.model.change(w=>{editor.model.insertContent(w.createText(t), editor.model.document.selection);});
  saveDocDebounced();
}
</script>

<!-- ===== ì‚¬ì´íŠ¸ ì¹´ë“œ UI ===== -->
<script>
function siteCardHTML({title,url,img,site,desc,preview}){
  return `<div class="card" data-title="${esc(title)}" data-url="${esc(url)}" data-source="${esc(site||'ì‚¬ì´íŠ¸')}">
    <img src="${esc(img||('https://picsum.photos/200/120?random='+Math.floor(Math.random()*1000)))}" alt=""/>
    <div>
      <div class="ttl">${esc(title||url)}</div>
      <div class="meta">${esc(site||new URL(url).hostname)}</div>
      <div class="meta">${esc(desc||'')}</div>
      ${preview?`<div class="meta" style="margin-top:6px;white-space:pre-wrap">${esc(preview)}</div>`:""}
    </div>
  </div>`;
}
</script>

<!-- ===== ê²€ìƒ‰/ë¯¸ë¦¬ë³´ê¸° ë¡œì§ ===== -->
<script>
function switchTab(tab){ document.querySelectorAll(".sidebar-nav .tab").forEach(t=>t.dataset.active=(t.dataset.tab===tab?"1":"0"));
  document.querySelectorAll(".sidebar-content").forEach(c=>c.dataset.active=(c.id.includes(tab)?"1":"0")); }
document.querySelectorAll(".sidebar-nav .tab").forEach(t=>t.onclick=()=>switchTab(t.dataset.tab));

function isURLlike(q){
  try {
    if (/^https?:\/\//i.test(q)) return true;
    if (/^[a-z0-9.-]+\.[a-z]{2,}$/i.test(q)) return true;         // domain.tld
    const m=q.match(/site:([a-z0-9.-]+\.[a-z]{2,})\s*(.*)/i);     // site:ë„ë©”ì¸ í‚¤ì›Œë“œ
    if (m) return { domain:m[1], rest:(m[2]||'').trim() };
    return false;
  } catch { return false; }
}

async function showSitePreview(url, q){
  const box = $$("rightSearchResults");
  box.innerHTML = `<div id="searchBox"><input id="searchInput" value="${esc(q)}"/><button class="btn" id="searchBtn">ê²€ìƒ‰</button></div>
                   <div class="result">ì‚¬ì´íŠ¸ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>`;
  document.getElementById("searchBtn").onclick=()=>internalSearch(document.getElementById("searchInput").value.trim());

  try{
    const html = await fetchText(url);
    const og = pickOG(html);
    const preview = firstParagraphs(html, 3);
    const card = siteCardHTML({title:og.title||url, url, img:og.image, site:og.site||new URL(url).hostname, desc:og.desc, preview});
    box.innerHTML = box.innerHTML + card;

    box.querySelector(".card:last-child").onclick = ()=> {
      insertAtCursor(`> [${og.site||'ì‚¬ì´íŠ¸'}] ${og.title||url}\n${url}\n\n${preview}\n`);
    };
  }catch(e){
    box.innerHTML += `<div class="result">ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨: ${esc(e.message)} â€” ìƒˆ íƒ­ìœ¼ë¡œ ì—½ë‹ˆë‹¤.</div>`;
    window.open(url, "_blank");
  }
}

async function internalSearch(q){
  if(!q) return; switchTab('search');

  // URL/ë„ë©”ì¸/ site: ê°ì§€
  const shape = isURLlike(q);
  if (shape === true) {
    const url = /^https?:\/\//i.test(q)? q : ("https://" + q);
    return showSitePreview(url, q);
  } else if (shape && shape.domain) {
    const domain = shape.domain, rest = shape.rest || "";
    const duck = await (await fetch(`https://r.jina.ai/http://duckduckgo.com/html/?q=${encodeURIComponent(`site:${domain} ${rest}`)}`)).text();
    const links = [...duck.matchAll(/<a[^>]*class="result__a"[^>]*>(.*?)<\/a>[\s\S]*?<a[^>]*href="(http[^"]+)"/g)]
      .slice(0,8).map(m=>decodeURIComponent(m[2].replace(/&amp;/g,'&')));
    if (!links.length) return showSitePreview("https://"+domain, q);

    const box=$$("rightSearchResults");
    box.innerHTML = `<div id="searchBox"><input id="searchInput" value="${esc(q)}"/><button class="btn" id="searchBtn">ê²€ìƒ‰</button></div>`;
    document.getElementById("searchBtn").onclick=()=>internalSearch(document.getElementById("searchInput").value.trim());

    for (const url of links){
      try{
        const html = await fetchText(url);
        const og = pickOG(html);
        const preview = firstParagraphs(html, 2);
        box.innerHTML += siteCardHTML({title:og.title||url, url, img:og.image, site:og.site||new URL(url).hostname, desc:og.desc, preview});
      }catch(_){}
    }
    box.querySelectorAll(".card").forEach(el=>{
      el.onclick=()=> insertAtCursor(`> [${el.dataset.source}] ${el.dataset.title}\n${el.dataset.url}\n`);
    });
    return;
  }

  // ì¼ë°˜ ê²€ìƒ‰
  const list = $$("rightSearchResults");
  list.innerHTML = `<div id="searchBox"><input id="searchInput" value="${esc(q)}"/><button class="btn" id="searchBtn">ê²€ìƒ‰</button></div>
                    <div class="result">ê²€ìƒ‰ ì¤‘â€¦</div>`;
  document.getElementById("searchBtn").onclick=()=>internalSearch(document.getElementById("searchInput").value.trim());

  try{
    const html = await (await fetch(`https://r.jina.ai/http://duckduckgo.com/html/?q=${encodeURIComponent(q)}`)).text();
    const items = [...html.matchAll(/<a[^>]*class="result__a"[^>]*>(.*?)<\/a>[\s\S]*?<a[^>]*href="(http[^"]+)"[\s\S]*?class="result__snippet">(.*?)<\/a>/g)]
      .slice(0,10).map(m=>({ title: stripTags(m[1]), url: decodeURIComponent(m[2].replace(/&amp;/g,'&')), desc: stripTags(m[3])}));

    list.innerHTML = `<div id="searchBox"><input id="searchInput" value="${esc(q)}"/><button class="btn" id="searchBtn">ê²€ìƒ‰</button></div>`;
    document.getElementById("searchBtn").onclick=()=>internalSearch(document.getElementById("searchInput").value.trim());

    for (const r of items){
      try{
        const page = await fetchText(r.url);
        const og=pickOG(page); const pv=firstParagraphs(page,2);
        list.innerHTML += siteCardHTML({title:r.title||og.title||r.url, url:r.url, img:og.image, site:og.site||new URL(r.url).hostname, desc:r.desc||og.desc, preview:pv});
      }catch(e){
        list.innerHTML += siteCardHTML({title:r.title, url:r.url, site:new URL(r.url).hostname, desc:r.desc});
      }
    }
    list.querySelectorAll(".card").forEach(el=>{
      el.onclick=()=> insertAtCursor(`> [${el.dataset.source}] ${el.dataset.title}\n${el.dataset.url}\n`);
    });
  }catch(e){
    window.open(`https://www.google.com/search?q=${encodeURIComponent(q)}`,'_blank');
    window.open(`https://search.naver.com/search.naver?query=${encodeURIComponent(q)}`,'_blank');
    list.innerHTML += `<div class="result">ë¸Œë¼ìš°ì € íƒ­ìœ¼ë¡œ ì—´ì—ˆìŠµë‹ˆë‹¤.</div>`;
  }
}

$$("searchBtn").onclick=()=>internalSearch($$("searchInput").value.trim());
$$("searchInput").addEventListener("keydown",(e)=>{ if(e.key==="Enter"){ e.preventDefault(); $$("searchBtn").click(); }});
</script>

<!-- ===== ì»¤ë§¨ë“œë°”(ê²€ìƒ‰/ì§ˆë¬¸) ===== -->
<script>
async function askOnline(prompt){
  // í•„ìš” ì‹œ ì—¬ê¸°ì— Gemini ë“± ì—°ê²° (í‚¤ê°€ ì—†ìœ¼ë©´ null ë°˜í™˜)
  return null;
}

const HelperModel = {
  // ê°„ë‹¨í•œ ì˜¤í”„ë¼ì¸ ê·œì¹™ ê¸°ë°˜ í—¬í¼ëª¨ë¸ (ë¡œì»¬ í´ë°±)
  async generate(prompt, ctx){
    const plain = ctx?.doc || "";
    const bullets=(txt)=> txt.split(/[.!?]\s+/).slice(0,6).map(s=>"â€¢ "+s.replace(/^[\-â€¢\s]+/,"")).join("\n");
    if(/ìš”ì•½|summary|ì •ë¦¬/.test(prompt)) return `ìš”ì•½:\n${bullets(plain.slice(-1200)||prompt)}`;
    if(/ëª©ì°¨|outline|ìŠ¬ë¼ì´ë“œ|í”„ë ˆì  í…Œì´ì…˜/.test(prompt)) return `# ${prompt}\n\n## ë°°ê²½\n## ë¬¸ì œì •ì˜\n## ë™í–¥\n## í•´ê²°ì „ëµ\n## ì‚¬ë¡€\n## ê²°ë¡ `;
    if(/í‚¤ì›Œë“œ|keywords?/.test(prompt)) {
      const arr=(plain.toLowerCase().match(/[a-zA-Zê°€-í£]{2,}/g)||[]);
      const uniq=[...new Set(arr)].slice(0,12).join(", ");
      return `í•µì‹¬ í‚¤ì›Œë“œ: ${uniq}`;
    }
    // ì¼ë°˜ ë‹µë³€
    return `ë‹µë³€:\n${bullets(prompt)}\n\në‹¤ìŒ ë‹¨ê³„\n- ëª©í‘œ í™•ì •\n- ìë£Œ ìˆ˜ì§‘\n- ì‹¤í—˜/í”„ë¡œí† íƒ€ì…\n- í”¼ë“œë°± ë°˜ì˜\n- ê³µìœ `;
  }
};

async function ask(prompt){
  // 1) ëŒë‹¤ ë¨¼ì € (ìˆìœ¼ë©´)
  const lambda = await window.lambdaBridge.call("chat", { prompt, context: { doc:getPlain(), history:chatHistory.slice(-10) }});
  if (lambda && lambda.ok && lambda.data) return String(lambda.data).trim();

  // 2) ì˜¨ë¼ì¸(Gemini ë“±) â€“ ì„ íƒ
  const online = await askOnline(prompt);
  if (online) return online;

  // 3) ë¡œì»¬ í—¬í¼ëª¨ë¸
  const newsCards=[...document.querySelectorAll("#rightSearchResults .card")].slice(0,6).map(el=>({
    title:el.dataset.title,url:el.dataset.url,desc:(el.querySelector(".meta:last-child")?.textContent||"")
  }));
  return await HelperModel.generate(prompt,{doc:getPlain(),chat:chatHistory,news:newsCards});
}

function setupCommandBar(){
  const cmd=$$("cmdInput"), btn=$$("cmdSend");
  const run=async ()=>{
    const q=cmd.value.trim(); if(!q) return; cmd.value="";
    if(q.startsWith('/search ')||q.startsWith('? ')){ internalSearch(q.replace(/^\/?search\s+|\?\s+/,'').trim()); return; }
    const out=await ask(q); insertAtCursor(out+"\n");
  };
  btn.onclick=run;
  cmd.addEventListener("keydown",(e)=>{ if(e.key==="Enter"&&!e.shiftKey){ e.preventDefault(); run(); }});
}
</script>

<!-- ===== ì±„íŒ… ===== -->
<script>
const THREADS_KEY="th.threads";
function threads(){try{return JSON.parse(localStorage.getItem(THREADS_KEY)||"[]")}catch{return[]}}
function saveThreads(a){localStorage.setItem(THREADS_KEY,JSON.stringify(a||[]))}
let chatHistory=[], threadId=null;

function renderThreads(){
  const arr=threads();
  $$("chatThreads").innerHTML=arr.map(t=>`
    <div class="threadRow" data-tid="${t.id}" ${t.id===threadId?'data-active="1"':''}>
      <div class="threadTitle"><b>${esc(t.title||"ìŠ¤ë ˆë“œ")}</b></div>
      <div style="display:flex;gap:6px">
        <button class="iconbtn" data-rename="${t.id}">âœï¸</button>
        <button class="iconbtn" data-del="${t.id}">ğŸ—‘ï¸</button>
      </div>
    </div>`).join("");

  $$("chatThreads").onclick=(e)=>{
    const r=e.target.closest("[data-rename]"), d=e.target.closest("[data-del]"), o=e.target.closest("[data-tid]");
    if(r){ const id=r.dataset.rename; const arr=threads(); const t=arr.find(x=>x.id===id); if(!t) return; const nt=prompt("ìƒˆ ì œëª©",t.title||"ìŠ¤ë ˆë“œ"); if(nt!=null){ t.title=nt.trim()||"ìŠ¤ë ˆë“œ"; saveThreads(arr); if(threadId===id) $$("threadTitleInput").value=t.title; renderThreads(); } return; }
    if(d){ const id=d.dataset.del; if(confirm("ì‚­ì œí• ê¹Œìš”?")){ const arr=threads().filter(x=>x.id!==id); saveThreads(arr); if(threadId===id){ threadId=null; $$("chatBody").innerHTML=""; } renderThreads(); } return; }
    if(o && !r && !d){ openThread(o.dataset.tid); $$("threadTitleInput").value=(threads().find(x=>x.id===o.dataset.tid)?.title)||""; }
  };
}

function openThread(id){
  const arr=threads(); const t=arr.find(x=>x.id===id); if(!t) return;
  threadId=id; chatHistory=t.history||[]; $$("chatBody").innerHTML="";
  chatHistory.forEach(m=>addBubble(m.content, m.role==="user", false));
  $$("threadTitleInput").value=t.title||"";
  renderThreads();
}

function newThread(){
  const id="t_"+Date.now(); threadId=id;
  const arr=[{id, title:"ìƒˆ ì±„íŒ…", history:[]}, ...threads()]; saveThreads(arr); renderThreads();
  $$("chatBody").innerHTML=""; chatHistory=[]; $$("threadTitleInput").value="ìƒˆ ì±„íŒ…";
}
function persistThread(){
  if(!threadId) newThread();
  const arr=threads(); const idx=arr.findIndex(x=>x.id===threadId);
  const title=$$("threadTitleInput").value.trim() || chatHistory.find(m=>m.role==="user")?.content?.slice(0,20) || "ì±„íŒ…";
  const t={id:threadId, title, history:chatHistory.slice(-50)};
  if(idx>=0) arr[idx]=t; else arr.unshift(t);
  saveThreads(arr); renderThreads();
}
$$("renameThread").onclick=()=>persistThread();
$$("deleteThread").onclick=()=>{ if(!threadId) return; if(confirm("í˜„ì¬ ìŠ¤ë ˆë“œë¥¼ ì‚­ì œí• ê¹Œìš”?")){ const arr=threads().filter(x=>x.id!==threadId); saveThreads(arr); threadId=null; $$("chatBody").innerHTML=""; renderThreads(); } };

const chatDock=$$("chatDock"), chatInput=$$("chatInput");
function openChat(){ chatDock.style.display="flex"; chatDock.setAttribute("aria-hidden","false"); renderThreads(); if(!threadId){newThread();} setTimeout(()=>chatInput?.focus(),0); }
function closeChat(){ chatDock.style.display="none"; chatDock.setAttribute("aria-hidden","true"); }
$$("chatBtn").onclick=openChat; $$("btnNewThread").onclick=newThread; $$("chatClose").onclick=closeChat;

function addBubble(text,me=false,isErr=false){
  const b=document.createElement("div"); b.className="bubble "+(me?"me":"ai")+(isErr?" sys":""); b.textContent=text;
  $$("chatBody").appendChild(b); b.scrollIntoView({behavior:"smooth",block:"end"}); return b;
}
async function typeOut(b,text,delay=6){ b.textContent=""; for(let i=1;i<=text.length;i++){ b.textContent=text.slice(0,i); if(i%3===0) await sleep(delay);} }

$$("chatForm").addEventListener("submit",async (e)=>{
  e.preventDefault();
  const msg=chatInput.value.trim(); if(!msg) return; chatInput.value="";
  addBubble(msg,true); chatHistory.push({role:"user",content:msg});
  const holder=addBubble("â€¦");
  const ans=await ask(msg);
  await typeOut(holder,ans||"(ë¹ˆ ì‘ë‹µ)");
  chatHistory.push({role:"assistant",content:holder.textContent});
  persistThread();
});
</script>

<!-- ===== ì´ˆê¸°í™” ===== -->
<script>
(async function(){
  await initEditor();
  const last=store.current(); if(last) openDoc(last); else newDoc(); renderList();
  setupCommandBar();
  switchTab('search'); // ê¸°ë³¸ ê²€ìƒ‰ íƒ­
})();
</script>
</body>
</html>
