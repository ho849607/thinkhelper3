<!DOCTYPE html>
<html lang="ko" data-theme="light">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>ThinkHelper â€” Editor</title>
<link rel="icon" href="data:,"/>

<!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-NXBQK43Z');</script>
<!-- End Google Tag Manager -->

<!-- CKEditor -->
<script src="https://cdn.ckeditor.com/ckeditor5/41.3.1/classic/ckeditor.js"></script>

<!-- Export (PDFë§Œ ìœ ì§€) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" defer></script>

<!-- WebGazer (ì˜µì…˜) -->
<script src="https://cdn.jsdelivr.net/npm/webgazer/dist/webgazer.min.js" defer></script>

<style>
:root{
  --bg:#f6f8fb; --fg:#0b1020; --muted:#6a7691;
  --panel:#ffffff; --card:#f2f5ff; --border:#d6deee;
  --hover:#e9effe; --accent:#2563eb; --accent-2:#f59e0b;
  --vscode:#1e1e1e; --vscode-2:#252526; --vscode-border:#333842;
}
:root[data-theme="dark"]{
  --bg:#0b1020; --fg:#f1f5ff; --muted:#a8b4cf;
  --panel:#0f172a; --card:#101a30; --border:#273453;
  --hover:#16213b; --accent:#60a5fa; --accent-2:#f59e0b;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--fg);
  font-family:-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif;
  display:flex;flex-direction:column}

/* Topbar */
.topbar{display:flex;gap:8px;align-items:center;padding:10px 12px;background:var(--panel);
  border-bottom:1px solid var(--border);position:sticky;top:0;z-index:40}
.brand{display:flex;align-items:center;gap:8px;font-weight:900}
.logo{width:18px;height:18px;border-radius:4px;background:linear-gradient(135deg,#60a5fa,#34d399)}
.btn{border:1px solid var(--border);background:var(--card);color:var(--fg);
  border-radius:8px;padding:.45rem .7rem;font-weight:900;cursor:pointer}
.btn:hover{background:var(--hover)}
.btn[disabled]{opacity:.6;cursor:not-allowed}

/* Menus */
.menu{position:relative}
.menu>.btn{font-weight:900}
.dropdown{display:none;position:absolute;top:42px;left:0;background:var(--panel);border:1px solid var(--border);
  border-radius:10px;min-width:280px;box-shadow:0 12px 24px rgba(0,0,0,.12);z-index:50}
.dropdown .item{padding:.55rem .7rem;border-bottom:1px dashed var(--border);cursor:pointer;
  display:flex;justify-content:space-between;gap:10px;align-items:center}
.dropdown .item:last-child{border-bottom:none}
.dropdown .item:hover{background:var(--hover)}
.badge{font-size:.72rem;padding:.1rem .35rem;border-radius:6px;border:1px solid var(--border);opacity:.8}

/* Layout */
main{flex:1;min-height:0;display:grid;grid-template-columns:260px 1fr;gap:10px;padding:10px}
@media (max-width:1200px){ main{grid-template-columns:0 1fr; padding:6px} #left{display:none}}
aside#left{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:10px;display:flex;flex-direction:column;min-height:0}
.listHead{display:flex;align-items:center;gap:8px}
#addDoc{margin-left:auto}
#docList{flex:1;overflow:auto;display:flex;flex-direction:column;gap:8px;margin-top:10px}
.notice{opacity:.75;padding:8px}
.doc{display:flex;gap:8px;align-items:center;padding:8px;background:var(--card);border:1px solid var(--border);border-radius:10px;cursor:pointer}
.doc:hover{background:var(--hover)}
.doc .title{flex:1;font-weight:900;color:var(--fg);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.doc .time{font-size:.78rem;color:var(--muted)}
.doc .act{display:none;gap:6px}
.doc:hover .act{display:inline-flex}
.iconbtn{border:1px solid var(--border);background:transparent;color:var(--fg);border-radius:6px;padding:.1rem .35rem;cursor:pointer}
.iconbtn:hover{background:var(--hover)}

section#center{display:flex;flex-direction:column;gap:10px;min-width:0}
#editorWrap{border:1px solid var(--border);border-radius:12px;background:var(--panel);padding:8px;position:relative}
#editor{min-height:62vh}

/* CKEditor ë°°ì§€ ìˆ¨ê¹€ */
.ck-balloon-panel,.ck-powered-by-balloon{display:none!important}
.ck-editor__editable_inline{
  min-height:58vh!important;color:#222;background:#fff;padding:12px;
  padding-bottom:140px;
  border-radius:8px;
  position:relative; z-index:1;
}
[data-theme="dark"] .ck-editor__editable_inline{color:#ffe7b3;background:#0b1327}

/* VSCode ìŠ¤íƒ€ì¼ ì¶”ì²œì–´ */
#suggPopup{position:absolute;display:none;z-index:60;background:var(--panel);color:var(--fg);
  border:1px solid var(--border);border-radius:10px;box-shadow:0 12px 24px rgba(0,0,0,.18);
  min-width:280px;max-width:560px}
#suggPopup header{padding:6px 10px;border-bottom:1px solid var(--border);font-size:.82rem;color:var(--muted)}
#suggPopup ul{list-style:none;margin:0;padding:6px;max-height:260px;overflow:auto}
#suggPopup li{padding:8px 10px;border-radius:8px;display:flex;gap:8px;cursor:pointer;align-items:center}
#suggPopup li[data-active="1"]{background:var(--hover);outline:1.5px solid #8ab4ff66}
.kind{opacity:.75;font-size:.75rem;width:120px;flex:0 0 auto;color:#ffd58a}

/* Search â€” sticky (í•­ìƒ ë³´ì´ê²Œ) */
#searchRow{
  display:flex;gap:10px;padding:10px;background:var(--panel);
  border:1px solid var(--border);border-radius:12px;align-items:flex-start;
  position:sticky; top:10px; z-index:25;
}
#searchBox{flex:1;height:44px;border:2px solid var(--border);border-radius:12px;background:var(--card);color:var(--fg);padding:.6rem .9rem;font-size:16px}
#searchBtn{height:44px}
#suggestList{display:none;position:absolute;left:10px;right:96px;top:60px;background:var(--panel);border:1px solid var(--border);border-radius:10px;box-shadow:0 12px 24px rgba(0,0,0,.15);z-index:26;max-height:240px;overflow:auto}
#suggestList .sugg{padding:.55rem .7rem;border-bottom:1px dashed var(--border);cursor:pointer}
#suggestList .sugg:last-child{border-bottom:none}
#suggestList .sugg[data-active="1"]{background:var(--hover)}

/* Footer */
footer {
  position: fixed; bottom: 0; left: 0; right: 0;
  background: var(--bg); padding: 8px 10px; border-top: 1px solid var(--border);
  font-size: 0.92rem; text-align: center; user-select: none; -webkit-user-select: none;
  pointer-events: none; z-index: 10;
}
footer a{pointer-events:auto;}
body { padding-bottom: 64px; }

/* ê°œë°œì ëª¨ë“œ */
body.dev .topbar, body.dev aside#left, body.dev #editorWrap, body.dev #searchRow{background:var(--vscode); border-color:var(--vscode-border)}
body.dev .btn{background:var(--vscode-2); border-color:var(--vscode-border); color:#e6e6e6}
body.dev .btn:hover{background:#2a2d2e}
body.dev .doc{background:#222; border-color:#333}
body.dev .doc:hover{background:#2a2d2e}
body.dev #searchBox{background:#1f1f1f; border-color:#333; color:#e6e6e6}

/* Chat dock */
#chatBtn{position:fixed;right:16px;bottom:80px;z-index:60}
#chatDock{position:fixed;right:16px;bottom:16px;width:min(92vw,880px);height:74vh;display:none;flex-direction:column;background:var(--panel);border:1px solid var(--border);border-radius:14px;box-shadow:0 18px 36px rgba(0,0,0,.28);z-index:70}
#chatHead{display:flex;align-items:center;gap:8px;justify-content:space-between;padding:12px;border-bottom:1px solid var(--border);font-weight:900}
#chatWrap{flex:1;display:grid;grid-template-columns:220px 1fr;min-height:0}
#chatThreads{border-right:1px solid var(--border);padding:10px;overflow:auto}
.threadRow{display:flex;gap:6px;align-items:center;padding:8px;border:1px solid var(--border);border-radius:10px;background:var(--card);cursor:pointer;margin-bottom:8px}
.threadRow:hover{background:var(--hover)}
.threadRow[data-active="1"]{outline:2px solid #9bbcff}
#chatMain{display:flex;flex-direction:column;min-width:0}
#chatBody{flex:1;overflow:auto;padding:12px;display:flex;flex-direction:column;gap:10px}
.bubble{max-width:85%;padding:.75rem 1rem;border:1px solid var(--border);border-radius:14px;background:var(--card);word-break:break-word;font-size:1.02rem;line-height:1.55;white-space:pre-wrap}
.me{margin-left:auto;background:#143763;color:#fff;border-color:#143763}
.ai{margin-right:auto;border-color:#3b4b72;background:#15284f;color:#fff}
.sys{margin:0 auto;background:#eef2ff;border-style:dashed;color:#111}
#chatForm{display:flex;gap:8px;padding:12px;border-top:1px solid var(--border)}
#chatInput{flex:1;border:1px solid var(--border);border-radius:10px;background:var(--card);color:#000;padding:.75rem .9rem;font-size:1.02rem;resize:vertical}
#quota{position:absolute;left:12px;bottom:12px;background:var(--panel);border:1px solid var(--border);border-radius:8px;padding:.25rem .55rem;font-size:.85rem;color:#666}

/* ì‹œì„  ì»¤ì„œ */
#gazeCursor{
  position:fixed; left:0; top:0; width:18px; height:18px; margin:-9px 0 0 -9px;
  border:2px solid var(--accent); border-radius:50%; pointer-events:none; z-index:120; display:none;
  box-shadow:0 0 0 3px rgba(96,165,250,0.25);
  background:radial-gradient(circle at 50% 50%, rgba(96,165,250,.35), rgba(96,165,250,0) 60%);
  transition: transform 0.05s linear;
}

/* ===== ë™ì˜ ëª¨ë‹¬ ===== */
#consentMask{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:200}
#consentCard{width:min(92vw,720px);max-height:82vh;overflow:auto;background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:16px 16px 12px}
#consentCard h3{margin:0 0 8px}
#consentCard .desc{margin:6px 0 12px;color:var(--muted);line-height:1.55}
#consentCard .box{border:1px solid var(--border);border-radius:12px;padding:10px;margin:8px 0;background:var(--card)}
#consentActions{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}
#btnConsentAgree:disabled{opacity:.6;cursor:not-allowed}
</style>
</head>
<body>
  <!-- Google Tag Manager (noscript) -->
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NXBQK43Z" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <!-- End Google Tag Manager (noscript) -->

  <div class="topbar">
    <div class="brand"><div class="logo"></div><div id="t_brand">ThinkHelper</div></div>

    <!-- ë„êµ¬ -->
    <div class="menu" data-menu>
      <button class="btn" id="t_tools">ë„êµ¬ â–¾</button>
      <div class="dropdown" id="dropTools">
        <div class="item" id="iNew"><span id="t_new">ìƒˆ ë¬¸ì„œ</span><span>âŒ˜/Ctrl+N</span></div>
        <div class="item" id="iSave"><span id="t_export">ë‚´ë³´ë‚´ê¸°/ì¸ì‡„</span><span>âŒ˜/Ctrl+S</span></div>
        <div class="item" id="iVSCode" style="display:none"><span id="t_vscode">VSCodeë¡œ ì—´ê¸°</span><span>â†—</span></div>
      </div>
    </div>

    <!-- ì„¤ì • -->
    <div class="menu" data-menu>
      <button class="btn" id="t_settings">ì„¤ì • â–¾</button>
      <div class="dropdown" id="dropSettings">
        <div class="item"><span id="t_lang">ì–¸ì–´</span>
          <select id="langSel">
            <option value="ko">í•œêµ­ì–´</option><option value="en">English</option><option value="ja">æ—¥æœ¬èª</option>
          </select>
        </div>
        <div class="item" style="justify-content:flex-start;gap:10px">
          <label><input type="checkbox" id="optDeep"> <span id="t_deep">ì‹¬ì¸µ ë¦¬ì„œì¹˜</span></label>
        </div>
        <div class="item" style="justify-content:flex-start;gap:10px">
          <label><input type="checkbox" id="optSugg" checked> <span id="t_sugg">ì œì•ˆì–´ í‘œì‹œ</span></label>
        </div>
        <div class="item" style="justify-content:flex-start;gap:10px">
          <label><input type="checkbox" id="optPersonal" checked> <span id="t_personal">ë§ì¶¤í˜• ì œì•ˆ í‘œì‹œ</span></label>
        </div>
        <div class="item" style="justify-content:flex-start;gap:10px">
          <label><input type="checkbox" id="optGaze"> <span id="t_gaze">ì‹œì„  ì»¤ì„œ(ì›¹ìº )</span></label>
        </div>
        <div class="item">
          <span id="t_mode">ëª¨ë“œ</span>
          <select id="modeSel">
            <option value="normal" data-i18n="mode_normal">ì¼ë°˜ ëª¨ë“œ</option>
            <option value="research" data-i18n="mode_research">ë¦¬ì„œì¹˜ ëª¨ë“œ</option>
            <option value="legal" data-i18n="mode_legal">ë¦¬ê±¸ ëª¨ë“œ</option>
            <option value="dev" data-i18n="mode_dev">ê°œë°œì ëª¨ë“œ</option>
          </select>
        </div>
        <div class="item" id="toggleTheme">ğŸŒ“ <span id="t_theme">í…Œë§ˆ ì „í™˜</span></div>
      </div>
    </div>

    <!-- ë„ì›€ë§ -->
    <div class="menu" data-menu>
      <button class="btn" id="t_help">ë„ì›€ë§ â–¾</button>
      <div class="dropdown">
        <div class="item"><span id="t_keys">ë‹¨ì¶•í‚¤</span><span>âŒ˜/Ctrl+K, âŒ˜/Ctrl+Space</span></div>
        <div class="item"><span id="t_note">ì£¼ì˜</span><span id="t_note_body">AI ê²°ê³¼ëŠ” í•­ìƒ ê²€í† </span></div>
      </div>
    </div>

    <button class="btn" id="chatBtn" style="margin-left:auto">ğŸ’¬ <span id="t_chat">ì±„íŒ…</span></button>
  </div>

  <main>
    <aside id="left" aria-label="ë¬¸ì„œëª©ë¡">
      <div class="listHead">
        <b id="t_docs">ë¬¸ì„œ</b>
        <select id="sortSel" class="btn" style="margin-left:auto">
          <option value="updated" id="t_sort1">ìµœê·¼ ìˆ˜ì •ìˆœ</option>
          <option value="title" id="t_sort2">ì œëª©ìˆœ</option>
          <option value="created" id="t_sort3">ìƒì„±ìˆœ</option>
        </select>
        <button class="btn" id="addDoc" title="ìƒˆ ë¬¸ì„œ ì¶”ê°€">ï¼‹</button>
      </div>
      <div id="docList"></div>
    </aside>

    <section id="center">
      <div id="editorWrap">
        <div id="editor" aria-label="ì—ë””í„°"></div>
        <!-- VSCode ìŠ¤íƒ€ì¼ ì œì•ˆ -->
        <div id="suggPopup">
          <header id="t_sugg_header">ì¶”ì²œ</header>
          <ul id="suggList"></ul>
        </div>
      </div>

      <div id="searchRow">
        <input id="searchBox" placeholder="ê²€ìƒ‰(Enter) / Ctrl+K"/>
        <button class="btn" id="searchBtn"><span id="t_search">ê²€ìƒ‰</span></button>
        <div id="suggestList"></div>
      </div>
    </section>
  </main>

  <footer>
    <div>Â© ThinkHelper â€” âš ï¸ <span id="t_disclaimer">ì¸ê³µì§€ëŠ¥ ëª¨ë¸ì€ ì‹¤ìˆ˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì¤‘ìš”í•œ ì •ë³´ëŠ” ë°˜ë“œì‹œ ì¬ì°¨ í™•ì¸í•˜ì„¸ìš”.</span></div>
    <div id="loc">ğŸ“ <span id="t_loc_wait">ìœ„ì¹˜ í™•ì¸ ì¤‘â€¦</span> Â·
      <a id="lnk_terms" target="_blank" rel="noopener">ì´ìš©ì•½ê´€</a> Â·
      <a id="lnk_privacy" target="_blank" rel="noopener">ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨</a> Â·
      ë¬¸ì˜: <a id="lnk_email" href="mailto:ho849607@gmail.com?subject=ThinkHelper%20ë¬¸ì˜">ho849607@gmail.com</a>
    </div>
  </footer>

  <!-- ì‹œì„  ì»¤ì„œ -->
  <div id="gazeCursor"></div>

  <!-- ë‚´ë³´ë‚´ê¸° ëª¨ë‹¬ -->
  <div id="saveMask" style="position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:120">
    <div id="saveCard" role="dialog" aria-modal="true" style="width:min(92vw,520px);background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:14px">
      <h3 style="margin:0 0 8px" id="t_export_title">ë‚´ë³´ë‚´ê¸° / ì¸ì‡„</h3>
      <div class="save-grid" style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:10px">
        <button class="btn" id="btnExportPDF">PDF</button>
        <button class="btn" id="btnPrint"    >Print</button>
        <button class="btn" disabled>PPT <span class="badge" id="t_coming">ì¤€ë¹„ì¤‘</span></button>
        <button class="btn" disabled>HWP <span class="badge" id="t_coming2">ì¤€ë¹„ì¤‘</span></button>
        <button class="btn" disabled>DOCX <span class="badge" id="t_coming3">ì¤€ë¹„ì¤‘</span></button>
        <button class="btn" id="btnCloseSave" ><span id="t_close">ë‹«ê¸°</span></button>
      </div>
    </div>
  </div>

  <!-- ë™ì˜ ëª¨ë‹¬ -->
  <div id="consentMask">
    <div id="consentCard" role="dialog" aria-modal="true">
      <h3 id="c_title">ë² íƒ€ ì„œë¹„ìŠ¤ ì•ˆë‚´ ë° ë™ì˜</h3>
      <div class="desc" id="c_desc">
        ThinkHelperëŠ” ë² íƒ€ ì„œë¹„ìŠ¤ì´ë©° ë¡œê·¸ì¸ ì—†ì´ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê³„ì† ì´ìš©í•˜ë ¤ë©´ ì•„ë˜ í•­ëª©ì— ë™ì˜í•´ ì£¼ì„¸ìš”.
      </div>

      <div class="box">
        <label style="display:flex;gap:8px;align-items:flex-start">
          <input type="checkbox" id="chkAuto" />
          <span id="c_auto">ìë™ ì œì•ˆ í‘œì‹œ(ì—ë””í„° ì œì•ˆ, ê²€ìƒ‰ ìë™ì™„ì„± í¬í•¨)ì— ë™ì˜í•©ë‹ˆë‹¤. (í•„ìˆ˜)</span>
        </label>
      </div>

      <div class="box">
        <label style="display:flex;gap:8px;align-items:flex-start">
          <input type="checkbox" id="chkPrivacy" />
          <span id="c_priv">ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨ì„ í™•ì¸í–ˆê³  ì´ì— ë™ì˜í•©ë‹ˆë‹¤. (í•„ìˆ˜) â€“
            <a id="c_priv_link" href="#" target="_blank" rel="noopener">ë³´ê¸°</a></span>
        </label>
      </div>

      <div class="box">
        <label style="display:flex;gap:8px;align-items:flex-start">
          <input type="checkbox" id="chkThird" />
          <span id="c_third">ì œ3ì ì •ë³´ ì œê³µ(ì˜ˆ: IP ê¸°ë°˜ ìœ„ì¹˜í™•ì¸, ê²€ìƒ‰ ì œì•ˆ í˜¸ì¶œ ë“±)ì— ë™ì˜í•©ë‹ˆë‹¤. (í•„ìˆ˜)</span>
        </label>
      </div>

      <div class="box">
        <label style="display:flex;gap:8px;align-items:flex-start">
          <input type="checkbox" id="chkPay"/>
          <span id="c_pay">ê²°ì œ/ìš”ê¸ˆ ì•ˆë‚´ ë§í¬ë¥¼ í™•ì¸í–ˆìŠµë‹ˆë‹¤. (ì„ íƒ) â€“
            <a id="c_pay_link" href="#" target="_blank" rel="noopener">ê²°ì œ ì •ë³´</a></span>
        </label>
      </div>

      <div id="consentActions">
        <button class="btn" id="btnConsentAll">ëª¨ë‘ ì„ íƒ</button>
        <button class="btn" id="btnConsentAgree" disabled>ë™ì˜í•˜ê³  ì‹œì‘</button>
      </div>
      <div class="desc" id="c_contact">ë¬¸ì˜: <a id="c_email" href="mailto:ho849607@gmail.com?subject=ThinkHelper%20ë¬¸ì˜">ho849607@gmail.com</a></div>
    </div>
  </div>

  <!-- Chat Dock -->
  <div id="chatDock" role="dialog" aria-hidden="true">
    <div id="chatHead">
      <span id="t_chatTitle">AI ì±„íŒ…</span>
      <div class="actions" style="display:flex;gap:8px;align-items:center">
        <button class="btn" id="btnNewThread" title="ìƒˆ ì±„íŒ…">ï¼‹ ìƒˆ ì±„íŒ…</button>
        <select id="chatProvider" class="btn" disabled title="ë¯¸ìŠ¤íŠ¸ë„ ê³ ì •">
          <option value="mistral" selected>Mistral</option>
          <option value="openai">OpenAI</option>
          <option value="auto">Auto</option>
        </select>
        <button class="btn" id="chatClose" aria-label="Close">âœ–</button>
      </div>
    </div>
    <div id="chatWrap">
      <aside id="chatThreads" aria-label="ì±„íŒ… ìŠ¤ë ˆë“œ"></aside>
      <section id="chatMain">
        <div id="chatBody"></div>
        <form id="chatForm">
          <textarea id="chatInput" rows="2" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš” (Enter=ì „ì†¡, Shift+Enter=ì¤„ë°”ê¿ˆ)"></textarea>
          <button class="btn" type="submit" id="t_send">ì „ì†¡</button>
        </form>
      </section>
    </div>
    <div id="quota">local Â· mistral</div>
  </div>

<script>
/* ============== ë§í¬/ì´ë©”ì¼ ì„¤ì • ============== */
const LINKS = {
  terms: "https://docs.google.com/document/d/1TLZ2m52s1mAd8BPzXDBQuXF6QZ_hLDZOyX6Y8TKALnE/edit?usp=sharing",
  privacy: "https://docs.google.com/document/d/1kmFzmp3ddJOKOp1TPsvsNzAuBKt6M0Vm0N_G5BIOZEE/edit?usp=sharing",
  payment: "https://example.com/payments", // í•„ìš”ì‹œ ì‹¤ì œ ê²°ì œ ì•ˆë‚´ ë§í¬ë¡œ êµì²´
  email: "ho849607@gmail.com"             // ë¬¸ì˜ ì´ë©”ì¼(ìš”ì²­ ë°˜ì˜)
};

/* ===================== i18n ===================== */
const I18N={
  ko:{brand:"ThinkHelper",tools:"ë„êµ¬ â–¾",settings:"ì„¤ì • â–¾",help:"ë„ì›€ë§ â–¾",
      new:"ìƒˆ ë¬¸ì„œ", export:"ë‚´ë³´ë‚´ê¸°/ì¸ì‡„", vscode:"VSCodeë¡œ ì—´ê¸°",
      lang:"ì–¸ì–´", deep:"ì‹¬ì¸µ ë¦¬ì„œì¹˜", sugg:"ì œì•ˆì–´ í‘œì‹œ", personal:"ë§ì¶¤í˜• ì œì•ˆ í‘œì‹œ",
      gaze:"ì‹œì„  ì»¤ì„œ(ì›¹ìº )", mode:"ëª¨ë“œ", theme:"í…Œë§ˆ ì „í™˜",
      mode_normal:"ì¼ë°˜ ëª¨ë“œ", mode_research:"ë¦¬ì„œì¹˜ ëª¨ë“œ", mode_legal:"ë¦¬ê±¸ ëª¨ë“œ", mode_dev:"ê°œë°œì ëª¨ë“œ",
      keys:"ë‹¨ì¶•í‚¤", note:"ì£¼ì˜", note_body:"AI ê²°ê³¼ëŠ” í•­ìƒ ê²€í† ", chat:"ì±„íŒ…",
      docs:"ë¬¸ì„œ", sort1:"ìµœê·¼ ìˆ˜ì •ìˆœ", sort2:"ì œëª©ìˆœ", sort3:"ìƒì„±ìˆœ",
      search:"ê²€ìƒ‰", sugg_header:"ì¶”ì²œ", close:"ë‹«ê¸°",
      disclaimer:"ì¸ê³µì§€ëŠ¥ ëª¨ë¸ì€ ì‹¤ìˆ˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì¤‘ìš”í•œ ì •ë³´ëŠ” ë°˜ë“œì‹œ ì¬ì°¨ í™•ì¸í•˜ì„¸ìš”.",
      chatTitle:"AI ì±„íŒ…", send:"ì „ì†¡",
      loc_wait:"ìœ„ì¹˜ í™•ì¸ ì¤‘â€¦", loc_hidden:"ìœ„ì¹˜ ë¹„ê³µê°œ",
      export_title:"ë‚´ë³´ë‚´ê¸° / ì¸ì‡„", coming:"ì¤€ë¹„ì¤‘",
      placeholder_editor:"ì—¬ê¸°ì„œ ì‘ì„±í•˜ì„¸ìš”â€¦", placeholder_search:"ê²€ìƒ‰(Enter) / Ctrl+K", placeholder_chat:"ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš” (Enter)",
      untitled:"ë¬´ì œ",
      // Consent
      c_title:"ë² íƒ€ ì„œë¹„ìŠ¤ ì•ˆë‚´ ë° ë™ì˜",
      c_desc:"ThinkHelperëŠ” ë² íƒ€ ì„œë¹„ìŠ¤ì´ë©° ë¡œê·¸ì¸ ì—†ì´ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê³„ì† ì´ìš©í•˜ë ¤ë©´ ì•„ë˜ í•­ëª©ì— ë™ì˜í•´ ì£¼ì„¸ìš”.",
      c_auto:"ìë™ ì œì•ˆ í‘œì‹œ(ì—ë””í„° ì œì•ˆ, ê²€ìƒ‰ ìë™ì™„ì„± í¬í•¨)ì— ë™ì˜í•©ë‹ˆë‹¤. (í•„ìˆ˜)",
      c_priv:"ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨ì„ í™•ì¸í–ˆê³  ì´ì— ë™ì˜í•©ë‹ˆë‹¤. (í•„ìˆ˜) â€“ ",
      c_third:"ì œ3ì ì •ë³´ ì œê³µ(ì˜ˆ: IP ê¸°ë°˜ ìœ„ì¹˜í™•ì¸, ê²€ìƒ‰ ì œì•ˆ í˜¸ì¶œ ë“±)ì— ë™ì˜í•©ë‹ˆë‹¤. (í•„ìˆ˜)",
      c_pay:"ê²°ì œ/ìš”ê¸ˆ ì•ˆë‚´ ë§í¬ë¥¼ í™•ì¸í–ˆìŠµë‹ˆë‹¤. (ì„ íƒ) â€“ ",
      c_all:"ëª¨ë‘ ì„ íƒ",
      c_start:"ë™ì˜í•˜ê³  ì‹œì‘",
      c_contact_prefix:"ë¬¸ì˜: "},
  en:{brand:"ThinkHelper",tools:"Tools â–¾",settings:"Settings â–¾",help:"Help â–¾",
      new:"New", export:"Export/Print", vscode:"Open in VSCode",
      lang:"Language", deep:"Deep research", sugg:"Show suggestions", personal:"Personalized suggestions",
      gaze:"Gaze cursor (webcam)", mode:"Mode", theme:"Toggle theme",
      mode_normal:"Normal mode", mode_research:"Research mode", mode_legal:"Legal mode", mode_dev:"Developer mode",
      keys:"Shortcuts", note:"Note", note_body:"Always verify AI results", chat:"Chat",
      docs:"Documents", sort1:"Recently updated", sort2:"Title", sort3:"Created",
      search:"Search", sugg_header:"Suggestions", close:"Close",
      disclaimer:"AI may make mistakes. Always verify important information.",
      chatTitle:"AI Chat", send:"Send",
      loc_wait:"Checking locationâ€¦", loc_hidden:"Location hidden",
      export_title:"Export / Print", coming:"Coming soon",
      placeholder_editor:"Start writingâ€¦", placeholder_search:"Search (Enter) / Ctrl+K", placeholder_chat:"Type & Enter",
      untitled:"Untitled",
      // Consent
      c_title:"Beta notice & consent",
      c_desc:"ThinkHelper is in beta and can be used without login. To continue, please consent to the following:",
      c_auto:"I agree to show suggestions (editor hints and search autocomplete). (Required)",
      c_priv:"I have read and agree to the Privacy Policy. (Required) â€“ ",
      c_third:"I agree to third-party data sharing (e.g., IP geolocation, suggestion APIs). (Required)",
      c_pay:"I have checked the payment/pricing info link. (Optional) â€“ ",
      c_all:"Select all",
      c_start:"Agree & start",
      c_contact_prefix:"Contact: "},
  ja:{brand:"ThinkHelper",tools:"ãƒ„ãƒ¼ãƒ« â–¾",settings:"è¨­å®š â–¾",help:"ãƒ˜ãƒ«ãƒ— â–¾",
      new:"æ–°è¦", export:"æ›¸ãå‡ºã—/å°åˆ·", vscode:"VSCodeã§é–‹ã",
      lang:"è¨€èª", deep:"æ·±å±¤ãƒªã‚µãƒ¼ãƒ", sugg:"ã‚µã‚¸ã‚§ã‚¹ãƒˆè¡¨ç¤º", personal:"ãƒ‘ãƒ¼ã‚½ãƒŠãƒ©ã‚¤ã‚ºè¡¨ç¤º",
      gaze:"è¦–ç·šã‚«ãƒ¼ã‚½ãƒ«(ã‚«ãƒ¡ãƒ©)", mode:"ãƒ¢ãƒ¼ãƒ‰", theme:"ãƒ†ãƒ¼ãƒåˆ‡æ›¿",
      mode_normal:"é€šå¸¸ãƒ¢ãƒ¼ãƒ‰", mode_research:"ãƒªã‚µãƒ¼ãƒãƒ¢ãƒ¼ãƒ‰", mode_legal:"ãƒªãƒ¼ã‚¬ãƒ«ãƒ¢ãƒ¼ãƒ‰", mode_dev:"é–‹ç™ºè€…ãƒ¢ãƒ¼ãƒ‰",
      keys:"ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ", note:"æ³¨æ„", note_body:"AI ã¯é–“é•ãˆã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚é‡è¦ãªæƒ…å ±ã¯å¿…ãšç¢ºèªã—ã¦ãã ã•ã„ã€‚",
      chat:"ãƒãƒ£ãƒƒãƒˆ", docs:"ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ", sort1:"æ›´æ–°é †", sort2:"ã‚¿ã‚¤ãƒˆãƒ«é †", sort3:"ä½œæˆé †",
      search:"æ¤œç´¢", sugg_header:"ãŠã™ã™ã‚", close:"é–‰ã˜ã‚‹",
      disclaimer:"AIã¯é–“é•ãˆã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚é‡è¦ãªæƒ…å ±ã¯å¿…ãšç¢ºèªã—ã¦ãã ã•ã„ã€‚",
      chatTitle:"AI ãƒãƒ£ãƒƒãƒˆ", send:"é€ä¿¡",
      loc_wait:"ä½ç½®ç¢ºèªä¸­â€¦", loc_hidden:"ä½ç½®ã¯éè¡¨ç¤º",
      export_title:"æ›¸ãå‡ºã— / å°åˆ·", coming:"æº–å‚™ä¸­",
      placeholder_editor:"ã“ã“ã«å…¥åŠ›â€¦", placeholder_search:"æ¤œç´¢ï¼ˆEnterï¼‰ / Ctrl+K", placeholder_chat:"å…¥åŠ›ã—ã¦ Enter",
      untitled:"ç„¡é¡Œ",
      // Consent
      c_title:"ãƒ™ãƒ¼ã‚¿é€šçŸ¥ã¨åŒæ„",
      c_desc:"ThinkHelperã¯ãƒ™ãƒ¼ã‚¿ç‰ˆã§ã€ãƒ­ã‚°ã‚¤ãƒ³ä¸è¦ã§åˆ©ç”¨ã§ãã¾ã™ã€‚ç¶šè¡Œã™ã‚‹ã«ã¯ä»¥ä¸‹ã«åŒæ„ã—ã¦ãã ã•ã„ã€‚",
      c_auto:"ã‚µã‚¸ã‚§ã‚¹ãƒˆè¡¨ç¤ºï¼ˆã‚¨ãƒ‡ã‚£ã‚¿ææ¡ˆãƒ»æ¤œç´¢ã®è‡ªå‹•è£œå®Œï¼‰ã«åŒæ„ã—ã¾ã™ã€‚ï¼ˆå¿…é ˆï¼‰",
      c_priv:"ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼ã«åŒæ„ã—ã¾ã™ã€‚ï¼ˆå¿…é ˆï¼‰ â€“ ",
      c_third:"ç¬¬ä¸‰è€…ã¸ã®æƒ…å ±æä¾›ï¼ˆIPä½ç½®æƒ…å ±ã€ã‚µã‚¸ã‚§ã‚¹ãƒˆAPIãªã©ï¼‰ã«åŒæ„ã—ã¾ã™ã€‚ï¼ˆå¿…é ˆï¼‰",
      c_pay:"æ”¯æ‰•ã„æƒ…å ±ãƒªãƒ³ã‚¯ã‚’ç¢ºèªã—ã¾ã—ãŸã€‚ï¼ˆä»»æ„ï¼‰ â€“ ",
      c_all:"ã™ã¹ã¦é¸æŠ",
      c_start:"åŒæ„ã—ã¦é–‹å§‹",
      c_contact_prefix:"ãŠå•ã„åˆã‚ã›: "}
};

const conf={
  lang: localStorage.getItem("th.lang")||"ko",
  mode: localStorage.getItem("th.mode")||"normal",
  deep: localStorage.getItem("th.deep")==="1",
  sugg: localStorage.getItem("th.sugg")!=="0",
  personal: localStorage.getItem("th.personal")!=="0",
  gaze: localStorage.getItem("th.gaze")==="1"
};

function T(k){return (I18N[conf.lang]||I18N.ko)[k];}

/* ===================== ì—ë””í„° ===================== */
let editor=null;
let _rebuilding=false;

async function initEditor(restoreHtml){
  editor = await ClassicEditor.create(
    document.getElementById('editor'),
    { placeholder: (I18N[conf.lang]||I18N.ko).placeholder_editor }
  );
  if(restoreHtml!=null){ editor.setData(restoreHtml); }
  editor.model.document.on("change:data", onType);
  editor.editing.view.document.on("keydown",(evt,data)=>{
    const k=(data.key||"").toLowerCase();
    if((data.ctrlKey||data.metaKey)&&k==="s"){ data.preventDefault(); openSave(); }
    if((data.ctrlKey||data.metaKey)&&k==="k"){ data.preventDefault(); document.getElementById("searchBox").focus(); }
    if((data.ctrlKey||data.metaKey)&&k===" "){ data.preventDefault(); openSuggest(true); }
  });
}

function getHTML(){ return editor ? editor.getData() : ""; }
function setHTML(h){ if(editor) editor.setData(h||""); }

/* ===================== i18n ì ìš© & ë§í¬ ì£¼ì… ===================== */
async function applyI18N(){
  const t=I18N[conf.lang]||I18N.ko;
  document.title = `${t.brand} â€” Editor`;

  const map={
    t_brand:t.brand,t_tools:t.tools,t_settings:t.settings,t_help:t.help,t_new:t.new,t_export:t.export,
    t_vscode:t.vscode,t_lang:t.lang,t_deep:t.deep,t_sugg:t.sugg,t_personal:t.personal,t_gaze:t.gaze,
    t_mode:t.mode,t_theme:t.theme,t_keys:t.keys,t_note:t.note,t_note_body:t.note_body,t_chat:t.chat,
    t_docs:t.docs,t_sort1:t.sort1,t_sort2:t.sort2,t_sort3:t.sort3,t_search:t.search,t_sugg_header:t.sugg_header,
    t_disclaimer:t.disclaimer,t_chatTitle:t.chatTitle,t_send:t.send,t_export_title:t.export_title,
    t_coming:t.coming,t_coming2:t.coming,t_coming3:t.coming,t_close:t.close,t_loc_wait:t.loc_wait
  };
  for(const id in map){ const el=document.getElementById(id); if(el) el.textContent=map[id]; }

  document.getElementById("searchBox").placeholder=t.placeholder_search;
  const ci=document.getElementById("chatInput"); if(ci) ci.placeholder=t.placeholder_chat;
  document.querySelectorAll("#modeSel option").forEach(op=>{
    const key=op.getAttribute("data-i18n"); if(key && t[key]) op.textContent=t[key];
  });

  // í‘¸í„° ë§í¬/ì´ë©”ì¼
  const terms = document.getElementById("lnk_terms");
  const privacy = document.getElementById("lnk_privacy");
  const email = document.getElementById("lnk_email");
  terms.textContent = conf.lang==="ja"?"åˆ©ç”¨è¦ç´„":(conf.lang==="en"?"Terms":"ì´ìš©ì•½ê´€");
  privacy.textContent = conf.lang==="ja"?"ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼":(conf.lang==="en"?"Privacy":"ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨");
  terms.href = LINKS.terms; privacy.href = LINKS.privacy;
  email.href = `mailto:${LINKS.email}?subject=ThinkHelper%20${encodeURIComponent(conf.lang==="ko"?"ë¬¸ì˜":"Support")}`;
  email.textContent = LINKS.email;

  // ë™ì˜ ëª¨ë‹¬ í…ìŠ¤íŠ¸
  document.getElementById("c_title").textContent=t.c_title;
  document.getElementById("c_desc").textContent=t.c_desc;
  document.getElementById("c_auto").textContent=t.c_auto;
  document.getElementById("c_priv").firstChild.nodeValue = t.c_priv;
  document.getElementById("c_third").textContent=t.c_third;
  document.getElementById("c_pay").firstChild.nodeValue = t.c_pay;
  document.getElementById("btnConsentAll").textContent=t.c_all;
  document.getElementById("btnConsentAgree").textContent=t.c_start;
  const ce = document.getElementById("c_contact");
  ce.firstChild.nodeValue = t.c_contact_prefix;
  // ë§í¬
  document.getElementById("c_priv_link").href = LINKS.privacy;
  document.getElementById("c_pay_link").href = LINKS.payment;
  document.getElementById("c_email").href = `mailto:${LINKS.email}?subject=ThinkHelper%20${encodeURIComponent(conf.lang==="ko"?"ë¬¸ì˜":"Support")}`;
  document.getElementById("c_email").textContent = LINKS.email;

  // ì—ë””í„° ë‚´ìš© ë³´ì¡´/ë³µì› (ì–¸ì–´ ì „í™˜ ì‹œ)
  if(editor && !_rebuilding){
    _rebuilding=true;
    const htmlBefore=getHTML();
    const hadFocus=document.activeElement && document.activeElement.closest('#editorWrap');
    await editor.destroy(); editor=null;
    await initEditor(htmlBefore);
    if(hadFocus){ document.querySelector('.ck-editor__editable')?.focus(); }
    _rebuilding=false;
  }

  renderList(true);
}

/* ì´ˆê¸° UI ê°’ ì£¼ì… + ë™ì˜/ì–¸ì–´ ì²˜ë¦¬(ë™ì˜ ë¨¼ì €) */
document.addEventListener('DOMContentLoaded', async ()=>{
  document.getElementById("langSel").value=conf.lang;
  document.getElementById("modeSel").value=conf.mode;
  document.getElementById("optDeep").checked=conf.deep;
  document.getElementById("optSugg").checked=conf.sugg;
  document.getElementById("optPersonal").checked=conf.personal;
  document.getElementById("optGaze").checked=conf.gaze;

  await initEditor();
  await applyI18N();
  openConsentIfNeeded();              // âœ… ë“¤ì–´ì˜¤ìë§ˆì ë™ì˜ì°½ í‘œì‹œ(ìµœì´ˆ 1íšŒ)
  await detectGeoAndMaybeSetLang();   // ì´í›„ IP ê¸°ë°˜ ì–¸ì–´ ìë™ ì „í™˜
});

/* ===================== ë©”ë‰´ í† ê¸€(ë‹«í˜ ë°©ì§€) ===================== */
(function(){
  const menus=[...document.querySelectorAll('[data-menu]')];
  function closeAll(){ document.querySelectorAll('.dropdown').forEach(d=> d.style.display='none'); }
  function toggle(btn){
    const drop=btn.nextElementSibling; if(!drop) return;
    const willOpen = drop.style.display!=='block';
    closeAll(); drop.style.display = willOpen ? 'block' : 'none';
  }
  menus.forEach(m=>{
    const btn=m.querySelector('.btn'); const drop=m.querySelector('.dropdown'); if(!btn||!drop) return;
    btn.addEventListener('click',(e)=>{ e.stopPropagation(); toggle(btn); });
    ['pointerdown','click','change','input'].forEach(ev=> drop.addEventListener(ev,(e)=> e.stopPropagation()));
  });
  document.addEventListener('click',(e)=>{ if(!e.target.closest('[data-menu]')) closeAll(); });
})();

/* ===================== í…Œë§ˆ & ëª¨ë“œ ===================== */
const bodyEl = document.body;
function applyMode(){
  bodyEl.classList.toggle('dev', conf.mode==='dev');
  document.getElementById('iVSCode').style.display = conf.mode==='dev' ? 'block':'none';
}
document.getElementById('modeSel').addEventListener('change', async (e)=>{
  e.stopPropagation(); conf.mode=e.target.value; localStorage.setItem("th.mode", conf.mode); applyMode();
});
document.getElementById('toggleTheme').addEventListener('click', (e)=>{
  e.stopPropagation();
  const isDark = document.documentElement.getAttribute('data-theme')==='dark';
  document.documentElement.setAttribute('data-theme', isDark?'light':'dark');
});
applyMode();

/* ===================== ì–¸ì–´ ë³€ê²½ ===================== */
document.getElementById("langSel").addEventListener('change', async (e)=>{
  e.stopPropagation(); conf.lang=e.target.value; localStorage.setItem("th.lang",conf.lang); await applyI18N();
});

/* ===================== ë¡œì»¬ ì €ì¥ì†Œ(ë¬¸ì„œ) ===================== */
const store={listKey:"th.docs.list", docKey:id=>`th.doc.${id}`, curKey:"th.cur",
  list(){try{return JSON.parse(localStorage.getItem(this.listKey)||"[]")}catch(e){return[]}},
  saveList(a){localStorage.setItem(this.listKey,JSON.stringify(a||[]))},
  get(id){try{return JSON.parse(localStorage.getItem(this.docKey(id))||"null")}catch(e){return null}},
  set(id,o){localStorage.setItem(this.docKey(id),JSON.stringify(o))},
  remove(id){localStorage.removeItem(this.docKey(id))},
  current(){return localStorage.getItem(this.curKey)||""},
  setCurrent(id){localStorage.setItem(this.curKey,id||"")}
};
let curId="";
function defaultTitle(){ return (I18N[conf.lang]||I18N.ko).untitled; }
function ensureTitleMap(doc){
  if(!doc.titleMap){
    const t=doc.title||defaultTitle();
    doc.titleMap={ko:t,en:t,ja:t};
  }
}
function listTitleFor(doc){ ensureTitleMap(doc); return doc.titleMap[conf.lang]||defaultTitle(); }

function renderList(migrate=false){
  const sort=document.getElementById("sortSel").value;
  const list=store.list();
  if(migrate){
    list.forEach(it=>{
      const d=store.get(it.id); if(!d) return; ensureTitleMap(d);
      const allUntitled = Object.values(d.titleMap).every(v=>["ë¬´ì œ","Untitled","ç„¡é¡Œ"].includes(v));
      if(allUntitled){ d.titleMap[conf.lang]=defaultTitle(); store.set(it.id,d); it.title=d.titleMap[conf.lang]; }
    });
  }
  list.sort((a,b)=>{
    const at=listTitleFor(store.get(a.id)||a), bt=listTitleFor(store.get(b.id)||b);
    return sort==="title" ? at.localeCompare(bt) :
           sort==="created"?((a.createdAt||0)-(b.createdAt||0)) :
           ((b.updatedAt||0)-(a.updatedAt||0));
  });
  const el=document.getElementById("docList");
  el.innerHTML = list.map(d=>{
    const dd=store.get(d.id)||d; ensureTitleMap(dd);
    const when=new Date(d.updatedAt||d.createdAt||Date.now()).toLocaleString();
    const title = escapeHtml(listTitleFor(dd));
    return `<div class="doc" data-open="${d.id}">
      <div class="title" title="${title}">${title}</div>
      <div class="time">${when}</div>
      <div class="act"><button class="iconbtn" data-rename="${d.id}">âœï¸</button><button class="iconbtn" data-del="${d.id}">âœ–</button></div>
    </div>`;
  }).join("") || `<div class="notice">${conf.lang==="ko"?"ì €ì¥ëœ ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤.":conf.lang==="ja"?"ä¿å­˜ã•ã‚ŒãŸãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“ã€‚":"No saved documents."}`;
  el.onclick=(e)=>{
    const r=e.target.closest("[data-rename]"); const d=e.target.closest("[data-del]");
    if(r){
      const id=r.dataset.rename; const doc=store.get(id); ensureTitleMap(doc);
      const t=prompt((I18N[conf.lang]||I18N.ko).new+" "+(I18N[conf.lang]||I18N.ko).docs+":", doc.titleMap[conf.lang]||defaultTitle())||defaultTitle();
      doc.titleMap[conf.lang]=t; doc.updatedAt=Date.now(); store.set(id,doc);
      const L=store.list().map(x=>x.id===id?{...x,title:t,updatedAt:doc.updatedAt}:x); store.saveList(L); renderList();
      return;
    }
    if(d){
      const id=d.dataset.del;
      if(confirm(conf.lang==="ko"?"ì‚­ì œí• ê¹Œìš”?":conf.lang==="ja"?"å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ":"Delete?")){
        store.remove(id); store.saveList(store.list().filter(x=>x.id!==id)); if(curId===id){curId=""; setHTML("");} renderList();
      }
      return;
    }
    const row=e.target.closest("[data-open]"); if(row) openDoc(row.dataset.open);
  };
}
document.getElementById("sortSel").onchange=()=>renderList();
document.getElementById("addDoc").onclick=newDoc;

function newDoc(){
  const id="d_"+Date.now(); curId=id; store.setCurrent(id);
  const row={id, createdAt:Date.now(), updatedAt:Date.now(), titleMap:{ko:defaultTitle(),en:defaultTitle(),ja:defaultTitle()}};
  store.saveList([row,...store.list().filter(x=>x.id!==id)]);
  setHTML(""); store.set(id,{id, createdAt:row.createdAt, updatedAt:row.updatedAt, titleMap:row.titleMap, payload:btoa(unescape(encodeURIComponent("")))});
  renderList();
}
function doSave(){
  if(!curId) newDoc();
  const html=getHTML(); const doc=store.get(curId)||{id:curId};
  doc.payload=btoa(unescape(encodeURIComponent(html)));
  ensureTitleMap(doc);
  const title=prompt((I18N[conf.lang]||I18N.ko).docs+" "+(I18N[conf.lang]||I18N.ko).new+":",doc.titleMap[conf.lang]||defaultTitle())||defaultTitle();
  doc.titleMap[conf.lang]=title; doc.updatedAt=Date.now(); store.set(curId,doc);
  const list=store.list().filter(x=>x.id!==curId);
  list.unshift({id:curId,createdAt:doc.createdAt||Date.now(),updatedAt:doc.updatedAt});
  store.saveList(list); renderList();
}
function openDoc(id){ const d=store.get(id); if(!d) return; curId=id; store.setCurrent(id); const html=decodeURIComponent(escape(atob(d.payload||""))); setHTML(html||""); }
function escapeHtml(s){
  return String(s ?? "")
    .replace(/[&<>"']/g, m => ({
      "&": "&amp;",
      "<": "&lt;",
      ">": "&gt;",
      "\"": "&quot;",
      "'": "&#39;"
    }[m]));
}

/* ë‹¨ì¶•í‚¤ */
document.addEventListener("keydown",(e)=>{
  const k=(e.key||"").toLowerCase();
  if((e.metaKey||e.ctrlKey)&&k==="n"){ e.preventDefault(); newDoc(); }
  if((e.metaKey||e.ctrlKey)&&k==="s"){ e.preventDefault(); openSave(); }
  if((e.metaKey||e.ctrlKey)&&k==="k"){ e.preventDefault(); document.getElementById("searchBox").focus(); }
});

/* ===================== ê²€ìƒ‰ ìë™ì™„ì„±(ì›¹ ì œì•ˆ) ===================== */
const suggBox = document.getElementById('suggestList');
let sIndex=-1, sItems=[];
async function fetchSuggest(q){
  if(!q){ suggBox.style.display='none'; return; }
  try{
    const r = await fetch('https://suggestqueries.google.com/complete/search?client=firefox&q='+encodeURIComponent(q));
    const j = await r.json();
    sItems = (j && j[1]) ? j[1].slice(0,8) : [];
    renderSuggest();
  }catch{ sItems=[]; suggBox.style.display='none'; }
}
function renderSuggest(){
  if(!sItems.length){ suggBox.style.display='none'; return; }
  suggBox.innerHTML = sItems.map((t,i)=>`<div class="sugg" data-i="${i}" ${i===sIndex?'data-active="1"':''}>${escapeHtml(t)}</div>`).join("");
  suggBox.style.display='block';
}
const searchBox=document.getElementById('searchBox');
searchBox.addEventListener('input',()=> fetchSuggest(searchBox.value.trim()));
searchBox.addEventListener('keydown',(e)=>{
  if(suggBox.style.display!=='block') return;
  if(e.key==='ArrowDown'){ e.preventDefault(); sIndex=(sIndex+1)%sItems.length; renderSuggest(); }
  else if(e.key==='ArrowUp'){ e.preventDefault(); sIndex=(sIndex-1+sItems.length)%sItems.length; renderSuggest(); }
  else if(e.key==='Tab' || e.key==='Enter'){ if(sIndex>=0){ e.preventDefault(); searchBox.value=sItems[sIndex]; suggBox.style.display='none'; } }
});
suggBox.addEventListener('click',(e)=>{ const it=e.target.closest('.sugg'); if(!it) return; const i=+it.dataset.i; searchBox.value=sItems[i]; suggBox.style.display='none'; });

/* ===================== (ê°œì„ ) í•œê¸€ ì´ˆì„±/ìŒììŒ ì¶”ì²œ + ì¼ë°˜ ì‚¬ì „ ===================== */
const DICT_KO_INIT = {
  "ã„±":["ê°€ì¹˜","ê°€ëŠ¥","ê°€ì´ë“œ","ê°€ì†","ê°€ìƒ","ê²€ìƒ‰","ê²°ê³¼","ê³„ì •","ê³µìœ ","êµ¬ë…","êµ¬ì„±","ê¸°ëŠ¥","ê¸°ë¡","ê¸°ë„","ê¸°ë³¸","ê¸°ì–µ","ê¸°ì¤€","ê¸°íš"],
  "ã„²":["ê¹¨ì§","êº¼ì§","ë„ê¸°","ëë‚´ê¸°","ê¾¸ë¯¸ê¸°","ê¼¼ê¼¼","ê»ì§ˆ","ëŠê¹€"],
  "ã„´":["ë‚´ìš©","ë‚´ë³´ë‚´ê¸°","ë„¤íŠ¸ì›Œí¬","ë…¸íŠ¸","ë…¸ì¶œ","ë†’ì„","ëˆ„ì ","ë‰´ìŠ¤","ë‰´ëŸ´"],
  "ã„·":["ë‹¤ìš´ë¡œë“œ","ë‹¤ë“¬ê¸°","ë‹¤ì‹œ","ë‹¨ì¶•í‚¤","ë‹«ê¸°","ëŒ€ì‹œë³´ë“œ","ëŒ€í™”","ë„êµ¬","ë„ì›€ë§","ë™ê¸°í™”"],
  "ã„¸":["ë”°ë¼ì“°ê¸°","ë•Œë¬¸","ë– ì˜¤ê¸°","ë˜ëŠ”","ë˜‘ë˜‘"],
  "ã„¹":["ë¼ë²¨","ë¼ì¸","ëœë“œ","ë¡œê·¸","ë¡œë”©","ë¡œì»¬","ë¦¬ìŠ¤íŠ¸","ë¦¬ë·°","ë¼ì´ì„ ìŠ¤","ë¦¬ì…‹","ë¦¬ì†ŒìŠ¤"],
  "ã…":["ë§ˆí¬ë‹¤ìš´","ë§Œë“¤ê¸°","ë©”ì¼","ë©”ëª¨","ë©”ëª¨ë¦¬","ë©”ë‰´","ë©”ì‹œì§€","ëª¨ë“œ","ëª¨ë¸","ë¬¸ì„œ","ë¯¸ë¦¬ë³´ê¸°"],
  "ã…‚":["ë°”ê¾¸ê¸°","ë°˜ë³µ","ë°œê²¬","ë²„ì „","ë²ˆì—­","ë°±ì—…","ë³€ìˆ˜","ë³€í™˜","ë³´ë‚´ê¸°","ë³´ì•ˆ","ë³µì‚¬","ë¶€ë¶„","ë¶„ì„","ë¶ˆëŸ¬ì˜¤ê¸°","ë·°ì–´"],
  "ã…ƒ":["ë¹¨ë¦¬","ë¼ˆëŒ€","ë¿ë§Œ"],
  "ã……":["ì‚¬ì „","ì„¤ì •","ì„œì‹","ì„œë¸Œ","ì„œëª…","ì„ íƒ","ì„±ëŠ¥","ì„¸ë¶€","ì†Œì…œ","ì†¡ì‹ ","ìˆ˜ë™","ìˆ˜ì •","ìŠ¤í¬ë¦½íŠ¸","ìŠ¤ëƒ…ìƒ·","ìŠ¤ë§ˆíŠ¸","ì‹œì‘","ì‹œìŠ¤í…œ","ì‹ ê·œ","ì‹ ë¢°","ì‹¤í–‰"],
  "ã…†":["ìŒììŒ","ì¨ë³´ê¸°","ì“°ë ˆë“œ","ì“°ì„ìƒˆ"],
  "ã…‡":["ì•„ì¹´ì´ë¸Œ","ì•Œë¦¼","ì•¡ì…˜","ì—ë””í„°","ì—°ê²°","ì—°ë™","ì—´ê¸°","ì˜ˆì•½","ì˜¤ë¥˜","ì˜µì…˜","ì™„ë£Œ","ì™¸ë¶€","ìš”ì•½","ìš°ì„ ìˆœìœ„","ìœ„ì ¯","ìœ„ì¹˜","ìœ ì§€","ìœ í‹¸","ì˜ê²¬","ì´ë ¥","ì´ìš©","ì„ì‹œ","ì…ë ¥"],
  "ã…ˆ":["ìë§‰","ìë™","ìë£Œ","ì‘ì—…","ì˜ë¼ë‚´ê¸°","ì ê¸ˆ","ì €ì¥","ì „ì†¡","ì „í™˜","ì •ë ¬","ì •ë³´","ì œê±°","ì œì•ˆ","ì œë¥¼","ì¡°ì •","ì£¼ì„","ì¤‘ë‹¨","ì¦ê²¨ì°¾ê¸°"],
  "ã…‰":["ì§œì„ìƒˆ","ìª¼ê°œê¸°","ì­‰"],
  "ã…Š":["ì°¨ë‹¨","ì°¨íŠ¸","ì°¸ê³ ","ì°¾ê¸°","ì²˜ë¦¬","ì²¨ë¶€","ì²´í¬","ì´ˆê¸°í™”","ìµœì í™”","ì¶”ê°€","ì¶”ì²œ","ì¶•ì•½","ì·¨ì†Œ"],
  "ã…‹":["ì¹´ë“œ","ì¹´ë©”ë¼","ìºì‹œ","ìº˜ë¦°ë”","ì»¤ì„œ","ì»¤ìŠ¤í…€","ì»¬ëŸ¼","ì¼€ì–´","ì½”ë“œ","ì½”ë©˜íŠ¸","ì½˜í…ì¸ ","ì¿¼ë¦¬","í€µ","í´ë¼ìš°ë“œ","í´ë¦½","í‚¤ë³´ë“œ","í‚¤ì›Œë“œ"],
  "ã…Œ":["íƒ€ê²Ÿ","íƒ€ì„ë¼ì¸","íƒœê·¸","íƒìƒ‰","í†µê³„","í†µí•©","íˆ¬ëª…","íŠ¸ë˜í”½","íŠ¸ë¦¬ê±°","íŠ¹ì§•"],
  "ã…":["íŒŒì¼","íŒŒíŠ¸","íŒ¨ë„","íŒ¨ì¹˜","íŒ¨í„´","íŒì—…","í‰ê°€","í˜ì´ì§€","í¸ì§‘","í‘œì‹œ","í”„ë¡¬í”„íŠ¸","í”„ë¡œí•„","í”ŒëŸ¬ê·¸ì¸","í”Œë¡œìš°"],
  "ã…":["í•˜ì´ë¼ì´íŠ¸","í•˜ê¸°","í•™ìŠµ","í™•ì¸","í™˜ê²½","í™œì„±í™”","íšŒìˆ˜","íšŒì „","íš¨ìœ¨","í›„ê¸°","íœ´ì§€í†µ"]
};
// ê¸°ë³¸ ì˜/ì¼/í•œ ë‹¨ì–´ ì˜ˆì‹œ(ìœ ì§€)
const DICT_KO = ["ì¸ê°„","ì¸ê³µ","ì¸ê³µì§€ëŠ¥","ì¸ê¶Œ","ì¸êµ¬","ì¸ê°","ì¸ì¦","ì¸ì‹","ì¸ì","ì¸ì¬","ì¸í„°ë„·","ì¸í„°í˜ì´ìŠ¤","ì¸ì²´","ì¸ì‡„","ì¸ìˆ˜","ì¸ìš©","ì¸í”„ë¼","ì¸í„´","ì¸ìƒ","ì¸í•˜"];
const DICT_EN = {a:["apple","array","algorithm","analysis","assistant","automation","authority"],b:["banana","binary","browser","backend","balance","behavior","buffer"],c:["cat","cache","client","cloud","compile","control","cursor"],d:["data","debug","design","device","docker","domain"],e:["edge","email","encode","engine","error","event"],f:["file","filter","frontend","function","framework"],g:["game","gateway","general","graphic","guide","gpu"],h:["hash","header","helper","history","host","hyperlink"],i:["image","index","input","interface","internet","issue","iteration"],j:["javascript","job","json","judge","join"],k:["kernel","key","keyword","knowledge"],l:["lambda","language","latency","library","link","load","logic","loop"],m:["machine","memory","message","method","model","module","monitor"],n:["name","namespace","network","node","notion","number"],o:["object","observer","offline","open","option","output"],p:["package","page","parse","pattern","performance","policy","prompt"],q:["query","queue","quick","quote"],r:["random","react","reasoning","record","redirect","request","response","router"],s:["sample","scale","schema","script","search","security","server","stream"],t:["table","task","template","thread","token","tool","type"],u:["unit","update","upload","user","utility"],v:["validate","value","variable","vector","version","visualization"],w:["web","window","worker","workflow","write"],x:["xml","xrange","xgboost"],y:["yaml","yield"],z:["zero","zip"]};
const DICT_JA = ["ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆ","ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹","ã‚¤ãƒ³ãƒ•ãƒ©","ã‚¤ãƒ³ã‚µã‚¤ãƒˆ","ã‚¤ãƒ³ãƒãƒ¼ãƒˆ","äººå·¥çŸ¥èƒ½","èªè­˜","å°åˆ·","å¼•ç”¨","å…¥åŠ›","æ”¹å–„","é–‹ç™º","å­¦ç¿’","æ¤œç´¢"];
const TOKEN_RE=/[A-Za-z0-9ê°€-í£ã-ã‚”ã‚¡-ãƒ´ãƒ¼ä¸€-é¾ ã€…ã€†ãƒµãƒ¶ãƒ¼]+/g;

// ì´ˆì„± ê³„ì‚°(ê°€~í£ ë²”ìœ„)
const CHO_LIST = ["ã„±","ã„²","ã„´","ã„·","ã„¸","ã„¹","ã…","ã…‚","ã…ƒ","ã……","ã…†","ã…‡","ã…ˆ","ã…‰","ã…Š","ã…‹","ã…Œ","ã…","ã…"];
function getChoseongOfChar(ch){
  const code=ch.charCodeAt(0);
  if(code<0xAC00 || code>0xD7A3) return ""; // í•œê¸€ ìŒì ˆ ì•„ë‹˜
  const idx = Math.floor((code-0xAC00)/588);
  return CHO_LIST[idx] || "";
}
function getPlain(){ return getHTML().replace(/<[^>]+>/g," "); }
function currentToken(){
  const t=getPlain(); const parts=t.match(TOKEN_RE)||[];
  return parts[parts.length-1]||"";
}
function langOfToken(tok){
  if(/[ê°€-í£ã„±-ã…]/.test(tok)) return "ko";
  if(/[ã-ã‚”ã‚¡-ãƒ´ãƒ¼ä¸€-é¾ ã€…ã€†ãƒµãƒ¶]/.test(tok)) return "ja";
  if(/^[A-Za-z0-9]+$/.test(tok)) return "en";
  return "en";
}
function suggestFromDict(tok){
  const L=langOfToken(tok);
  const max=10;
  if(!tok) return [];

  if(L==="ko"){
    // 1) ì´ˆì„±ë§Œ ì…ë ¥ ì‹œ(ã„±~ã…/ìŒììŒ í¬í•¨) â†’ í•´ë‹¹ ì´ˆì„± ì‚¬ì „ ì œì•ˆ
    if(/^[ã„±-ã…]$/.test(tok)){
      return (DICT_KO_INIT[tok]||[]).slice(0,max);
    }
    // 2) í•œê¸€ ìŒì ˆ ì…ë ¥ ì‹œ â†’ í•´ë‹¹ ë‹¨ì–´ ì‹œì‘ ì´ˆì„±ê³¼ ì¼ë°˜ ì‚¬ì „ì„ í•¨ê»˜ ì¶”ì²œ
    const ch0 = tok[0];
    const cho = /[ê°€-í£]/.test(ch0) ? getChoseongOfChar(ch0) : "";
    const fromCho = cho ? (DICT_KO_INIT[cho]||[]).filter(w=>w.startsWith(tok[0])) : [];
    const fromWhole = DICT_KO.filter(w=>w.startsWith(tok));
    // ì¤‘ë³µ ì œê±° í›„ í•©ì¹˜ê¸°
    const seen=new Set(), out=[];
    for(const arr of [fromWhole, fromCho]){
      for(const w of arr){
        if(!seen.has(w)){ out.push(w); seen.add(w); if(out.length>=max) break; }
      }
      if(out.length>=max) break;
    }
    return out.length?out: (DICT_KO_INIT[cho]||[]).slice(0,max);
  }else if(L==="en"){
    const t=tok.toLowerCase();
    const pool=(DICT_EN[t[0]]||[]).concat(...Object.values(DICT_EN));
    const seen=new Set(), res=[];
    for(const w of pool){
      if(w.startsWith(t) && !seen.has(w)){ res.push(w); seen.add(w); if(res.length>=max) break; }
    }
    return res;
  }else{
    return DICT_JA.filter(w=>w.startsWith(tok)).slice(0,max);
  }
}

/* VSCode ìŠ¤íƒ€ì¼ íŒì—… */
const suggPopup=document.getElementById("suggPopup"), suggList=document.getElementById("suggList");
let eItems=[], eSel=-1, hideUntilNextType=false;
function caretRect(){
  const sel=window.getSelection(); if(!sel||sel.rangeCount===0) return null;
  const r=sel.getRangeAt(0).cloneRange(); r.collapse(true);
  const rects=r.getClientRects(); if(!rects.length) return null; return rects[0];
}
function openSuggest(force){
  if(!conf.sugg) return closeSuggest();
  if(hideUntilNextType){ hideUntilNextType=false; return; }
  const token=currentToken();
  if(!token && !force) return closeSuggest();
  const items=suggestFromDict(token);
  if(!items.length) return closeSuggest();
  eItems=items; eSel=-1;
  const L=langOfToken(token);
  const kindLabel=(L==="ko"?"êµ­ì–´ì‚¬ì „":L==="en"?"English":"æ—¥æœ¬èª");
  suggList.innerHTML=items.map((it,i)=>`<li data-i="${i}"><span class="kind">${kindLabel}</span><span>${escapeHtml(it)}</span></li>`).join("");
  Array.from(suggList.children).forEach(li=> li.onclick=()=> choose(+li.dataset.i));
  const r=caretRect(); if(!r){ closeSuggest(); return; }
  const host=document.getElementById("editorWrap").getBoundingClientRect();
  suggPopup.style.left=Math.max(6,(r.left-host.left))+"px";
  suggPopup.style.top=(r.bottom-host.top+6)+"px";
  suggPopup.style.display="block";
}
function closeSuggest(){ suggPopup.style.display='none'; eItems=[]; eSel=-1; }
document.addEventListener("keydown",(e)=>{
  if(suggPopup.style.display!=="block") return;
  const list=Array.from(document.querySelectorAll("#suggList li")); if(!list.length) return;
  if(e.key==="ArrowDown"){ e.preventDefault(); eSel=(eSel+1)%list.length; markSel(); }
  else if(e.key==="ArrowUp"){ e.preventDefault(); eSel=(eSel-1+list.length)%list.length; markSel(); }
  else if(e.key==="Enter"||e.key==="Tab"){ e.preventDefault(); if(eSel<0) eSel=0; choose(eSel); }
  else if(e.key==="Escape"){ e.preventDefault(); closeSuggest(); }
});
function markSel(){ Array.from(document.querySelectorAll("#suggList li")).forEach((li,i)=> li.setAttribute("data-active", i===eSel? "1":"0")); }
function choose(i){
  const it=eItems[i]; if(!it) return;
  const tok=currentToken();
  // í˜„ì¬ í† í° ì´ì–´ë¶™ì´ê¸°
  editor.model.change(w=> editor.model.insertContent(w.createText(it.slice(tok.length)+" ")));
  closeSuggest(); hideUntilNextType=true;
}
function onType(){ if(conf.sugg) openSuggest(false); }

/* ===================== ë‚´ë³´ë‚´ê¸° ===================== */
const saveMask=document.getElementById('saveMask');
function openSave(){ saveMask.style.display='flex'; }
document.getElementById('iSave').onclick=openSave;
document.getElementById('btnCloseSave').onclick=()=>{ saveMask.style.display='none'; };
saveMask.addEventListener('click',(e)=>{ if(e.target===saveMask) saveMask.style.display='none'; });
document.getElementById('btnPrint').onclick=()=> window.print();
document.getElementById('btnExportPDF').onclick=()=>{
  const el=document.createElement('div'); el.innerHTML=getHTML();
  html2pdf().from(el).save('ThinkHelper_'+Date.now()+'.pdf');
};

/* ===================== ë„êµ¬ ë²„íŠ¼ ===================== */
document.getElementById('iNew').onclick=newDoc;
document.getElementById('iVSCode').onclick=()=>{ window.open('http://127.0.0.1:1234','_blank','noopener'); };

/* ===================== ì˜µì…˜ ì €ì¥ ===================== */
document.getElementById('optDeep').onchange=e=>{ e.stopPropagation(); conf.deep=e.target.checked; localStorage.setItem("th.deep", conf.deep?'1':'0'); };
document.getElementById('optSugg').onchange=e=>{ e.stopPropagation(); conf.sugg=e.target.checked; localStorage.setItem("th.sugg", conf.sugg?'1':'0'); };
document.getElementById('optPersonal').onchange=e=>{ e.stopPropagation(); conf.personal=e.target.checked; localStorage.setItem("th.personal", conf.personal?'1':'0'); };

/* ===================== ì‹œì„  ì»¤ì„œ ===================== */
const optGaze=document.getElementById('optGaze');
let gazeRunning=false, emaX=null, emaY=null;
optGaze.onchange=e=>{ e.stopPropagation(); conf.gaze=e.target.checked; localStorage.setItem("th.gaze",conf.gaze?"1":"0"); conf.gaze?startGaze():stopGaze(); };
async function startGaze(){
  if(gazeRunning) return;
  const cursor=document.getElementById("gazeCursor");
  try{
    if(!window.webgazer){ alert("WebGazer ë¡œë“œ ì „ì…ë‹ˆë‹¤."); return; }
    emaX=null; emaY=null;

    // â˜… ë§ˆìš°ìŠ¤ ì»¤ì„œ ìˆ¨ê¹€
    document.body.classList.add('hide-cursor');

    await webgazer.setRegression('ridge').setGazeListener((data)=>{
      if(!data) return;
      if(emaX===null){ emaX=data.x; emaY=data.y; }
      const a=.15; emaX += a*(data.x-emaX); emaY += a*(data.y-emaY);
      const cx=Math.max(0,Math.min(window.innerWidth,emaX));
      const cy=Math.max(0,Math.min(window.innerHeight,emaY));
      cursor.style.display="block"; cursor.style.transform=`translate(${cx}px,${cy}px)`;
    }).begin();
    webgazer.showVideo(false).showFaceOverlay(false).showFaceFeedbackBox(false);
    gazeRunning=true;
  }catch(e){ alert("ì¹´ë©”ë¼ ê¶Œí•œ í•„ìš”: "+e.message); }
}

async function stopGaze(){
  const c=document.getElementById("gazeCursor");
  c.style.display="none";
  try{ if(window.webgazer){ await webgazer.end(); } }catch{}
  gazeRunning=false;

  // â˜… ì‹œì„  ì»¤ì„œ ì¢…ë£Œ ì‹œ ë§ˆìš°ìŠ¤ ì»¤ì„œ ë‹¤ì‹œ ë³´ì´ê¸°
  document.body.classList.remove('hide-cursor');
}


/* ===================== ìœ„ì¹˜/IP & ì–¸ì–´ ìë™ì„¤ì • + í‘¸í„° í‘œê¸° ===================== */
async function detectGeoAndMaybeSetLang(){
  const el=document.getElementById('loc');
  try{
    const r=await fetch("https://ipapi.co/json/");
    const j=await r.json();
    el.textContent = `ğŸ“ ${[j.city,j.region,j.country_name].filter(Boolean).join(', ')} (IP: ${j.ip}) Â· `;
    // ì–¸ì–´ ì €ì¥ì´ ì—†ì„ ë•Œë§Œ ìë™ ì„¤ì •
    if(!localStorage.getItem("th.lang")){
      const mapByCC={KR:"ko", JP:"ja"};
      const next=mapByCC[j.country_code] || "en";
      if(conf.lang!==next){
        conf.lang=next; localStorage.setItem("th.lang",conf.lang);
        document.getElementById("langSel").value=conf.lang;
        await applyI18N();
      }
    }
    window.__geo=j;
  }catch{
    el.textContent="ğŸ“ "+(I18N[conf.lang]||I18N.ko).loc_hidden+" Â· ";
  }
  // í‘¸í„° ë§í¬ ë‹¤ì‹œ ë§ë¶™ì´ê¸°(ìœ„ì¹˜ í…ìŠ¤íŠ¸ ë®ì–´ì“´ í›„)
  const suffix = document.createElement('span');
  suffix.innerHTML = `<a id="lnk_terms2" target="_blank" rel="noopener">${conf.lang==="ja"?"åˆ©ç”¨è¦ç´„":(conf.lang==="en"?"Terms":"ì´ìš©ì•½ê´€")}</a> Â·
                      <a id="lnk_privacy2" target="_blank" rel="noopener">${conf.lang==="ja"?"ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼":(conf.lang==="en"?"Privacy":"ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨")}</a> Â·
                      ${conf.lang==="ja"?"ãŠå•ã„åˆã‚ã›:":(conf.lang==="en"?"Contact:":"ë¬¸ì˜:")}
                      <a id="lnk_email2"></a>`;
  el.appendChild(suffix);
  document.getElementById("lnk_terms2").href=LINKS.terms;
  document.getElementById("lnk_privacy2").href=LINKS.privacy;
  const e2=document.getElementById("lnk_email2");
  e2.href=`mailto:${LINKS.email}?subject=ThinkHelper%20${encodeURIComponent(conf.lang==="ko"?"ë¬¸ì˜":"Support")}`;
  e2.textContent=LINKS.email;
}

/* ===================== ë™ì˜(ìµœì´ˆ 1íšŒë§Œ) ===================== */
function hasConsent(){ return !!localStorage.getItem("th.consent.v1"); }
function openConsentIfNeeded(){
  if(hasConsent()) return;
  // ë™ì˜ì°½ ì—´ê¸°
  const mask=document.getElementById("consentMask");
  mask.style.display="flex";

  const chkAuto=document.getElementById("chkAuto");
  const chkPrivacy=document.getElementById("chkPrivacy");
  const chkThird=document.getElementById("chkThird");
  const chkPay=document.getElementById("chkPay");
  const agreeBtn=document.getElementById("btnConsentAgree");
  const allBtn=document.getElementById("btnConsentAll");

  function updateBtn(){
    const ok = chkAuto.checked && chkPrivacy.checked && chkThird.checked;
    agreeBtn.disabled = !ok;
  }
  ["change","input"].forEach(ev=>{
    chkAuto.addEventListener(ev,updateBtn);
    chkPrivacy.addEventListener(ev,updateBtn);
    chkThird.addEventListener(ev,updateBtn);
    chkPay.addEventListener(ev,updateBtn);
  });
  allBtn.onclick=()=>{ chkAuto.checked=chkPrivacy.checked=chkThird.checked=chkPay.checked=true; updateBtn(); };

  agreeBtn.onclick=()=>{
    // ì €ì¥: ë™ì˜ ìƒíƒœ & ì„ íƒ ì‚¬í•­
    const geo = window.__geo||{};
    const payload={
      agreedAt: Date.now(),
      lang: conf.lang,
      country: geo.country || geo.country_name || "",
      ip: geo.ip || "",
      autoSuggest:true, privacy:true, thirdParty:true, paymentOptIn: !!chkPay.checked
    };
    localStorage.setItem("th.consent.v1", JSON.stringify(payload));

    // ì˜µì…˜ê³¼ ì—°ë™(ìë™ì œì•ˆ, ê²€ìƒ‰ ìë™ì™„ì„±)
    conf.sugg = true;
    localStorage.setItem("th.sugg","1");
    document.getElementById("optSugg").checked=true;

    // ë‹«ê¸°
    mask.style.display="none";
  };

  // ì™¸ë¶€ ë§í¬
  document.getElementById("c_priv_link").href=LINKS.privacy;
  document.getElementById("c_pay_link").href=LINKS.payment;
}

/* ===================== ì±„íŒ…(ì €ì¥/ìŠ¤íŠ¸ë¦¬ë° í´ë°±) ===================== */
const CHAT_LIST_KEY="th.chat.threads";
const CHAT_THREAD_KEY=(id)=>`th.chat.thread.${id}`;
const chatDock=document.getElementById("chatDock");
const chatBody=document.getElementById("chatBody");
const chatInput=document.getElementById("chatInput");
const chatSend=document.getElementById("t_send");
const chatThreadsEl=document.getElementById("chatThreads");
let curThreadId=null;

// ê°œë°œ(ë¡œì»¬)ë§Œ 5050, ë°°í¬ëŠ” /api ì‚¬ìš©
const isLocal = location.hostname === '127.0.0.1' || location.hostname === 'localhost';
const CHAT_ENDPOINT = isLocal ? 'http://127.0.0.1:5050' : '/api';
const CHAT_CHAT = CHAT_ENDPOINT + '/chat';

document.getElementById("chatBtn").onclick=()=>{ chatDock.style.display="flex"; renderThreadList(); if(!curThreadId) newThread(); };
document.getElementById("chatClose").onclick=()=> chatDock.style.display="none";
document.getElementById("btnNewThread").onclick=()=> newThread();

function loadThreadList(){ try{ return JSON.parse(localStorage.getItem(CHAT_LIST_KEY)||"[]"); }catch{return[]}}
function saveThreadList(list){ localStorage.setItem(CHAT_LIST_KEY, JSON.stringify(list)); }
function newThread(){
  const id="c_"+Date.now();
  const item={id, title:"ìƒˆ ì±„íŒ…", createdAt:Date.now(), updatedAt:Date.now()};
  const list=loadThreadList(); list.unshift(item); saveThreadList(list);
  localStorage.setItem(CHAT_THREAD_KEY(id), JSON.stringify({id, messages:[]}));
  openThread(id);
}
function openThread(id){
  curThreadId=id;
  renderThreadList();
  chatBody.innerHTML="";
  const data=JSON.parse(localStorage.getItem(CHAT_THREAD_KEY(id))||'{"messages":[]}');
  for(const m of data.messages){ addBubble(m.role==="user"?"me":"ai", m.content); }
  scrollBottom();
}
function saveMessage(role, content){
  if(!curThreadId) newThread();
  const key=CHAT_THREAD_KEY(curThreadId);
  const data=JSON.parse(localStorage.getItem(key)||'{"messages":[]}');
  data.messages.push({role, content});
  localStorage.setItem(key, JSON.stringify(data));
  const list=loadThreadList();
  const idx=list.findIndex(x=>x.id===curThreadId);
  if(idx>=0){
    if(list[idx].title==="ìƒˆ ì±„íŒ…" && role==="user") list[idx].title=content.slice(0,30);
    list[idx].updatedAt=Date.now();
    saveThreadList(list);
    renderThreadList();
  }
}
function renderThreadList(){
  const list=loadThreadList();
  chatThreadsEl.innerHTML = list.map(it=>`
    <div class="threadRow" data-id="${it.id}" ${curThreadId===it.id?'data-active="1"':''}>
      <div style="flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis" title="${escapeHtml(it.title)}">${escapeHtml(it.title)}</div>
      <button class="iconbtn" data-open="${it.id}" title="ì—´ê¸°">â†©</button>
      <button class="iconbtn" data-del="${it.id}" title="ì‚­ì œ">âœ–</button>
    </div>
  `).join("") || `<div class="notice">ì €ì¥ëœ ì±„íŒ…ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
  chatThreadsEl.onclick=(e)=>{
    const o=e.target.closest("[data-open]"); const d=e.target.closest("[data-del]");
    if(o){ openThread(o.dataset.open); }
    if(d){
      const id=d.dataset.del;
      if(confirm("ì±„íŒ…ì„ ì‚­ì œí• ê¹Œìš”?")){
        const list=loadThreadList().filter(x=>x.id!==id); saveThreadList(list);
        localStorage.removeItem(CHAT_THREAD_KEY(id));
        if(curThreadId===id) curThreadId=null;
        renderThreadList();
        if(list[0]) openThread(list[0].id); else { chatBody.innerHTML=""; }
      }
    }
  };
}
function scrollBottom(){ chatBody.scrollTop=chatBody.scrollHeight; }

function addBubble(who,text,cls=""){
  const d=document.createElement("div");
  d.className=`bubble ${who} ${cls}`.trim();
  d.textContent=text;
  chatBody.appendChild(d);
  scrollBottom();
  return d;
}
function setSending(isSending){
  chatSend.disabled = isSending;
  chatInput.disabled = isSending;
  chatSend.textContent = isSending ? (I18N[conf.lang]||I18N.ko).send+"â€¦" : (I18N[conf.lang]||I18N.ko).send;
}

/* Enter=ì „ì†¡, Shift+Enter=ì¤„ë°”ê¿ˆ */
chatInput.addEventListener("keydown",(e)=>{
  if(e.key==="Enter" && !e.shiftKey){
    e.preventDefault();
    document.getElementById("chatForm").dispatchEvent(new Event("submit",{cancelable:true}));
  }
});

/* --- í†µì‹  ìœ í‹¸ --- */
async function sendNonStream(payload){
  const r = await fetch(CHAT_ENDPOINT, {
    method: "POST",
    headers: {"Content-Type":"application/json", "Accept":"application/json"},
    body: JSON.stringify(payload)
  });
  if(!r.ok) throw new Error("HTTP "+r.status);
  const data = await r.json().catch(()=> ({}));
  return data.reply || data.text || data.output || "";
}
async function streamChat(payload, onChunk){
  let res;
  try{
    res = await fetch(CHAT_CHAT, {
      method:"POST",
      headers:{ "Content-Type":"application/json", "Accept":"text/event-stream, text/plain, application/json" },
      body: JSON.stringify(payload)
    });
  }catch(e){ throw e; }
  if(!res.ok) throw new Error("HTTP "+res.status);

  const ctype=(res.headers.get("content-type")||"").toLowerCase();
  const reader = res.body.getReader();
  const decoder = new TextDecoder("utf-8");
  let buffer=""; const isSSE = ctype.includes("text/event-stream");
  while(true){
    const {value, done} = await reader.read();
    if(done) break;
    const chunk=decoder.decode(value,{stream:true});
    if(isSSE){
      buffer += chunk;
      const lines = buffer.split(/\r?\n/);
      buffer = lines.pop()||"";
      for(const line of lines){
        if(line.startsWith("data:")){
          const data=line.slice(5).trim();
          if(data==="[DONE]") return;
          onChunk(data);
        }
      }
    }else{
      onChunk(chunk);
    }
  }
}

/* í¼ ì „ì†¡ */
document.getElementById("chatForm").addEventListener("submit", async (e)=>{
  e.preventDefault();
  const v=(chatInput.value||"").trim();
  if(!v) return;
  chatInput.value="";
  if(!curThreadId) newThread();
  addBubble("me", v);
  saveMessage("user", v);

  const aiBubble = addBubble("ai","");
  let acc="";
  const payload = { message: v, mode: conf.mode, lang: conf.lang, provider: "mistral", thread_id: curThreadId };

  try{
    setSending(true);
    let text = "";
    try{ text = await sendNonStream(payload); }catch(e){}

    if(text){
      acc = text; aiBubble.textContent = acc;
    }else{
      await streamChat(payload, (chunk)=>{
        let t = chunk;
        try{ const obj=JSON.parse(chunk); t = obj.reply || obj.delta || obj.text || chunk; }catch{}
        acc += t; aiBubble.textContent = acc; scrollBottom();
      });

      if(!acc){
        const res2=await fetch(CHAT_CHAT,{ method:"POST", headers:{"Content-Type":"application/json","Accept":"application/json"}, body: JSON.stringify(payload) });
        const data=await res2.json().catch(()=>null);
        acc=(data && (data.reply||data.text||data.output)) || "[no reply]";
        aiBubble.textContent=acc;
      }
    }
    saveMessage("assistant", acc || "[no reply]");
  }catch(err){
    aiBubble.classList.add("sys");
    aiBubble.textContent="ì—°ê²° ì‹¤íŒ¨. ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ ë˜ëŠ” ì—”ë“œí¬ì¸íŠ¸ê°€ ë§ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.";
  }finally{
    setSending(false);
    renderThreadList();
  }
});

/* ===================== ê²€ìƒ‰ ì‹¤í–‰(ìƒˆ íƒ­) ===================== */
function routeSearch(q){
  const low=q.toLowerCase().trim();
  const is=(re)=> re.test(low);
  const law=parseLaw(q);
  if(is(/ì¿ íŒ¡|coupang/)) return {title:"ì¿ íŒ¡", url:`https://www.coupang.com/np/search?q=${encodeURIComponent(q.replace(/ì¿ íŒ¡|coupang/ig,"").trim()||"")}`};
  if(is(/ì•„ë§ˆì¡´|amazon/)) return {title:"Amazon", url:`https://www.amazon.com/s?k=${encodeURIComponent(q.replace(/ì•„ë§ˆì¡´|amazon/ig,"").trim()||"")}`};
  if(is(/ë„¤ì´ë²„|naver/)) return {title:"ë„¤ì´ë²„", url:`https://search.naver.com/search.naver?query=${encodeURIComponent(q.replace(/ë„¤ì´ë²„|naver/ig,"").trim()||"")}`};
  if(law) return {title:`${law.code} ì œ${law.article}ì¡°`, url:law.url};
  if(is(/ë‰´ìŠ¤|news/)) return {title:"ë‰´ìŠ¤",url:`https://news.google.com/search?q=${encodeURIComponent(q.replace(/ë‰´ìŠ¤|news/ig,"").trim()||"")}`};
  return {title:"ì›¹ê²€ìƒ‰", url:`https://www.google.com/search?q=${encodeURIComponent(q)}`};
}
function parseLaw(q){
  const m=q.match(/(í˜•ë²•|ë¯¼ë²•|í˜•ì‚¬ì†Œì†¡ë²•|ë¯¼ì‚¬ì†Œì†¡ë²•|ìƒë²•)\s*ì œ?\s*(\d+)(ì¡°(?:ì˜\d+)*)?/); if(!m) return null;
  const code=m[1], art=m[2]+(m[3]||""); const url=`https://www.law.go.kr/%EB%B2%95%EB%A0%B9/${encodeURIComponent(code)}/${encodeURIComponent('ì œ'+art+'ì¡°')}`; return {code,article:art,url};
}
document.getElementById("searchBtn").onclick=()=> runSearch();
document.getElementById("searchBox").addEventListener("keydown",(e)=>{ if(e.key==="Enter"){ e.preventDefault(); runSearch(); }});
function runSearch(){
  const q=(document.getElementById("searchBox").value||"").trim(); if(!q) return;
  const r=routeSearch(q);
  try{ window.open(r.url,"_blank","noopener,noreferrer"); }catch{ location.href=r.url; }
}

/* ===================== ë¶€íŠ¸ìŠ¤íŠ¸ë© ===================== */
(function boot(){
  const cur=store.current(); if(cur && store.get(cur)) openDoc(cur); else newDoc(); renderList();
})();
</script>
</body>
</html>
